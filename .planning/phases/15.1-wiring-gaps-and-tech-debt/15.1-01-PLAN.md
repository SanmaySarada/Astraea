---
phase: 15.1-wiring-gaps-and-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/validation/engine.py
  - src/astraea/cli/app.py
  - tests/unit/validation/test_engine_registration.py
  - tests/unit/cli/test_reviewed_glob.py
autonomous: true

must_haves:
  truths:
    - "SUPPQUAL datasets are validated for referential integrity when running `astraea validate`"
    - "Variable ordering is checked against SDTM-IG spec when running `astraea validate`"
    - "Reviewed specs (*_reviewed.json) are found by validate, generate-define, generate-csdrg, and auto-fix commands"
  artifacts:
    - path: "src/astraea/validation/engine.py"
      provides: "SUPPQUAL + ordering rule registration in register_defaults()"
      contains: "get_suppqual_rules"
    - path: "src/astraea/cli/app.py"
      provides: "Glob patterns include *_reviewed.json"
      contains: "_reviewed.json"
    - path: "tests/unit/validation/test_engine_registration.py"
      provides: "Tests that engine registers ASTR-S001 and ASTR-O001"
      min_lines: 20
    - path: "tests/unit/cli/test_reviewed_glob.py"
      provides: "Tests that glob patterns include reviewed specs"
      min_lines: 15
  key_links:
    - from: "src/astraea/validation/engine.py"
      to: "src/astraea/validation/rules/suppqual_validation.py"
      via: "import get_suppqual_rules in register_defaults"
      pattern: "from astraea\\.validation\\.rules\\.suppqual_validation import get_suppqual_rules"
    - from: "src/astraea/validation/engine.py"
      to: "src/astraea/validation/rules/ordering.py"
      via: "import get_ordering_rules in register_defaults"
      pattern: "from astraea\\.validation\\.rules\\.ordering import get_ordering_rules"
    - from: "src/astraea/cli/app.py"
      to: "filesystem"
      via: "glob pattern for reviewed specs"
      pattern: "_reviewed\\.json"
---

<objective>
Fix the 2 moderate wiring gaps identified in the v1.1 milestone audit: (1) register SUPPQUAL integrity and variable ordering validation rules in ValidationEngine.register_defaults(), and (2) add *_reviewed.json to downstream CLI command glob patterns so reviewed specs are found by validate, generate-define, generate-csdrg, and auto-fix.

Purpose: These are the only 2 issues blocking a PASSED verdict on the v1.1 audit. Both are simple wiring -- the code exists, it just needs to be connected.
Output: Updated engine.py with 2 new rule registration blocks, updated app.py with expanded glob patterns, and tests proving both fixes work.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md

Key files to modify:
@src/astraea/validation/engine.py
@src/astraea/cli/app.py

Rules being wired (read-only reference):
@src/astraea/validation/rules/suppqual_validation.py
@src/astraea/validation/rules/ordering.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register SUPPQUAL and ordering rules in ValidationEngine</name>
  <files>src/astraea/validation/engine.py, tests/unit/validation/test_engine_registration.py</files>
  <action>
In `src/astraea/validation/engine.py`, add two new registration blocks to `register_defaults()` after the existing FDA TRC Rules block (after line 132):

Block 1 - SUPPQUAL integrity rules:
```python
# SUPPQUAL integrity rules
try:
    from astraea.validation.rules.suppqual_validation import get_suppqual_rules

    for rule in get_suppqual_rules():
        self.register(rule)
except (ImportError, AttributeError):
    logger.debug("No SUPPQUAL integrity rules available yet")
```

Block 2 - Variable ordering rules:
```python
# Variable ordering rules
try:
    from astraea.validation.rules.ordering import get_ordering_rules

    for rule in get_ordering_rules():
        self.register(rule)
except (ImportError, AttributeError):
    logger.debug("No variable ordering rules available yet")
```

Follow the exact same pattern as the existing registration blocks (try/except with logger.debug fallback).

Create `tests/unit/validation/test_engine_registration.py` with tests:
1. `test_engine_registers_suppqual_rule` - create a ValidationEngine and verify ASTR-S001 is in the rules list
2. `test_engine_registers_ordering_rule` - create a ValidationEngine and verify ASTR-O001 is in the rules list
3. `test_engine_total_rule_count` - verify total registered rules is >= 23 (21 FDAB + SUPPQUAL + ordering)

Use the real `load_sdtm_reference()` and `load_ct_reference()` to instantiate the engine (matching existing test patterns).
  </action>
  <verify>
Run: `pytest tests/unit/validation/test_engine_registration.py -v` -- all 3 tests pass.
Run: `python -c "from astraea.validation.engine import ValidationEngine; from astraea.reference import load_sdtm_reference, load_ct_reference; e = ValidationEngine(sdtm_ref=load_sdtm_reference(), ct_ref=load_ct_reference()); ids = [r.rule_id for r in e.rules]; assert 'ASTR-S001' in ids; assert 'ASTR-O001' in ids; print(f'OK: {len(ids)} rules registered')"` -- prints OK with rule count.
  </verify>
  <done>ASTR-S001 and ASTR-O001 appear in ValidationEngine.rules after construction. Engine registers at least 23 rules total.</done>
</task>

<task type="auto">
  <name>Task 2: Add *_reviewed.json to downstream CLI glob patterns</name>
  <files>src/astraea/cli/app.py, tests/unit/cli/test_reviewed_glob.py</files>
  <action>
In `src/astraea/cli/app.py`, find all 4 locations where spec files are globbed:

1. Line ~738 (validate command): `spec_files = sorted(search_dir.glob("*_spec.json")) + sorted(search_dir.glob("*_mapping.json"))`
2. Line ~871 (generate-define command): same pattern
3. Line ~969 (generate-csdrg command): same pattern
4. Line ~1098 (auto-fix command): same pattern

Add `+ sorted(search_dir.glob("*_reviewed.json"))` to each line. The result for each should be:
```python
spec_files = (
    sorted(search_dir.glob("*_spec.json"))
    + sorted(search_dir.glob("*_mapping.json"))
    + sorted(search_dir.glob("*_reviewed.json"))
)
```

Create `tests/unit/cli/test_reviewed_glob.py` that:
1. Creates a temp directory with `DM_reviewed.json` containing a valid DomainMappingSpec JSON
2. Verifies the glob pattern `*_reviewed.json` matches the file
3. Verifies the matched file can be loaded as a DomainMappingSpec

This is a unit test -- no CLI invocation needed, just verify the glob pattern works on a real filesystem path.
  </action>
  <verify>
Run: `pytest tests/unit/cli/test_reviewed_glob.py -v` -- tests pass.
Run: `grep -c "_reviewed.json" src/astraea/cli/app.py` -- should output at least 6 (4 glob locations + 2 review-domain writes).
  </verify>
  <done>All 4 downstream commands (validate, generate-define, generate-csdrg, auto-fix) glob for *_reviewed.json in addition to *_spec.json and *_mapping.json.</done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/validation/test_engine_registration.py tests/unit/cli/test_reviewed_glob.py -v` -- all new tests pass
2. `pytest -x -q` -- full test suite passes (2052+ tests)
3. `ruff check src/astraea/validation/engine.py src/astraea/cli/app.py` -- no lint violations
</verification>

<success_criteria>
- ASTR-S001 (SUPPQUAL integrity) and ASTR-O001 (variable ordering) are registered in ValidationEngine.register_defaults()
- All 4 downstream CLI commands find *_reviewed.json spec files
- All new tests pass; all existing 2052+ tests still pass
- Zero ruff violations introduced
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-wiring-gaps-and-tech-debt/15.1-01-SUMMARY.md`
</output>
