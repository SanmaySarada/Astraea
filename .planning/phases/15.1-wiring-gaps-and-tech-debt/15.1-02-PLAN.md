---
phase: 15.1-wiring-gaps-and-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/execution/pattern_handlers.py
  - src/astraea/learning/template_library.py
  - tests/unit/execution/test_handle_split_keywords.py
autonomous: true

must_haves:
  truths:
    - "handle_split stub warning only fires for truly unsupported keywords, not for recognized SPLIT operations"
    - "Template library is explicitly documented as v2-only (not a wiring gap)"
    - "LangGraph deferral is explicitly documented as intentional v2 decision"
    - "All existing 2052+ tests pass with no regressions"
  artifacts:
    - path: "src/astraea/execution/pattern_handlers.py"
      provides: "handle_split with documented keyword coverage and clean fallback"
      contains: "handle_split"
    - path: "src/astraea/learning/template_library.py"
      provides: "Module-level docstring marking as v2-only"
      contains: "v2"
    - path: "tests/unit/execution/test_handle_split_keywords.py"
      provides: "Tests for all 3 SPLIT keywords + unknown keyword fallback"
      min_lines: 30
  key_links:
    - from: "src/astraea/execution/pattern_handlers.py"
      to: "PATTERN_HANDLERS dict"
      via: "MappingPattern.SPLIT entry"
      pattern: "MappingPattern\\.SPLIT.*handle_split"
---

<objective>
Resolve remaining tech debt items from the v1.1 audit: (1) improve handle_split to have clear documentation and clean fallback behavior (not a stub warning), (2) mark template_library as explicitly v2-only in its module docstring, (3) document LangGraph deferral. Then run full regression to verify zero breakage.

Purpose: Close all non-deferred tech debt items so the v1.1 audit re-run produces a clean PASSED verdict. These are documentation and minor code improvements, not functional changes.
Output: Updated pattern_handlers.py with improved handle_split docs, updated template_library.py docstring, new tests, and verified full regression.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md

Key files:
@src/astraea/execution/pattern_handlers.py
@src/astraea/learning/template_library.py
@src/astraea/agents/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve handle_split and mark v2 modules</name>
  <files>src/astraea/execution/pattern_handlers.py, src/astraea/learning/template_library.py, src/astraea/agents/__init__.py</files>
  <action>
1. In `src/astraea/execution/pattern_handlers.py`, update `handle_split` (line ~709):
   - Improve the docstring to clearly list all 3 supported derivation keywords (SUBSTRING, DELIMITER_PART, REGEX_GROUP) as the complete SPLIT vocabulary
   - Change the fallback warning (line ~772) from `logger.warning` to `logger.info` since falling back to source column copy is expected behavior for simple splits without a derivation rule
   - The actual SPLIT functionality already works correctly with 3 keywords -- this is not a stub, it's a complete implementation. The audit incorrectly called it a "stub" because the warning message sounded incomplete.
   - Do NOT change any functional behavior -- only the log level and docstring

2. In `src/astraea/learning/template_library.py`, update the module-level docstring to clearly state:
   ```python
   """Cross-study domain template library (v2 feature).

   This module is fully implemented and tested but intentionally not exposed
   via CLI in v1. It will be wired into the CLI in v2 when cross-study
   workflow support is added. See .planning/v1.1-MILESTONE-AUDIT.md ISSUE-3.
   """
   ```

3. In `src/astraea/agents/__init__.py`, add a module docstring:
   ```python
   """LLM agent orchestration package (v2 feature).

   LangGraph-based multi-agent orchestration is deferred to v2.
   v1 uses direct Claude API calls via the mapping engine.
   See .planning/research/ARCHITECTURE.md for the planned agent architecture.
   """
   ```

4. Create `tests/unit/execution/test_handle_split_keywords.py` with tests:
   - `test_substring_keyword` - SUBSTRING(col, 0, 3) extracts first 3 chars
   - `test_delimiter_part_keyword` - DELIMITER_PART(col, "-", 0) extracts before first dash
   - `test_regex_group_keyword` - REGEX_GROUP(col, "(\d+)", 0) extracts first number
   - `test_unknown_keyword_falls_back_to_source` - unrecognized keyword returns source column (not None)
   - `test_no_rule_copies_source` - no derivation_rule just copies source column

Use VariableMapping from astraea.models.mapping with MappingPattern.SPLIT.
  </action>
  <verify>
Run: `pytest tests/unit/execution/test_handle_split_keywords.py -v` -- all 5 tests pass.
Run: `python -c "import ast; tree = ast.parse(open('src/astraea/learning/template_library.py').read()); doc = ast.get_docstring(tree); assert 'v2' in doc.lower(); print('OK: v2 marked')"` -- prints OK.
Run: `ruff check src/astraea/execution/pattern_handlers.py src/astraea/learning/template_library.py src/astraea/agents/__init__.py` -- no violations.
  </verify>
  <done>handle_split has clear documentation of all 3 keywords with info-level fallback (not warning). Template library and agents package are explicitly marked as v2-only. 5 new tests verify SPLIT keyword coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Full regression verification</name>
  <files></files>
  <action>
Run the complete test suite to verify zero regressions from both Plan 01 and Plan 02 changes:

1. `pytest -x -q` -- all 2052+ tests pass, 0 failures
2. `ruff check src/ tests/` -- 0 violations
3. `mypy src/` -- 0 errors (or same count as before)

If any test fails, investigate and fix. The changes in this phase are minimal wiring -- failures indicate a regression.
  </action>
  <verify>
Run: `pytest -x -q` -- output shows 2052+ passed, 0 failed.
Run: `ruff check src/ tests/` -- 0 violations.
  </verify>
  <done>Full test suite passes with 0 failures. 0 ruff violations. All changes from Phase 15.1 are regression-free.</done>
</task>

</tasks>

<verification>
1. `pytest -x -q` -- 2052+ tests pass, 0 failures
2. `ruff check src/ tests/` -- 0 violations
3. handle_split supports SUBSTRING, DELIMITER_PART, REGEX_GROUP with clean fallback
4. template_library.py and agents/__init__.py explicitly document v2 deferral
</verification>

<success_criteria>
- handle_split is documented and tested for all 3 keywords, no stub warning at WARNING level
- Template library and agents package are explicitly marked v2-only
- Full test suite passes (2052+ existing + new tests from both plans)
- Zero ruff violations, zero mypy errors introduced
- All items from v1.1 audit tech debt section either fixed or explicitly deferred with documentation
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-wiring-gaps-and-tech-debt/15.1-02-SUMMARY.md`
</output>
