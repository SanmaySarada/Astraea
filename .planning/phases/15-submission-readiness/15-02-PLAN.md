---
phase: 15-submission-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/submission/csdrg.py
  - src/astraea/submission/ectd.py
  - tests/unit/submission/test_csdrg_content.py
  - tests/unit/submission/test_ectd_structure.py
autonomous: true

must_haves:
  truths:
    - "cSDRG Section 2 auto-generates study description from TS parameters"
    - "cSDRG Section 6 auto-populates known data issues from validation findings"
    - "cSDRG Section 8 includes per-variable justification for SUPPQUAL candidates"
    - "eCTD directory structure assembly creates m5/datasets/tabulations/sdtm/ tree"
  artifacts:
    - path: "src/astraea/submission/csdrg.py"
      provides: "Enhanced cSDRG with populated Sections 2, 6, 8"
      contains: "study_description|generate_study_description"
    - path: "src/astraea/submission/ectd.py"
      provides: "eCTD directory structure assembly"
      contains: "m5/datasets/tabulations/sdtm"
    - path: "tests/unit/submission/test_csdrg_content.py"
      provides: "cSDRG content generation tests"
      min_lines: 50
    - path: "tests/unit/submission/test_ectd_structure.py"
      provides: "eCTD structure tests"
      min_lines: 40
  key_links:
    - from: "src/astraea/submission/csdrg.py"
      to: "generate_csdrg function"
      via: "ts_params parameter for Section 2"
      pattern: "ts_params|study_description"
---

<objective>
Populate cSDRG placeholder sections with auto-generated content and add eCTD directory structure assembly.

Purpose: MED-26 (cSDRG Sections 2 and 6 are placeholders), MED-28 (cSDRG missing per-variable SUPPQUAL justification), MED-27 (no eCTD directory structure enforcement). These are submission artifacts that reviewers expect.

Output: cSDRG with populated study description, known data issues, and per-variable justification; eCTD folder assembly function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/submission/csdrg.py
@src/astraea/submission/package.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate cSDRG Sections 2, 6, and 8</name>
  <files>src/astraea/submission/csdrg.py, tests/unit/submission/test_csdrg_content.py</files>
  <action>
Modify `generate_csdrg()` to accept a new optional parameter `ts_params: dict[str, str] | None = None` and `validation_issues: list[str] | None = None`.

**Section 2 -- Study Description:**
Add a helper function `_generate_study_description(ts_params: dict[str, str]) -> str` that:
- Builds a study description paragraph from TS parameters: TITLE, TPHASE, INDIC, TBLIND, TCNTRL, NARMS, PLANSUB, OBJPRIM
- For each missing parameter, uses "[Not specified]" fallback
- Format: "{TITLE}\n\nThis is a {TPHASE}, {TBLIND}, {TCNTRL} study investigating {INDIC}. The study was designed with {NARMS} treatment arm(s) and a planned enrollment of {PLANSUB} subjects. Primary objective: {OBJPRIM}."
- Replace the placeholder in `_CSDRG_TEMPLATE` Section 2 with `{{ study_description }}`
- Pass the generated text (or the placeholder message if ts_params is None) to the template

**Section 6 -- Known Data Issues:**
Replace the placeholder in Section 6 with auto-generated content:
- Accept validation findings (from the ValidationReport already passed in)
- List unresolved ERROR-level findings as known data issues, grouped by domain
- For each known false positive, add an explanation entry
- If no issues, say "No unresolved data quality issues were identified."
- Template variable: `{{ known_data_issues }}`

**Section 8 -- Non-Standard Variables (per-variable justification):**
Enhance the existing Section 8 template to include per-variable justification text:
- For each SUPPQUAL candidate, include: source variable name, reason for SUPPQUAL placement ("Variable {X} from source dataset {DS} does not map to a standard {DOMAIN} variable per SDTM-IG v3.4. Placed in SUPP{DOMAIN} to preserve data for regulatory review."), and data origin (CRF/Derived)
- Pull this info from the DomainMappingSpec's variable_mappings -- any mapping with notes containing "suppqual" or "non-standard"

Create `tests/unit/submission/test_csdrg_content.py`:
- Test Section 2 generates from TS params
- Test Section 2 uses fallback when no TS params provided
- Test Section 6 populates from validation findings
- Test Section 6 shows "no issues" when clean
- Test Section 8 includes per-variable SUPPQUAL justification
  </action>
  <verify>pytest tests/unit/submission/test_csdrg_content.py -v passes</verify>
  <done>cSDRG Sections 2, 6, and 8 are populated with auto-generated content from TS params, validation findings, and SUPPQUAL metadata</done>
</task>

<task type="auto">
  <name>Task 2: eCTD directory structure assembly</name>
  <files>src/astraea/submission/ectd.py, tests/unit/submission/test_ectd_structure.py</files>
  <action>
Create `src/astraea/submission/ectd.py` with a function `assemble_ectd_package()`:

```python
def assemble_ectd_package(
    source_dir: Path,
    output_dir: Path,
    study_id: str,
    *,
    define_xml_path: Path | None = None,
    csdrg_path: Path | None = None,
) -> Path:
```

The function should:
1. Create the eCTD directory structure under output_dir:
   ```
   m5/
     datasets/
       tabulations/
         sdtm/
           *.xpt           (all domain datasets)
           define.xml       (if provided)
           define2-0-0.xsl  (placeholder note if not present)
   ```
2. Copy all .xpt files from source_dir to the sdtm/ directory
3. Validate file naming: all filenames must be lowercase, alphanumeric + underscore only, .xpt extension
4. Rename files to lowercase if needed (e.g., DM.xpt -> dm.xpt)
5. Copy define.xml if provided
6. Copy cSDRG if provided (place at the tabulations/ level per FDA guidance)
7. Return the path to the sdtm/ directory
8. Use `shutil.copy2` for file copies, `pathlib` for path operations
9. Log each file operation with loguru

Add a helper `validate_xpt_filename(name: str) -> tuple[bool, str]` that checks FDA naming conventions and returns (valid, corrected_name).

Create `tests/unit/submission/test_ectd_structure.py`:
- Test directory structure created correctly
- Test XPT files copied and renamed to lowercase
- Test define.xml placed correctly
- Test cSDRG placed at tabulations/ level
- Test filename validation catches invalid names
- Test handles empty source directory gracefully
  </action>
  <verify>pytest tests/unit/submission/test_ectd_structure.py -v passes</verify>
  <done>eCTD assembly function creates correct m5/datasets/tabulations/sdtm/ structure with file naming enforcement</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/submission/test_csdrg_content.py tests/unit/submission/test_ectd_structure.py -v
pytest tests/ -x -q  # Full suite regression
ruff check src/astraea/submission/csdrg.py src/astraea/submission/ectd.py
```
</verification>

<success_criteria>
- cSDRG Section 2 populated from TS parameters
- cSDRG Section 6 populated from validation findings
- cSDRG Section 8 has per-variable SUPPQUAL justification
- eCTD directory structure correctly assembled
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-02-SUMMARY.md`
</output>
