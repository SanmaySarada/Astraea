---
phase: 15-submission-readiness
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - src/astraea/validation/rules/fda_business.py
  - tests/unit/validation/test_expanded_fdab_rules.py
autonomous: true

must_haves:
  truths:
    - "At least 14 new FDAB rules added (total 20+ from original 6)"
    - "AE-specific rules validate AESER, AEREL, AEOUT, AEACN, and AE date ordering"
    - "Cross-domain rules validate VISITNUM numeric, --DY no Day 0, --DTC ISO 8601"
    - "Domain-specific rules validate CMTRT not null, EXTRT not null"
    - "Most new rules use ERROR severity; FDAB005 (AE date ordering), FDAB016 (COUNTRY), FDAB035/036 (paired results) use WARNING"
  artifacts:
    - path: "src/astraea/validation/rules/fda_business.py"
      provides: "20+ FDA Business Rules"
      contains: "FDAB001|FDAB002|FDAB003|FDAB004|FDAB005"
    - path: "tests/unit/validation/test_expanded_fdab_rules.py"
      provides: "Tests for all new FDAB rules"
      min_lines: 150
  key_links:
    - from: "src/astraea/validation/rules/fda_business.py"
      to: "get_fda_business_rules()"
      via: "All new rules returned from registry"
      pattern: "get_fda_business_rules"
---

<objective>
Expand FDA Business Rules from 6 to 20+ rules covering AE, DM, CM, EX, LB, and cross-domain checks.

Purpose: Only 6 of ~45 FDAB rules are implemented. Adding 14+ more covers the most common FDA validation findings. New rules use ERROR severity for definitive violations and WARNING for cases with legitimate exceptions (date ordering with partial dates, country code variations, paired result completeness).

Output: 14+ new ValidationRule subclasses registered in get_fda_business_rules().
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/validation/rules/fda_business.py
@src/astraea/validation/rules/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AE and domain-specific FDAB rules</name>
  <files>src/astraea/validation/rules/fda_business.py, tests/unit/validation/test_expanded_fdab_rules.py</files>
  <action>
Add the following rule classes to `fda_business.py`, following the existing pattern (subclass ValidationRule, implement evaluate(), register in get_fda_business_rules()):

**AE Domain Rules (5 rules):**
1. `FDAB001Rule` -- AESER (Serious Event) must be Y or N. Check AE domain, AESER column, values in {"Y", "N"}. ERROR.
2. `FDAB002Rule` -- AEREL (Causality) must use CT. Check AE domain, AEREL column. Valid values from C66767 codelist or at minimum {"RELATED", "NOT RELATED", "POSSIBLY RELATED", "PROBABLY RELATED", "UNLIKELY RELATED"}. ERROR.
3. `FDAB003Rule` -- AEOUT (Outcome) must use CT C101854. Valid values: {"RECOVERED/RESOLVED", "RECOVERING/RESOLVING", "NOT RECOVERED/NOT RESOLVED", "RECOVERED/RESOLVED WITH SEQUELAE", "FATAL", "UNKNOWN"}. ERROR.
4. `FDAB004Rule` -- AEACN (Action Taken) must use CT C66767. Valid values: {"DRUG WITHDRAWN", "DOSE REDUCED", "DOSE INCREASED", "DOSE NOT CHANGED", "UNKNOWN", "NOT APPLICABLE"}. ERROR.
5. `FDAB005Rule` -- AESTDTC <= AEENDTC. For rows where both dates exist and are complete (10+ chars), compare date strings lexicographically. WARNING (dates may be partial).

**CM/EX Domain Rules (2 rules):**
6. `FDAB025Rule` -- CMTRT must not be null/blank in CM domain. ERROR.
7. `FDAB026Rule` -- EXTRT must not be null/blank in EX domain. ERROR.

**DM Domain Rule (1 rule):**
8. `FDAB016Rule` -- DM.COUNTRY should use ISO 3166-1 alpha-3 codes. Check COUNTRY column values against a hardcoded set of common ISO 3166-1 alpha-3 codes (USA, GBR, DEU, FRA, JPN, CAN, AUS, etc. -- include top ~50 countries). WARNING (not ERROR since country coding varies).

Register all new rules in `get_fda_business_rules()`.

Create `tests/unit/validation/test_expanded_fdab_rules.py`:
- Test each AE rule with valid data (passes)
- Test each AE rule with invalid data (fires)
- Test AE date ordering with partial dates (should skip comparison)
- Test CMTRT/EXTRT null checks
- Test COUNTRY validation with valid and invalid codes
- Test rules only fire for their target domain (not other domains)
  </action>
  <verify>pytest tests/unit/validation/test_expanded_fdab_rules.py -v passes</verify>
  <done>8 new domain-specific FDAB rules added and tested</done>
</task>

<task type="auto">
  <name>Task 2: Cross-domain FDAB rules</name>
  <files>src/astraea/validation/rules/fda_business.py, tests/unit/validation/test_expanded_fdab_rules.py</files>
  <action>
Add cross-domain FDAB rules that apply to multiple domains:

**Cross-domain Rules (6 rules):**
9. `FDAB020Rule` -- VISITNUM must be numeric when present. Applies to all domains with VISITNUM column. Check that all non-null VISITNUM values can be cast to float. ERROR.
10. `FDAB021Rule` -- --DY must not include Day 0. For any column ending in "DY", check that 0 is not in the values. ERROR. (Note: existing DY calculation already handles this, but this validation catches any data that slipped through.)
11. `FDAB022Rule` -- --DTC must be ISO 8601. For any column ending in "DTC", validate non-null values match ISO 8601 pattern (YYYY, YYYY-MM, YYYY-MM-DD, YYYY-MM-DDTHH:MM, YYYY-MM-DDTHH:MM:SS, with optional timezone). ERROR. Use a compiled regex for performance.
12. `FDAB035Rule` -- LBORRES/LBORRESU paired. When LBORRES is non-null, LBORRESU should also be non-null (and vice versa for numeric results). Applies to LB domain. WARNING (some results may legitimately lack units).
13. `FDAB036Rule` -- LBSTRESN/LBSTRESU paired. When LBSTRESN is non-null, LBSTRESU should also be non-null. Applies to LB domain. WARNING.
14. `PopulationFlagRule` -- Population flags (COMPLT, FULLSET, ITT, PPROT, SAFETY) must NOT be in DM domain per SDTM-IG v3.4. If any of these appear as columns in DM, fire ERROR. Rule ID: "FDAB-POP".

Register all in `get_fda_business_rules()`. Final count should be 20+ rules total (6 existing + 14 new).

Add tests to `test_expanded_fdab_rules.py`:
- Test VISITNUM numeric check with valid and invalid (string) values
- Test DY Day 0 check catches zero
- Test DTC ISO 8601 check with valid dates, partial dates, and invalid formats
- Test LBORRES/LBORRESU pairing
- Test LBSTRESN/LBSTRESU pairing
- Test population flag check in DM
- Test cross-domain rules apply to correct domains
  </action>
  <verify>pytest tests/unit/validation/test_expanded_fdab_rules.py -v passes; python -c "from astraea.validation.rules.fda_business import get_fda_business_rules; print(f'{len(get_fda_business_rules())} rules')"</verify>
  <done>6 cross-domain FDAB rules added; total rule count is 20+; all rules registered and tested</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/validation/test_expanded_fdab_rules.py -v
pytest tests/ -x -q  # Full suite regression
ruff check src/astraea/validation/rules/fda_business.py
# Verify rule count
source .venv/bin/activate && python -c "from astraea.validation.rules.fda_business import get_fda_business_rules; print(f'Total FDAB rules: {len(get_fda_business_rules())}')"
```
</verification>

<success_criteria>
- 20+ total FDAB rules (6 existing + 14 new)
- AE rules validate AESER, AEREL, AEOUT, AEACN, date ordering
- Cross-domain rules validate VISITNUM, DY, DTC, paired results
- Domain-specific rules validate CMTRT, EXTRT, COUNTRY
- Population flags rejected from DM
- ERROR severity for definitive violations; WARNING for FDAB005, FDAB016, FDAB035, FDAB036
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-05-SUMMARY.md`
</output>
