---
phase: 15-submission-readiness
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/mapping/context.py
  - src/astraea/profiling/profiler.py
  - src/astraea/validation/rules/presence.py
  - tests/unit/mapping/test_dm_arm_enforcement.py
  - tests/unit/profiling/test_sdtm_detection.py
autonomous: true

must_haves:
  truths:
    - "DM mapping prompt context lists ARM/ARMCD/ACTARM/ACTARMCD as Required variables"
    - "Post-mapping validation catches missing ARM/ARMCD/ACTARM/ACTARMCD in generated DM data"
    - "Profiler detects pre-mapped SDTM Findings datasets via column pattern analysis"
  artifacts:
    - path: "src/astraea/mapping/context.py"
      provides: "DM-specific mapping context with ARM enforcement"
      contains: "ARM|ARMCD|ACTARM|ACTARMCD"
    - path: "src/astraea/validation/rules/presence.py"
      provides: "DM ARM variable presence check"
      contains: "ARM|ARMCD|ACTARM|ACTARMCD"
    - path: "src/astraea/profiling/profiler.py"
      provides: "Pre-mapped SDTM detection function"
      contains: "detect_sdtm_format|is_sdtm_format"
    - path: "tests/unit/profiling/test_sdtm_detection.py"
      provides: "SDTM detection tests"
      min_lines: 40
  key_links:
    - from: "src/astraea/mapping/context.py"
      to: "MappingContextBuilder.build_prompt"
      via: "DM-specific context injection"
      pattern: "ARM.*Required|Required.*ARM"
    - from: "src/astraea/profiling/profiler.py"
      to: "DatasetProfile model"
      via: "detect_sdtm_format returns bool"
      pattern: "detect_sdtm_format"
---

<objective>
Add DM ARM variable enforcement at both mapping-prompt and validation levels, plus pre-mapped SDTM data detection.

Purpose: MED-14 (DM mapping prompts must enforce ARM/ARMCD/ACTARM/ACTARMCD as Required) and MED-29 (ecg_results, lab_results are pre-mapped SDTM data that should be detected). ARM enforcement at the prompt level prevents the LLM from omitting treatment arm variables; post-mapping validation is the safety net.

Output: DM-specific mapping prompt context enforcing ARM variables; validation rule catching missing DM ARM variables; profiler function detecting pre-mapped SDTM datasets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/mapping/context.py
@src/astraea/mapping/prompts.py
@src/astraea/validation/rules/presence.py
@src/astraea/profiling/profiler.py
@src/astraea/models/profiling.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: DM ARM variable enforcement via mapping prompt AND validation rule</name>
  <files>src/astraea/mapping/context.py, src/astraea/validation/rules/presence.py, tests/unit/mapping/test_dm_arm_enforcement.py</files>
  <action>
**Part A: DM mapping prompt context (MED-14 primary fix)**

Modify `MappingContextBuilder.build_prompt()` in `src/astraea/mapping/context.py` to add DM-specific context when `domain == "DM"`. After the standard domain spec context is assembled, append a DM-specific instruction block:

```
## DM Domain: Required Treatment Arm Variables

The following variables are REQUIRED for DM per SDTM-IG v3.4 and FDA submission:
- ARM (Description of Planned Arm) -- Required
- ARMCD (Planned Arm Code) -- Required
- ACTARM (Description of Actual Arm) -- Required
- ACTARMCD (Actual Arm Code) -- Required

ACTARM/ACTARMCD must be independently derived from source data reflecting the ACTUAL treatment received, not copied from ARM/ARMCD. If the source data does not distinguish planned vs actual treatment, map both ARM and ACTARM from the same source but flag for human review.

Do NOT omit these variables. They are a top FDA finding when missing.
```

This should be injected into the prompt text, not as a separate system message. Find where domain-specific context is assembled (likely in the `build_prompt` method) and add a conditional block for DM.

**Part B: Post-mapping validation rule (safety net)**

Add a new presence validation rule `DMArmPresenceRule` in `presence.py` that:
- Only applies to DM domain
- Checks all four variables exist as columns in the generated DataFrame
- Severity: ERROR
- Rule ID: "ASTR-P010" (or next available ID in presence module)
- Message includes which specific ARM variables are missing
- fix_suggestion: "Add ARM, ARMCD, ACTARM, ACTARMCD to DM mapping specification. These are Required per SDTM-IG v3.4."
- Register it in `get_presence_rules()`

Also add a separate rule `DMArmCopyPasteRule` that checks ACTARM != ARM and ACTARMCD != ARMCD for all rows. WARNING severity (values CAN legitimately be equal when patient received planned treatment).

Create `tests/unit/mapping/test_dm_arm_enforcement.py`:
- Test rule fires when ARM/ARMCD missing from DM DataFrame
- Test rule fires when ACTARM/ACTARMCD missing
- Test rule passes when all four present
- Test copy-paste warning fires when ACTARM == ARM for all rows
- Test copy-paste warning does NOT fire when some rows differ
- Test rule does not apply to non-DM domains
  </action>
  <verify>pytest tests/unit/mapping/test_dm_arm_enforcement.py -v passes</verify>
  <done>DM mapping prompt context lists ARM/ARMCD/ACTARM/ACTARMCD as Required; post-mapping validation catches missing ARM variables with ERROR and copy-paste with WARNING</done>
</task>

<task type="auto">
  <name>Task 2: Pre-mapped SDTM data detection in profiler</name>
  <files>src/astraea/profiling/profiler.py, tests/unit/profiling/test_sdtm_detection.py</files>
  <action>
Add a `detect_sdtm_format()` function to `profiler.py` that takes a `DatasetProfile` and returns `bool`:

```python
_FINDINGS_INDICATORS = {"TESTCD", "TEST", "ORRES", "STRESC", "STRESN"}

def detect_sdtm_format(profile: DatasetProfile) -> bool:
    """Detect if a profiled dataset is already in SDTM Findings format."""
```

Logic:
1. Get all non-EDC column names (uppercase)
2. For each Findings domain prefix (LB, EG, VS, PE, QS): count how many of the `_FINDINGS_INDICATORS` suffixes appear with that prefix (e.g., LBTESTCD, LBTEST, LBORRES)
3. If any prefix has >= 3 matches, return True
4. Also check: if DOMAIN column exists with a valid SDTM domain code value, return True
5. Otherwise return False

Also add the detection result to the `DatasetProfile` model if it has an optional field for it -- check the model first. If not, add an optional `is_sdtm_preformatted: bool = False` field to the model. The profiler's `profile_dataset()` function should call `detect_sdtm_format()` and set this field.

This detection is used downstream by the classifier/executor to route pre-mapped data to a validate-only path (that wiring is informational -- the detection function is the deliverable here).

Create `tests/unit/profiling/test_sdtm_detection.py`:
- Test detects SDTM LB format (LBTESTCD, LBTEST, LBORRES, LBSTRESC, LBSTRESN present)
- Test detects SDTM EG format
- Test detects by DOMAIN column presence
- Test returns False for raw EDC data (no SDTM patterns)
- Test returns False when only 1-2 indicators match (below threshold)
- Test ignores EDC system columns
  </action>
  <verify>pytest tests/unit/profiling/test_sdtm_detection.py -v passes</verify>
  <done>Profiler detects pre-mapped SDTM datasets; DatasetProfile includes is_sdtm_preformatted flag</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/mapping/test_dm_arm_enforcement.py tests/unit/profiling/test_sdtm_detection.py -v
pytest tests/ -x -q  # Full suite regression
ruff check src/astraea/mapping/context.py src/astraea/validation/rules/presence.py src/astraea/profiling/profiler.py
```
</verification>

<success_criteria>
- DM mapping prompt includes ARM/ARMCD/ACTARM/ACTARMCD as Required with explicit instructions
- DM ARM presence rule catches missing ARM/ARMCD/ACTARM/ACTARMCD with ERROR severity
- DM ARM copy-paste rule warns when ACTARM == ARM for all rows
- Pre-mapped SDTM detection works for LB, EG, VS format datasets
- DatasetProfile model includes is_sdtm_preformatted field
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-03-SUMMARY.md`
</output>
