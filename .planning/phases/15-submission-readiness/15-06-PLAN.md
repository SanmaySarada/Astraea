---
phase: 15-submission-readiness
plan: 06
type: execute
wave: 3
depends_on: ["15-01", "15-02", "15-03", "15-04", "15-05"]
files_modified:
  - src/astraea/cli/app.py
  - src/astraea/validation/rules/base.py
  - src/astraea/validation/rules/suppqual_validation.py
  - src/astraea/validation/rules/ordering.py
  - src/astraea/submission/__init__.py
  - tests/unit/submission/test_ectd_cli.py
  - tests/integration/test_submission_readiness.py
autonomous: true

must_haves:
  truths:
    - "CLI command for eCTD package assembly exists and works"
    - "Full regression suite passes with all Phase 15 changes"
    - "SUPPQUAL referential integrity validation rule implemented"
    - "Variable ordering validation rule implemented"
    - "INFORMATIONAL severity level added to enum"
  artifacts:
    - path: "tests/integration/test_submission_readiness.py"
      provides: "Integration test for Phase 15 features"
      min_lines: 60
    - path: "src/astraea/cli/app.py"
      provides: "CLI command for eCTD assembly"
      contains: "assemble-ectd|package-submission"
    - path: "src/astraea/validation/rules/suppqual_validation.py"
      provides: "SUPPQUAL referential integrity rule"
      contains: "RDOMAIN|IDVAR|IDVARVAL"
    - path: "src/astraea/validation/rules/ordering.py"
      provides: "Variable ordering validation rule"
      contains: "variable_order|SD0066"
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/submission/ectd.py"
      via: "CLI command calls assemble_ectd_package"
      pattern: "assemble_ectd_package"
---

<objective>
Wire Phase 15 features into CLI, address LOW priority items, and run full integration verification.

Purpose: Ensure all Phase 15 features are accessible from the CLI, address remaining LOW items that improve submission quality, and verify the full regression suite passes.

Output: CLI command for eCTD assembly, LOW item fixes (SUPPQUAL validation, variable ordering, INFORMATIONAL severity), integration tests, clean full test suite.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/cli/app.py
@src/astraea/submission/ectd.py
@src/astraea/validation/rules/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI package-submission command and INFORMATIONAL enum</name>
  <files>src/astraea/cli/app.py, src/astraea/validation/rules/base.py, tests/unit/submission/test_ectd_cli.py</files>
  <action>
**CLI Command:**
Add a `package-submission` CLI command to `app.py` that:
- Takes `--output-dir` (required), `--source-dir` (required, where XPT files live), `--study-id` (required)
- Optional: `--define-xml`, `--csdrg` paths
- Calls `assemble_ectd_package()` from `submission/ectd.py`
- Displays Rich progress and summary of files packaged
- Shows any file naming corrections made

**INFORMATIONAL severity level:**
Add `INFORMATIONAL` to the `RuleSeverity` enum in `base.py` (P21 has 4 levels: Error, Warning, Notice, Info). No existing rules need to change -- this just adds the option for future use. Place it after NOTICE in the enum definition.

Create `tests/unit/submission/test_ectd_cli.py`:
- Test CLI command invokes correctly with required args
- Test CLI error handling for missing dirs
- Test INFORMATIONAL severity is a valid RuleSeverity value
  </action>
  <verify>pytest tests/unit/submission/test_ectd_cli.py -v passes</verify>
  <done>CLI package-submission command works; INFORMATIONAL severity added to RuleSeverity enum</done>
</task>

<task type="auto">
  <name>Task 2: SUPPQUAL referential integrity and variable ordering validation rules</name>
  <files>src/astraea/validation/rules/suppqual_validation.py, src/astraea/validation/rules/ordering.py, tests/integration/test_submission_readiness.py</files>
  <action>
**SUPPQUAL referential integrity validation (LOW item from audit):**

Create `src/astraea/validation/rules/suppqual_validation.py` with a `SUPPQUALIntegrityRule` that:
- Applies to any SUPP* domain (SUPPAE, SUPPDM, SUPPLB, etc.)
- Checks that every RDOMAIN/USUBJID/IDVAR/IDVARVAL combination references an existing record in the parent domain
- This is a cross-domain validation rule that needs access to multiple DataFrames. Accept parent domain DataFrame as context or check RDOMAIN column values are valid domain codes.
- If parent domain data is not available at validation time, at minimum validate: RDOMAIN is a valid domain code, IDVAR is a valid variable name for RDOMAIN, QNAM follows naming convention (<=8 chars, alphanumeric)
- Rule ID: "ASTR-S001"
- Severity: ERROR
- Register in a `get_suppqual_rules()` function

**Variable ordering validation (LOW item from audit, P21 SD0066 equivalent):**

Create `src/astraea/validation/rules/ordering.py` with a `VariableOrderingRule` that:
- Checks that variable order in the generated DataFrame matches SDTM-IG-specified order for that domain
- Load expected order from SDTM-IG reference (domains.json key_variables or variable list)
- Compare actual DataFrame column order against expected order
- Only check SDTM variables (ignore any extra columns)
- Rule ID: "ASTR-O001"
- Severity: WARNING (variable ordering is aesthetic but P21 checks it)
- Register in a `get_ordering_rules()` function
  </action>
  <verify>pytest tests/ -k "suppqual or ordering" -v passes</verify>
  <done>SUPPQUAL referential integrity validation rule and variable ordering validation rule implemented</done>
</task>

<task type="auto">
  <name>Task 3: Integration test and full regression</name>
  <files>tests/integration/test_submission_readiness.py</files>
  <action>
Create `tests/integration/test_submission_readiness.py` that verifies the key Phase 15 deliverables work together:

1. **SPLIT pattern integration test**: Create a synthetic DataFrame with a delimited column, create a VariableMapping with SPLIT pattern and DELIMITER_PART rule, run through pattern handler, verify output.

2. **LC domain integration test**: Create a synthetic LB DataFrame with standard LB columns, generate LC via `generate_lc_from_lb()`, verify all LB columns renamed to LC, row count matches, DOMAIN="LC".

3. **cSDRG content integration test**: Create a mock ValidationReport and list of DomainMappingSpec, call `generate_csdrg()` with ts_params, verify Section 2 is populated (not placeholder), Section 6 has content, Section 8 has SUPPQUAL justification.

4. **FDAB rule count test**: Import `get_fda_business_rules()`, verify len >= 20.

5. **Pre-mapped SDTM detection test**: Create a DatasetProfile with SDTM-like columns, verify `detect_sdtm_format()` returns True.

Run full test suite to verify no regressions:
```bash
pytest tests/ -x -q
ruff check src/ tests/
```
  </action>
  <verify>pytest tests/integration/test_submission_readiness.py -v passes; pytest tests/ -x -q shows 0 failures</verify>
  <done>Integration tests verify Phase 15 features; full suite passes with 0 failures and 0 ruff errors</done>
</task>

</tasks>

<verification>
```bash
pytest tests/integration/test_submission_readiness.py -v
pytest tests/ -x -q  # FULL regression -- must be 0 failures
ruff check src/ tests/
```
</verification>

<success_criteria>
- CLI package-submission command works end-to-end
- SUPPQUAL referential integrity validation rule exists (ASTR-S001, ERROR)
- Variable ordering validation rule exists (ASTR-O001, WARNING)
- INFORMATIONAL severity level added to RuleSeverity enum
- Integration tests verify SPLIT, LC, cSDRG, FDAB, detection
- FULL test suite passes with 0 failures
- ruff clean
</success_criteria>

<low_items_disposition>
All 18 LOW items from the FDA Compliance Audit, with disposition:

**Addressed in this phase (3 items):**
1. Missing SUPPQUAL referential integrity check -- Plan 06 Task 2 (ASTR-S001)
2. Missing variable ordering validation (P21 SD0066) -- Plan 06 Task 2 (ASTR-O001)
3. Missing INFORMATIONAL severity level -- Plan 06 Task 1

**Deferred to future phases (15 items):**

Define.xml (4 LOW):
4. Missing XML stylesheet processing instruction -- cosmetic, deferred
5. FormalExpression Context="Python" should be "SAS" -- deferred to define.xml polish phase
6. MethodDef Name truncated to 40 chars -- deferred to define.xml polish phase
7. No def:StandardOID reference on CodeList -- deferred to define.xml polish phase

Execution Pipeline (2 LOW):
8. XPT read-back verification does not check data values -- deferred, current column/row check is sufficient for v1
9. Column name regex allows underscores (XPT v5 strictly alphanumeric) -- deferred, underscores are common in practice

Reference Data (3 LOW):
10. C66734 missing RELREC, PR, SU domain codes -- deferred, these domains not implemented in v1
11. SE TAESSION variable name may be fabricated -- deferred, SE domain is low-priority
12. C66728 includes "ONGOING" which may not be standard -- deferred, low-risk

Transforms (4 LOW):
13. SEQ determinism for tied sort keys -- deferred, pandas sort is stable which is sufficient
14. EPOCH date values not validated against standard terms -- deferred, low-risk
15. USUBJID delimiter hardcoded to "-" -- deferred, configurable delimiter is a v2 feature
16. ASCII replacement map missing special characters -- deferred, edge case

Submission (2 LOW):
17. No check for define2-0-0.xsl stylesheet -- deferred, stylesheet distribution is a packaging concern
18. cSDRG output is Markdown not PDF -- deferred, PDF conversion requires additional tooling (weasyprint/pandoc)
</low_items_disposition>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-06-SUMMARY.md`
</output>
