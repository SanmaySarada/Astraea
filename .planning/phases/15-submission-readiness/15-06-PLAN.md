---
phase: 15-submission-readiness
plan: 06
type: execute
wave: 3
depends_on: ["15-01", "15-02", "15-03", "15-04", "15-05"]
files_modified:
  - src/astraea/cli/app.py
  - src/astraea/submission/__init__.py
  - tests/unit/submission/test_ectd_cli.py
  - tests/integration/test_submission_readiness.py
autonomous: true

must_haves:
  truths:
    - "CLI command for eCTD package assembly exists and works"
    - "Full regression suite passes with all Phase 15 changes"
    - "LOW items addressed: SUPPQUAL referential integrity validation, variable ordering validation, INFORMATIONAL severity level"
  artifacts:
    - path: "tests/integration/test_submission_readiness.py"
      provides: "Integration test for Phase 15 features"
      min_lines: 60
    - path: "src/astraea/cli/app.py"
      provides: "CLI command for eCTD assembly"
      contains: "assemble-ectd|package-submission"
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/submission/ectd.py"
      via: "CLI command calls assemble_ectd_package"
      pattern: "assemble_ectd_package"
---

<objective>
Wire Phase 15 features into CLI, address LOW priority items, and run full integration verification.

Purpose: Ensure all Phase 15 features are accessible from the CLI, address remaining LOW items that improve submission quality, and verify the full regression suite passes.

Output: CLI command for eCTD assembly, LOW item fixes, integration test, clean full test suite.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/cli/app.py
@src/astraea/submission/ectd.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI commands and LOW item fixes</name>
  <files>src/astraea/cli/app.py, src/astraea/validation/rules/base.py, src/astraea/validation/rules/presence.py, tests/unit/submission/test_ectd_cli.py</files>
  <action>
**CLI Command:**
Add a `package-submission` CLI command to `app.py` that:
- Takes `--output-dir` (required), `--source-dir` (required, where XPT files live), `--study-id` (required)
- Optional: `--define-xml`, `--csdrg` paths
- Calls `assemble_ectd_package()` from `submission/ectd.py`
- Displays Rich progress and summary of files packaged
- Shows any file naming corrections made

**LOW Items to Address:**

1. **SUPPQUAL referential integrity validation** (LOW from audit): Add a validation rule that checks every SUPPQUAL dataset's RDOMAIN/USUBJID/IDVAR/IDVARVAL references exist in the parent domain. This is a cross-domain consistency rule. Add to `presence.py` or create a new `suppqual_validation.py`. Rule ID: "ASTR-S001". Severity: ERROR.

2. **Variable ordering validation** (LOW from audit, P21 SD0066 equivalent): Add a validation rule that checks variable order in generated DataFrames matches the SDTM-IG-specified order for that domain. Rule ID: "ASTR-O001". Severity: WARNING (variable ordering is aesthetic but P21 checks it).

3. **INFORMATIONAL severity level** (LOW from audit): Add `INFORMATIONAL` to the `RuleSeverity` enum in `base.py` (P21 has 4 levels: Error, Warning, Notice, Info). No existing rules need to change -- this just adds the option for future use.

Create `tests/unit/submission/test_ectd_cli.py`:
- Test CLI command invokes correctly with required args
- Test CLI error handling for missing dirs
  </action>
  <verify>pytest tests/unit/submission/test_ectd_cli.py -v passes</verify>
  <done>CLI package-submission command works; SUPPQUAL validation rule added; variable ordering check added; INFORMATIONAL severity available</done>
</task>

<task type="auto">
  <name>Task 2: Integration test and full regression</name>
  <files>tests/integration/test_submission_readiness.py</files>
  <action>
Create `tests/integration/test_submission_readiness.py` that verifies the key Phase 15 deliverables work together:

1. **SPLIT pattern integration test**: Create a synthetic DataFrame with a delimited column, create a VariableMapping with SPLIT pattern and DELIMITER_PART rule, run through pattern handler, verify output.

2. **LC domain integration test**: Create a synthetic LB DataFrame with standard LB columns, generate LC via `generate_lc_from_lb()`, verify all LB columns renamed to LC, row count matches, DOMAIN="LC".

3. **cSDRG content integration test**: Create a mock ValidationReport and list of DomainMappingSpec, call `generate_csdrg()` with ts_params, verify Section 2 is populated (not placeholder), Section 6 has content, Section 8 has SUPPQUAL justification.

4. **FDAB rule count test**: Import `get_fda_business_rules()`, verify len >= 20.

5. **Pre-mapped SDTM detection test**: Create a DatasetProfile with SDTM-like columns, verify `detect_sdtm_format()` returns True.

Run full test suite to verify no regressions:
```bash
pytest tests/ -x -q
ruff check src/ tests/
```
  </action>
  <verify>pytest tests/integration/test_submission_readiness.py -v passes; pytest tests/ -x -q shows 0 failures</verify>
  <done>Integration tests verify Phase 15 features; full suite passes with 0 failures and 0 ruff errors</done>
</task>

</tasks>

<verification>
```bash
pytest tests/integration/test_submission_readiness.py -v
pytest tests/ -x -q  # FULL regression -- must be 0 failures
ruff check src/ tests/
```
</verification>

<success_criteria>
- CLI package-submission command works end-to-end
- SUPPQUAL referential integrity validation rule exists
- Variable ordering validation rule exists
- INFORMATIONAL severity level added to enum
- Integration tests verify SPLIT, LC, cSDRG, FDAB, detection
- FULL test suite passes with 0 failures
- ruff clean
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-06-SUMMARY.md`
</output>
