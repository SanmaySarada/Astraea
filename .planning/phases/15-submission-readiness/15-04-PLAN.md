---
phase: 15-submission-readiness
plan: 04
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/astraea/execution/lc_domain.py
  - src/astraea/models/mapping.py
  - tests/unit/execution/test_lc_domain.py
autonomous: true

must_haves:
  truths:
    - "LC domain generated from LB data with correct LC-prefixed variable names"
    - "LCSEQ matches LBSEQ for 1:1 observation pairing"
    - "DOMAIN column set to LC in generated dataset"
    - "LC domain has identical row count to LB"
  artifacts:
    - path: "src/astraea/execution/lc_domain.py"
      provides: "LC domain generation from LB data"
      contains: "generate_lc_from_lb"
    - path: "tests/unit/execution/test_lc_domain.py"
      provides: "LC domain generation tests"
      min_lines: 60
  key_links:
    - from: "src/astraea/execution/lc_domain.py"
      to: "LB DataFrame"
      via: "Column rename LB* -> LC*"
      pattern: "rename.*LB.*LC"
---

<objective>
Implement LC (Laboratory Conventional) domain generation per FDA SDTCG v5.7 requirement.

Purpose: FDA mandates dual lab domains -- LB for SI units, LC for conventional units -- with 1:1 observation count matching. This is a new FDA requirement (SDTCG v5.7, March 2024) not addressed by any prior phase.

Output: LC domain generator that mirrors LB data with LC-prefixed variable names. For v1, no unit conversion is performed -- LC is a structural copy. A validation warning is emitted indicating manual unit review is needed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/execution/findings.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: LC domain generator</name>
  <files>src/astraea/execution/lc_domain.py, tests/unit/execution/test_lc_domain.py</files>
  <action>
Create `src/astraea/execution/lc_domain.py` with:

```python
def generate_lc_from_lb(
    lb_df: pd.DataFrame,
    study_id: str,
    *,
    unit_conversion: bool = False,
) -> tuple[pd.DataFrame, list[str]]:
```

Implementation:
1. Copy the LB DataFrame entirely
2. Rename all LB-prefixed columns to LC-prefixed:
   - LBTESTCD -> LCTESTCD, LBTEST -> LCTEST, LBORRES -> LCORRES, etc.
   - LBSEQ -> LCSEQ (critical: must maintain 1:1 pairing)
   - Do NOT rename common columns: STUDYID, DOMAIN, USUBJID, VISITNUM, VISIT, EPOCH, etc.
   - Do NOT rename LBBLFL (baseline flag) -- LC has its own LCBLFL
3. Set DOMAIN column to "LC"
4. If unit_conversion=False (default for v1):
   - Log a warning: "LC domain generated as structural copy of LB. Unit conversion from SI to conventional units not performed. Manual review required."
   - Return the warnings list with this message
5. Validate: assert len(lc_df) == len(lb_df), "LC and LB row count mismatch"
6. Return (lc_df, warnings)

Also add a helper `get_lb_to_lc_rename_map(columns: list[str]) -> dict[str, str]` that builds the column rename mapping, filtering out common/non-LB columns.

Add a `generate_lc_mapping_spec(lb_spec: DomainMappingSpec) -> DomainMappingSpec` that creates the LC mapping spec by copying the LB spec with domain="LC" and renaming all variable references from LB to LC. This is needed for define.xml and cSDRG.

Create `tests/unit/execution/test_lc_domain.py`:
- Test basic LB -> LC column renaming (LBTESTCD -> LCTESTCD, etc.)
- Test DOMAIN set to "LC"
- Test LCSEQ == LBSEQ values (1:1 pairing)
- Test row count matches between LB and LC
- Test common columns (STUDYID, USUBJID, VISITNUM) are NOT renamed
- Test warning generated when unit_conversion=False
- Test empty LB DataFrame produces empty LC
- Test generate_lc_mapping_spec creates valid LC spec from LB spec
  </action>
  <verify>pytest tests/unit/execution/test_lc_domain.py -v passes all tests</verify>
  <done>LC domain generated from LB with correct renaming, 1:1 pairing, DOMAIN="LC", and unit conversion warning</done>
</task>

<task type="auto">
  <name>Task 2: LC domain registration and define.xml support</name>
  <files>src/astraea/execution/lc_domain.py, src/astraea/models/mapping.py, tests/unit/execution/test_lc_domain.py</files>
  <action>
Ensure LC domain is recognized by the existing infrastructure:

1. Check if `src/astraea/data/sdtm_ig/domains.json` has an LC entry. If not, add a minimal LC domain definition -- LC has the same structure as LB (class: Findings, structure: "One record per subject per visit per lab test per time point"). The variable list mirrors LB with LC prefix.

2. In `lc_domain.py`, add a constant `LC_DOMAIN_DEFINITION` with the basic metadata needed for define.xml:
   - domain: "LC"
   - domain_label: "Laboratory Test Results - Conventional Units"
   - domain_class: "Findings"
   - structure: "One record per subject per visit per lab test per time point"

3. Add the LC domain to the known domain list in any relevant module that enumerates valid domains (check `src/astraea/reference/sdtm_ig.py` for domain enumeration).

4. Add tests verifying LC domain definition is well-formed and LC mapping spec serializes/deserializes correctly.
  </action>
  <verify>pytest tests/unit/execution/test_lc_domain.py -v passes; ruff check src/astraea/execution/lc_domain.py</verify>
  <done>LC domain is registered in domain infrastructure and define.xml can reference it</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/execution/test_lc_domain.py -v
pytest tests/ -x -q  # Full suite regression
ruff check src/astraea/execution/lc_domain.py
```
</verification>

<success_criteria>
- LC domain generated from LB with all columns correctly renamed
- LCSEQ matches LBSEQ for 1:1 pairing
- Row count identical between LB and LC
- Unit conversion warning emitted for v1
- LC mapping spec generated for define.xml
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-04-SUMMARY.md`
</output>
