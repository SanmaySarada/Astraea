---
phase: 15-submission-readiness
plan: 04
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/astraea/execution/lc_domain.py
  - src/astraea/models/mapping.py
  - src/astraea/validation/rules/fda_business.py
  - src/astraea/cli/app.py
  - tests/unit/execution/test_lc_domain.py
autonomous: true

must_haves:
  truths:
    - "LC domain generated from LB data with correct LC-prefixed variable names"
    - "LCSEQ matches LBSEQ for 1:1 observation pairing"
    - "DOMAIN column set to LC in generated dataset"
    - "LC domain has identical row count to LB"
    - "Validation WARNING fires when LCORRES == LBORRES for all rows, indicating unit conversion was not performed"
    - "CLI execute-domain for LB auto-triggers LC generation"
  artifacts:
    - path: "src/astraea/execution/lc_domain.py"
      provides: "LC domain generation from LB data"
      contains: "generate_lc_from_lb"
    - path: "src/astraea/validation/rules/fda_business.py"
      provides: "LC/LB identity validation rule"
      contains: "LCORRES.*LBORRES|lc_lb_identity"
    - path: "tests/unit/execution/test_lc_domain.py"
      provides: "LC domain generation tests"
      min_lines: 60
  key_links:
    - from: "src/astraea/execution/lc_domain.py"
      to: "LB DataFrame"
      via: "Column rename LB* -> LC*"
      pattern: "rename.*LB.*LC"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/execution/lc_domain.py"
      via: "execute-domain LB triggers LC auto-generation"
      pattern: "generate_lc_from_lb"
---

<objective>
Implement LC (Laboratory Conventional) domain generation per FDA SDTCG v5.7 requirement, with validation warning for missing unit conversion and CLI auto-generation wiring.

Purpose: FDA mandates dual lab domains -- LB for SI units, LC for conventional units -- with 1:1 observation count matching. This is a new FDA requirement (SDTCG v5.7, March 2024) not addressed by any prior phase. For v1, LC is a structural scaffold; a validation warning explicitly flags that unit conversion was not performed, ensuring reviewers know manual unit review is needed before submission.

Output: LC domain generator, LC/LB identity validation warning, CLI auto-generation after LB execution, LC domain registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-submission-readiness/15-RESEARCH.md
@src/astraea/execution/findings.py
@src/astraea/models/mapping.py
@src/astraea/cli/app.py
@src/astraea/validation/rules/fda_business.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: LC domain generator with identity validation warning</name>
  <files>src/astraea/execution/lc_domain.py, src/astraea/validation/rules/fda_business.py, tests/unit/execution/test_lc_domain.py</files>
  <action>
**Part A: LC domain generator**

Create `src/astraea/execution/lc_domain.py` with:

```python
def generate_lc_from_lb(
    lb_df: pd.DataFrame,
    study_id: str,
    *,
    unit_conversion: bool = False,
) -> tuple[pd.DataFrame, list[str]]:
```

Implementation:
1. Copy the LB DataFrame entirely
2. Rename all LB-prefixed columns to LC-prefixed:
   - LBTESTCD -> LCTESTCD, LBTEST -> LCTEST, LBORRES -> LCORRES, etc.
   - LBSEQ -> LCSEQ (critical: must maintain 1:1 pairing)
   - Do NOT rename common columns: STUDYID, DOMAIN, USUBJID, VISITNUM, VISIT, EPOCH, etc.
   - Do NOT rename LBBLFL (baseline flag) -- LC has its own LCBLFL
3. Set DOMAIN column to "LC"
4. If unit_conversion=False (default for v1):
   - Log a warning: "LC domain generated as structural copy of LB. Unit conversion from SI to conventional units not performed. Manual review required."
   - Return the warnings list with this message
5. Validate: assert len(lc_df) == len(lb_df), "LC and LB row count mismatch"
6. Return (lc_df, warnings)

Also add a helper `get_lb_to_lc_rename_map(columns: list[str]) -> dict[str, str]` that builds the column rename mapping, filtering out common/non-LB columns.

Add a `generate_lc_mapping_spec(lb_spec: DomainMappingSpec) -> DomainMappingSpec` that creates the LC mapping spec by copying the LB spec with domain="LC" and renaming all variable references from LB to LC. This is needed for define.xml and cSDRG.

**Part B: LC/LB identity validation rule (blocker fix)**

Add a new FDAB rule `FDABLCIdentityRule` in `fda_business.py` that:
- Applies to LC domain only
- Requires both LB and LC DataFrames (accept via a cross-domain validation interface, or check by comparing LCORRES values against a pattern that would indicate no conversion)
- Simple heuristic: if the LC dataset has columns LCORRES and LCORRESU, and the LCORRESU values are ALL identical to what would be SI units (or more practically: emit a WARNING unconditionally when `unit_conversion=False` was used)
- Implementation: Add a metadata flag `lc_unit_conversion_performed: bool` to the LC DataFrame attrs (df.attrs["lc_unit_conversion_performed"] = False). The rule checks this attr. If False, fire WARNING: "LC domain contains identical values to LB. SDTCG v5.7 requires conventional units in LC. Unit conversion from SI to conventional was not performed. Manual review required before submission."
- Rule ID: "FDAB-LC01"
- Severity: WARNING (not ERROR -- the scaffold is valid structure, but content needs manual review)
- Register in `get_fda_business_rules()`

Create `tests/unit/execution/test_lc_domain.py`:
- Test basic LB -> LC column renaming (LBTESTCD -> LCTESTCD, etc.)
- Test DOMAIN set to "LC"
- Test LCSEQ == LBSEQ values (1:1 pairing)
- Test row count matches between LB and LC
- Test common columns (STUDYID, USUBJID, VISITNUM) are NOT renamed
- Test warning generated when unit_conversion=False
- Test empty LB DataFrame produces empty LC
- Test generate_lc_mapping_spec creates valid LC spec from LB spec
- Test FDAB-LC01 validation rule fires WARNING for unconverted LC data
  </action>
  <verify>pytest tests/unit/execution/test_lc_domain.py -v passes all tests</verify>
  <done>LC domain generated from LB with correct renaming, 1:1 pairing, DOMAIN="LC", unit conversion warning emitted; FDAB-LC01 validation rule fires WARNING when LC values are identical to LB</done>
</task>

<task type="auto">
  <name>Task 2: LC domain registration and CLI auto-generation wiring</name>
  <files>src/astraea/execution/lc_domain.py, src/astraea/models/mapping.py, src/astraea/cli/app.py, tests/unit/execution/test_lc_domain.py</files>
  <action>
**Part A: LC domain registration**

1. Check if `src/astraea/data/sdtm_ig/domains.json` has an LC entry. If not, add a minimal LC domain definition -- LC has the same structure as LB (class: Findings, structure: "One record per subject per visit per lab test per time point"). The variable list mirrors LB with LC prefix.

2. In `lc_domain.py`, add a constant `LC_DOMAIN_DEFINITION` with the basic metadata needed for define.xml:
   - domain: "LC"
   - domain_label: "Laboratory Test Results - Conventional Units"
   - domain_class: "Findings"
   - structure: "One record per subject per visit per lab test per time point"

3. Add the LC domain to the known domain list in any relevant module that enumerates valid domains (check `src/astraea/reference/sdtm_ig.py` for domain enumeration).

**Part B: CLI auto-generation wiring**

Modify the `execute-domain` CLI command in `src/astraea/cli/app.py` to auto-generate LC when executing LB:

After the LB domain execution completes successfully, add logic:
```python
# After LB execution succeeds:
if domain == "LB":
    from astraea.execution.lc_domain import generate_lc_from_lb
    console.print("\n[bold blue]Auto-generating LC domain from LB...[/bold blue]")
    lc_df, lc_warnings = generate_lc_from_lb(lb_df, study_id)
    # Write LC XPT to same output directory
    lc_output_path = output_dir / "lc.xpt"
    # Use same XPT writer as LB
    for warning in lc_warnings:
        console.print(f"[yellow]WARNING:[/yellow] {warning}")
    console.print(f"[green]LC domain written to:[/green] {lc_output_path}")
```

The exact integration point depends on where the LB DataFrame is available post-execution. Read the execute-domain command to find where the generated DataFrame is written to XPT, and add the LC generation immediately after.

Add tests verifying:
- LC domain definition is well-formed
- LC mapping spec serializes/deserializes correctly
- CLI auto-generation logic is triggered for LB domain (unit test the conditional, not the full CLI)
  </action>
  <verify>pytest tests/unit/execution/test_lc_domain.py -v passes; ruff check src/astraea/execution/lc_domain.py src/astraea/cli/app.py</verify>
  <done>LC domain is registered in domain infrastructure, define.xml can reference it, and CLI execute-domain for LB auto-triggers LC generation</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/execution/test_lc_domain.py -v
pytest tests/ -x -q  # Full suite regression
ruff check src/astraea/execution/lc_domain.py src/astraea/cli/app.py
```
</verification>

<success_criteria>
- LC domain generated from LB with all columns correctly renamed
- LCSEQ matches LBSEQ for 1:1 pairing
- Row count identical between LB and LC
- FDAB-LC01 WARNING fires when unit conversion not performed
- Unit conversion warning emitted for v1
- LC mapping spec generated for define.xml
- CLI execute-domain for LB auto-generates LC
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-submission-readiness/15-04-SUMMARY.md`
</output>
