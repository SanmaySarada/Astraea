---
phase: 10-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/models/sdtm.py
  - src/astraea/io/sas_reader.py
  - src/astraea/llm/client.py
  - src/astraea/profiling/profiler.py
  - src/astraea/mapping/transform_registry.py
  - src/astraea/mapping/exporters.py
  - src/astraea/mapping/engine.py
  - src/astraea/mapping/validation.py
  - src/astraea/execution/executor.py
  - src/astraea/parsing/pdf_extractor.py
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - src/astraea/validation/predict.py
  - src/astraea/validation/rules/fda_business.py
  - src/astraea/validation/rules/fda_trc.py
  - src/astraea/validation/rules/consistency.py
  - src/astraea/learning/retriever.py
  - src/astraea/learning/vector_store.py
  - src/astraea/learning/metrics.py
  - src/astraea/learning/example_store.py
  - src/astraea/learning/dspy_optimizer.py
  - tests/integration/execution/test_lb_execution.py
  - tests/integration/execution/test_vs_execution.py
  - tests/integration/execution/test_eg_execution.py
  - tests/integration/execution/test_ts_integration.py
  - tests/integration/validation/test_validation_integration.py
  - tests/test_parsing/test_ecrf_parser.py
  - tests/unit/execution/test_trial_summary.py
  - tests/unit/execution/test_trial_design.py
  - tests/unit/execution/test_subject_visits.py
  - tests/unit/learning/test_dspy_optimizer.py
  - tests/unit/learning/test_retriever.py
  - tests/unit/cli/test_learn_commands.py
  - tests/unit/validation/test_fda_rules.py
  - tests/unit/validation/test_presence_rules.py
  - tests/test_transforms/test_dates.py
  - tests/test_classification/test_heuristic.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ruff check src/ tests/ reports zero violations"
    - "mypy src/ --ignore-missing-imports reports zero errors"
    - "All existing tests still pass"
  artifacts:
    - path: "src/astraea/models/sdtm.py"
      provides: "StrEnum instead of str+Enum for DomainClass, CoreDesignation"
      contains: "StrEnum"
  key_links:
    - from: "ruff check"
      to: "all source and test files"
      via: "zero violations"
      pattern: "Found 0 errors"
---

<objective>
Fix all ruff lint violations and mypy type errors across the entire codebase.

Purpose: The codebase currently has 139 ruff violations (86 E501 line-length, 26 F401 unused-imports, 17 I001 unsorted-imports, 2 UP042 str+Enum, 2 E402 import-order, 2 B017, 1 SIM108, 1 B905, 1 F841, 1 SIM300) and 122 mypy errors (107 in exporters.py alone from unused type:ignore comments, plus scattered type-arg, attr-defined errors). This plan fixes all of them.

Output: Zero ruff violations, zero mypy errors, all tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all ruff violations across src/ and tests/</name>
  <files>All files listed in files_modified above</files>
  <action>
Fix all 139 ruff violations. Strategy by rule type:

1. **E501 (86 violations — line too long):** Reformat long lines to stay under 88 chars (ruff default). Break strings, wrap function arguments, use intermediate variables where needed. Affected files: test_lb_execution.py (25), test_vs_execution.py (16), test_eg_execution.py (15), test_ecrf_parser.py (8), test_trial_summary.py (7), test_trial_design.py (6), models/sdtm.py (5), test_dates.py (4), test_dspy_optimizer.py (4), and others.

2. **F401 (26 violations — unused imports):** Remove all unused imports. Check each one — if it is re-exported intentionally (e.g., `__init__.py`), add `__all__` instead. Otherwise delete the import line.

3. **I001 (17 violations — unsorted imports):** Run `ruff check --fix` to auto-sort. If auto-fix doesn't resolve, manually reorder import blocks: stdlib first, then third-party, then local, with `from __future__` at top.

4. **UP042 (2 violations — str+Enum):** In `src/astraea/models/sdtm.py`, change `class DomainClass(str, Enum)` to `class DomainClass(StrEnum)` and `class CoreDesignation(str, Enum)` to `class CoreDesignation(StrEnum)`. Add `from enum import StrEnum` import. Remove `from enum import Enum` if no longer used. NOTE: MappingPattern and ConfidenceLevel in mapping.py already use StrEnum per decision D-0301-01 — this makes sdtm.py consistent.

5. **E402 (2 violations — module-level import not at top):** Move imports to top of file or add `noqa: E402` comment if the late import is intentional (e.g., after `sys.path` manipulation).

6. **B017 (2 violations):** Fix assertRaises/pytest.raises usage per flake8-bugbear rules.

7. **SIM108 (1 violation — use ternary):** In `src/astraea/io/sas_reader.py` line 55, replace if/else block with ternary: `dtype = "character" if sas_format is not None and sas_format.startswith("$") else "numeric"`.

8. **B905 (1 violation):** Fix zip() without strict= per flake8-bugbear.

9. **F841 (1 violation — unused variable):** Remove or prefix with `_`.

10. **SIM300 (1 violation — Yoda condition):** Flip comparison order.

Use `ruff check --fix src/ tests/` first for auto-fixable violations (44 auto-fixable). Then manually fix the remaining ~95 violations.

IMPORTANT: After UP042 fix (StrEnum), grep for any code that does `DomainClass.value` or `str(DomainClass.X)` — StrEnum changes how string conversion works slightly. The value IS the string, so `.value` still works but string comparisons may need updating. Check tests.
  </action>
  <verify>Run `source .venv/bin/activate && ruff check src/ tests/` — must report "Found 0 errors" or "All checks passed".</verify>
  <done>Zero ruff violations across all source and test files.</done>
</task>

<task type="auto">
  <name>Task 2: Fix all mypy type errors</name>
  <files>src/astraea/mapping/exporters.py, src/astraea/mapping/engine.py, src/astraea/mapping/validation.py, src/astraea/models/mapping.py, src/astraea/execution/executor.py, src/astraea/parsing/pdf_extractor.py, src/astraea/cli/display.py, src/astraea/validation/predict.py, src/astraea/validation/rules/fda_business.py, src/astraea/validation/rules/fda_trc.py, src/astraea/validation/rules/consistency.py, src/astraea/learning/retriever.py, src/astraea/learning/vector_store.py, src/astraea/learning/metrics.py, src/astraea/learning/example_store.py, src/astraea/learning/dspy_optimizer.py, src/astraea/mapping/transform_registry.py</files>
  <action>
Fix all 122 mypy errors. Strategy by category:

1. **exporters.py (107 errors — "Unused type: ignore comment"):** Remove all `# type: ignore` comments that are no longer needed. These were likely added when openpyxl stubs were missing but are now resolved with `--ignore-missing-imports`. Remove each one and re-check — if the underlying error resurfaces, replace with a properly scoped ignore like `# type: ignore[import-untyped]`.

2. **engine.py (13 errors):** Fix attribute access errors. Line 326 has `# type: ignore` that should be `# type: ignore[attr-defined]` (object has no attribute "structure"). Fix other type annotation issues.

3. **fda_business.py (2 errors):** `CTReference` has no attribute `get_codelist`. Check the actual method name on `CTReference` class — likely `list_codelists` or `get_codelist_by_id`. Fix the method call to match the actual API.

4. **Missing type parameters (type-arg errors):** In `models/mapping.py`, `validation/predict.py`, `validation/rules/fda_trc.py`, `validation/rules/consistency.py` — add explicit type parameters to bare `dict` and `list` annotations (e.g., `dict[str, Any]` instead of `dict`).

5. **mapping/validation.py (arg-type error):** Line 160 passes `str` where `Literal['Char', 'Num']` expected for `sdtm_data_type`. Either cast the value or widen the type annotation on the model.

6. **cli/app.py (valid-type error):** Line 487 has invalid type comment/annotation. Fix the syntax.

7. **Remaining scattered errors in learning/, execution/, parsing/:** Fix type annotations, add missing type parameters, correct import types.

Run mypy after each major file change to verify progress. Do NOT add blanket `# type: ignore` — fix the actual types.
  </action>
  <verify>Run `source .venv/bin/activate && mypy src/ --ignore-missing-imports` — must report "Success: no issues found" or "Found 0 errors".</verify>
  <done>Zero mypy errors across all source files. All existing tests still pass (`pytest tests/ -x -q`).</done>
</task>

</tasks>

<verification>
1. `source .venv/bin/activate && ruff check src/ tests/` — zero violations
2. `source .venv/bin/activate && mypy src/ --ignore-missing-imports` — zero errors
3. `source .venv/bin/activate && pytest tests/ -x -q` — all tests pass
4. `source .venv/bin/activate && ruff format --check src/ tests/` — no formatting issues
</verification>

<success_criteria>
- ruff check reports zero violations
- mypy reports zero errors
- All existing tests pass (no regressions)
- UP042 violations fixed (StrEnum used consistently)
</success_criteria>

<output>
After completion, create `.planning/phases/10-tech-debt/10-01-SUMMARY.md`
</output>
