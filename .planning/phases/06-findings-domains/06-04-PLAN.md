---
phase: 06-findings-domains
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - tests/integration/execution/test_suppqual_generation.py
  - tests/integration/execution/test_findings_xpt_output.py
autonomous: true

must_haves:
  truths:
    - "SUPPQUAL generation from LB and EG parent domains produces referentially-intact supplemental datasets"
    - "All Findings domains (LB, EG, PE) produce valid .xpt files with correct variable labels and sort order"
    - "Cross-domain USUBJID validation covers all new Findings domains"
  artifacts:
    - path: "tests/integration/execution/test_suppqual_generation.py"
      provides: "Integration tests for SUPPLB and SUPPEG generation from parent domains"
    - path: "tests/integration/execution/test_findings_xpt_output.py"
      provides: "XPT output tests for LB, EG, PE domains + SUPPQUAL"
  key_links:
    - from: "tests/integration/execution/test_suppqual_generation.py"
      to: "src/astraea/execution/suppqual.py"
      via: "Tests generate_suppqual with realistic parent domain data"
      pattern: "generate_suppqual|validate_suppqual_integrity"
    - from: "tests/integration/execution/test_findings_xpt_output.py"
      to: "src/astraea/io/xpt_writer.py"
      via: "Tests XPT write + read-back for Findings domains"
      pattern: "write_xpt_v5"
---

<objective>
Integration tests for SUPPQUAL generation and XPT output for all Findings domains -- the final verification layer ensuring all Phase 6 execution components work end-to-end.

Purpose: SUPPQUAL referential integrity is a common source of P21 validation failures. XPT output tests verify that generated datasets survive write-read roundtrip. This plan ties together the TRANSPOSE handler, FindingsExecutor, SUPPQUAL generator, and XPT writer.

Output: Integration tests verifying SUPPLB/SUPPEG generation and XPT output for LB, EG, PE.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/suppqual.py
@src/astraea/execution/findings.py
@src/astraea/io/xpt_writer.py
@tests/integration/execution/test_xpt_output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: SUPPQUAL generation integration tests</name>
  <files>
    tests/integration/execution/test_suppqual_generation.py
  </files>
  <action>
Create `tests/integration/execution/test_suppqual_generation.py`:

1. Create a realistic LB parent DataFrame fixture:
   - 10 rows, 3 subjects, with STUDYID, DOMAIN="LB", USUBJID, LBSEQ (1-N per subject), LBTESTCD, LBORRES, LBORRESU
   - Add supplemental candidate columns: LBFAST (fasting status, "Y"/"N"), LBMETHOD ("Enzymatic"/"Turbidimetric"), LBTOX (toxicity grade, some null)

2. Create a realistic EG parent DataFrame fixture:
   - 8 rows, 2 subjects, STUDYID, DOMAIN="EG", USUBJID, EGSEQ, EGTESTCD, EGORRES
   - Add supplemental candidate columns: EGCLSIG (clinical significance, "Y"/"N"/null), EGABS (abnormality description, mostly null)

3. Define SuppVariable lists:
   - SUPPLB: SuppVariable(qnam="LBFAST", qlabel="Fasting Status", source_col="LBFAST", qorig="CRF"), SuppVariable(qnam="LBTOX", qlabel="Toxicity Grade", source_col="LBTOX", qorig="CRF")
   - SUPPEG: SuppVariable(qnam="EGCLSIG", qlabel="Clinically Significant", source_col="EGCLSIG", qorig="CRF"), SuppVariable(qnam="EGABS", qlabel="Abnormality Description", source_col="EGABS", qorig="CRF")

4. Tests:
   - test_supplb_generation: Generate SUPPLB from LB parent, verify correct RDOMAIN="LB", IDVAR="LBSEQ", QNAM values
   - test_supplb_null_skipped: Verify null LBTOX values do NOT produce SUPPQUAL records
   - test_supplb_referential_integrity: Run validate_suppqual_integrity, verify 0 errors
   - test_supplb_row_count: Verify row count = (non-null LBFAST rows * 1) + (non-null LBTOX rows * 1)
   - test_suppeg_generation: Generate SUPPEG, verify RDOMAIN="EG", IDVAR="EGSEQ"
   - test_suppeg_sparse_data: Most EGABS values are null -> very few SUPPEG records for that QNAM
   - test_suppeg_referential_integrity: Validate integrity passes
   - test_suppqual_orphan_detection: Create a SUPPQUAL df with an IDVARVAL that does not exist in parent, verify validation catches it
   - test_suppqual_duplicate_qnam_detection: Create SUPPQUAL with duplicate QNAM for same (USUBJID, IDVARVAL), verify validation catches it
  </action>
  <verify>
Run `pytest tests/integration/execution/test_suppqual_generation.py -v` -- all tests pass.
  </verify>
  <done>
SUPPLB and SUPPEG integration tests verify correct generation from parent domains. Referential integrity validation catches orphans and duplicate QNAMs. Null source values correctly skipped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Findings domain XPT output tests</name>
  <files>
    tests/integration/execution/test_findings_xpt_output.py
  </files>
  <action>
Create `tests/integration/execution/test_findings_xpt_output.py` following the pattern from `test_xpt_output.py`:

1. Create fixtures for LB, EG, PE SDTM DataFrames (minimal but valid):
   - LB: 6 rows with STUDYID, DOMAIN, USUBJID, LBSEQ, LBTESTCD, LBTEST, LBORRES, LBORRESU, LBSTRESC, LBSTRESN, LBSTRESU, LBNRIND, LBDTC
   - EG: 4 rows with STUDYID, DOMAIN, USUBJID, EGSEQ, EGTESTCD, EGTEST, EGORRES, EGORRESU, EGSTRESC, EGSTRESN, EGDTC, EGTPT
   - PE: 3 rows with STUDYID, DOMAIN, USUBJID, PESEQ, PETESTCD, PETEST, PEORRES, PEDTC
   - SUPPLB: 4 rows with STUDYID, RDOMAIN, USUBJID, IDVAR, IDVARVAL, QNAM, QLABEL, QVAL, QORIG, QEVAL

2. Tests (use tmp_path for temporary XPT files):
   - test_lb_xpt_roundtrip: Write LB DataFrame to XPT, read back with pyreadstat, verify all columns and row count match
   - test_eg_xpt_roundtrip: Same for EG
   - test_pe_xpt_roundtrip: Same for PE
   - test_supplb_xpt_roundtrip: Same for SUPPLB
   - test_lb_xpt_variable_labels: Verify column labels survive roundtrip (LBTESTCD -> "Lab Test or Examination Short Name")
   - test_xpt_variable_name_length: Verify all variable names are <= 8 chars (important for Findings where names like LBSTRESN are exactly 8)
   - test_cross_domain_findings_usubjid: Create DM + LB + EG + PE DataFrames, run DatasetExecutor.validate_cross_domain_usubjid, verify all USUBJIDs consistent
  </action>
  <verify>
Run `pytest tests/integration/execution/test_findings_xpt_output.py -v` -- all tests pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
XPT roundtrip tests pass for LB, EG, PE, and SUPPLB. Variable labels survive write-read. Cross-domain USUBJID validation covers all Findings domains. Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/integration/execution/test_suppqual_generation.py tests/integration/execution/test_findings_xpt_output.py -v` -- all pass
- `pytest tests/ -x -q` -- full suite (1100+ tests) still passes
- SUPPQUAL referential integrity validated for both SUPPLB and SUPPEG
- XPT roundtrip successful for all Findings domains
</verification>

<success_criteria>
1. SUPPLB and SUPPEG generated correctly from parent domains with null handling
2. Referential integrity validation catches orphan and duplicate issues
3. All Findings domain XPT files survive write-read roundtrip
4. Cross-domain USUBJID validation covers LB, EG, PE
5. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-04-SUMMARY.md`
</output>
