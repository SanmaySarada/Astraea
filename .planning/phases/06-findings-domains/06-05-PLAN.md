---
phase: 06-findings-domains
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - tests/integration/mapping/test_lb_mapping.py
  - tests/integration/mapping/test_eg_mapping.py
  - tests/integration/mapping/test_pe_mapping.py
  - tests/integration/mapping/test_vs_mapping.py
autonomous: false

must_haves:
  truths:
    - "LLM correctly proposes LB variable mappings from lab_results.sas7bdat with SDTM-structured columns"
    - "LLM correctly proposes EG variable mappings from ecg_results.sas7bdat"
    - "LLM correctly proposes PE variable mappings from pe.sas7bdat minimal data"
    - "VS LLM mapping test exists with synthetic profile data (no raw VS data in Fakedata)"
    - "All mapping specs include correct domain_class='findings' and appropriate mapping patterns"
    - "CT codelists C71148 (position), C66789 (specimen condition), C66785 (laterality) are referenced in VS and EG mapping specs"
  artifacts:
    - path: "tests/integration/mapping/test_lb_mapping.py"
      provides: "LLM-based LB mapping tests against real Fakedata"
    - path: "tests/integration/mapping/test_eg_mapping.py"
      provides: "LLM-based EG mapping tests against real Fakedata with CT codelist verification"
    - path: "tests/integration/mapping/test_pe_mapping.py"
      provides: "LLM-based PE mapping tests against real Fakedata"
    - path: "tests/integration/mapping/test_vs_mapping.py"
      provides: "LLM-based VS mapping tests using synthetic profile data with CT codelist verification"
  key_links:
    - from: "tests/integration/mapping/"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.generate_mapping_spec()"
      pattern: "generate_mapping_spec"
---

<objective>
Run LLM-based mapping specification generation against real Fakedata for all Findings domains (LB, EG, PE) and synthetic data for VS -- proving the mapping engine handles Findings-class domains correctly, including CT codelist references.

Purpose: Validates that the LLM produces sensible mapping proposals for Findings domains, including correct pattern detection (DIRECT for pre-SDTM-structured data vs. TRANSPOSE for wide data), domain_class assignment, Findings-specific variables (--TESTCD, --TEST, --ORRES, --ORRESU, --STRESC, --STRESN, --NRIND), and CT codelist references for position (C71148), specimen condition (C66789), and laterality (C66785).

Output: LLM mapping integration tests for LB, EG, PE using real Fakedata + VS using synthetic profile (requires ANTHROPIC_API_KEY).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@tests/integration/mapping/test_ae_mapping.py
@src/astraea/mapping/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: LB, EG, and VS LLM mapping tests with CT codelist verification</name>
  <files>
    tests/integration/mapping/test_lb_mapping.py
    tests/integration/mapping/test_eg_mapping.py
    tests/integration/mapping/test_vs_mapping.py
  </files>
  <action>
Create `tests/integration/mapping/test_lb_mapping.py` following Phase 5 mapping test pattern:

1. Mark all tests with `@pytest.mark.skipif(not os.environ.get("ANTHROPIC_API_KEY"), reason="Requires ANTHROPIC_API_KEY")`
2. Create fixtures that load real lab_results.sas7bdat via pyreadstat and profile it
3. Use MappingEngine.generate_mapping_spec() with domain="LB", primary source=lab_results
4. Tests:
   - test_lb_mapping_generates_spec: Verify DomainMappingSpec returned with domain="LB"
   - test_lb_mapping_has_testcd: Verify LBTESTCD mapping exists with DIRECT pattern (source already has it)
   - test_lb_mapping_has_test: Verify LBTEST mapping exists
   - test_lb_mapping_has_orres: Verify LBORRES mapping exists
   - test_lb_mapping_has_orresu: Verify LBORRESU mapping exists
   - test_lb_mapping_has_stresc_stresn: Verify LBSTRESC and LBSTRESN mappings exist
   - test_lb_mapping_has_nrind: Verify LBNRIND mapping exists (normal range indicator)
   - test_lb_mapping_required_vars: Verify all REQ variables present (STUDYID, DOMAIN, USUBJID, LBSEQ, LBTESTCD, LBTEST, LBORRES)
   - test_lb_mapping_domain_class: Verify domain_class is "findings" (case-insensitive)
   - test_lb_mapping_confidence: Verify average confidence >= 0.6
   - test_lb_mapping_specimen_codelist: Verify LBSPEC mapping references CT codelist C66789 (specimen condition) if codelist info is present in the spec

Create `tests/integration/mapping/test_eg_mapping.py`:
1. Same pattern, load ecg_results.sas7bdat
2. Tests:
   - test_eg_mapping_generates_spec: Verify domain="EG"
   - test_eg_mapping_has_testcd: Verify EGTESTCD
   - test_eg_mapping_has_orres: Verify EGORRES
   - test_eg_mapping_has_tpt: Verify EGTPT (time point reference)
   - test_eg_mapping_required_vars: STUDYID, DOMAIN, USUBJID, EGSEQ, EGTESTCD, EGTEST, EGORRES
   - test_eg_mapping_domain_class: Verify "findings"
   - test_eg_mapping_confidence: Average >= 0.6
   - **test_eg_mapping_position_codelist: If EGPOS mapping exists, verify it references CT codelist C71148 (position). Assert codelist ID is present in mapping metadata.**

Create `tests/integration/mapping/test_vs_mapping.py` (uses synthetic profile since no VS raw data exists):
1. Mark all tests with `@pytest.mark.skipif(not os.environ.get("ANTHROPIC_API_KEY"), reason="Requires ANTHROPIC_API_KEY")`
2. Create a synthetic RawDatasetProfile for VS-like data: variable names VSTESTCD, VSTEST, VSORRES, VSORRESU, VSPOS, VSDTC, etc. with sample values (SYSBP, DIABP, PULSE, WEIGHT)
3. Use MappingEngine.generate_mapping_spec() with domain="VS", the synthetic profile
4. Tests:
   - test_vs_mapping_generates_spec: Verify DomainMappingSpec returned with domain="VS"
   - test_vs_mapping_has_testcd: Verify VSTESTCD mapping exists
   - test_vs_mapping_has_orres: Verify VSORRES mapping exists
   - test_vs_mapping_required_vars: STUDYID, DOMAIN, USUBJID, VSSEQ, VSTESTCD, VSTEST, VSORRES
   - test_vs_mapping_domain_class: Verify "findings"
   - **test_vs_mapping_position_codelist: Verify VSPOS mapping references CT codelist C71148 (position). This is a key CT validation for VS domain.**
   - **test_vs_mapping_laterality_codelist: If VSLAT mapping exists, verify it references CT codelist C66785 (laterality).**
   - test_vs_mapping_confidence: Average >= 0.5 (lower threshold since synthetic profile)
   - test_vs_no_fakedata_note: Docstring note that VS uses synthetic profile because no vs.sas7bdat exists
  </action>
  <verify>
If ANTHROPIC_API_KEY is set: `pytest tests/integration/mapping/test_lb_mapping.py tests/integration/mapping/test_eg_mapping.py tests/integration/mapping/test_vs_mapping.py -v`
Otherwise: tests skip gracefully
  </verify>
  <done>
LB, EG, and VS LLM mapping tests created. EG tests verify position CT C71148 reference. VS tests verify position C71148 and laterality C66785 codelist references. LB tests verify specimen condition C66789. Tests skip gracefully without API key.
  </done>
</task>

<task type="auto">
  <name>Task 2: PE LLM mapping test + UAT checkpoint</name>
  <files>
    tests/integration/mapping/test_pe_mapping.py
  </files>
  <action>
Create `tests/integration/mapping/test_pe_mapping.py`:
1. Same pattern, load pe.sas7bdat (only 11 rows, very minimal)
2. Tests:
   - test_pe_mapping_generates_spec: Verify domain="PE"
   - test_pe_mapping_has_peorres: Verify PEORRES mapping exists
   - test_pe_mapping_has_pedtc: Verify PEDTC mapping exists
   - test_pe_mapping_required_vars: STUDYID, DOMAIN, USUBJID, PESEQ
   - test_pe_mapping_domain_class: Verify "findings"
   - test_pe_mapping_confidence: Average >= 0.5 (lower threshold since PE data is very sparse)
  </action>
  <verify>
If ANTHROPIC_API_KEY is set: `pytest tests/integration/mapping/test_pe_mapping.py -v`
Run `pytest tests/ -x -q` -- full suite passes (LLM tests skip without API key).
  </verify>
  <done>
PE LLM mapping tests created. All Findings domain mapping tests complete (LB, EG, PE, VS). Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- All 4 mapping test files created and importable
- With API key: all LLM mapping tests pass for LB, EG, PE, VS
- Without API key: tests skip gracefully
- CT codelist references verified: C71148 (position) in EG/VS, C66789 (specimen) in LB, C66785 (laterality) in VS
- `pytest tests/ -x -q` -- full suite passes
</verification>

<success_criteria>
1. LB mapping spec includes all Findings-class variables (LBTESTCD, LBTEST, LBORRES, LBORRESU, LBSTRESC, LBSTRESN, LBNRIND)
2. EG mapping spec includes EGTPT and position codelist reference (C71148)
3. PE mapping spec handles minimal data correctly
4. VS mapping spec includes position (C71148) and laterality (C66785) codelist references
5. All specs have domain_class = "findings"
6. Tests skip gracefully without ANTHROPIC_API_KEY
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-05-SUMMARY.md`
</output>
