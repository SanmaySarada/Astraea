---
phase: 06-findings-domains
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - tests/integration/mapping/test_lb_mapping.py
  - tests/integration/mapping/test_eg_mapping.py
  - tests/integration/mapping/test_pe_mapping.py
autonomous: false

must_haves:
  truths:
    - "LLM correctly proposes LB variable mappings from lab_results.sas7bdat with SDTM-structured columns"
    - "LLM correctly proposes EG variable mappings from ecg_results.sas7bdat"
    - "LLM correctly proposes PE variable mappings from pe.sas7bdat minimal data"
    - "All mapping specs include correct domain_class='findings' and appropriate mapping patterns"
  artifacts:
    - path: "tests/integration/mapping/test_lb_mapping.py"
      provides: "LLM-based LB mapping tests against real Fakedata"
    - path: "tests/integration/mapping/test_eg_mapping.py"
      provides: "LLM-based EG mapping tests against real Fakedata"
    - path: "tests/integration/mapping/test_pe_mapping.py"
      provides: "LLM-based PE mapping tests against real Fakedata"
  key_links:
    - from: "tests/integration/mapping/"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.generate_mapping_spec()"
      pattern: "generate_mapping_spec"
---

<objective>
Run LLM-based mapping specification generation against real Fakedata for all Findings domains (LB, EG, PE) -- proving the mapping engine handles Findings-class domains correctly.

Purpose: Validates that the LLM produces sensible mapping proposals for Findings domains, including correct pattern detection (DIRECT for pre-SDTM-structured data vs. TRANSPOSE for wide data), domain_class assignment, and Findings-specific variables (--TESTCD, --TEST, --ORRES, --ORRESU, --STRESC, --STRESN, --NRIND).

Output: LLM mapping integration tests for LB, EG, PE using real Fakedata (requires ANTHROPIC_API_KEY).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@tests/integration/mapping/test_ae_mapping.py
@src/astraea/mapping/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: LB and EG LLM mapping tests</name>
  <files>
    tests/integration/mapping/test_lb_mapping.py
    tests/integration/mapping/test_eg_mapping.py
  </files>
  <action>
Create `tests/integration/mapping/test_lb_mapping.py` following Phase 5 mapping test pattern:

1. Mark all tests with `@pytest.mark.skipif(not os.environ.get("ANTHROPIC_API_KEY"), reason="Requires ANTHROPIC_API_KEY")`
2. Create fixtures that load real lab_results.sas7bdat via pyreadstat and profile it
3. Use MappingEngine.generate_mapping_spec() with domain="LB", primary source=lab_results
4. Tests:
   - test_lb_mapping_generates_spec: Verify DomainMappingSpec returned with domain="LB"
   - test_lb_mapping_has_testcd: Verify LBTESTCD mapping exists with DIRECT pattern (source already has it)
   - test_lb_mapping_has_test: Verify LBTEST mapping exists
   - test_lb_mapping_has_orres: Verify LBORRES mapping exists
   - test_lb_mapping_has_orresu: Verify LBORRESU mapping exists
   - test_lb_mapping_has_stresc_stresn: Verify LBSTRESC and LBSTRESN mappings exist
   - test_lb_mapping_has_nrind: Verify LBNRIND mapping exists (normal range indicator)
   - test_lb_mapping_required_vars: Verify all REQ variables present (STUDYID, DOMAIN, USUBJID, LBSEQ, LBTESTCD, LBTEST, LBORRES)
   - test_lb_mapping_domain_class: Verify domain_class is "findings" (case-insensitive)
   - test_lb_mapping_confidence: Verify average confidence >= 0.6

Create `tests/integration/mapping/test_eg_mapping.py`:
1. Same pattern, load ecg_results.sas7bdat
2. Tests:
   - test_eg_mapping_generates_spec: Verify domain="EG"
   - test_eg_mapping_has_testcd: Verify EGTESTCD
   - test_eg_mapping_has_orres: Verify EGORRES
   - test_eg_mapping_has_tpt: Verify EGTPT (time point reference)
   - test_eg_mapping_required_vars: STUDYID, DOMAIN, USUBJID, EGSEQ, EGTESTCD, EGTEST, EGORRES
   - test_eg_mapping_domain_class: Verify "findings"
   - test_eg_mapping_confidence: Average >= 0.6
  </action>
  <verify>
If ANTHROPIC_API_KEY is set: `pytest tests/integration/mapping/test_lb_mapping.py tests/integration/mapping/test_eg_mapping.py -v`
Otherwise: `pytest tests/integration/mapping/test_lb_mapping.py tests/integration/mapping/test_eg_mapping.py -v` (tests skip gracefully)
  </verify>
  <done>
LB and EG LLM mapping tests created. When run with API key, they verify the mapping engine produces correct Findings-class specs with all required variables. Tests skip gracefully without API key.
  </done>
</task>

<task type="auto">
  <name>Task 2: PE LLM mapping test + UAT checkpoint</name>
  <files>
    tests/integration/mapping/test_pe_mapping.py
  </files>
  <action>
Create `tests/integration/mapping/test_pe_mapping.py`:
1. Same pattern, load pe.sas7bdat (only 11 rows, very minimal)
2. Tests:
   - test_pe_mapping_generates_spec: Verify domain="PE"
   - test_pe_mapping_has_peorres: Verify PEORRES mapping exists
   - test_pe_mapping_has_pedtc: Verify PEDTC mapping exists
   - test_pe_mapping_required_vars: STUDYID, DOMAIN, USUBJID, PESEQ
   - test_pe_mapping_domain_class: Verify "findings"
   - test_pe_mapping_confidence: Average >= 0.5 (lower threshold since PE data is very sparse)
  </action>
  <verify>
If ANTHROPIC_API_KEY is set: `pytest tests/integration/mapping/test_pe_mapping.py -v`
Run `pytest tests/ -x -q` -- full suite passes (LLM tests skip without API key).
  </verify>
  <done>
PE LLM mapping tests created. All Findings domain mapping tests complete (LB, EG, PE). Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- All 3 mapping test files created and importable
- With API key: all LLM mapping tests pass for LB, EG, PE
- Without API key: tests skip gracefully
- `pytest tests/ -x -q` -- full suite passes
</verification>

<success_criteria>
1. LB mapping spec includes all Findings-class variables (LBTESTCD, LBTEST, LBORRES, LBORRESU, LBSTRESC, LBSTRESN, LBNRIND)
2. EG mapping spec includes EGTPT for time point handling
3. PE mapping spec handles minimal data correctly
4. All specs have domain_class = "findings"
5. Tests skip gracefully without ANTHROPIC_API_KEY
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-05-SUMMARY.md`
</output>
