---
phase: 06-findings-domains
plan: 06
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - src/astraea/execution/subject_visits.py
  - tests/unit/execution/test_subject_visits.py
  - tests/integration/execution/test_ts_integration.py
autonomous: true

must_haves:
  truths:
    - "SV domain derived from visit-level metadata (InstanceName/FolderName) across all raw EDC files"
    - "TS domain integrates with DM domain for study start/end dates"
    - "All trial design and special purpose domains have clear generation paths"
  artifacts:
    - path: "src/astraea/execution/subject_visits.py"
      provides: "SV domain builder from EDC visit metadata"
      exports: ["build_sv_domain", "extract_visit_dates"]
    - path: "tests/unit/execution/test_subject_visits.py"
      provides: "SV domain builder unit tests"
    - path: "tests/integration/execution/test_ts_integration.py"
      provides: "TS domain integration with DM data"
  key_links:
    - from: "src/astraea/execution/subject_visits.py"
      to: "src/astraea/execution/executor.py"
      via: "Uses CrossDomainContext for visit mapping"
      pattern: "CrossDomainContext|visit_mapping"
    - from: "tests/integration/execution/test_ts_integration.py"
      to: "src/astraea/execution/trial_summary.py"
      via: "Tests build_ts_domain with DM DataFrame"
      pattern: "build_ts_domain|validate_ts_completeness"
---

<objective>
Build the SV (Subject Visits) domain builder and TS domain integration test -- completing the special-purpose domains needed for Phase 6.

Purpose: SV tracks every subject's actual visit dates, derived from EDC metadata present in all raw files. TS integration with DM provides study start/end dates. Together with the TS builder from Plan 03, these complete the mandatory special-purpose domains.

Output: SV domain builder, SV unit tests, TS integration test with DM data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/trial_summary.py
@src/astraea/execution/executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: SV domain builder from EDC visit metadata</name>
  <files>
    src/astraea/execution/subject_visits.py
    tests/unit/execution/test_subject_visits.py
  </files>
  <action>
Create `src/astraea/execution/subject_visits.py` with:

1. **extract_visit_dates(raw_dfs: dict[str, pd.DataFrame], date_cols: list[str] | None = None) -> pd.DataFrame**:
   - Scans all raw DataFrames for visit-level metadata columns: InstanceName, FolderName, FolderSeq
   - For each raw DataFrame that has these columns + a subject identifier (Subject or USUBJID):
     - Extract unique (Subject, InstanceName, FolderName, FolderSeq) tuples
     - Find the earliest date in any date-like column (columns ending in "DAT" or "DTC") per subject+visit
     - Find the latest date per subject+visit
   - Returns DataFrame with: subject_id, visit_name, visit_folder, visit_seq, earliest_date, latest_date

2. **build_sv_domain(visit_data: pd.DataFrame, study_id: str, *, site_col: str = "SiteNumber", usubjid_lookup: dict[str, str] | None = None) -> pd.DataFrame**:
   - Takes the output of extract_visit_dates
   - Produces SV domain DataFrame with: STUDYID, DOMAIN="SV", USUBJID, VISITNUM (from visit_seq), VISIT (from visit_name), SVSTDTC (earliest_date as ISO 8601), SVENDTC (latest_date as ISO 8601), SVUPDES (unplanned visit description, empty for planned)
   - SVSEQ = row number per subject
   - Sorts by STUDYID, USUBJID, VISITNUM
   - If usubjid_lookup provided, maps subject_id -> USUBJID; otherwise constructs from study_id + subject_id

Create `tests/unit/execution/test_subject_visits.py`:
- test_extract_visit_dates_basic: 2 subjects, 3 visits each, verify 6 rows extracted
- test_extract_visit_dates_multi_source: Data from 2 different raw files, visits merged correctly
- test_extract_visit_dates_no_visit_cols: DataFrame without InstanceName -> empty result
- test_build_sv_basic: Build SV from extracted visit data, verify all required columns
- test_build_sv_visitnum: Verify VISITNUM from FolderSeq
- test_build_sv_dates: Verify SVSTDTC = earliest, SVENDTC = latest
- test_build_sv_seq: Verify SVSEQ monotonic per subject
- test_build_sv_sort_order: Verify sorted by STUDYID, USUBJID, VISITNUM
  </action>
  <verify>
Run `pytest tests/unit/execution/test_subject_visits.py -v` -- all tests pass.
Run `ruff check src/astraea/execution/subject_visits.py` -- no lint errors.
  </verify>
  <done>
SV domain builder extracts visit-level metadata from EDC files and produces valid SV DataFrames with SVSTDTC/SVENDTC date ranges, VISITNUM sequencing, and proper sort order.
  </done>
</task>

<task type="auto">
  <name>Task 2: TS domain integration test with DM data</name>
  <files>
    tests/integration/execution/test_ts_integration.py
  </files>
  <action>
Create `tests/integration/execution/test_ts_integration.py`:

1. Create a realistic DM DataFrame fixture:
   - 5 subjects with STUDYID, DOMAIN="DM", USUBJID, RFSTDTC (various ISO dates), RFENDTC (some null, some populated)

2. Create a TSConfig fixture with study-specific values:
   - study_id="PHA022121-C301"
   - study_title="A Phase 3 Study of C1-INH in HAE"
   - sponsor="Test Pharma"
   - indication="Hereditary Angioedema"
   - treatment="C1-INH (Human)"
   - pharmacological_class="Complement Inhibitor"
   - trial_phase="PHASE III TRIAL"
   - planned_enrollment=120
   - number_of_arms=3

3. Tests:
   - test_ts_with_dm_derives_sstdtc: Build TS with DM, verify SSTDTC = min(RFSTDTC)
   - test_ts_with_dm_derives_sendtc: Verify SENDTC = max(RFENDTC)
   - test_ts_all_mandatory_present: Run validate_ts_completeness, verify 0 errors
   - test_ts_without_dm: Build TS without DM, verify SSTDTC/SENDTC not present
   - test_ts_xpt_roundtrip: Write TS to XPT, read back, verify all parameters survive
   - test_ts_row_count: Verify at least 10 rows (8 required + SSTDTC + SENDTC + optional params)
   - test_ts_studyid_consistent: Verify STUDYID same for all rows
   - test_ts_tsseq_unique: Verify TSSEQ values are unique integers
  </action>
  <verify>
Run `pytest tests/integration/execution/test_ts_integration.py -v` -- all tests pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
TS integration tests verify DM-derived study dates, all mandatory parameters present, XPT roundtrip, and parameter completeness. Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/unit/execution/test_subject_visits.py tests/integration/execution/test_ts_integration.py -v` -- all pass
- `ruff check src/astraea/execution/subject_visits.py` -- clean
- `pytest tests/ -x -q` -- full suite (1100+ tests) still passes
- SV domain correctly derived from EDC visit metadata
- TS domain integrates with DM for study dates
</verification>

<success_criteria>
1. SV domain builder extracts visits from EDC metadata across multiple raw files
2. SVSTDTC/SVENDTC correctly represent earliest/latest dates per visit
3. TS domain derives SSTDTC/SENDTC from DM.RFSTDTC/RFENDTC
4. TS validation confirms all FDA-mandatory parameters present
5. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-06-SUMMARY.md`
</output>
