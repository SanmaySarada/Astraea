---
phase: 06-findings-domains
plan: 06
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - src/astraea/execution/subject_visits.py
  - src/astraea/execution/trial_design.py
  - src/astraea/models/trial_design.py
  - src/astraea/models/relrec.py
  - src/astraea/execution/relrec.py
  - tests/unit/execution/test_subject_visits.py
  - tests/unit/execution/test_trial_design.py
  - tests/unit/execution/test_relrec.py
  - tests/integration/execution/test_ts_integration.py
autonomous: true

must_haves:
  truths:
    - "SV domain derived from visit-level metadata (InstanceName/FolderName) across all raw EDC files"
    - "TS domain integrates with DM domain for study start/end dates"
    - "Trial design domains (TA, TE, TV, TI) have config-driven builders producing valid SDTM DataFrames"
    - "RELREC model and stub generator exist with explicit deferral note for full implementation"
    - "All trial design and special purpose domains have clear generation paths"
  artifacts:
    - path: "src/astraea/execution/subject_visits.py"
      provides: "SV domain builder from EDC visit metadata"
      exports: ["build_sv_domain", "extract_visit_dates"]
    - path: "src/astraea/execution/trial_design.py"
      provides: "Config-driven builders for TA, TE, TV, TI domains"
      exports: ["build_ta_domain", "build_te_domain", "build_tv_domain", "build_ti_domain", "TrialDesignConfig"]
    - path: "src/astraea/models/relrec.py"
      provides: "Pydantic model for RELREC relationship records"
      exports: ["RelRecRecord", "RelRecConfig"]
    - path: "src/astraea/execution/relrec.py"
      provides: "Stub RELREC generator with deferral documentation"
      exports: ["generate_relrec_stub"]
    - path: "tests/unit/execution/test_subject_visits.py"
      provides: "SV domain builder unit tests"
    - path: "tests/unit/execution/test_trial_design.py"
      provides: "Trial design domain builder unit tests (TA, TE, TV, TI)"
    - path: "tests/unit/execution/test_relrec.py"
      provides: "RELREC model and stub generator tests"
    - path: "tests/integration/execution/test_ts_integration.py"
      provides: "TS domain integration with DM data"
  key_links:
    - from: "src/astraea/execution/subject_visits.py"
      to: "src/astraea/execution/executor.py"
      via: "Uses CrossDomainContext for visit mapping"
      pattern: "CrossDomainContext|visit_mapping"
    - from: "tests/integration/execution/test_ts_integration.py"
      to: "src/astraea/execution/trial_summary.py"
      via: "Tests build_ts_domain with DM DataFrame"
      pattern: "build_ts_domain|validate_ts_completeness"
    - from: "src/astraea/execution/trial_design.py"
      to: "src/astraea/models/trial_design.py"
      via: "Uses TrialDesignConfig for arm/element/visit definitions"
      pattern: "TrialDesignConfig"
---

<objective>
Build the SV (Subject Visits) domain builder, config-driven trial design domain builders (TA, TE, TV, TI), RELREC model + stub generator, and TS domain integration test -- completing all special-purpose and trial design domains needed for Phase 6.

Purpose: SV tracks every subject's actual visit dates, derived from EDC metadata present in all raw files. Trial design domains (TA, TE, TV, TI) describe the study structure and are required for submission completeness. RELREC is complex and no raw data drives it -- a minimal model and stub are provided with explicit deferral of full implementation to a later phase (per PITFALLS.md recommendation). TS integration with DM provides study start/end dates.

Output: SV domain builder, trial design domain builders (TA, TE, TV, TI), RELREC model + stub, SV unit tests, trial design unit tests, RELREC tests, TS integration test with DM data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/trial_summary.py
@src/astraea/execution/executor.py
@src/astraea/models/trial_design.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: SV domain builder, trial design builders (TA/TE/TV/TI), and RELREC model + stub</name>
  <files>
    src/astraea/execution/subject_visits.py
    src/astraea/execution/trial_design.py
    src/astraea/models/trial_design.py
    src/astraea/models/relrec.py
    src/astraea/execution/relrec.py
    tests/unit/execution/test_subject_visits.py
    tests/unit/execution/test_trial_design.py
    tests/unit/execution/test_relrec.py
  </files>
  <action>
**SV Domain Builder** -- Create `src/astraea/execution/subject_visits.py` with:

1. **extract_visit_dates(raw_dfs: dict[str, pd.DataFrame], date_cols: list[str] | None = None) -> pd.DataFrame**:
   - Scans all raw DataFrames for visit-level metadata columns: InstanceName, FolderName, FolderSeq
   - For each raw DataFrame that has these columns + a subject identifier (Subject or USUBJID):
     - Extract unique (Subject, InstanceName, FolderName, FolderSeq) tuples
     - Find the earliest date in any date-like column (columns ending in "DAT" or "DTC") per subject+visit
     - Find the latest date per subject+visit
   - Returns DataFrame with: subject_id, visit_name, visit_folder, visit_seq, earliest_date, latest_date

2. **build_sv_domain(visit_data: pd.DataFrame, study_id: str, *, site_col: str = "SiteNumber", usubjid_lookup: dict[str, str] | None = None) -> pd.DataFrame**:
   - Takes the output of extract_visit_dates
   - Produces SV domain DataFrame with: STUDYID, DOMAIN="SV", USUBJID, VISITNUM (from visit_seq), VISIT (from visit_name), SVSTDTC (earliest_date as ISO 8601), SVENDTC (latest_date as ISO 8601), SVUPDES (unplanned visit description, empty for planned)
   - SVSEQ = row number per subject
   - Sorts by STUDYID, USUBJID, VISITNUM
   - If usubjid_lookup provided, maps subject_id -> USUBJID; otherwise constructs from study_id + subject_id

Create `tests/unit/execution/test_subject_visits.py`:
- test_extract_visit_dates_basic: 2 subjects, 3 visits each, verify 6 rows extracted
- test_extract_visit_dates_multi_source: Data from 2 different raw files, visits merged correctly
- test_extract_visit_dates_no_visit_cols: DataFrame without InstanceName -> empty result
- test_build_sv_basic: Build SV from extracted visit data, verify all required columns
- test_build_sv_visitnum: Verify VISITNUM from FolderSeq
- test_build_sv_dates: Verify SVSTDTC = earliest, SVENDTC = latest
- test_build_sv_seq: Verify SVSEQ monotonic per subject
- test_build_sv_sort_order: Verify sorted by STUDYID, USUBJID, VISITNUM

**Trial Design Domain Builders** -- Update `src/astraea/models/trial_design.py` to add:

3. **TrialDesignConfig** Pydantic model:
   - `arms: list[ArmDef]` -- arm definitions (ARMCD, ARM, TAETORD)
   - `elements: list[ElementDef]` -- element definitions (ETCD, ELEMENT, TESTRL, TEENRL)
   - `visits: list[VisitDef]` -- visit definitions (VISITNUM, VISIT, VISITDY, ARMCD)
   - `inclusion_exclusion: list[IEDef] | None = None` -- I/E criteria (IETESTCD, IETEST, IECAT)

4. **ArmDef**, **ElementDef**, **VisitDef**, **IEDef** Pydantic sub-models with appropriate fields

Create `src/astraea/execution/trial_design.py` with:

5. **build_ta_domain(config: TrialDesignConfig, study_id: str) -> pd.DataFrame**:
   - Produces TA (Trial Arms) domain: STUDYID, DOMAIN="TA", ARMCD, ARM, TAETORD, ETCD, ELEMENT, TABESSION, EPOCH
   - One row per element per arm
   - TABESSION = sequence number per arm

6. **build_te_domain(config: TrialDesignConfig, study_id: str) -> pd.DataFrame**:
   - Produces TE (Trial Elements): STUDYID, DOMAIN="TE", ETCD, ELEMENT, TESTRL, TEENRL, TEDUR
   - One row per element

7. **build_tv_domain(config: TrialDesignConfig, study_id: str) -> pd.DataFrame**:
   - Produces TV (Trial Visits): STUDYID, DOMAIN="TV", VISITNUM, VISIT, VISITDY, ARMCD, TVSTRL, TVENRL
   - One row per visit per arm

8. **build_ti_domain(config: TrialDesignConfig, study_id: str) -> pd.DataFrame**:
   - Produces TI (Trial Inclusion/Exclusion): STUDYID, DOMAIN="TI", IETESTCD, IETEST, IECAT, TIRL
   - One row per I/E criterion. If config.inclusion_exclusion is None, returns empty DataFrame with correct columns.
   - NOTE: TI may overlap with IE domain from Phase 5. TI is the trial-level template, IE is subject-level data.

Create `tests/unit/execution/test_trial_design.py`:
- test_ta_basic: Build TA with 2 arms, 3 elements each, verify 6 rows, correct columns
- test_ta_columns: Verify STUDYID, DOMAIN="TA", ARMCD, ARM, TAETORD, ETCD, ELEMENT present
- test_te_basic: Build TE with 3 elements, verify 3 rows, correct columns
- test_tv_basic: Build TV with 5 visits, 2 arms, verify 10 rows
- test_tv_visitnum: Verify VISITNUM populated correctly
- test_ti_basic: Build TI with 5 criteria, verify 5 rows
- test_ti_empty: Build TI with no criteria -> empty DataFrame with correct columns
- test_trial_design_config_validation: Verify TrialDesignConfig accepts valid data and rejects invalid

**RELREC Model + Stub** -- Create `src/astraea/models/relrec.py` with:

9. **RelRecRecord** Pydantic model:
   - `studyid: str`
   - `rdomain: str` -- related domain
   - `usubjid: str`
   - `idvar: str` -- identifier variable name
   - `idvarval: str` -- identifier value
   - `reltype: str` -- relationship type (ONE, MANY)
   - `relid: str` -- relationship identifier (links paired records)

10. **RelRecConfig** Pydantic model:
    - `relationships: list[RelRecRelationship]` -- defines which domains are related and how
    - Contains docstring: "RELREC full implementation deferred. See PITFALLS.md m2: RELREC is complex, no raw data drives it in Fakedata, and it is rarely needed for initial submissions."

Create `src/astraea/execution/relrec.py` with:

11. **generate_relrec_stub(study_id: str, domains: list[str] | None = None) -> pd.DataFrame**:
    - Returns an empty DataFrame with correct RELREC columns: STUDYID, RDOMAIN, USUBJID, IDVAR, IDVARVAL, RELTYPE, RELID
    - Logs a warning via loguru: "RELREC generation is a stub. Full cross-domain relationship linking is deferred to Phase 7+. See PITFALLS.md m2."
    - If domains provided, validates they are valid SDTM domain codes
    - Does NOT attempt to auto-detect relationships -- that requires significant cross-domain analysis deferred to later phase

Create `tests/unit/execution/test_relrec.py`:
- test_relrec_record_model: Verify RelRecRecord accepts valid data and validates fields
- test_relrec_config_model: Verify RelRecConfig model structure with docstring about deferral
- test_relrec_stub_returns_empty_df: Verify generate_relrec_stub returns empty DataFrame with correct columns
- test_relrec_stub_logs_warning: Verify loguru warning is logged about deferral
- test_relrec_stub_column_names: Verify columns match SDTM RELREC spec exactly
  </action>
  <verify>
Run `pytest tests/unit/execution/test_subject_visits.py tests/unit/execution/test_trial_design.py tests/unit/execution/test_relrec.py -v` -- all tests pass.
Run `ruff check src/astraea/execution/subject_visits.py src/astraea/execution/trial_design.py src/astraea/execution/relrec.py src/astraea/models/relrec.py` -- no lint errors.
  </verify>
  <done>
SV domain builder extracts visit metadata from EDC files. Trial design builders (TA, TE, TV, TI) produce valid SDTM DataFrames from TrialDesignConfig. RELREC model and stub generator exist with explicit deferral documentation. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: TS domain integration test with DM data</name>
  <files>
    tests/integration/execution/test_ts_integration.py
  </files>
  <action>
Create `tests/integration/execution/test_ts_integration.py`:

1. Create a realistic DM DataFrame fixture:
   - 5 subjects with STUDYID, DOMAIN="DM", USUBJID, RFSTDTC (various ISO dates), RFENDTC (some null, some populated)

2. Create a TSConfig fixture with study-specific values:
   - study_id="PHA022121-C301"
   - study_title="A Phase 3 Study of C1-INH in HAE"
   - sponsor="Test Pharma"
   - indication="Hereditary Angioedema"
   - treatment="C1-INH (Human)"
   - pharmacological_class="Complement Inhibitor"
   - trial_phase="PHASE III TRIAL"
   - planned_enrollment=120
   - number_of_arms=3

3. Tests:
   - test_ts_with_dm_derives_sstdtc: Build TS with DM, verify SSTDTC = min(RFSTDTC)
   - test_ts_with_dm_derives_sendtc: Verify SENDTC = max(RFENDTC)
   - test_ts_all_mandatory_present: Run validate_ts_completeness, verify 0 errors
   - test_ts_without_dm: Build TS without DM, verify SSTDTC/SENDTC not present
   - test_ts_xpt_roundtrip: Write TS to XPT, read back, verify all parameters survive
   - test_ts_row_count: Verify at least 10 rows (8 required + SSTDTC + SENDTC + optional params)
   - test_ts_studyid_consistent: Verify STUDYID same for all rows
   - test_ts_tsseq_unique: Verify TSSEQ values are unique integers
  </action>
  <verify>
Run `pytest tests/integration/execution/test_ts_integration.py -v` -- all tests pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
TS integration tests verify DM-derived study dates, all mandatory parameters present, XPT roundtrip, and parameter completeness. Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/unit/execution/test_subject_visits.py tests/unit/execution/test_trial_design.py tests/unit/execution/test_relrec.py tests/integration/execution/test_ts_integration.py -v` -- all pass
- `ruff check src/astraea/execution/subject_visits.py src/astraea/execution/trial_design.py src/astraea/execution/relrec.py src/astraea/models/relrec.py` -- clean
- `pytest tests/ -x -q` -- full suite (1100+ tests) still passes
- SV domain correctly derived from EDC visit metadata
- TS domain integrates with DM for study dates
- Trial design domains (TA, TE, TV, TI) produce valid DataFrames from config
- RELREC stub exists with deferral documentation
</verification>

<success_criteria>
1. SV domain builder extracts visits from EDC metadata across multiple raw files
2. SVSTDTC/SVENDTC correctly represent earliest/latest dates per visit
3. TS domain derives SSTDTC/SENDTC from DM.RFSTDTC/RFENDTC
4. TS validation confirms all FDA-mandatory parameters present
5. Trial design domains (TA, TE, TV, TI) produce valid SDTM DataFrames from TrialDesignConfig
6. RELREC model and stub exist with explicit deferral note (full implementation Phase 7+)
7. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-06-SUMMARY.md`
</output>
