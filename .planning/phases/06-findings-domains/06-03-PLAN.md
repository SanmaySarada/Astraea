---
phase: 06-findings-domains
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/astraea/execution/trial_summary.py
  - src/astraea/models/trial_design.py
  - tests/unit/execution/test_trial_summary.py
  - tests/integration/execution/test_pe_execution.py
autonomous: true

must_haves:
  truths:
    - "TS domain builder produces a valid Trial Summary dataset with all FDA-mandatory parameters"
    - "PE domain execution works with minimal CRF data (performed flag + date only)"
    - "TSConfig model validates all required parameters are provided"
  artifacts:
    - path: "src/astraea/execution/trial_summary.py"
      provides: "Config-driven TS domain builder and TS parameter validation"
      exports: ["TSConfig", "build_ts_domain", "validate_ts_completeness"]
    - path: "src/astraea/models/trial_design.py"
      provides: "Pydantic models for trial design configuration"
      exports: ["TSConfig", "TSParameter"]
    - path: "tests/unit/execution/test_trial_summary.py"
      provides: "TS domain builder unit tests"
    - path: "tests/integration/execution/test_pe_execution.py"
      provides: "PE domain execution tests"
  key_links:
    - from: "src/astraea/execution/trial_summary.py"
      to: "src/astraea/models/trial_design.py"
      via: "Uses TSConfig model for parameter specification"
      pattern: "TSConfig"
---

<objective>
Build the TS (Trial Summary) domain builder and PE domain execution -- two independent but simpler components that round out Phase 6 coverage.

Purpose: TS is mandatory for FDA submission (missing TS = automatic rejection). PE is the simplest Findings domain in this study (minimal data). Both are config/data-driven with no LLM involvement.

Output: TSConfig model, build_ts_domain function, PE execution tests, TS completeness validator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/executor.py
@tests/integration/execution/test_ae_execution.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TS domain builder with TSConfig model</name>
  <files>
    src/astraea/models/trial_design.py
    src/astraea/execution/trial_summary.py
    tests/unit/execution/test_trial_summary.py
  </files>
  <action>
Create `src/astraea/models/trial_design.py` with:

1. **TSParameter** Pydantic model:
   - `tsparmcd: str` -- parameter code (max 8 chars)
   - `tsparm: str` -- parameter name (max 40 chars)
   - `tsval: str` -- parameter value

2. **TSConfig** Pydantic model:
   - `study_id: str` -- STUDYID
   - `study_title: str` -- TITLE
   - `sponsor: str` -- SPONSOR name
   - `indication: str` -- INDIC (disease/condition)
   - `treatment: str` -- TRT (investigational therapy)
   - `pharmacological_class: str` -- PCLAS
   - `study_type: str = "INTERVENTIONAL"` -- STYPE
   - `sdtm_version: str = "3.4"` -- SDTMVER
   - `trial_phase: str = "PHASE III TRIAL"` -- TPHASE
   - `planned_enrollment: int | None = None` -- PLESSION
   - `number_of_arms: int | None = None` -- NARMS
   - `accession_number: str | None = None` -- ACESSION
   - `addon: str | None = None` -- ADDON (Y/N)
   - `additional_params: list[TSParameter] = []` -- extra study-specific parameters

Create `src/astraea/execution/trial_summary.py` with:

1. **build_ts_domain(config: TSConfig, dm_df: pd.DataFrame | None = None) -> pd.DataFrame**:
   - Builds TS domain as key-value DataFrame (one row per parameter)
   - Always includes: TITLE, SPONSOR, INDIC, TRT, PCLAS, STYPE, SDTMVER, TPHASE
   - Conditionally includes: PLESSION (if planned_enrollment set), NARMS (if number_of_arms set), ACESSION, ADDON
   - If dm_df provided and has RFSTDTC: derives SSTDTC (min RFSTDTC) and SENDTC (max RFENDTC if available)
   - Appends any additional_params from config
   - Assigns TSSEQ = row number (1-based)
   - Columns: STUDYID, DOMAIN ("TS"), TSSEQ, TSPARMCD, TSPARM, TSVAL
   - Returns DataFrame

2. **validate_ts_completeness(ts_df: pd.DataFrame) -> list[str]**:
   - Checks that all FDA-mandatory TSPARMCD values are present: SSTDTC, SPONSOR, INDIC, TRT, STYPE, SDTMVER, TPHASE
   - Checks that no TSVAL is empty/null for required parameters
   - Returns list of warning/error messages (empty = valid)

3. **FDA_REQUIRED_PARAMS** frozenset of mandatory TSPARMCD codes

Create `tests/unit/execution/test_trial_summary.py`:
- test_ts_basic_build: Build with minimal TSConfig, verify all 8 required params present
- test_ts_with_dm_dates: Build with DM DataFrame containing RFSTDTC, verify SSTDTC/SENDTC derived
- test_ts_optional_params: Build with planned_enrollment and narms, verify they appear
- test_ts_additional_params: Build with custom TSParameter entries
- test_ts_seq_monotonic: Verify TSSEQ is 1, 2, 3, ...
- test_ts_validate_complete: Validate a complete TS passes
- test_ts_validate_missing_sponsor: Validate catches missing SPONSOR
- test_ts_validate_empty_tsval: Validate catches empty TSVAL
- test_ts_domain_column: Verify DOMAIN = "TS" for all rows
  </action>
  <verify>
Run `pytest tests/unit/execution/test_trial_summary.py -v` -- all tests pass.
Run `ruff check src/astraea/execution/trial_summary.py src/astraea/models/trial_design.py` -- no lint errors.
  </verify>
  <done>
TSConfig model created with all FDA-required and optional parameters. build_ts_domain produces valid TS DataFrames. validate_ts_completeness catches missing mandatory parameters. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: PE domain execution test</name>
  <files>
    tests/integration/execution/test_pe_execution.py
  </files>
  <action>
Create `tests/integration/execution/test_pe_execution.py` following Phase 5 pattern:

1. Create `_mapping()` helper (same pattern as other execution tests)
2. Create `pe_spec` fixture with PE domain mappings:
   - STUDYID (ASSIGN), DOMAIN (ASSIGN "PE"), USUBJID (DERIVATION, generate_usubjid)
   - PESEQ (DERIVATION), PETESTCD (ASSIGN "PEPERF"), PETEST (ASSIGN "Physical Exam Performed")
   - PEORRES (DIRECT from PEPERF), PEORIG (ASSIGN "CRF")
   - PEDTC (REFORMAT from PEDAT, date conversion)
   - PEDY (DERIVATION, study day)
   - domain_class = "findings"

3. Create synthetic PE data: 4 rows, 2 subjects, 2 visits each, PEPERF="Y", PEDAT as datetime
   - Include SiteNumber, Subject columns for USUBJID generation

4. Tests:
   - test_pe_basic_execution: Execute spec, verify 4 rows with correct columns
   - test_pe_seq_generation: Verify PESEQ unique per USUBJID
   - test_pe_domain_assign: Verify DOMAIN = "PE" for all rows
   - test_pe_column_order: Verify columns in spec order
   - test_pe_performed_flag: Verify PEORRES = "Y" from source

NOTE: PE is very simple in this study -- it only records "was PE performed" and the date. There are no body system findings or individual test results. This is intentional based on the Fakedata profile.
  </action>
  <verify>
Run `pytest tests/integration/execution/test_pe_execution.py -v` -- all tests pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
PE domain execution tests pass with synthetic data. PE domain handles the minimal CRF data (performed flag + date only). Full test suite remains green.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/unit/execution/test_trial_summary.py tests/integration/execution/test_pe_execution.py -v` -- all pass
- `ruff check src/astraea/execution/trial_summary.py src/astraea/models/trial_design.py` -- clean
- `pytest tests/ -x -q` -- full suite still passes
- TS domain has all FDA-mandatory parameters
- PE execution produces valid Findings-class output
</verification>

<success_criteria>
1. TSConfig accepts all required + optional trial summary parameters
2. build_ts_domain produces correct TS DataFrame with TSSEQ sequencing
3. validate_ts_completeness catches missing FDA-mandatory parameters
4. PE execution works with minimal data (performed flag + date)
5. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-03-SUMMARY.md`
</output>
