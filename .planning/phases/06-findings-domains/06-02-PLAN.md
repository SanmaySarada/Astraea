---
phase: 06-findings-domains
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/astraea/execution/findings.py
  - tests/integration/execution/test_lb_execution.py
  - tests/integration/execution/test_eg_execution.py
autonomous: true

must_haves:
  truths:
    - "LB domain correctly merges lab_results (primary) with llb (local lab) into a single tall SDTM LB dataset"
    - "EG domain correctly handles ecg_results as primary source with pre/post-dose time points"
    - "Multi-source Findings data produces correct row counts, LBSEQ/EGSEQ, and SDTM column order"
  artifacts:
    - path: "src/astraea/execution/findings.py"
      provides: "FindingsExecutor orchestrator for multi-source Findings domain assembly"
      exports: ["FindingsExecutor", "normalize_lab_columns", "normalize_ecg_columns"]
    - path: "tests/integration/execution/test_lb_execution.py"
      provides: "LB domain execution tests with multi-source merge"
    - path: "tests/integration/execution/test_eg_execution.py"
      provides: "EG domain execution tests with pre/post-dose handling"
  key_links:
    - from: "src/astraea/execution/findings.py"
      to: "src/astraea/execution/executor.py"
      via: "Uses DatasetExecutor for final spec execution"
      pattern: "DatasetExecutor"
    - from: "tests/integration/execution/test_lb_execution.py"
      to: "src/astraea/execution/findings.py"
      via: "Tests FindingsExecutor with synthetic multi-source lab data"
      pattern: "FindingsExecutor|normalize_lab"
---

<objective>
Build the Findings domain execution pipeline for LB and EG domains with multi-source data merging, column normalization, and integration tests using synthetic data.

Purpose: LB is the most complex domain (multiple data sources, 1350+ rows, SDTM-structured central lab data merged with local lab data). EG has pre/post-dose time point handling. Both follow the Findings class pattern established by the research.

Output: FindingsExecutor module, LB and EG execution integration tests with synthetic data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/executor.py
@src/astraea/execution/preprocessing.py
@tests/integration/execution/test_ae_execution.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: FindingsExecutor and column normalization utilities</name>
  <files>
    src/astraea/execution/findings.py
  </files>
  <action>
Create `src/astraea/execution/findings.py` with:

1. **normalize_lab_columns(df: pd.DataFrame, source_name: str) -> pd.DataFrame**:
   - Handles column name normalization for different lab source files
   - For llb.sas7bdat-style data: renames LBTEST2->LBTEST, LBNAM->LBNAM (keep), LBCAT->LBCAT (keep), etc.
   - For lab_results.sas7bdat: columns are already SDTM-named, no changes needed
   - Returns copy with normalized column names
   - Adds LBCAT column if missing (set to "")
   - Ensures LBTESTCD exists: if missing but LBTEST exists, create placeholder LBTESTCD from first 8 chars of LBTEST uppercased

2. **normalize_ecg_columns(df: pd.DataFrame, source_name: str, time_point: str | None = None) -> pd.DataFrame**:
   - For ecg_results.sas7bdat: already SDTM-named, no changes
   - For eg_pre/eg_post/eg3: normalizes EGPERF3->EGPERF, EGDAT3->EGDTC, EGTIM3 (incorporate into EGDTC if date+time), EGRS3->EGORRES (overall interpretation), EGABS3 (abnormality description, SUPPEG candidate), EGCS3 (clinical significance, SUPPEG candidate), EG_TPT_PRE/POST/NA -> EGTPT
   - `time_point` parameter: if provided (e.g., "Pre-dose"), sets EGTPT for all rows in this source
   - Returns copy with normalized column names

3. **merge_findings_sources(dfs: dict[str, pd.DataFrame], domain: str) -> tuple[pd.DataFrame, list[str]]**:
   - Takes multiple source DataFrames (already normalized)
   - Aligns columns across sources (uses align_multi_source_columns from preprocessing.py)
   - Concatenates into single DataFrame
   - Returns (merged_df, list of supplemental_candidate_columns that are NOT standard SDTM)
   - Supplemental candidates: columns that exist in CRF sources but not in the SDTM domain spec (e.g., EGCS3, EGABS3 after normalization)

4. **FindingsExecutor** class:
   - `__init__(self, *, sdtm_ref, ct_ref)` -- wraps DatasetExecutor
   - `execute_lb(self, spec, raw_dfs, cross_domain, study_id, site_col, subject_col) -> tuple[pd.DataFrame, pd.DataFrame | None]`:
     - Normalizes each lab source DataFrame
     - Merges into single source
     - Delegates to DatasetExecutor.execute()
     - Returns (lb_df, supplb_df_or_none)
   - `execute_eg(self, spec, raw_dfs, cross_domain, study_id, site_col, subject_col) -> tuple[pd.DataFrame, pd.DataFrame | None]`:
     - Similar pattern for ECG
     - Returns (eg_df, suppeg_df_or_none)
  </action>
  <verify>
Run `ruff check src/astraea/execution/findings.py` -- no lint errors.
Run `python -c "from astraea.execution.findings import FindingsExecutor, normalize_lab_columns"` -- imports work.
  </verify>
  <done>
FindingsExecutor class created with normalize_lab_columns, normalize_ecg_columns, and merge_findings_sources. Wraps DatasetExecutor for Findings-class domain execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: LB and EG execution integration tests</name>
  <files>
    tests/integration/execution/test_lb_execution.py
    tests/integration/execution/test_eg_execution.py
  </files>
  <action>
Create `tests/integration/execution/test_lb_execution.py` following the Phase 5 pattern (synthetic data, no Fakedata dependency):

1. Create a `_mapping()` helper identical to the AE test pattern
2. Create an `lb_spec` fixture with LB domain mappings:
   - STUDYID (ASSIGN), DOMAIN (ASSIGN "LB"), USUBJID (DERIVATION, generate_usubjid), LBSEQ (DERIVATION), LBTESTCD (DIRECT), LBTEST (DIRECT), LBCAT (DIRECT), LBORRES (DIRECT), LBORRESU (DIRECT), LBSTRESC (DIRECT), LBSTRESN (DIRECT), LBSTRESU (DIRECT), LBSTNRLO (DIRECT), LBSTNRHI (DIRECT), LBNRIND (DIRECT), LBSPEC (DIRECT), LBLOINC (DIRECT if available), LBMETHOD (DIRECT), LBBLFL (DIRECT), LBFAST (DIRECT), LBDTC (DIRECT), LBDY (DERIVATION)
   - domain_class = "findings"
3. Create synthetic lab data simulating two sources:
   - "lab_results": 10 rows with SDTM-like columns (LBTESTCD, LBTEST, LBORRES, LBORRESU, etc.), 3 subjects, chemistry + haem tests (ALT, WBC, HGB)
   - "llb": 3 rows with local lab columns (LBTEST2, LBORRES, LBORRESU, LBORNRLO, LBORNRHI), normalized before merging
4. Tests:
   - test_lb_basic_execution: Execute spec on lab_results only, verify SDTM columns present and row count
   - test_lb_multi_source_merge: Merge lab_results + normalized llb, verify combined row count = 13
   - test_lb_seq_generation: Verify LBSEQ is unique per USUBJID and monotonically increasing
   - test_lb_column_order: Verify columns appear in spec order
   - test_lb_domain_class_findings: Verify domain_class is "findings" in spec
   - test_lb_nrind_passthrough: Verify LBNRIND values from source are preserved
   - test_lb_normalize_llb_columns: Test normalize_lab_columns on llb-style data

Create `tests/integration/execution/test_eg_execution.py`:

1. Create `eg_spec` fixture with EG domain mappings:
   - STUDYID, DOMAIN ("EG"), USUBJID, EGSEQ, EGTESTCD, EGTEST, EGORRES, EGORRESU, EGSTRESC, EGSTRESN, EGSTRESU, EGTPT, EGDTC, EGDY
   - domain_class = "findings"
2. Create synthetic ECG data:
   - "ecg_results": 8 rows with SDTM-like columns, 2 subjects, test codes QTcF/QRS/PR/HR, EGTPT populated
   - "eg_pre": 3 rows with CRF columns (EGPERF3, EGDAT3, EGRS3, EG_TPT_PRE="Pre-dose")
3. Tests:
   - test_eg_basic_execution: Execute on ecg_results only
   - test_eg_pre_dose_normalization: Test normalize_ecg_columns on eg_pre data, verify EGTPT = "Pre-dose"
   - test_eg_seq_generation: Verify EGSEQ monotonic per USUBJID
   - test_eg_column_order: Verify spec order
  </action>
  <verify>
Run `pytest tests/integration/execution/test_lb_execution.py tests/integration/execution/test_eg_execution.py -v` -- all pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
LB execution tests verify multi-source merge (lab_results + llb), LBSEQ generation, column normalization. EG execution tests verify ecg_results handling, pre/post-dose time point normalization. All tests pass including full suite.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/integration/execution/test_lb_execution.py tests/integration/execution/test_eg_execution.py -v` -- all pass
- `ruff check src/astraea/execution/findings.py` -- clean
- `pytest tests/ -x -q` -- full suite (1100+ tests) still passes
- LB multi-source merge produces correct combined row count
- EG pre/post-dose time points correctly normalized
</verification>

<success_criteria>
1. FindingsExecutor handles multi-source lab data merging (lab_results + llb)
2. Column normalization handles both SDTM-structured and CRF-format sources
3. EG time points (Pre-dose, Post-dose) correctly derived from source files
4. All execution tests pass with synthetic data
5. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-02-SUMMARY.md`
</output>
