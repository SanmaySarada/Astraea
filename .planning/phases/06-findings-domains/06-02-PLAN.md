---
phase: 06-findings-domains
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/astraea/execution/findings.py
  - tests/integration/execution/test_lb_execution.py
  - tests/integration/execution/test_eg_execution.py
  - tests/integration/execution/test_vs_execution.py
autonomous: true

must_haves:
  truths:
    - "LB domain correctly merges lab_results (primary) with llb (local lab) into a single tall SDTM LB dataset"
    - "EG domain correctly handles ecg_results as primary source with pre/post-dose time points"
    - "VS domain normalizer and executor exist with synthetic test data, even though no VS raw data exists in Fakedata"
    - "Multi-source Findings data produces correct row counts, LBSEQ/EGSEQ/VSSEQ, and SDTM column order"
    - "CT codelists C71148 (position), C66789 (specimen condition), C66785 (laterality) are verified in EG/VS execution tests"
    - "Date imputation flags (--DTF/--TMF) are generated for partial dates in LB and EG execution"
  artifacts:
    - path: "src/astraea/execution/findings.py"
      provides: "FindingsExecutor orchestrator for multi-source Findings domain assembly"
      exports: ["FindingsExecutor", "normalize_lab_columns", "normalize_ecg_columns", "normalize_vs_columns"]
    - path: "tests/integration/execution/test_lb_execution.py"
      provides: "LB domain execution tests with multi-source merge and date imputation flag assertions"
    - path: "tests/integration/execution/test_eg_execution.py"
      provides: "EG domain execution tests with pre/post-dose handling and CT codelist verification"
    - path: "tests/integration/execution/test_vs_execution.py"
      provides: "VS domain execution tests with synthetic data, position codes, and CT verification"
  key_links:
    - from: "src/astraea/execution/findings.py"
      to: "src/astraea/execution/executor.py"
      via: "Uses DatasetExecutor for final spec execution"
      pattern: "DatasetExecutor"
    - from: "tests/integration/execution/test_lb_execution.py"
      to: "src/astraea/execution/findings.py"
      via: "Tests FindingsExecutor with synthetic multi-source lab data"
      pattern: "FindingsExecutor|normalize_lab"
    - from: "tests/integration/execution/test_vs_execution.py"
      to: "src/astraea/execution/findings.py"
      via: "Tests normalize_vs_columns and execute_vs with synthetic vital signs data"
      pattern: "normalize_vs_columns|execute_vs"
---

<objective>
Build the Findings domain execution pipeline for LB, EG, and VS domains with multi-source data merging, column normalization, CT codelist verification, date imputation flags, and integration tests using synthetic data.

Purpose: LB is the most complex domain (multiple data sources, 1350+ rows, SDTM-structured central lab data merged with local lab data). EG has pre/post-dose time point handling. VS has no raw data in Fakedata but must have a working normalizer and executor with synthetic test data for general-purpose use. All follow the Findings class pattern established by the research.

Output: FindingsExecutor module with LB, EG, and VS normalizers/executors, plus integration tests with CT codelist and date imputation flag assertions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-findings-domains/06-RESEARCH.md
@src/astraea/execution/executor.py
@src/astraea/execution/preprocessing.py
@tests/integration/execution/test_ae_execution.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: FindingsExecutor with LB, EG, and VS column normalization utilities</name>
  <files>
    src/astraea/execution/findings.py
  </files>
  <action>
Create `src/astraea/execution/findings.py` with:

1. **normalize_lab_columns(df: pd.DataFrame, source_name: str) -> pd.DataFrame**:
   - Handles column name normalization for different lab source files
   - For llb.sas7bdat-style data: renames LBTEST2->LBTEST, LBNAM->LBNAM (keep), LBCAT->LBCAT (keep), etc.
   - For lab_results.sas7bdat: columns are already SDTM-named, no changes needed
   - Returns copy with normalized column names
   - Adds LBCAT column if missing (set to "")
   - Ensures LBTESTCD exists: if missing but LBTEST exists, create placeholder LBTESTCD from first 8 chars of LBTEST uppercased

2. **normalize_ecg_columns(df: pd.DataFrame, source_name: str, time_point: str | None = None) -> pd.DataFrame**:
   - For ecg_results.sas7bdat: already SDTM-named, no changes
   - For eg_pre/eg_post/eg3: normalizes EGPERF3->EGPERF, EGDAT3->EGDTC, EGTIM3 (incorporate into EGDTC if date+time), EGRS3->EGORRES (overall interpretation), EGABS3 (abnormality description, SUPPEG candidate), EGCS3 (clinical significance, SUPPEG candidate), EG_TPT_PRE/POST/NA -> EGTPT
   - `time_point` parameter: if provided (e.g., "Pre-dose"), sets EGTPT for all rows in this source
   - Returns copy with normalized column names

3. **normalize_vs_columns(df: pd.DataFrame, source_name: str) -> pd.DataFrame**:
   - Normalizes vital signs source columns to SDTM VS domain names
   - Handles common CRF patterns: maps columns like VSPERF->VSSTAT (performed flag), VSDAT->VSDTC, VSTIM->VSDTC (append time to date), VSPOS->VSPOS (position), VSLOC->VSLOC (location), VSBLFL->VSBLFL (baseline flag)
   - For pre-SDTM-structured data: columns already SDTM-named, no changes
   - Returns copy with normalized column names
   - Ensures VSTESTCD exists: if missing but VSTEST exists, create placeholder from first 8 chars uppercased

4. **merge_findings_sources(dfs: dict[str, pd.DataFrame], domain: str) -> tuple[pd.DataFrame, list[str]]**:
   - Takes multiple source DataFrames (already normalized)
   - Aligns columns across sources (uses align_multi_source_columns from preprocessing.py)
   - Concatenates into single DataFrame
   - Returns (merged_df, list of supplemental_candidate_columns that are NOT standard SDTM)
   - Supplemental candidates: columns that exist in CRF sources but not in the SDTM domain spec (e.g., EGCS3, EGABS3 after normalization)

5. **FindingsExecutor** class:
   - `__init__(self, *, sdtm_ref, ct_ref)` -- wraps DatasetExecutor
   - `execute_lb(self, spec, raw_dfs, cross_domain, study_id, site_col, subject_col) -> tuple[pd.DataFrame, pd.DataFrame | None]`:
     - Normalizes each lab source DataFrame
     - Merges into single source
     - Delegates to DatasetExecutor.execute()
     - Returns (lb_df, supplb_df_or_none)
   - `execute_eg(self, spec, raw_dfs, cross_domain, study_id, site_col, subject_col) -> tuple[pd.DataFrame, pd.DataFrame | None]`:
     - Similar pattern for ECG
     - Returns (eg_df, suppeg_df_or_none)
   - `execute_vs(self, spec, raw_dfs, cross_domain, study_id, site_col, subject_col) -> tuple[pd.DataFrame, pd.DataFrame | None]`:
     - Normalizes VS source DataFrames via normalize_vs_columns
     - Merges if multiple sources
     - Delegates to DatasetExecutor.execute()
     - Returns (vs_df, suppvs_df_or_none)
  </action>
  <verify>
Run `ruff check src/astraea/execution/findings.py` -- no lint errors.
Run `python -c "from astraea.execution.findings import FindingsExecutor, normalize_lab_columns, normalize_vs_columns"` -- imports work.
  </verify>
  <done>
FindingsExecutor class created with normalize_lab_columns, normalize_ecg_columns, normalize_vs_columns, and merge_findings_sources. Wraps DatasetExecutor for Findings-class domain execution including VS.
  </done>
</task>

<task type="auto">
  <name>Task 2: LB, EG, and VS execution integration tests with CT and date imputation assertions</name>
  <files>
    tests/integration/execution/test_lb_execution.py
    tests/integration/execution/test_eg_execution.py
    tests/integration/execution/test_vs_execution.py
  </files>
  <action>
Create `tests/integration/execution/test_lb_execution.py` following the Phase 5 pattern (synthetic data, no Fakedata dependency):

1. Create a `_mapping()` helper identical to the AE test pattern
2. Create an `lb_spec` fixture with LB domain mappings:
   - STUDYID (ASSIGN), DOMAIN (ASSIGN "LB"), USUBJID (DERIVATION, generate_usubjid), LBSEQ (DERIVATION), LBTESTCD (DIRECT), LBTEST (DIRECT), LBCAT (DIRECT), LBORRES (DIRECT), LBORRESU (DIRECT), LBSTRESC (DIRECT), LBSTRESN (DIRECT), LBSTRESU (DIRECT), LBSTNRLO (DIRECT), LBSTNRHI (DIRECT), LBNRIND (DIRECT), LBSPEC (DIRECT), LBLOINC (DIRECT if available), LBMETHOD (DIRECT), LBBLFL (DIRECT), LBFAST (DIRECT), LBDTC (DIRECT), LBDY (DERIVATION), LBDTF (DIRECT, date imputation flag)
   - domain_class = "findings"
3. Create synthetic lab data simulating two sources:
   - "lab_results": 10 rows with SDTM-like columns (LBTESTCD, LBTEST, LBORRES, LBORRESU, etc.), 3 subjects, chemistry + haem tests (ALT, WBC, HGB)
   - "llb": 3 rows with local lab columns (LBTEST2, LBORRES, LBORRESU, LBORNRLO, LBORNRHI), normalized before merging
4. Tests:
   - test_lb_basic_execution: Execute spec on lab_results only, verify SDTM columns present and row count
   - test_lb_multi_source_merge: Merge lab_results + normalized llb, verify combined row count = 13
   - test_lb_seq_generation: Verify LBSEQ is unique per USUBJID and monotonically increasing
   - test_lb_column_order: Verify columns appear in spec order
   - test_lb_domain_class_findings: Verify domain_class is "findings" in spec
   - test_lb_nrind_passthrough: Verify LBNRIND values from source are preserved
   - test_lb_normalize_llb_columns: Test normalize_lab_columns on llb-style data
   - **test_lb_date_imputation_flag: Create synthetic rows with partial dates (e.g., "2022-03" missing day). Verify LBDTF column is present and contains "D" for day-imputed dates, empty/null for complete dates. This tests that --DTF is generated for partial dates.**

Create `tests/integration/execution/test_eg_execution.py`:

1. Create `eg_spec` fixture with EG domain mappings:
   - STUDYID, DOMAIN ("EG"), USUBJID, EGSEQ, EGTESTCD, EGTEST, EGORRES, EGORRESU, EGSTRESC, EGSTRESN, EGSTRESU, EGTPT, EGDTC, EGDY, EGPOS (position, CT C71148)
   - domain_class = "findings"
2. Create synthetic ECG data:
   - "ecg_results": 8 rows with SDTM-like columns, 2 subjects, test codes QTcF/QRS/PR/HR, EGTPT populated
   - "eg_pre": 3 rows with CRF columns (EGPERF3, EGDAT3, EGRS3, EG_TPT_PRE="Pre-dose")
   - Include EGPOS column with values from CT C71148 ("SUPINE", "SITTING", "STANDING")
3. Tests:
   - test_eg_basic_execution: Execute on ecg_results only
   - test_eg_pre_dose_normalization: Test normalize_ecg_columns on eg_pre data, verify EGTPT = "Pre-dose"
   - test_eg_seq_generation: Verify EGSEQ monotonic per USUBJID
   - test_eg_column_order: Verify spec order
   - **test_eg_position_ct_c71148: Verify EGPOS values are valid terms from CT codelist C71148 (SUPINE, SITTING, STANDING). Assert that all non-null EGPOS values are members of the expected controlled terminology.**
   - **test_eg_date_imputation_flag: Create a row with partial EGDTC (e.g., "2022-03"). Verify EGDTF column is present and contains "D" for day-imputed dates.**

Create `tests/integration/execution/test_vs_execution.py` (synthetic data only -- no VS raw data exists in Fakedata):

1. Create `vs_spec` fixture with VS domain mappings:
   - STUDYID, DOMAIN ("VS"), USUBJID, VSSEQ, VSTESTCD, VSTEST, VSORRES, VSORRESU, VSSTRESC, VSSTRESN, VSSTRESU, VSPOS, VSLOC, VSBLFL, VSDTC, VSDY, VSNRIND
   - domain_class = "findings"
2. Create synthetic VS data: 12 rows, 2 subjects, 3 visits each, test codes SYSBP/DIABP/PULSE/WEIGHT, with:
   - VSPOS values from CT C71148 ("SUPINE", "STANDING", "SITTING")
   - VSLOC values ("ARM", "LEG")
   - Numeric results with units (mmHg, beats/min, kg)
3. Tests:
   - test_vs_basic_execution: Execute spec, verify row count and SDTM columns present
   - test_vs_seq_generation: Verify VSSEQ unique per USUBJID, monotonically increasing
   - test_vs_domain_assign: Verify DOMAIN = "VS" for all rows
   - test_vs_column_order: Verify columns in spec order
   - **test_vs_position_ct_c71148: Verify all VSPOS values are valid terms from CT C71148 (SUPINE, STANDING, SITTING). This validates the position codelist is correctly applied.**
   - **test_vs_nrind_present: Verify VSNRIND column exists and is populated for rows with numeric results and reference ranges (NORMAL, LOW, HIGH).**
   - test_vs_normalize_columns: Test normalize_vs_columns on CRF-style data (VSDAT->VSDTC, etc.)
   - test_vs_no_fakedata_note: Docstring note that VS is tested with synthetic data because no vs.sas7bdat exists in Fakedata
  </action>
  <verify>
Run `pytest tests/integration/execution/test_lb_execution.py tests/integration/execution/test_eg_execution.py tests/integration/execution/test_vs_execution.py -v` -- all pass.
Run `pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
LB execution tests verify multi-source merge, LBSEQ generation, column normalization, and date imputation flags (LBDTF). EG execution tests verify ecg_results handling, pre/post-dose time point normalization, position CT C71148 verification, and date imputation flags (EGDTF). VS execution tests verify synthetic vital signs data with position codes (C71148), normal range indicators, and column normalization. All tests pass including full suite.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/integration/execution/test_lb_execution.py tests/integration/execution/test_eg_execution.py tests/integration/execution/test_vs_execution.py -v` -- all pass
- `ruff check src/astraea/execution/findings.py` -- clean
- `pytest tests/ -x -q` -- full suite (1100+ tests) still passes
- LB multi-source merge produces correct combined row count
- EG pre/post-dose time points correctly normalized
- VS synthetic data tests pass with position codes and normal range indicators
- CT C71148 position codelist verified in EG and VS tests
- Date imputation flags (--DTF) verified in LB and EG tests
</verification>

<success_criteria>
1. FindingsExecutor handles multi-source lab data merging (lab_results + llb)
2. Column normalization handles both SDTM-structured and CRF-format sources for LB, EG, and VS
3. EG time points (Pre-dose, Post-dose) correctly derived from source files
4. VS normalizer and executor work with synthetic data (no Fakedata dependency)
5. CT codelist C71148 (position) verified in EG and VS execution tests
6. Date imputation flags (--DTF/--TMF) generated for partial dates in LB and EG
7. All execution tests pass with synthetic data
8. Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-findings-domains/06-02-SUMMARY.md`
</output>
