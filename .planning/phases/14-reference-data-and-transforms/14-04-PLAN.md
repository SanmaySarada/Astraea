---
phase: 14-reference-data-and-transforms
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/validation/rules/fda_business.py
  - src/astraea/validation/rules/consistency.py
  - tests/unit/validation/test_vectorized_rules_phase14.py
autonomous: true

must_haves:
  truths:
    - "FDAB009 uses groupby+nunique instead of iterrows"
    - "FDAB030 uses groupby+nunique instead of iterrows"
    - "ASTR-C005 uses merge+vectorized comparison instead of iterrows"
    - "All validation rule results are identical before and after vectorization"
  artifacts:
    - path: "src/astraea/validation/rules/fda_business.py"
      provides: "Vectorized FDAB009 and FDAB030 rules"
      contains: "groupby"
    - path: "src/astraea/validation/rules/consistency.py"
      provides: "Vectorized ASTR-C005 study day sign check"
      contains: "merge"
  key_links:
    - from: "src/astraea/validation/rules/fda_business.py"
      to: "pandas groupby API"
      via: "Vectorized 1:1 relationship checking"
      pattern: "groupby.*nunique"
    - from: "src/astraea/validation/rules/consistency.py"
      to: "pandas merge API"
      via: "Vectorized DM RFSTDTC lookup"
      pattern: "merge.*RFSTDTC"
---

<objective>
Replace iterrows() loops in validation rules with vectorized pandas operations for 10-100x performance improvement on large datasets.

Purpose: FDAB009, FDAB030, and ASTR-C005 validation rules use iterrows() which is slow for large clinical datasets (LB can have 100K+ rows). Vectorized operations maintain identical behavior with dramatically better performance.
Output: Vectorized fda_business.py (FDAB009, FDAB030) and consistency.py (ASTR-C005).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-reference-data-and-transforms/14-RESEARCH.md
@src/astraea/validation/rules/fda_business.py
@src/astraea/validation/rules/consistency.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vectorize FDAB009 and FDAB030 in fda_business.py (MED-02 partial)</name>
  <files>src/astraea/validation/rules/fda_business.py, tests/unit/validation/test_vectorized_rules_phase14.py</files>
  <action>
  Replace iterrows() loops in FDAB009 and FDAB030 validation rules with pandas vectorized operations. The behavior and output must remain IDENTICAL -- only the implementation changes.

  **FDAB009 (TESTCD/TEST 1:1 relationship check, ~line 268-299):**
  Current: Two iterrows loops building dicts to check that each TESTCD maps to exactly one TEST value and vice versa.
  Replace with:
  ```python
  # Forward check: TESTCD -> TEST (1:1)
  valid = df[[testcd_col, test_col]].dropna().astype(str)
  if not valid.empty:
      fwd_counts = valid.groupby(testcd_col)[test_col].nunique()
      fwd_violations = fwd_counts[fwd_counts > 1].index.tolist()
      # Get violation details for error messages
      if fwd_violations:
          fwd_details = (
              valid[valid[testcd_col].isin(fwd_violations)]
              .groupby(testcd_col)[test_col]
              .apply(lambda x: sorted(x.unique().tolist()))
              .to_dict()
          )

  # Reverse check: TEST -> TESTCD (1:1)
  rev_counts = valid.groupby(test_col)[testcd_col].nunique()
  rev_violations = rev_counts[rev_counts > 1].index.tolist()
  # Similar detail extraction
  ```
  Produce the same RuleResult objects as before (same rule_id, severity, messages, affected_rows counts).

  **FDAB030 (STRESU unit consistency, ~line 363):**
  Current: iterrows loop checking that each TESTCD has exactly one STRESU value.
  Replace with:
  ```python
  valid = df[[testcd_col, stresu_col]].dropna().astype(str)
  if not valid.empty:
      unit_counts = valid.groupby(testcd_col)[stresu_col].nunique()
      violations = unit_counts[unit_counts > 1].index.tolist()
  ```
  Produce the same RuleResult as before.

  CRITICAL: Do NOT change the function signatures, return types, or error message format. Only replace the internal loop logic. The tests for existing behavior must still pass.
  </action>
  <verify>
  ```bash
  cd /Users/sanmaysarada/Astraea-SDTM && python3.12 -m pytest tests/unit/validation/ -x -q --timeout=30 -k "fdab" 2>&1 | tail -5
  ```
  </verify>
  <done>FDAB009 and FDAB030 use groupby+nunique. Existing validation tests pass unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Vectorize ASTR-C005 in consistency.py (MED-02 partial)</name>
  <files>src/astraea/validation/rules/consistency.py, tests/unit/validation/test_vectorized_rules_phase14.py</files>
  <action>
  Replace iterrows() loops in ASTR-C005 (study day sign consistency check) with vectorized operations. Two loops to replace:

  **RFSTDTC lookup build (~line 274):**
  Current: iterrows over DM to build {USUBJID: RFSTDTC} dict.
  Replace with:
  ```python
  dm_lookup = dm_df[["USUBJID", "RFSTDTC"]].dropna(subset=["RFSTDTC"]).copy()
  rfstdtc_map = dm_lookup.set_index("USUBJID")["RFSTDTC"].str[:10].to_dict()
  ```

  **Study day sign check (~line 298):**
  Current: iterrows over domain DataFrame checking --DY sign vs --DTC/RFSTDTC relationship.
  Replace with merge + vectorized comparison:
  ```python
  # Merge RFSTDTC into domain
  dm_ref = dm_df[["USUBJID", "RFSTDTC"]].dropna().copy()
  dm_ref["_rfstdtc_date"] = dm_ref["RFSTDTC"].astype(str).str[:10]
  merged = df.merge(dm_ref[["USUBJID", "_rfstdtc_date"]], on="USUBJID", how="left")

  for dy_col in dy_cols:
      dtc_col = dy_col.replace("DY", "DTC")  # or appropriate derivation
      if dtc_col not in merged.columns:
          continue
      mask = merged[dy_col].notna() & merged[dtc_col].notna() & merged["_rfstdtc_date"].notna()
      subset = merged[mask].copy()
      subset["_dtc_date"] = subset[dtc_col].astype(str).str[:10]
      subset["_dy_num"] = pd.to_numeric(subset[dy_col], errors="coerce")

      inconsistent = (
          ((subset["_dy_num"] > 0) & (subset["_dtc_date"] < subset["_rfstdtc_date"])) |
          ((subset["_dy_num"] < 0) & (subset["_dtc_date"] > subset["_rfstdtc_date"]))
      )
      n_inconsistent = inconsistent.sum()
      # Create RuleResult with same format as before
  ```

  CRITICAL: Preserve exact same behavior, rule_ids, severities, and message formats. Only change implementation.

  **Tests** in `tests/unit/validation/test_vectorized_rules_phase14.py`:
  - test_fdab009_vectorized_detects_violation: TESTCD with multiple TEST values -> caught
  - test_fdab009_vectorized_no_violation: Clean 1:1 data -> no issues
  - test_fdab030_vectorized_detects_unit_mismatch: Same TESTCD with different STRESU -> caught
  - test_fdab030_vectorized_clean_data: Consistent units -> no issues
  - test_astr_c005_vectorized_detects_sign_mismatch: Positive DY with DTC before RFSTDTC -> caught
  - test_astr_c005_vectorized_clean_data: Consistent signs -> no issues
  - test_astr_c005_vectorized_handles_missing_dm: No DM data -> graceful (no crash)
  </action>
  <verify>
  ```bash
  cd /Users/sanmaysarada/Astraea-SDTM && python3.12 -m pytest tests/unit/validation/test_vectorized_rules_phase14.py tests/unit/validation/ -x -q --timeout=30 2>&1 | tail -5
  ```
  </verify>
  <done>ASTR-C005 uses merge+vectorized comparison. All existing + new validation tests pass. No iterrows() remains in targeted functions.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/sanmaysarada/Astraea-SDTM && python3.12 -m pytest tests/ -x -q --timeout=60 2>&1 | tail -5
```
Full test suite passes. No iterrows() remains in FDAB009, FDAB030, or ASTR-C005.

```bash
cd /Users/sanmaysarada/Astraea-SDTM && grep -n "iterrows" src/astraea/validation/rules/fda_business.py src/astraea/validation/rules/consistency.py
```
No matches (iterrows removed from targeted files).
</verification>

<success_criteria>
- FDAB009 uses groupby+nunique for 1:1 relationship checking
- FDAB030 uses groupby+nunique for unit consistency
- ASTR-C005 uses merge+vectorized comparison for study day sign checks
- Zero iterrows() calls remain in fda_business.py and consistency.py
- All existing validation tests pass without modification
- New vectorization tests verify correct behavior
</success_criteria>

<output>
After completion, create `.planning/phases/14-reference-data-and-transforms/14-04-SUMMARY.md`
</output>
