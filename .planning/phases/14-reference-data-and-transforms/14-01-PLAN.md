---
phase: 14-reference-data-and-transforms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/data/ct/codelists.json
  - src/astraea/data/sdtm_ig/domains.json
  - src/astraea/reference/controlled_terms.py
  - tests/unit/reference/test_controlled_terms_phase14.py
autonomous: true

must_haves:
  truths:
    - "C66738 codelist exists and contains at least 28 FDA-required TSPARMCD values"
    - "PE and QS domains have VISITNUM and VISIT in their variables arrays"
    - "C66789 maps to LBSPCND not LBSPEC"
    - "C66742 includes CEOCCUR, CEPRESP, LBBLFL, VSBLFL, EGBLFL, DVBLFL, PEBLFL"
    - "Reverse codelist lookup handles collisions with warning, returns list"
  artifacts:
    - path: "src/astraea/data/ct/codelists.json"
      provides: "C66738 codelist, corrected C66789, expanded C66742"
      contains: "C66738"
    - path: "src/astraea/data/sdtm_ig/domains.json"
      provides: "VISITNUM/VISIT variables in PE and QS"
      contains: "VISITNUM"
    - path: "src/astraea/reference/controlled_terms.py"
      provides: "Collision-safe reverse lookup"
      contains: "get_codelists_for_variable"
  key_links:
    - from: "src/astraea/reference/controlled_terms.py"
      to: "src/astraea/data/ct/codelists.json"
      via: "JSON loading and reverse lookup building"
      pattern: "_variable_to_codelist"
---

<objective>
Fix reference data errors in codelists.json, domains.json, and controlled_terms.py to ensure correct CT validation and domain variable completeness.

Purpose: Reference data correctness is foundational -- wrong codelist mappings cause cascading validation failures and incorrect SDTM output.
Output: Corrected codelists.json (C66738 added, C66789 fixed, C66742 expanded), domains.json (PE/QS VISITNUM), controlled_terms.py (collision-safe reverse lookup).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-reference-data-and-transforms/14-RESEARCH.md
@src/astraea/data/ct/codelists.json
@src/astraea/data/sdtm_ig/domains.json
@src/astraea/reference/controlled_terms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix codelists.json (HIGH-14, MED-15, MED-16)</name>
  <files>src/astraea/data/ct/codelists.json</files>
  <action>
  Three changes to codelists.json:

  1. **Add C66738 (Trial Summary Parameter Code)** -- HIGH-14:
     Add a new entry under key "C66738" with:
     - name: "Trial Summary Parameter Code"
     - extensible: true
     - variable_mappings: ["TSPARMCD"]
     - terms: Include at minimum these 28 entries (submission_value = nci_preferred_term = the code):
       SSTDTC (Study Start Date), SENDTC (Study End Date), SPONSOR (Sponsor Name), TITLE (Study Title), INDIC (Trial Indication), TRT (Investigational Therapy or Treatment), PCLAS (Pharmacological Class), PLESSION (Planned Number of Subjects), SEXPOP (Sex of Participants), AGEMIN (Planned Minimum Age), AGEMAX (Planned Maximum Age), STOTEFP (Reason for Study Stopping), ADDON (Added on to Existing Treatment), TPHASE (Trial Phase Classification), SDTMVER (SDTM Version), TTYPE (Trial Type), ACESSION (Accession Number), COMPTRT (Comparator Treatment), REGID (Registry Identifier), HLTSUBJI (Healthy Subject Indicator), RANDOM (Trial Is Randomized), STYPE (Study Type), ADAPT (Adaptive Design), INTMODEL (Intervention Model), CURTRT (Control Type), DOSFRQ (Planned Dose Frequency), ROUTE (Planned Route of Administration), OBJPRIM (Trial Primary Objective)
     - Each term has: submission_value (the code, e.g., "SSTDTC"), nci_preferred_term (full name, e.g., "Study Start Date"), nci_code (null for now -- real C-codes require NCI EVS lookup)

  2. **Fix C66789 variable_mappings** -- MED-15:
     Change C66789 (Specimen Condition) variable_mappings from ["LBSPEC"] to ["LBSPCND"]. LBSPEC is Specimen Type (C78734), LBSPCND is Specimen Condition.

  3. **Expand C66742 variable_mappings** -- MED-16:
     Add these missing variables to C66742 (No Yes Response) variable_mappings array: CEOCCUR, CEPRESP, LBBLFL, VSBLFL, EGBLFL, DVBLFL, PEBLFL, IESTRESC.
     Keep all existing entries.
  </action>
  <verify>
  ```bash
  python3.12 -c "
  import json
  with open('src/astraea/data/ct/codelists.json') as f:
      data = json.load(f)
  # C66738 exists with terms
  assert 'C66738' in data, 'C66738 missing'
  assert len(data['C66738']['terms']) >= 28, f'C66738 only has {len(data[\"C66738\"][\"terms\"])} terms'
  assert data['C66738']['variable_mappings'] == ['TSPARMCD']
  # C66789 fixed
  assert data['C66789']['variable_mappings'] == ['LBSPCND'], f'C66789 maps to {data[\"C66789\"][\"variable_mappings\"]}'
  # C66742 expanded
  vm = data['C66742']['variable_mappings']
  for v in ['CEOCCUR', 'CEPRESP', 'LBBLFL', 'VSBLFL']:
      assert v in vm, f'{v} missing from C66742'
  print('All codelist checks passed')
  "
  ```
  </verify>
  <done>C66738 exists with 28+ TSPARMCD terms, C66789 maps to LBSPCND, C66742 includes all --OCCUR/--PRESP/--BLFL variables.</done>
</task>

<task type="auto">
  <name>Task 2: Fix domains.json PE/QS VISITNUM + controlled_terms.py collision safety (HIGH-15, MED-17)</name>
  <files>src/astraea/data/sdtm_ig/domains.json, src/astraea/reference/controlled_terms.py, tests/unit/reference/test_controlled_terms_phase14.py</files>
  <action>
  Two changes:

  1. **Add VISITNUM and VISIT to PE and QS domains** -- HIGH-15:
     In domains.json, find the PE domain and QS domain variable arrays. Add VISITNUM and VISIT entries matching the pattern used in LB/VS domains:
     ```json
     {
       "name": "VISITNUM",
       "label": "Visit Number",
       "data_type": "Num",
       "core": "Exp",
       "cdisc_notes": "Clinical encounter number.",
       "codelist_code": null,
       "order": <next available order after existing variables>
     },
     {
       "name": "VISIT",
       "label": "Visit Name",
       "data_type": "Char",
       "core": "Exp",
       "cdisc_notes": "Protocol-defined description of clinical encounter.",
       "codelist_code": null,
       "order": <next after VISITNUM>
     }
     ```
     Only add if not already present. Check LB or VS for the exact field values to copy.

  2. **Make reverse lookup collision-safe** -- MED-17:
     In `controlled_terms.py`, change `_variable_to_codelist: dict[str, str]` to `_variable_to_codelist: dict[str, list[str]]`.
     - During initialization, append codelist codes to a list instead of overwriting.
     - `get_codelist_for_variable(var_name)` returns the first codelist code (backward compatible), but logs a warning via loguru if multiple codelists exist for that variable.
     - Add new method `get_codelists_for_variable(var_name) -> list[str]` returning all matching codelist codes.
     - Ensure the existing public API (`get_codelist_for_variable`) remains backward compatible (returns `str | None`).

  3. **Tests:**
     Create `tests/unit/reference/test_controlled_terms_phase14.py`:
     - Test that `get_codelist_for_variable("TSPARMCD")` returns "C66738"
     - Test that `get_codelist_for_variable("LBSPCND")` returns "C66789" (after MED-15 fix)
     - Test that `get_codelists_for_variable` returns a list
     - Test that collision case returns list with multiple entries (mock a collision scenario)
     - Test PE domain has VISITNUM in variables (load domains.json, check PE)
     - Test QS domain has VISITNUM in variables
  </action>
  <verify>
  ```bash
  cd /Users/sanmaysarada/Astraea-SDTM && python3.12 -m pytest tests/unit/reference/test_controlled_terms_phase14.py -xvs
  ```
  </verify>
  <done>PE and QS have VISITNUM/VISIT variables. Reverse lookup handles collisions safely with warning. All new tests pass.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/sanmaysarada/Astraea-SDTM && python3.12 -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5
```
All existing tests plus new reference data tests pass.
</verification>

<success_criteria>
- C66738 codelist present with 28+ TSPARMCD terms
- C66789 variable_mappings corrected to LBSPCND
- C66742 expanded with CEOCCUR, CEPRESP, LBBLFL, VSBLFL, etc.
- PE and QS domains have VISITNUM and VISIT in variables arrays
- controlled_terms.py reverse lookup is collision-safe
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-reference-data-and-transforms/14-01-SUMMARY.md`
</output>
