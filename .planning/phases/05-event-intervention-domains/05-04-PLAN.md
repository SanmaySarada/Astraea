---
phase: 05-event-intervention-domains
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/integration/execution/test_mh_execution.py
  - tests/integration/execution/test_ie_execution.py
  - tests/integration/execution/test_ce_execution.py
  - tests/integration/execution/test_dv_execution.py
autonomous: true

must_haves:
  truths:
    - "MH domain merges two source files (mh + haemh) and maps MedDRA terms"
    - "IE domain (Findings-class, no transpose) maps inclusion/exclusion criteria"
    - "CE domain maps clinical events with prespecified Y/N flags"
    - "DV domain handles non-standard column names (Subject_ID, Site_Number)"
  artifacts:
    - path: "tests/integration/execution/test_mh_execution.py"
      provides: "MH domain end-to-end execution test"
      min_lines: 80
    - path: "tests/integration/execution/test_ie_execution.py"
      provides: "IE domain end-to-end execution test"
      min_lines: 60
    - path: "tests/integration/execution/test_ce_execution.py"
      provides: "CE domain end-to-end execution test"
      min_lines: 70
    - path: "tests/integration/execution/test_dv_execution.py"
      provides: "DV domain end-to-end execution test"
      min_lines: 60
  key_links:
    - from: "tests/integration/execution/test_dv_execution.py"
      to: "src/astraea/execution/executor.py"
      via: "Custom site_col/subject_col parameters"
      pattern: "site_col.*subject_col"
---

<objective>
Create integration tests for the four simpler Phase 5 domains: MH (multi-source merge, MedDRA), IE (Findings-class without transpose), CE (clinical events with Y/N flags), and DV (non-standard column names).

Purpose: Completes domain coverage for all 8 Event/Intervention domains. MH validates multi-source merge with MedDRA. IE proves Findings-class domains work without transpose. CE tests prespecified event flags. DV validates the custom column name parameters.

Output: Four integration test files with synthetic data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@tests/integration/execution/test_dm_execution.py
@src/astraea/execution/executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: MH and IE domain integration tests</name>
  <files>
    tests/integration/execution/test_mh_execution.py
    tests/integration/execution/test_ie_execution.py
  </files>
  <action>
**MH domain test** (`tests/integration/execution/test_mh_execution.py`):

mh_spec fixture with mappings:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "MH", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. MHSEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. MHTERM (DIRECT, source="MHTERM", order=5)
6. MHDECOD (RENAME, source="MHTERM_PT", order=6)
7. MHBODSYS (RENAME, source="MHTERM_SOC", order=7)
8. MHSTDTC (REFORMAT, source="MHSTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=8)

Set domain="MH", domain_label="Medical History", domain_class="Events", structure="One record per medical history event per subject", study_id="PHA022121-C301".

Two raw DataFrames (mh_df + haemh_df):

mh_df (3 rows, general medical history):
```python
{
    "Subject": ["001", "002", "003"],
    "SiteNumber": ["101", "101", "102"],
    "MHTERM": ["Hypertension", "Type 2 diabetes", "Asthma"],
    "MHTERM_PT": ["Hypertension", "Type 2 diabetes mellitus", "Asthma"],
    "MHTERM_SOC": ["Vascular disorders", "Metabolism disorders", "Respiratory disorders"],
    "MHSTDAT_RAW": ["un UNK 2015", "01 Jan 2010", "un Mar 2018"],
    "projectid": [1, 1, 1],
}
```

haemh_df (2 rows, HAE-specific):
```python
{
    "Subject": ["001", "002"],
    "SiteNumber": ["101", "101"],
    "MHTERM": ["HAE Type I", "HAE Type II"],
    "MHTERM_PT": ["Hereditary angioedema type I", "Hereditary angioedema type II"],
    "MHTERM_SOC": ["Immune system disorders", "Immune system disorders"],
    "MHSTDAT_RAW": ["un UNK 2005", "un UNK 2010"],
    "projectid": [1, 1],
}
```

Test class TestMHEndToEnd:
- test_five_rows_from_two_sources: len(result) == 5 (3 + 2)
- test_mhdecod_from_pt: MHDECOD values match MHTERM_PT
- test_mhbodsys_from_soc: MHBODSYS values match MHTERM_SOC
- test_partial_date_year_only: rows with "un UNK 2015" produce "2015"
- test_partial_date_year_month: row with "un Mar 2018" produces "2018-03"
- test_mhseq_generated: MHSEQ present per USUBJID
- test_columns_correct: 8 mapped columns present

---

**IE domain test** (`tests/integration/execution/test_ie_execution.py`):

ie_spec fixture with mappings:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "IE", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. IESEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. IETESTCD (DIRECT, source="IETESTCD", order=5)
6. IETEST (DIRECT, source="IETEST", order=6)
7. IECAT (DIRECT, source="IECAT", order=7)
8. IEORRES (DIRECT, source="IEORRES", order=8, core=CoreDesignation.EXP)
9. IESTRESC (DIRECT, source="IESTRESC", order=9, core=CoreDesignation.EXP)
10. IEDTC (REFORMAT, source="IEDTC_RAW", derivation_rule="parse_string_date_to_iso", order=10, core=CoreDesignation.EXP)

Set domain="IE", domain_label="Inclusion/Exclusion Criteria Not Met", domain_class="Findings", structure="One record per inclusion/exclusion criterion not met per subject", study_id="PHA022121-C301".

raw_ie_df fixture (3 rows -- only subjects who had criteria violations):
```python
{
    "Subject": ["002", "003", "003"],
    "SiteNumber": ["101", "102", "102"],
    "IETESTCD": ["INCL01", "EXCL03", "INCL05"],
    "IETEST": ["Age >= 18 years", "No active hepatitis B", "Adequate renal function"],
    "IECAT": ["INCLUSION", "EXCLUSION", "INCLUSION"],
    "IEORRES": ["Y", "N", "Y"],
    "IESTRESC": ["Y", "N", "Y"],
    "IEDTC_RAW": ["15 Dec 2021", "10 Dec 2021", "10 Dec 2021"],
    "projectid": [1, 1, 1],
}
```

Test class TestIEEndToEnd:
- test_output_has_correct_columns: 10 mapped columns
- test_three_rows_preserved: len(result) == 3
- test_ietestcd_values: IETESTCD has expected codes
- test_iecat_values: IECAT includes "INCLUSION" and "EXCLUSION"
- test_dates_converted: IEDTC in ISO format
- test_ieseq_generated: IESEQ present
- test_findings_class_domain: Proves Findings-class works without transpose
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_mh_execution.py tests/integration/execution/test_ie_execution.py -v` -- all tests pass
  </verify>
  <done>MH multi-source merge works, IE Findings-class without transpose works. MH: 7+ tests, IE: 7+ tests.</done>
</task>

<task type="auto">
  <name>Task 2: CE and DV domain integration tests</name>
  <files>
    tests/integration/execution/test_ce_execution.py
    tests/integration/execution/test_dv_execution.py
  </files>
  <action>
**CE domain test** (`tests/integration/execution/test_ce_execution.py`):

ce_spec fixture with mappings:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "CE", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. CESEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. CETERM (DIRECT, source="CETERM", order=5)
6. CEDECOD (DIRECT, source="CEDECOD", order=6)
7. CECAT (ASSIGN, assigned="HAE ATTACK", order=7)
8. CEPRESP (ASSIGN, assigned="Y", order=8, core=CoreDesignation.PERM)
9. CEOCCUR (LOOKUP_RECODE, source="CEOCCUR_STD", codelist="C66742", order=9, core=CoreDesignation.PERM)
10. CESTDTC (REFORMAT, source="CESTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=10)
11. CEENDTC (REFORMAT, source="CEENDAT_RAW", derivation_rule="parse_string_date_to_iso", order=11)

Set domain="CE", domain_label="Clinical Events", domain_class="Events", structure="One record per event per subject", study_id="PHA022121-C301".

raw_ce_df fixture (4 rows of HAE attack events):
```python
{
    "Subject": ["001", "001", "002", "003"],
    "SiteNumber": ["101", "101", "101", "102"],
    "CETERM": ["HAE Attack - Abdominal", "HAE Attack - Peripheral", "HAE Attack - Laryngeal", "HAE Attack - Facial"],
    "CEDECOD": ["HAE ATTACK", "HAE ATTACK", "HAE ATTACK", "HAE ATTACK"],
    "CEOCCUR_STD": ["Y", "Y", "Y", "N"],
    "CESTDAT_RAW": ["10 Jan 2022", "05 Feb 2022", "20 Jan 2022", ""],
    "CEENDAT_RAW": ["12 Jan 2022", "07 Feb 2022", "22 Jan 2022", ""],
    "projectid": [1, 1, 1, 1],
}
```

Test class TestCEEndToEnd:
- test_output_has_correct_columns: 11 mapped columns
- test_four_rows_preserved: len(result) == 4
- test_cecat_assigned: all CECAT == "HAE ATTACK"
- test_cepresp_assigned: all CEPRESP == "Y"
- test_ceoccur_recoded: CEOCCUR values are "Y" or "N" (C66742)
- test_dates_converted: CESTDTC in ISO format
- test_ceseq_generated: CESEQ present per USUBJID

---

**DV domain test** (`tests/integration/execution/test_dv_execution.py`):

dv_spec fixture with mappings:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "DV", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. DVSEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. DVTERM (DIRECT, source="Description", order=5)
6. DVDECOD (DIRECT, source="Category", order=6)
7. DVCAT (DIRECT, source="Category", order=7)
8. DVSTDTC (REFORMAT, source="Date_Occurred_RAW", derivation_rule="parse_string_date_to_iso", order=8)

Set domain="DV", domain_label="Protocol Deviations", domain_class="Events", structure="One record per deviation per subject", study_id="PHA022121-C301".

raw_dv_df fixture (2 rows with NON-STANDARD column names):
```python
{
    "Subject_ID": ["001", "002"],  # NOT "Subject"
    "Site_Number": ["101", "101"],  # NOT "SiteNumber"
    "Description": ["Missed visit Window 3", "Wrong dose administered"],
    "Category": ["VISIT WINDOW DEVIATION", "DOSING ERROR"],
    "Date_Occurred_RAW": ["15 Mar 2022", "20 Apr 2022"],
    "Deviation_Id": ["DV001", "DV002"],
}
```

Note: No standard EDC columns (no projectid, no instanceId). This dataset uses a completely different naming convention.

The test MUST pass custom column names to executor:
```python
result = executor.execute(
    dv_spec,
    {"dv": raw_dv_df},
    study_id="PHA022121-C301",
    site_col="Site_Number",     # Custom!
    subject_col="Subject_ID",   # Custom!
)
```

Test class TestDVEndToEnd:
- test_output_has_correct_columns: 8 mapped columns
- test_two_rows_preserved: len(result) == 2
- test_usubjid_from_custom_columns: USUBJID values are correctly generated from Subject_ID + Site_Number
- test_dvterm_from_description: DVTERM values match Description column
- test_dvcat_from_category: DVCAT values match Category column
- test_dates_converted: DVSTDTC in ISO format
- test_dvseq_generated: DVSEQ present
- test_no_raw_columns_leak: "Subject_ID", "Site_Number", "Deviation_Id" not in result.columns
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_ce_execution.py tests/integration/execution/test_dv_execution.py -v` -- all tests pass
  </verify>
  <done>CE domain proves assigned+Y/N pattern works. DV domain proves custom column name parameters work for non-standard source data. CE: 7+ tests, DV: 8+ tests.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_mh_execution.py tests/integration/execution/test_ie_execution.py tests/integration/execution/test_ce_execution.py tests/integration/execution/test_dv_execution.py -v` -- all new tests pass
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest` -- full suite passes
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/execution/` -- no lint errors
</verification>

<success_criteria>
- MH multi-source merge produces 5 rows from 2 source files with MedDRA terms
- IE Findings-class domain works without transpose (10 variables mapped correctly)
- CE HAE attack events with assigned CECAT and Y/N codelist recode
- DV non-standard columns (Subject_ID, Site_Number) correctly used for USUBJID generation
- All 4 domains have --SEQ, correct column order, no raw column leakage
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-04-SUMMARY.md`
</output>
