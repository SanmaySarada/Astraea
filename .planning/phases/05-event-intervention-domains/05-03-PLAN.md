---
phase: 05-event-intervention-domains
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/integration/execution/test_cm_execution.py
  - tests/integration/execution/test_ex_execution.py
autonomous: true

must_haves:
  truths:
    - "CM domain correctly handles partial dates (year-only) in CMSTDTC"
    - "CM domain recodes route, frequency, and dose unit via CT codelists"
    - "EX domain filters out records where drug was not administered (EXYN=N)"
    - "EX domain merges two source files (ex + ex_ole) correctly"
  artifacts:
    - path: "tests/integration/execution/test_cm_execution.py"
      provides: "CM domain end-to-end execution test"
      min_lines: 100
    - path: "tests/integration/execution/test_ex_execution.py"
      provides: "EX domain end-to-end execution test with row filtering and multi-source"
      min_lines: 100
  key_links:
    - from: "tests/integration/execution/test_ex_execution.py"
      to: "src/astraea/execution/preprocessing.py"
      via: "filter_rows for EXYN exclusion"
      pattern: "filter_rows"
---

<objective>
Create integration tests proving CM and EX domains execute correctly. CM validates partial date handling and multiple CT codelist recodes (route, frequency, unit). EX validates source row filtering (EXYN=N exclusion) and multi-source merge (ex + ex_ole).

Purpose: CM and EX are the Interventions-class domains. CM exercises partial date preservation. EX exercises the new filter_rows utility -- the first test that proves pre-execution row filtering works end-to-end.

Output: Two integration test files with synthetic data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@tests/integration/execution/test_dm_execution.py
@src/astraea/execution/executor.py
@src/astraea/execution/pattern_handlers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CM domain integration test</name>
  <files>tests/integration/execution/test_cm_execution.py</files>
  <action>
Create `tests/integration/execution/test_cm_execution.py` following the DM test pattern.

**cm_spec fixture:** DomainMappingSpec for CM domain:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "CM", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. CMSEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. CMTRT (DIRECT, source="CMTRT", order=5)
6. CMDOSE (DIRECT, source="CMDOSE", order=6, core=CoreDesignation.PERM)
7. CMDOSU (LOOKUP_RECODE, source="CMDOSU_STD", codelist="C71620", order=7, core=CoreDesignation.PERM)
8. CMROUTE (LOOKUP_RECODE, source="CMROUTE_STD", codelist="C66729", order=8, core=CoreDesignation.PERM)
9. CMDOSFRQ (LOOKUP_RECODE, source="CMDOSFRQ_STD", codelist="C71113", order=9, core=CoreDesignation.PERM)
10. CMSTDTC (REFORMAT, source="CMSTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=10)
11. CMENDTC (REFORMAT, source="CMENDAT_RAW", derivation_rule="parse_string_date_to_iso", order=11)
12. CMINDC (DIRECT, source="CMINDC", order=12, core=CoreDesignation.PERM)

Set domain="CM", domain_label="Concomitant Medications", domain_class="Interventions", structure="One record per medication occurrence or constant-dosing interval per subject", study_id="PHA022121-C301".

**raw_cm_df fixture:** DataFrame with 5 rows:
```python
{
    "Subject": ["001", "001", "002", "002", "003"],
    "SiteNumber": ["101", "101", "101", "101", "102"],
    "CMTRT": ["IBUPROFEN", "PARACETAMOL", "ASPIRIN", "LISINOPRIL", "METFORMIN"],
    "CMDOSE": ["400", "500", "325", "10", "500"],
    "CMDOSU_STD": ["mg", "mg", "mg", "mg", "mg"],
    "CMROUTE_STD": ["ORAL", "ORAL", "ORAL", "ORAL", "ORAL"],
    "CMDOSFRQ_STD": ["BID", "QD", "PRN", "QD", "BID"],
    "CMSTDAT_RAW": ["15 Jan 2022", "un UNK 2020", "01 Mar 2022", "un Jun 2019", "10 Apr 2022"],
    "CMENDAT_RAW": ["30 Jun 2022", "", "15 Apr 2022", "", ""],
    "CMINDC": ["Headache", "Pain", "Cardioprotection", "Hypertension", "Diabetes"],
    "projectid": [1, 1, 1, 1, 1],
}
```

Note: "un UNK 2020" should produce "2020" (year-only partial date). "un Jun 2019" should produce "2019-06" (year-month partial date).

**Test class TestCMEndToEnd:**
- test_output_has_correct_columns: 12 mapped variables
- test_five_rows_preserved: len(result) == 5
- test_cmtrt_direct_copy: CMTRT values match raw
- test_partial_date_year_only: row with "un UNK 2020" produces CMSTDTC = "2020"
- test_partial_date_year_month: row with "un Jun 2019" produces CMSTDTC containing "2019-06" (or "2019-06" prefix)
- test_full_date_converted: row with "15 Jan 2022" produces "2022-01-15"
- test_route_recoded: CMROUTE values match C66729 submission values
- test_frequency_recoded: CMDOSFRQ values include standard CT terms (BID, QD, PRN)
- test_cmseq_generated: CMSEQ present, 2 records for subject 001 -> seq 1, 2
- test_no_edc_columns: "projectid" not in result.columns
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_cm_execution.py -v` -- all tests pass
  </verify>
  <done>CM domain integration test proves: partial date handling (year-only, year-month), CT recode for route/frequency/unit, --SEQ generation. 10+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: EX domain integration test with row filtering and multi-source</name>
  <files>tests/integration/execution/test_ex_execution.py</files>
  <action>
Create `tests/integration/execution/test_ex_execution.py` following the DM test pattern.

**ex_spec fixture:** DomainMappingSpec for EX domain:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "EX", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. EXSEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. EXTRT (DIRECT, source="EXTRT", order=5)
6. EXDOSE (DIRECT, source="EXDOSE", order=6)
7. EXDOSU (LOOKUP_RECODE, source="EXDOSU_STD", codelist="C71620", order=7)
8. EXDOSFRM (LOOKUP_RECODE, source="EXDOSFRM_STD", codelist="C66726", order=8)
9. EXROUTE (LOOKUP_RECODE, source="EXROUTE_STD", codelist="C66729", order=9)
10. EXSTDTC (REFORMAT, source="EXSTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=10)
11. EXENDTC (REFORMAT, source="EXENDAT_RAW", derivation_rule="parse_string_date_to_iso", order=11)

Set domain="EX", domain_label="Exposure", domain_class="Interventions", structure="One record per constant-dosing interval per subject", study_id="PHA022121-C301".

**raw_ex_dfs fixture:** Two DataFrames plus filtering:

ex_df (main study, 4 rows, 1 with EXYN=No):
```python
{
    "Subject": ["001", "001", "002", "003"],
    "SiteNumber": ["101", "101", "101", "102"],
    "EXTRT": ["C1-INH", "C1-INH", "C1-INH", "C1-INH"],
    "EXDOSE": ["50", "50", "50", "50"],
    "EXDOSU_STD": ["IU/kg", "IU/kg", "IU/kg", "IU/kg"],
    "EXDOSFRM_STD": ["INJECTION", "INJECTION", "INJECTION", "INJECTION"],
    "EXROUTE_STD": ["INTRAVENOUS", "INTRAVENOUS", "INTRAVENOUS", "INTRAVENOUS"],
    "EXSTDAT_RAW": ["01 Jan 2022", "15 Jan 2022", "01 Jan 2022", "05 Jan 2022"],
    "EXENDAT_RAW": ["01 Jan 2022", "15 Jan 2022", "01 Jan 2022", "05 Jan 2022"],
    "EXYN_STD": ["Y", "N", "Y", "Y"],  # Row 2: drug NOT administered
    "projectid": [1, 1, 1, 1],
}
```

ex_ole_df (OLE extension, 2 rows, all administered):
```python
{
    "Subject": ["001", "002"],
    "SiteNumber": ["101", "101"],
    "EXTRT": ["C1-INH", "C1-INH"],
    "EXDOSE": ["50", "50"],
    "EXDOSU_STD": ["IU/kg", "IU/kg"],
    "EXDOSFRM_STD": ["INJECTION", "INJECTION"],
    "EXROUTE_STD": ["INTRAVENOUS", "INTRAVENOUS"],
    "EXSTDAT_RAW": ["01 Jul 2022", "01 Jul 2022"],
    "EXENDAT_RAW": ["01 Jul 2022", "01 Jul 2022"],
    "EXYN_STD": ["Y", "Y"],
    "projectid": [1, 1],
}
```

The test must:
1. Use filter_rows to exclude EXYN_STD="N" rows from BOTH DataFrames BEFORE passing to executor
2. Pass filtered dfs to executor

```python
from astraea.execution.preprocessing import filter_rows

filtered_ex = filter_rows(ex_df, column="EXYN_STD", keep_values={"Y"})
filtered_ole = filter_rows(ex_ole_df, column="EXYN_STD", keep_values={"Y"})
result = executor.execute(ex_spec, {"ex": filtered_ex, "ex_ole": filtered_ole}, study_id="PHA022121-C301")
```

**Test class TestEXEndToEnd:**
- test_output_has_correct_columns: 11 mapped variables
- test_non_administered_filtered_out: len(result) == 5 (not 6 -- the EXYN=N row excluded)
- test_extrt_direct_copy: all EXTRT == "C1-INH"
- test_multi_source_merged: result has both main study and OLE records (5 total: 3 from ex + 2 from ex_ole)
- test_dosage_form_recoded: EXDOSFRM values match C66726
- test_route_recoded: EXROUTE values match C66729
- test_dates_converted: EXSTDTC in ISO 8601 format
- test_exseq_generated: EXSEQ present and correct per USUBJID
- test_no_exyn_column_in_output: EXYN_STD not in result.columns (not mapped, should be dropped)
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_ex_execution.py -v` -- all tests pass
  </verify>
  <done>EX domain integration test proves: row filtering (EXYN=N excluded), multi-source merge (ex + ex_ole), CT codelist recode for dose form/route, --SEQ generation. 9+ tests passing.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_cm_execution.py tests/integration/execution/test_ex_execution.py -v` -- all new tests pass
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest` -- full suite passes
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/execution/test_cm_execution.py tests/integration/execution/test_ex_execution.py` -- no lint errors
</verification>

<success_criteria>
- CM partial dates: "un UNK 2020" produces "2020", "un Jun 2019" produces "2019-06"
- CM codelist recodes work for route (C66729), frequency (C71113), unit (C71620)
- EX EXYN=N row excluded (5 rows, not 6)
- EX multi-source merge combines main + OLE data
- Both domains have --SEQ, correct column order, no EDC leakage
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-03-SUMMARY.md`
</output>
