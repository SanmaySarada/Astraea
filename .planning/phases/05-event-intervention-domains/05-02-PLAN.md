---
phase: 05-event-intervention-domains
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/integration/execution/test_ae_execution.py
  - tests/integration/execution/test_ds_execution.py
autonomous: true

must_haves:
  truths:
    - "AE domain executes with checkbox 0/1->Y/N seriousness flags via numeric_to_yn transform"
    - "AE domain correctly maps MedDRA coded terms to AEDECOD and AEBODSYS"
    - "DS domain merges two source files (ds + ds2) with aligned column names"
    - "DS domain produces both EOT and EOS records with DSCAT differentiation"
  artifacts:
    - path: "tests/integration/execution/test_ae_execution.py"
      provides: "AE domain end-to-end execution test"
      min_lines: 120
    - path: "tests/integration/execution/test_ds_execution.py"
      provides: "DS domain end-to-end execution test with multi-source merge"
      min_lines: 100
  key_links:
    - from: "tests/integration/execution/test_ae_execution.py"
      to: "src/astraea/execution/executor.py"
      via: "DatasetExecutor.execute()"
      pattern: "executor\\.execute"
    - from: "tests/integration/execution/test_ds_execution.py"
      to: "src/astraea/execution/preprocessing.py"
      via: "align_multi_source_columns for ds2 column renaming"
      pattern: "align_multi_source_columns"
---

<objective>
Create integration tests proving the AE and DS domains execute correctly through the DatasetExecutor pipeline. AE is the most complex domain (29 variables, 5 codelists, checkbox 0/1->Y/N, MedDRA terms). DS requires multi-source column alignment (ds + ds2 with different column names).

Purpose: AE validates the hardest non-transpose domain. DS validates multi-source merge with column alignment. Together they prove the execution pipeline handles the most challenging Event-class patterns.

Output: Two integration test files with synthetic data following the proven DM test pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@tests/integration/execution/test_dm_execution.py
@src/astraea/execution/executor.py
@src/astraea/execution/pattern_handlers.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AE domain integration test</name>
  <files>tests/integration/execution/test_ae_execution.py</files>
  <action>
Create `tests/integration/execution/test_ae_execution.py` following the DM test pattern (synthetic data, no Fakedata dependency, no LLM calls).

Create a helper `_mapping()` function identical to DM test pattern for constructing VariableMapping objects.

Create fixtures:

**ae_spec fixture:** DomainMappingSpec for AE domain with these variable mappings:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "AE", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. AESEQ (DERIVATION, derivation_rule="generate_seq", order=4) -- will be auto-generated by executor
5. AETERM (DIRECT, source="AETERM", order=5)
6. AEDECOD (RENAME, source="AETERM_PT", order=6) -- MedDRA Preferred Term
7. AEBODSYS (RENAME, source="AETERM_SOC", order=7) -- MedDRA SOC
8. AESEV (LOOKUP_RECODE, source="AESEV_STD", codelist="C66769", order=8)
9. AESER (LOOKUP_RECODE, source="AESER_STD", codelist="C66742", order=9)
10. AEACN (LOOKUP_RECODE, source="AEACN_STD", codelist="C66767", order=10)
11. AEREL (DIRECT, source="AEREL_STD", order=11)
12. AEOUT (LOOKUP_RECODE, source="AEOUT_STD", codelist="C66768", order=12)
13. AESDTH (REFORMAT, source="AESDTH", derivation_rule="numeric_to_yn", order=13)
14. AESLIFE (REFORMAT, source="AESLIFE", derivation_rule="numeric_to_yn", order=14)
15. AESHOSP (REFORMAT, source="AESHOSP", derivation_rule="numeric_to_yn", order=15)
16. AESTDTC (REFORMAT, source="AESTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=16)
17. AEENDTC (REFORMAT, source="AEENDAT_RAW", derivation_rule="parse_string_date_to_iso", order=17)

Set domain="AE", domain_label="Adverse Events", domain_class="Events", structure="One record per adverse event per subject", study_id="PHA022121-C301".

**raw_ae_df fixture:** DataFrame with 4 rows of synthetic AE data:
```python
{
    "Subject": ["001", "001", "002", "003"],
    "SiteNumber": ["101", "101", "101", "102"],
    "AETERM": ["Headache", "Nausea", "Fatigue", "Dizziness"],
    "AETERM_PT": ["Headache", "Nausea", "Fatigue", "Dizziness"],
    "AETERM_SOC": ["Nervous system disorders", "Gastrointestinal disorders", "General disorders", "Nervous system disorders"],
    "AESEV_STD": ["MILD", "MODERATE", "MILD", "SEVERE"],
    "AESER_STD": ["N", "N", "N", "Y"],
    "AEACN_STD": ["DOSE NOT CHANGED", "DOSE NOT CHANGED", "DOSE NOT CHANGED", "DRUG WITHDRAWN"],
    "AEREL_STD": ["POSSIBLY RELATED", "NOT RELATED", "RELATED", "POSSIBLY RELATED"],
    "AEOUT_STD": ["RECOVERED/RESOLVED", "RECOVERED/RESOLVED", "NOT RECOVERED/NOT RESOLVED", "RECOVERING/RESOLVING"],
    "AESDTH": [0.0, 0.0, 0.0, 0.0],
    "AESLIFE": [0.0, 0.0, 0.0, 1.0],
    "AESHOSP": [0.0, 0.0, 0.0, 1.0],
    "AESTDAT_RAW": ["15 Jan 2022", "20 Feb 2022", "01 Mar 2022", "10 Apr 2022"],
    "AEENDAT_RAW": ["18 Jan 2022", "25 Feb 2022", "", ""],
    # EDC columns
    "projectid": [1, 1, 1, 1],
    "instanceId": [10, 11, 20, 30],
}
```

**Test class TestAEEndToEnd:**
- test_output_has_correct_columns: assert set(result.columns) matches all 17 mapped variables
- test_studyid_constant: all rows have "PHA022121-C301"
- test_domain_is_ae: all rows have "AE"
- test_aeterm_direct_copy: AETERM values match raw AETERM
- test_aedecod_from_pt: AEDECOD values match raw AETERM_PT
- test_aebodsys_from_soc: AEBODSYS values match raw AETERM_SOC
- test_seriousness_yn_conversion: AESDTH all "N", AESLIFE has "Y" for row 3, AESHOSP has "Y" for row 3
- test_severity_recoded: AESEV values are {"MILD", "MODERATE", "SEVERE"}
- test_outcome_recoded: AEOUT values match CT C66768 submission values
- test_dates_converted_to_iso: AESTDTC values are ISO 8601 format ("2022-01-15", "2022-02-20", etc.)
- test_no_edc_columns_leak: "projectid", "instanceId" not in result.columns
- test_columns_in_sdtm_order: STUDYID before DOMAIN before USUBJID etc.
- test_aeseq_generated: AESEQ present and monotonically increasing per USUBJID
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_ae_execution.py -v` -- all tests pass
  </verify>
  <done>AE domain integration test proves: checkbox 0/1->Y/N via numeric_to_yn, MedDRA term mapping, CT codelist recode, date conversion, --SEQ generation, column ordering. 13+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: DS domain integration test with multi-source merge</name>
  <files>tests/integration/execution/test_ds_execution.py</files>
  <action>
Create `tests/integration/execution/test_ds_execution.py` following the same pattern.

Create fixtures:

**ds_spec fixture:** DomainMappingSpec for DS domain:
1. STUDYID (ASSIGN, "PHA022121-C301", order=1)
2. DOMAIN (ASSIGN, "DS", order=2)
3. USUBJID (DERIVATION, derivation_rule="generate_usubjid", order=3)
4. DSSEQ (DERIVATION, derivation_rule="generate_seq", order=4)
5. DSTERM (DIRECT, source="DSDECOD", order=5) -- verbatim term
6. DSDECOD (LOOKUP_RECODE, source="DSDECOD_STD", codelist="C66727", order=6)
7. DSCAT (DIRECT, source="DSCAT", order=7) -- category (TREATMENT/STUDY)
8. DSSTDTC (REFORMAT, source="DSSTDAT_RAW", derivation_rule="parse_string_date_to_iso", order=8)

Set domain="DS", domain_label="Disposition", domain_class="Events", structure="One record per disposition status or protocol milestone per subject", study_id="PHA022121-C301".

**raw_ds_dfs fixture:** Two DataFrames simulating ds + ds2 merge:

ds_df (EOT -- end of treatment):
```python
{
    "Subject": ["001", "002", "003"],
    "SiteNumber": ["101", "101", "102"],
    "DSDECOD": ["Completed", "Adverse Event", "Completed"],
    "DSDECOD_STD": ["COMPLETED", "ADVERSE EVENT", "COMPLETED"],
    "DSSTDAT_RAW": ["30 Jun 2022", "15 May 2022", "30 Jun 2022"],
    "DSCAT": ["DISPOSITION EVENT", "DISPOSITION EVENT", "DISPOSITION EVENT"],
    "projectid": [1, 1, 1],
}
```

ds2_df (EOS -- end of study):
```python
{
    "Subject": ["001", "002", "003"],
    "SiteNumber": ["101", "101", "102"],
    "DSDECOD2": ["Completed", "Adverse Event", "Completed"],
    "DSDECOD2_STD": ["COMPLETED", "ADVERSE EVENT", "COMPLETED"],
    "DSENDAT2_RAW": ["15 Jul 2022", "30 May 2022", "15 Jul 2022"],
    "DSCAT": ["PROTOCOL MILESTONE", "PROTOCOL MILESTONE", "PROTOCOL MILESTONE"],
    "projectid": [1, 1, 1],
}
```

The test must use `align_multi_source_columns` to rename ds2 columns before creating the merged dict:
```python
from astraea.execution.preprocessing import align_multi_source_columns

aligned = align_multi_source_columns(
    {"ds": ds_df, "ds2": ds2_df},
    rename_maps={"ds2": {
        "DSDECOD2": "DSDECOD",
        "DSDECOD2_STD": "DSDECOD_STD",
        "DSENDAT2_RAW": "DSSTDAT_RAW",
    }},
)
result = executor.execute(ds_spec, aligned, study_id="PHA022121-C301")
```

**Test class TestDSEndToEnd:**
- test_output_has_correct_columns: 8 mapped variables
- test_six_rows_from_two_sources: len(result) == 6 (3 from ds + 3 from ds2)
- test_dscat_differentiates_sources: result has both "DISPOSITION EVENT" and "PROTOCOL MILESTONE" in DSCAT
- test_dsdecod_recoded: DSDECOD values match C66727 submission values
- test_dates_converted: DSSTDTC in ISO 8601 format
- test_dsseq_generated: DSSEQ present and correct per USUBJID (2 records per subject -> seq 1, 2)
- test_multi_source_alignment_works: No NaN columns from mismatched names
- test_columns_in_order: STUDYID < DOMAIN < USUBJID
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_ds_execution.py -v` -- all tests pass
  </verify>
  <done>DS domain integration test proves: multi-source merge with column alignment, DSCAT differentiation, disposition event CT recode, --SEQ for multi-record subjects. 8+ tests passing.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_ae_execution.py tests/integration/execution/test_ds_execution.py -v` -- all new tests pass
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest` -- full suite passes
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/execution/test_ae_execution.py tests/integration/execution/test_ds_execution.py` -- no lint errors
</verification>

<success_criteria>
- AE seriousness checkbox 0.0/1.0 values correctly convert to "N"/"Y" via numeric_to_yn REFORMAT
- AE MedDRA terms (AETERM_PT, AETERM_SOC) correctly map to AEDECOD, AEBODSYS
- AE codelist recodes (severity, action taken, outcome) produce valid CT submission values
- DS multi-source merge produces 6 rows (3+3) with no NaN from column misalignment
- DS DSCAT correctly differentiates EOT vs EOS records
- Both domains have --SEQ, correct column order, no EDC column leakage
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-02-SUMMARY.md`
</output>
