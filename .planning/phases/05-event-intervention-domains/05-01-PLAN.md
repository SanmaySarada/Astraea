---
phase: 05-event-intervention-domains
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/transforms/recoding.py
  - src/astraea/mapping/transform_registry.py
  - src/astraea/execution/preprocessing.py
  - src/astraea/execution/__init__.py
  - tests/test_transforms/test_recoding.py
  - tests/unit/execution/test_preprocessing.py
autonomous: true

must_haves:
  truths:
    - "numeric_to_yn converts 0/0.0 to N and 1/1.0 to Y and NaN to None"
    - "Source row filtering removes rows matching a condition before execution"
    - "Multi-source column alignment renames suffixed columns before merge"
  artifacts:
    - path: "src/astraea/transforms/recoding.py"
      provides: "numeric_to_yn transform function"
      exports: ["numeric_to_yn"]
    - path: "src/astraea/execution/preprocessing.py"
      provides: "Pre-execution utilities: filter_rows, align_multi_source_columns"
      exports: ["filter_rows", "align_multi_source_columns"]
    - path: "src/astraea/mapping/transform_registry.py"
      provides: "Updated registry with numeric_to_yn"
      contains: "numeric_to_yn"
  key_links:
    - from: "src/astraea/mapping/transform_registry.py"
      to: "src/astraea/transforms/recoding.py"
      via: "import numeric_to_yn"
      pattern: "from astraea.transforms.recoding import numeric_to_yn"
---

<objective>
Add the three execution infrastructure gaps identified in Phase 5 research: (1) numeric_to_yn transform for AE seriousness checkbox 0/1->Y/N conversion, (2) source row filtering utility for EX EXYN=N exclusion, (3) multi-source column alignment utility for DS/MH column name normalization before merge.

Purpose: These utilities are prerequisites for all 8 domain integration tests in Plans 02-04. Without numeric_to_yn, AE seriousness flags fail CT validation. Without row filtering, EX includes non-administered records. Without column alignment, DS merge produces NaN-filled wide DataFrames.

Output: Three new modules with full test coverage, registered in transform registry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@src/astraea/mapping/transform_registry.py
@src/astraea/execution/pattern_handlers.py
@src/astraea/execution/executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create numeric_to_yn transform and register it</name>
  <files>
    src/astraea/transforms/recoding.py
    src/astraea/mapping/transform_registry.py
    tests/test_transforms/test_recoding.py
  </files>
  <action>
Create `src/astraea/transforms/recoding.py` with a `numeric_to_yn` function:

```python
def numeric_to_yn(value) -> str | None:
    """Convert numeric 0/1 or checkbox values to Y/N for C66742 codelist.

    Handles float64 (0.0/1.0), int (0/1), and string ("0"/"1") inputs.
    Returns None for NaN/missing values.
    """
```

Logic:
- `pd.isna(value)` -> return None
- `isinstance(value, (int, float))`: 1/1.0 -> "Y", 0/0.0 -> "N"
- String fallback: str(value).strip() in ("1", "1.0") -> "Y", ("0", "0.0") -> "N"
- Anything else -> None (conservative, don't guess)

Register in `transform_registry.py`:
- Add import: `from astraea.transforms.recoding import numeric_to_yn`
- Add entry: `"numeric_to_yn": numeric_to_yn` in AVAILABLE_TRANSFORMS dict under a new "# recoding transforms" section

Create `tests/test_transforms/test_recoding.py` with tests:
- test_numeric_1_returns_y (int 1)
- test_numeric_0_returns_n (int 0)
- test_float_1_returns_y (float 1.0)
- test_float_0_returns_n (float 0.0)
- test_nan_returns_none (float("nan"))
- test_none_returns_none (None via pd.isna)
- test_string_1_returns_y ("1")
- test_string_0_returns_n ("0")
- test_string_10_returns_y ("1.0")
- test_string_00_returns_n ("0.0")
- test_unexpected_value_returns_none ("maybe")
- test_registered_in_registry (get_transform("numeric_to_yn") is not None)
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/test_transforms/test_recoding.py -v` -- all tests pass
    `cd /Users/sanmaysarada/Astraea-SDTM && python -c "from astraea.mapping.transform_registry import get_transform; assert get_transform('numeric_to_yn') is not None; print('OK')"` -- prints OK
  </verify>
  <done>numeric_to_yn converts all numeric/string 0/1 variants to Y/N correctly, is registered in transform_registry, 12+ tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Create preprocessing utilities (row filtering + column alignment)</name>
  <files>
    src/astraea/execution/preprocessing.py
    src/astraea/execution/__init__.py
    tests/unit/execution/test_preprocessing.py
  </files>
  <action>
Create `src/astraea/execution/preprocessing.py` with two functions:

**1. filter_rows:**
```python
def filter_rows(
    df: pd.DataFrame,
    *,
    column: str,
    keep_values: set[str] | None = None,
    exclude_values: set[str] | None = None,
) -> pd.DataFrame:
    """Filter source DataFrame rows before execution.

    Exactly one of keep_values or exclude_values must be provided.
    Comparison is case-insensitive string matching after str() conversion.

    Args:
        df: Source DataFrame to filter.
        column: Column name to filter on.
        keep_values: If provided, keep only rows where column value is in this set.
        exclude_values: If provided, remove rows where column value is in this set.

    Returns:
        Filtered DataFrame copy with reset index.

    Raises:
        ValueError: If neither or both of keep_values/exclude_values are provided.
        KeyError: If column not in df.
    """
```

Logic:
- Validate exactly one of keep_values/exclude_values is set
- Validate column exists in df
- Convert column to str, apply .str.strip().str.upper() for case-insensitive matching
- Apply filter, return df copy with reset_index(drop=True)

**2. align_multi_source_columns:**
```python
def align_multi_source_columns(
    dfs: dict[str, pd.DataFrame],
    rename_maps: dict[str, dict[str, str]],
) -> dict[str, pd.DataFrame]:
    """Rename columns in multiple source DataFrames to align before merge.

    Args:
        dfs: Dict of source_name -> DataFrame.
        rename_maps: Dict of source_name -> {old_col: new_col} rename mapping.
            Source names not in rename_maps are passed through unchanged.

    Returns:
        Dict of source_name -> DataFrame with columns renamed. DataFrames are copies.
    """
```

Logic:
- For each source_name in dfs, if source_name is in rename_maps, apply df.rename(columns=rename_maps[source_name])
- Always return copies, never modify originals

Update `src/astraea/execution/__init__.py` to export these:
```python
from astraea.execution.preprocessing import align_multi_source_columns, filter_rows
```

Create `tests/unit/execution/test_preprocessing.py`:

filter_rows tests:
- test_keep_values_filters_correctly (keep_values={"Y"}, only Y rows remain)
- test_exclude_values_filters_correctly (exclude_values={"N"}, N rows removed)
- test_case_insensitive_matching ("y" matches keep_values={"Y"})
- test_missing_column_raises_keyerror
- test_both_keep_and_exclude_raises_valueerror
- test_neither_keep_nor_exclude_raises_valueerror
- test_returns_copy_with_reset_index
- test_empty_result_returns_empty_df

align_multi_source_columns tests:
- test_renames_columns_correctly (DSDECOD2->DSDECOD)
- test_sources_without_rename_pass_through
- test_returns_copies_not_originals
- test_empty_rename_maps_returns_copies
- test_multiple_sources_renamed
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/execution/test_preprocessing.py -v` -- all tests pass
    `cd /Users/sanmaysarada/Astraea-SDTM && python -c "from astraea.execution import filter_rows, align_multi_source_columns; print('OK')"` -- prints OK
  </verify>
  <done>filter_rows and align_multi_source_columns work correctly, 13+ tests passing, importable from astraea.execution</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/test_transforms/test_recoding.py tests/unit/execution/test_preprocessing.py -v` -- all new tests pass
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest` -- full suite still passes (907+ existing tests unbroken)
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check src/astraea/transforms/recoding.py src/astraea/execution/preprocessing.py` -- no lint errors
</verification>

<success_criteria>
- numeric_to_yn handles all input types (int, float, str, NaN, None) and returns Y/N/None
- filter_rows can exclude EX rows where EXYN_STD="N"
- align_multi_source_columns can rename DS2 suffixed columns to match DS
- All utilities are importable from their public APIs
- Full test suite passes with 0 regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-01-SUMMARY.md`
</output>
