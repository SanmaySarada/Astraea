---
phase: 05-event-intervention-domains
plan: 07
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/integration/mapping/test_mh_mapping.py
  - tests/integration/mapping/test_ie_mapping.py
  - tests/integration/mapping/test_ce_mapping.py
  - tests/integration/mapping/test_dv_mapping.py
autonomous: false

must_haves:
  truths:
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for MH from two source files"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for IE (Findings-class, no transpose)"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for CE with HAE attack events"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for DV with non-standard column names"
  artifacts:
    - path: "tests/integration/mapping/test_mh_mapping.py"
      provides: "MH domain LLM mapping integration test"
      min_lines: 80
    - path: "tests/integration/mapping/test_ie_mapping.py"
      provides: "IE domain LLM mapping integration test"
      min_lines: 60
    - path: "tests/integration/mapping/test_ce_mapping.py"
      provides: "CE domain LLM mapping integration test"
      min_lines: 70
    - path: "tests/integration/mapping/test_dv_mapping.py"
      provides: "DV domain LLM mapping integration test"
      min_lines: 60
  key_links:
    - from: "tests/integration/mapping/test_mh_mapping.py"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.map_domain()"
      pattern: "engine\\.map_domain"
    - from: "tests/integration/mapping/test_dv_mapping.py"
      to: "src/astraea/models/mapping.py"
      via: "DomainMappingSpec with non-standard source"
      pattern: "DomainMappingSpec"

user_setup:
  - service: anthropic
    why: "LLM calls to Claude for mapping proposal generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
---

<objective>
Run MappingEngine.map_domain() on real Fakedata for the 4 simpler Phase 5 domains (MH, IE, CE, DV) to produce actual DomainMappingSpec artifacts. Together with Plan 06, this completes mapping spec generation for all 8 Event/Intervention domains.

Purpose: Completes Success Criteria #1 coverage. MH validates multi-source MedDRA mapping. IE validates Findings-class without transpose. CE validates study-specific clinical events. DV validates non-standard source format handling.

Output: Four integration test files following the proven test_dm_mapping.py pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@tests/integration/mapping/test_dm_mapping.py
@src/astraea/mapping/engine.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: MH and IE domain LLM mapping integration tests</name>
  <files>
    tests/integration/mapping/test_mh_mapping.py
    tests/integration/mapping/test_ie_mapping.py
  </files>
  <action>
Create two integration test files following the test_dm_mapping.py pattern.

**MH mapping test** (`tests/integration/mapping/test_mh_mapping.py`):

Helper `_build_mh_ecrf_form()`: Create ECRFForm for MH with fields for MHTERM, MedDRA coded terms (_PT, _SOC), onset date, ongoing flag.

`mh_mapping_result` fixture (module-scoped):
- Profile BOTH mh.sas7bdat AND haemh.sas7bdat from Fakedata/
- Note: haemh_screen.sas7bdat has 0 rows -- skip or include but expect it to not contribute
- Pass both profiles to engine.map_domain(domain="MH", source_profiles=[mh_profile, haemh_profile], ...)

Test class TestMHMappingEndToEnd:
- test_domain_is_mh: spec.domain == "MH"
- test_sufficient_variable_count: total_variables >= 8
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, MHSEQ, MHTERM present
- test_mhdecod_mapped: MHDECOD present (MedDRA Preferred Term)
- test_dates_mapped: MHSTDTC present
- test_high_confidence_exists
- test_multiple_source_datasets: spec.source_datasets has 2 entries (mh + haemh)

Test class TestMHCTValidation:
- test_yn_codelist_if_present: If MHPRESP or MHOCCUR mapped, references C66742

Test class TestMHExportRoundtrip:
- test_json_export_roundtrip

**IE mapping test** (`tests/integration/mapping/test_ie_mapping.py`):

Helper `_build_ie_ecrf_form()`: Create ECRFForm for IE with fields for IETESTCD, IETEST, IECAT (inclusion/exclusion), IEORRES, date.

`ie_mapping_result` fixture (module-scoped):
- Profile ie.sas7bdat from Fakedata/
- Call engine.map_domain(domain="IE", ...)
- IE is Findings-class but no transpose is needed (one row per criterion)

Test class TestIEMappingEndToEnd:
- test_domain_is_ie: spec.domain == "IE"
- test_sufficient_variable_count: total_variables >= 7
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, IESEQ, IETESTCD, IETEST, IECAT present
- test_findings_class: spec.domain_class == "Findings" (validates non-transpose Findings work)
- test_high_confidence_exists
- test_ieorres_mapped: At least IEORRES or IESTRESC present

Test class TestIEExportRoundtrip:
- test_json_export_roundtrip
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_mh_mapping.py tests/integration/mapping/test_ie_mapping.py -v --timeout=120` -- all tests pass
    Without API key: tests skipped gracefully
  </verify>
  <done>MH and IE mapping specs generated from real Fakedata. MH: multi-source with MedDRA, IE: Findings-class without transpose. Both have required variables mapped.</done>
</task>

<task type="auto">
  <name>Task 2: CE and DV domain LLM mapping integration tests</name>
  <files>
    tests/integration/mapping/test_ce_mapping.py
    tests/integration/mapping/test_dv_mapping.py
  </files>
  <action>
Create two more integration test files.

**CE mapping test** (`tests/integration/mapping/test_ce_mapping.py`):

Helper `_build_ce_ecrf_form()`: Create ECRFForm for CE with fields for CETERM (HAE attack types), CEDECOD, location checkboxes, severity, dates.

`ce_mapping_result` fixture (module-scoped):
- Profile ce.sas7bdat from Fakedata/
- Call engine.map_domain(domain="CE", ...)

Test class TestCEMappingEndToEnd:
- test_domain_is_ce: spec.domain == "CE"
- test_sufficient_variable_count: total_variables >= 7
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, CESEQ, CETERM present
- test_cedecod_mapped: CEDECOD present
- test_dates_mapped: CESTDTC present
- test_high_confidence_exists

Test class TestCECTValidation:
- test_yn_codelist_if_present: If CEPRESP or CEOCCUR mapped, references C66742

Test class TestCEExportRoundtrip:
- test_json_export_roundtrip

**DV mapping test** (`tests/integration/mapping/test_dv_mapping.py`):

Helper `_build_dv_ecrf_form()`: Create ECRFForm for DV with fields matching the non-standard column names (Description, Category, Date_Occurred, Subject_ID, Site_Number).

`dv_mapping_result` fixture (module-scoped):
- Profile dv.sas7bdat from Fakedata/
- Call engine.map_domain(domain="DV", ...)
- DV has non-standard column names -- the LLM must handle this

Test class TestDVMappingEndToEnd:
- test_domain_is_dv: spec.domain == "DV"
- test_sufficient_variable_count: total_variables >= 6
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, DVSEQ, DVTERM present
- test_dates_mapped: DVSTDTC present
- test_high_confidence_exists
- test_non_standard_source_handled: At least one mapping references a non-standard source variable (Description, Category, Date_Occurred, etc.)

Test class TestDVExportRoundtrip:
- test_json_export_roundtrip
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_ce_mapping.py tests/integration/mapping/test_dv_mapping.py -v --timeout=120` -- all tests pass
    Without API key: tests skipped gracefully
  </verify>
  <done>CE and DV mapping specs generated from real Fakedata. CE: HAE attack events with Y/N codelist. DV: non-standard column names handled. Both have required variables mapped.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_mh_mapping.py tests/integration/mapping/test_ie_mapping.py tests/integration/mapping/test_ce_mapping.py tests/integration/mapping/test_dv_mapping.py -v --timeout=300` -- all tests pass with API key
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/mapping/ -v` -- LLM tests skipped gracefully without API key
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/mapping/` -- no lint errors
</verification>

<success_criteria>
- MappingEngine.map_domain() produces valid DomainMappingSpec for MH, IE, CE, DV from real Fakedata
- All required SDTM variables present in each spec
- MH references both source datasets (mh + haemh)
- IE correctly identified as Findings-class
- DV handles non-standard column naming
- Tests skip gracefully without ANTHROPIC_API_KEY
- Combined with Plan 06, all 8 Phase 5 domains have LLM-generated mapping specs
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-07-SUMMARY.md`
</output>
