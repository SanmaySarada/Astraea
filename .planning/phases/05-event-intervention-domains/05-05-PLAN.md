---
phase: 05-event-intervention-domains
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04"]
files_modified:
  - tests/integration/execution/test_cross_domain_validation.py
  - tests/integration/execution/test_xpt_output.py
autonomous: true

must_haves:
  truths:
    - "Cross-domain USUBJID validation catches orphan subjects not in DM"
    - "All 8 domains produce valid XPT files via execute_to_xpt"
    - "--DY calculation works correctly across domains using cross-domain RFSTDTC"
    - "EPOCH is derived from CrossDomainContext SE data when available"
    - "Variable origin metadata is populated on VariableMapping and accessible post-execution"
  artifacts:
    - path: "tests/integration/execution/test_cross_domain_validation.py"
      provides: "Cross-domain USUBJID validation, --DY, EPOCH, and origin metadata tests"
      min_lines: 120
    - path: "tests/integration/execution/test_xpt_output.py"
      provides: "XPT file generation test for multiple domains"
      min_lines: 80
  key_links:
    - from: "tests/integration/execution/test_cross_domain_validation.py"
      to: "src/astraea/execution/executor.py"
      via: "DatasetExecutor.validate_cross_domain_usubjid()"
      pattern: "validate_cross_domain_usubjid"
    - from: "tests/integration/execution/test_xpt_output.py"
      to: "src/astraea/execution/executor.py"
      via: "DatasetExecutor.execute_to_xpt()"
      pattern: "execute_to_xpt"
---

<objective>
Validate cross-domain consistency, XPT output generation, EPOCH derivation, and variable origin metadata across all Phase 5 domains. This plan proves: (1) cross-domain USUBJID validation catches orphan subjects, (2) --DY calculation works with cross-domain RFSTDTC lookup, (3) EPOCH is correctly assigned from SE data, (4) variable origin metadata is populated for define.xml traceability, and (5) all domains can produce valid .xpt files.

Purpose: Individual domain tests in Plans 02-04 prove each domain in isolation. This plan proves they work TOGETHER -- consistent USUBJIDs across domains, study day derivation, epoch assignment, origin tracking, and actual XPT file output.

Output: Two integration test files proving cross-domain coherence, EPOCH derivation, origin metadata, and XPT output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@src/astraea/execution/executor.py
@src/astraea/io/xpt_writer.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-domain validation, --DY, EPOCH, and origin metadata tests</name>
  <files>tests/integration/execution/test_cross_domain_validation.py</files>
  <action>
Create `tests/integration/execution/test_cross_domain_validation.py`.

Create synthetic DM and AE DataFrames that share the same 3 subjects, plus an AE DataFrame with an orphan subject.

**Fixtures:**

dm_df fixture: Pre-built DM DataFrame (not going through executor, just the reference):
```python
pd.DataFrame({
    "STUDYID": ["PHA022121-C301"] * 3,
    "DOMAIN": ["DM"] * 3,
    "USUBJID": [
        "PHA022121-C301-101-001",
        "PHA022121-C301-101-002",
        "PHA022121-C301-102-003",
    ],
    "RFSTDTC": ["2022-01-01", "2022-01-15", "2022-02-01"],
})
```

ae_spec and raw_ae_df fixtures: Minimal AE spec with STUDYID, DOMAIN, USUBJID, AESEQ, AETERM, AESTDTC, AESTDY, and EPOCH. Same 3 subjects as DM.

```python
raw_ae_df = pd.DataFrame({
    "Subject": ["001", "002", "003"],
    "SiteNumber": ["101", "101", "102"],
    "AETERM": ["Headache", "Nausea", "Fatigue"],
    "AESTDAT_RAW": ["15 Jan 2022", "01 Feb 2022", "15 Mar 2022"],
})
```

ae_with_orphan_df: Same as raw_ae_df but includes a 4th row with Subject "999" (not in DM).

CrossDomainContext with both rfstdtc_lookup AND se_data (for EPOCH):
```python
cross_domain = CrossDomainContext(
    rfstdtc_lookup={
        "PHA022121-C301-101-001": "2022-01-01",
        "PHA022121-C301-101-002": "2022-01-15",
        "PHA022121-C301-102-003": "2022-02-01",
    },
    se_data=pd.DataFrame({
        "USUBJID": [
            "PHA022121-C301-101-001", "PHA022121-C301-101-001",
            "PHA022121-C301-101-002", "PHA022121-C301-101-002",
            "PHA022121-C301-102-003", "PHA022121-C301-102-003",
        ],
        "EPOCH": ["SCREENING", "TREATMENT", "SCREENING", "TREATMENT", "SCREENING", "TREATMENT"],
        "SESTDTC": ["2021-12-15", "2022-01-01", "2021-12-20", "2022-01-15", "2022-01-10", "2022-02-01"],
        "SEENDTC": ["2021-12-31", "2022-06-30", "2022-01-14", "2022-06-30", "2022-01-31", "2022-06-30"],
    }),
)
```

**Test class TestCrossDomainValidation:**
- test_all_subjects_in_dm_passes: validate_cross_domain_usubjid(dm_df, {"AE": ae_result}) returns empty list when all subjects match
- test_orphan_subject_detected: validate_cross_domain_usubjid(dm_df, {"AE": ae_with_orphan_result}) returns error for subject 999
- test_multiple_domains_validated: validate with {"AE": ae_df, "CM": cm_df} where CM has consistent subjects

**Test class TestStudyDayDerivation:**
- test_aestdy_derived_from_rfstdtc: Execute AE spec with AESTDY mapping and CrossDomainContext.rfstdtc_lookup populated from DM. Verify:
  - Subject 001: AESTDTC="2022-01-15", RFSTDTC="2022-01-01" -> AESTDY=15
  - Subject 002: AESTDTC="2022-02-01", RFSTDTC="2022-01-15" -> AESTDY=18
  - Subject 003: AESTDTC="2022-03-15", RFSTDTC="2022-02-01" -> AESTDY=43

For --DY test, add AESTDY to the ae_spec:
```python
VariableMapping(
    sdtm_variable="AESTDY",
    mapping_pattern=MappingPattern.DERIVATION,
    derivation_rule="calculate_study_day",
    ...
)
```

- test_dy_without_cross_domain_context: Execute without CrossDomainContext -- AESTDY should not be present or should be NaN (graceful handling)

**Test class TestEpochDerivation:**
- test_epoch_assigned_from_se_data: Execute AE spec with EPOCH mapping and CrossDomainContext.se_data populated. Add EPOCH to spec:
```python
VariableMapping(
    sdtm_variable="EPOCH",
    mapping_pattern=MappingPattern.DERIVATION,
    derivation_rule="assign_epoch",
    ...
)
```
  Verify:
  - Subject 001: AESTDTC="2022-01-15" falls within TREATMENT epoch (2022-01-01 to 2022-06-30) -> EPOCH="TREATMENT"
  - Subject 002: AESTDTC="2022-02-01" falls within TREATMENT epoch -> EPOCH="TREATMENT"
  - Subject 003: AESTDTC="2022-03-15" falls within TREATMENT epoch -> EPOCH="TREATMENT"
- test_epoch_without_se_data: Execute without se_data in CrossDomainContext -- EPOCH should be empty/NaN (graceful handling)

**Test class TestVariableOriginMetadata:**
- test_origin_populated_on_assign: For STUDYID (ASSIGN pattern), verify VariableMapping.origin == VariableOrigin.ASSIGNED
- test_origin_populated_on_direct: For AETERM (DIRECT pattern), verify VariableMapping.origin == VariableOrigin.CRF
- test_origin_populated_on_derivation: For AESTDY (DERIVATION pattern), verify VariableMapping.origin == VariableOrigin.DERIVED
- test_origin_accessible_after_execution: After executing, the spec's variable_mappings still have origin populated -- origin survives the execution pipeline
- test_all_mappings_have_origin: Loop through all variable_mappings in the AE spec and verify every mapping has a non-None origin value
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_cross_domain_validation.py -v` -- all tests pass
  </verify>
  <done>Cross-domain USUBJID validation catches orphans. --DY calculation correct. EPOCH derived from SE data. Variable origin metadata populated for all mapping patterns (CRF, Derived, Assigned). 12+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: XPT file output test for multiple domains</name>
  <files>tests/integration/execution/test_xpt_output.py</files>
  <action>
Create `tests/integration/execution/test_xpt_output.py`.

This test verifies that execute_to_xpt produces readable .xpt files for AE and CM domains (representative of all domain types). Uses tmp_path fixture for output.

**Fixtures:**
Reuse minimal spec+data patterns from earlier tests (keep small -- just enough to exercise XPT writing).

ae_spec: Minimal AE spec with 6 variables: STUDYID, DOMAIN, USUBJID, AESEQ, AETERM, AESTDTC
cm_spec: Minimal CM spec with 6 variables: STUDYID, DOMAIN, USUBJID, CMSEQ, CMTRT, CMSTDTC
raw_ae_df: 3 rows of synthetic AE data
raw_cm_df: 3 rows of synthetic CM data

**Test class TestXPTOutput:**
- test_ae_xpt_created: execute_to_xpt produces ae.xpt file that exists
- test_ae_xpt_readable: pyreadstat.read_xport() can read the produced file, returns correct shape (3 rows, 6 cols)
- test_ae_xpt_labels_present: Column labels (STUDYID -> "Study Identifier", AETERM -> "Reported Term for the Adverse Event") are preserved in XPT metadata
- test_ae_xpt_table_name: XPT metadata table_name == "AE"
- test_cm_xpt_created: execute_to_xpt produces cm.xpt file
- test_cm_xpt_readable: read back, correct shape
- test_xpt_variable_names_valid: All variable names <= 8 chars
- test_xpt_labels_valid: All labels <= 40 chars

Read-back pattern:
```python
import pyreadstat
df, meta = pyreadstat.read_xport(str(xpt_path))
assert df.shape == (3, 6)
assert meta.column_labels is not None
```
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_xpt_output.py -v` -- all tests pass
  </verify>
  <done>XPT output verified: files created, readable by pyreadstat, correct shapes, labels preserved, variable names within limits. 8+ tests passing.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/execution/test_cross_domain_validation.py tests/integration/execution/test_xpt_output.py -v` -- all new tests pass
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest` -- full suite passes (907+ existing + all new Phase 5 tests)
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/execution/` -- no lint errors
</verification>

<success_criteria>
- Cross-domain USUBJID validation detects orphan subjects not in DM
- --DY correctly computes study day from RFSTDTC for 3 subjects
- EPOCH correctly derived from SE data (all 3 subjects in TREATMENT epoch)
- EPOCH handles missing SE data gracefully
- Variable origin metadata (CRF, Derived, Assigned) is populated on all VariableMappings and survives execution
- AE and CM domains produce valid .xpt files readable by pyreadstat
- XPT metadata (labels, table name) is correctly written
- Full test suite passes with all Phase 5 tests included
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-05-SUMMARY.md`
</output>
