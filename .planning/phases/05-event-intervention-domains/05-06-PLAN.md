---
phase: 05-event-intervention-domains
plan: 06
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/integration/mapping/test_ae_mapping.py
  - tests/integration/mapping/test_cm_mapping.py
  - tests/integration/mapping/test_ex_mapping.py
  - tests/integration/mapping/test_ds_mapping.py
autonomous: false

must_haves:
  truths:
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for AE with all required variables and CT codelists"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for CM with dose, route, frequency mappings"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for EX from two source files"
    - "MappingEngine.map_domain() produces a complete DomainMappingSpec for DS from two source files with column alignment"
  artifacts:
    - path: "tests/integration/mapping/test_ae_mapping.py"
      provides: "AE domain LLM mapping integration test"
      min_lines: 120
    - path: "tests/integration/mapping/test_cm_mapping.py"
      provides: "CM domain LLM mapping integration test"
      min_lines: 100
    - path: "tests/integration/mapping/test_ex_mapping.py"
      provides: "EX domain LLM mapping integration test"
      min_lines: 100
    - path: "tests/integration/mapping/test_ds_mapping.py"
      provides: "DS domain LLM mapping integration test"
      min_lines: 100
  key_links:
    - from: "tests/integration/mapping/test_ae_mapping.py"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.map_domain()"
      pattern: "engine\\.map_domain"
    - from: "tests/integration/mapping/test_ae_mapping.py"
      to: "src/astraea/models/mapping.py"
      via: "DomainMappingSpec validation"
      pattern: "DomainMappingSpec"

user_setup:
  - service: anthropic
    why: "LLM calls to Claude for mapping proposal generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
---

<objective>
Run MappingEngine.map_domain() on real Fakedata for the 4 complex Phase 5 domains (AE, CM, EX, DS) to produce actual DomainMappingSpec artifacts. This closes the blocker gap: existing plans 02-04 test execution with hand-crafted specs but never exercise the LLM-based mapping pipeline that is the phase goal.

Purpose: Success Criteria #1 requires "complete, reviewable mapping specifications" produced by the system. This plan proves the MappingEngine can generate valid specs for the 4 most complex Event/Intervention domains using real study data. The specs are validated for required variables, CT codelist references, mapping patterns, and confidence scores.

Output: Four integration test files following the proven test_dm_mapping.py pattern. Each runs one LLM call (module-scoped fixture), then validates the resulting DomainMappingSpec.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-event-intervention-domains/05-RESEARCH.md
@tests/integration/mapping/test_dm_mapping.py
@src/astraea/mapping/engine.py
@src/astraea/models/mapping.py
@src/astraea/models/ecrf.py
@src/astraea/models/profiling.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AE and CM domain LLM mapping integration tests</name>
  <files>
    tests/integration/mapping/test_ae_mapping.py
    tests/integration/mapping/test_cm_mapping.py
  </files>
  <action>
Create two integration test files following the exact pattern of `tests/integration/mapping/test_dm_mapping.py`:
- Module-scoped fixture that runs MappingEngine.map_domain() once
- @pytest.mark.integration + skipif(no ANTHROPIC_API_KEY)
- Profile real Fakedata SAS files with profile_dataset()
- Build representative ECRFForm from known dataset structure
- Validate resulting DomainMappingSpec

**AE mapping test** (`tests/integration/mapping/test_ae_mapping.py`):

Helper `_build_ae_ecrf_form()`: Create ECRFForm for AE with fields for AETERM, seriousness checkboxes (AESDTH, AESLIFE, AESHOSP -- float 0/1), severity (AEGRSER), MedDRA coded terms (_PT, _SOC), action taken, outcome, causality, dates.

`ae_mapping_result` fixture (module-scoped):
- Profile ae.sas7bdat from Fakedata/
- Build AE eCRF form
- Call engine.map_domain(domain="AE", ...)
- Display spec for human inspection (visible with pytest -s)

Test class TestAEMappingEndToEnd:
- test_domain_is_ae: spec.domain == "AE"
- test_sufficient_variable_count: total_variables >= 15 (AE has 29 possible)
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, AESEQ, AETERM, AEDECOD all present
- test_studyid_is_assign: STUDYID uses ASSIGN pattern
- test_aeterm_has_source: AETERM is DIRECT or RENAME from a source variable
- test_aedecod_has_source: AEDECOD mapped (should be from AETERM_PT or similar MedDRA column)
- test_seriousness_flags_mapped: At least AESDTH, AESER, AESLIFE present in mappings
- test_dates_mapped: AESTDTC present in mappings
- test_high_confidence_exists: high_confidence_count > 0
- test_required_vars_reasonable_confidence: all Required vars have confidence >= 0.5

Test class TestAECTValidation:
- test_severity_references_codelist: AESEV or AETOXGR mapping references C66769 or has reasonable CT
- test_outcome_references_codelist: AEOUT references C66768
- test_action_references_codelist: AEACN references C66767

Test class TestAEExportRoundtrip:
- test_json_export_roundtrip: Export to JSON, read back, validate round-trip

**CM mapping test** (`tests/integration/mapping/test_cm_mapping.py`):

Helper `_build_cm_ecrf_form()`: Create ECRFForm for CM with fields for CMTRT, CMDOSE, route, frequency, indication, dates (including partial date patterns).

`cm_mapping_result` fixture (module-scoped):
- Profile cm.sas7bdat from Fakedata/
- Call engine.map_domain(domain="CM", ...)

Test class TestCMMappingEndToEnd:
- test_domain_is_cm: spec.domain == "CM"
- test_sufficient_variable_count: total_variables >= 10
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, CMSEQ, CMTRT present
- test_cmtrt_has_source: CMTRT mapped from source
- test_dates_mapped: CMSTDTC present
- test_high_confidence_exists
- test_dose_variables_mapped: At least one of CMDOSE, CMDOSU, CMROUTE present

Test class TestCMCTValidation:
- test_route_references_codelist: CMROUTE references C66729 if present
- test_frequency_references_codelist: CMDOSFRQ references C71113 if present
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_ae_mapping.py tests/integration/mapping/test_cm_mapping.py -v --timeout=120` -- all tests pass (requires API key)
    Without API key: `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/mapping/test_ae_mapping.py tests/integration/mapping/test_cm_mapping.py -v` -- all tests skipped (not failed)
  </verify>
  <done>AE and CM mapping specs generated by MappingEngine from real Fakedata. AE: required vars mapped, CT codelists referenced, seriousness flags present. CM: dose/route/frequency mapped, dates present. Both export to JSON round-trip.</done>
</task>

<task type="auto">
  <name>Task 2: EX and DS domain LLM mapping integration tests</name>
  <files>
    tests/integration/mapping/test_ex_mapping.py
    tests/integration/mapping/test_ds_mapping.py
  </files>
  <action>
Create two more integration test files following the same pattern.

**EX mapping test** (`tests/integration/mapping/test_ex_mapping.py`):

Helper `_build_ex_ecrf_form()`: Create ECRFForm for EX with fields for EXTRT, dose, route, dates, EXYN (administered flag).

`ex_mapping_result` fixture (module-scoped):
- Profile BOTH ex.sas7bdat AND ex_ole.sas7bdat from Fakedata/
- Pass both profiles as source_profiles to engine.map_domain(domain="EX", source_profiles=[ex_profile, ex_ole_profile], ...)
- This tests multi-source mapping

Test class TestEXMappingEndToEnd:
- test_domain_is_ex: spec.domain == "EX"
- test_sufficient_variable_count: total_variables >= 8
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, EXSEQ, EXTRT present
- test_extrt_has_source: EXTRT mapped from source
- test_dates_mapped: EXSTDTC present
- test_high_confidence_exists
- test_multiple_source_datasets: spec.source_datasets has 2 entries (ex + ex_ole)

Test class TestEXCTValidation:
- test_dose_form_references_codelist: EXDOSFRM references C66726 if present
- test_route_references_codelist: EXROUTE references C66729 if present

**DS mapping test** (`tests/integration/mapping/test_ds_mapping.py`):

Helper `_build_ds_ecrf_form()`: Create ECRFForm for DS with fields for disposition event, date, category.

`ds_mapping_result` fixture (module-scoped):
- Profile BOTH ds.sas7bdat AND ds2.sas7bdat from Fakedata/
- Pass both profiles to engine.map_domain(domain="DS", source_profiles=[ds_profile, ds2_profile], ...)

Test class TestDSMappingEndToEnd:
- test_domain_is_ds: spec.domain == "DS"
- test_sufficient_variable_count: total_variables >= 6
- test_required_variables_mapped: STUDYID, DOMAIN, USUBJID, DSSEQ, DSTERM, DSDECOD present
- test_dates_mapped: DSSTDTC present
- test_high_confidence_exists
- test_multiple_source_datasets: spec.source_datasets has 2 entries (ds + ds2)

Test class TestDSCTValidation:
- test_dsdecod_references_codelist: DSDECOD references C66727

Test class TestDSExportRoundtrip:
- test_json_export_roundtrip
  </action>
  <verify>
    `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_ex_mapping.py tests/integration/mapping/test_ds_mapping.py -v --timeout=120` -- all tests pass
    Without API key: tests skipped gracefully
  </verify>
  <done>EX and DS mapping specs generated from real Fakedata with multi-source profiles. Both correctly reference multiple source datasets, required variables mapped, CT codelists referenced.</done>
</task>

</tasks>

<verification>
1. `cd /Users/sanmaysarada/Astraea-SDTM && ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY python -m pytest tests/integration/mapping/test_ae_mapping.py tests/integration/mapping/test_cm_mapping.py tests/integration/mapping/test_ex_mapping.py tests/integration/mapping/test_ds_mapping.py -v --timeout=300` -- all tests pass with API key
2. `cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/integration/mapping/ -v` -- LLM tests skipped gracefully without API key, all other tests pass
3. `cd /Users/sanmaysarada/Astraea-SDTM && ruff check tests/integration/mapping/` -- no lint errors
</verification>

<success_criteria>
- MappingEngine.map_domain() produces valid DomainMappingSpec for AE, CM, EX, DS from real Fakedata
- All required SDTM variables are present in each spec
- CT codelist references are correct (C66769, C66768, C66767 for AE; C66729, C71113 for CM; C66726, C66729 for EX; C66727 for DS)
- Multi-source domains (EX, DS) reference both source datasets
- Specs export to JSON and round-trip successfully
- Tests skip gracefully when ANTHROPIC_API_KEY is not set
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-intervention-domains/05-06-SUMMARY.md`
</output>
