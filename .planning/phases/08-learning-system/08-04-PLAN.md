---
phase: 08-learning-system
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/astraea/learning/template_library.py
  - tests/unit/learning/test_template_library.py
autonomous: true

must_haves:
  truths:
    - "Approved domain mapping patterns are abstracted into reusable templates"
    - "Templates capture the mapping shape (pattern distribution, variable patterns) not study-specific details"
    - "When mapping a new study, relevant templates can be matched by domain"
    - "Templates include quality signals (accuracy_rate from metrics)"
  artifacts:
    - path: "src/astraea/learning/template_library.py"
      provides: "DomainTemplate model and TemplateLibrary for cross-study reuse"
      exports: ["DomainTemplate", "VariablePattern", "TemplateLibrary"]
  key_links:
    - from: "src/astraea/learning/template_library.py"
      to: "src/astraea/learning/example_store.py"
      via: "reads examples and metrics to build templates"
      pattern: "ExampleStore"
    - from: "src/astraea/learning/template_library.py"
      to: "src/astraea/models/mapping.py"
      via: "reads DomainMappingSpec for template construction"
      pattern: "DomainMappingSpec"
---

<objective>
Build the cross-study template library that abstracts approved domain mappings into reusable patterns, enabling the system to start new study mappings from a proven template rather than from scratch.

Purpose: Templates provide a higher-level learning signal than individual variable examples -- they capture the "shape" of a successful domain mapping.
Output: TemplateLibrary class with domain template creation, storage, and matching.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-learning-system/08-RESEARCH.md

@src/astraea/learning/models.py
@src/astraea/learning/example_store.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain template models and TemplateLibrary</name>
  <files>
    src/astraea/learning/template_library.py
    tests/unit/learning/test_template_library.py
  </files>
  <action>
    Create `src/astraea/learning/template_library.py`:

    1. **VariablePattern(BaseModel)** -- study-independent variable mapping pattern:
       - `sdtm_variable: str`
       - `typical_pattern: str` (most common mapping_pattern for this variable across studies)
       - `typical_source_keywords: list[str]` (keywords from source variable names/labels, e.g., ["birth", "date"] for BRTHDTC)
       - `derivation_template: str | None = None` (generalized derivation logic)
       - `common_issues: list[str] = []` (issues found during past reviews for this variable)

    2. **DomainTemplate(BaseModel)** -- reusable domain mapping template:
       - `template_id: str` (UUID default_factory)
       - `domain: str`
       - `domain_class: str` (Events/Interventions/Findings/Special Purpose)
       - `source_study_ids: list[str]` (studies this template was derived from)
       - `pattern_distribution: dict[str, int]` (e.g., {"direct": 8, "derivation": 5, "assign": 3})
       - `variable_patterns: list[VariablePattern]`
       - `accuracy_rate: float` (from study metrics, averaged across source studies)
       - `created_at: str`
       - `updated_at: str`

    3. **TemplateLibrary** class:
       - `__init__(self, db_path: Path)` -- opens SQLite DB (can share DB with ExampleStore or use separate file).
         Create table `domain_templates`: id, template_id (TEXT UNIQUE), domain, domain_class, source_study_ids_json, pattern_distribution_json, variable_patterns_json, accuracy_rate, created_at, updated_at.

       - `build_template(self, domain: str, specs: list[DomainMappingSpec], metrics: list[StudyMetrics] | None = None) -> DomainTemplate`:
         - Takes one or more completed DomainMappingSpecs (from different studies, same domain).
         - For each SDTM variable that appears across specs:
           - Determine typical_pattern (mode of mapping_pattern across specs)
           - Extract typical_source_keywords from source_variable names and mapping_logic (split on underscores, spaces; lowercase; deduplicate)
           - Set derivation_template from the most common derivation_rule (if derivation pattern)
           - Collect common_issues (empty for now -- would be populated from corrections)
         - Compute pattern_distribution: count of each mapping pattern across all variables
         - Average accuracy_rate from metrics (or 0.0 if no metrics)
         - Return DomainTemplate.

       - `save_template(self, template: DomainTemplate) -> None`:
         Upsert into domain_templates table (INSERT OR REPLACE on template domain).

       - `get_template(self, domain: str) -> DomainTemplate | None`:
         Retrieve template by domain code. Return None if not found.

       - `get_all_templates(self) -> list[DomainTemplate]`:
         Return all stored templates.

       - `update_template(self, domain: str, new_spec: DomainMappingSpec, new_metrics: StudyMetrics | None = None) -> DomainTemplate`:
         Load existing template, merge the new spec's patterns into it:
         - Add new study_id to source_study_ids
         - Update pattern_distribution
         - Update variable_patterns (merge new variables, update typical_pattern if changed)
         - Recalculate accuracy_rate (weighted average: existing weight = len(source_study_ids) - 1)
         - Save and return updated template.

       - `close() -> None`: Close SQLite connection.

    Tests in `tests/unit/learning/test_template_library.py`:
    - Test build_template from single DomainMappingSpec.
    - Test build_template correctly computes pattern_distribution (count direct, assign, derivation, etc.).
    - Test build_template extracts variable_patterns with typical_pattern.
    - Test typical_source_keywords extraction (e.g., "AETERM" -> ["aeterm"], mapping_logic "Direct carry from source ae.AETERM" -> ["direct", "carry", "source", "ae", "aeterm"]).
    - Test save_template and get_template round-trip.
    - Test get_template returns None for non-existent domain.
    - Test update_template merges new spec (adds study_id, updates patterns).
    - Test get_all_templates returns all saved.
    - Test accuracy_rate averaging from metrics.

    Use tmp_path for SQLite. Create minimal DomainMappingSpec and VariableMapping fixtures.
  </action>
  <verify>pytest tests/unit/learning/test_template_library.py -v passes all tests</verify>
  <done>TemplateLibrary builds, stores, retrieves, and updates domain templates from completed mapping specs. All tests pass.</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/learning/ -v` -- all learning tests pass
- `ruff check src/astraea/learning/template_library.py`
- `python -c "from astraea.learning.template_library import TemplateLibrary, DomainTemplate; print('OK')"`
</verification>

<success_criteria>
- DomainTemplate captures mapping shape (pattern distribution, variable patterns, quality signal)
- TemplateLibrary builds templates from DomainMappingSpecs
- Templates persist to SQLite and can be retrieved by domain
- Templates can be updated when new studies are processed
- All tests pass, ruff clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-learning-system/08-04-SUMMARY.md`
</output>
