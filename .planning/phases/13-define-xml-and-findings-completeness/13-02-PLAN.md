---
phase: 13-define-xml-and-findings-completeness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/submission/define_xml.py
  - tests/unit/submission/test_define_xml.py
autonomous: true

must_haves:
  truths:
    - "ItemRef has KeySequence attribute for key variables"
    - "ItemGroupDef has def:Label attribute"
    - "--SEQ variables have DataType=integer (not float)"
    - "def:Origin has Source attribute"
    - "ODM root has Originator and AsOfDateTime attributes"
  artifacts:
    - path: "src/astraea/submission/define_xml.py"
      provides: "KeySequence, def:Label, integer DataType, Origin Source, Originator/AsOfDateTime"
      contains: "KeySequence"
    - path: "tests/unit/submission/test_define_xml.py"
      provides: "Tests for each MED-06 through MED-10 attribute"
      min_lines: 400
  key_links:
    - from: "src/astraea/submission/define_xml.py"
      to: "src/astraea/data/sdtm_ig/domains.json"
      via: "SDTMReference for key_variables lookup"
      pattern: "key_variables"
---

<objective>
Add missing define.xml attributes: KeySequence on ItemRef (MED-06), def:Label on ItemGroupDef (MED-07), integer DataType for --SEQ (MED-08), def:Origin Source (MED-09), ODM Originator/AsOfDateTime (MED-10).

Purpose: These missing attributes cause P21 define.xml validation warnings. Each is a small addition but collectively they improve define.xml compliance significantly.
Output: Updated define_xml.py with all five attribute additions and corresponding tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-define-xml-and-findings-completeness/13-RESEARCH.md

@src/astraea/submission/define_xml.py
@tests/unit/submission/test_define_xml.py
@src/astraea/models/sdtm.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KeySequence, def:Label, integer DataType for --SEQ</name>
  <files>
    src/astraea/submission/define_xml.py
    tests/unit/submission/test_define_xml.py
  </files>
  <action>
1. **MED-06: KeySequence on ItemRef.** Update `_add_item_group()` to accept an optional `key_variables: list[str] | None` parameter. When provided, add `KeySequence` attribute to ItemRef for key variables. KeySequence numbering is independent of OrderNumber -- iterate only over key variables in their key order (1-based).

   The `generate_define_xml()` function needs a way to get key_variables per domain. Two options:
   - Option A: Accept an `sdtm_ref: SDTMReference` parameter (preferred -- already used elsewhere)
   - Option B: Accept a `key_variables_map: dict[str, list[str]]` parameter

   Use Option A: Add `sdtm_ref: SDTMReference | None = None` parameter to `generate_define_xml()`. Inside, for each spec, look up `sdtm_ref.get_domain(spec.domain).key_variables` if sdtm_ref is provided. Pass to `_add_item_group()`.

   Import SDTMReference at top of file (lazy import not needed -- define_xml already imports from astraea.reference).

   ```python
   # In _add_item_group, after creating ItemRef:
   if key_variables and vm.sdtm_variable in key_variables:
       key_seq = key_variables.index(vm.sdtm_variable) + 1
       ir.set("KeySequence", str(key_seq))
   ```

2. **MED-07: def:Label on ItemGroupDef.** In `_add_item_group()`, add `def:Label` attribute right after the `def:Class` attribute:
   ```python
   ig.set(f"{{{DEFINE_NS}}}Label", spec.domain_label)
   ```

3. **MED-08: integer DataType for --SEQ.** In `_add_item_def()`, when `sdtm_data_type == "Num"`, check if the variable name ends with "SEQ":
   ```python
   if vm.sdtm_data_type == "Num":
       if vm.sdtm_variable.endswith("SEQ"):
           it.set("DataType", "integer")
       else:
           it.set("DataType", "float")
   ```

4. Add tests:
   - `test_key_sequence_on_item_ref`: Create an AE spec with key_variables=["STUDYID", "USUBJID", "AESEQ"] from a mock SDTMReference. Verify ItemRef for STUDYID has KeySequence="1", USUBJID has KeySequence="2", AESEQ has KeySequence="3", AETERM has no KeySequence.
   - `test_def_label_on_item_group`: Verify ItemGroupDef has `def:Label` equal to domain_label.
   - `test_seq_integer_datatype`: Create spec with AESEQ (Num) and AGE (Num). Verify AESEQ ItemDef has DataType="integer", AGE has DataType="float".
  </action>
  <verify>`pytest tests/unit/submission/test_define_xml.py -x -q` passes</verify>
  <done>KeySequence, def:Label, and integer DataType for --SEQ all working correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add Origin Source and ODM Originator/AsOfDateTime</name>
  <files>
    src/astraea/submission/define_xml.py
    tests/unit/submission/test_define_xml.py
  </files>
  <action>
1. **MED-09: def:Origin Source attribute.** In `_add_item_def()`, update the origin block to include a Source attribute based on origin type:
   ```python
   if vm.origin:
       origin_el = etree.SubElement(it, f"{{{DEFINE_NS}}}Origin")
       origin_el.set("Type", vm.origin.value)
       if vm.origin == VariableOrigin.CRF and vm.source_variable:
           origin_el.set("Source", f"CRF ({vm.source_variable})")
       elif vm.origin == VariableOrigin.DERIVED:
           origin_el.set("Source", "Derived")
       elif vm.origin == VariableOrigin.ASSIGNED:
           origin_el.set("Source", "Sponsor defined")
   ```
   Import VariableOrigin at the top of define_xml.py (add to existing import from astraea.models.mapping).

2. **MED-10: Originator and AsOfDateTime on ODM root.** In `_create_odm_root()`, add two attributes:
   ```python
   root.set("Originator", "Astraea-SDTM")
   root.set("AsOfDateTime", datetime.now(tz=UTC).strftime("%Y-%m-%dT%H:%M:%S"))
   ```

3. Add tests:
   - `test_origin_source_crf`: Variable with origin=CRF and source_variable="GENDER" produces `<def:Origin Type="CRF" Source="CRF (GENDER)"/>`.
   - `test_origin_source_derived`: Variable with origin=DERIVED produces `<def:Origin Type="Derived" Source="Derived"/>`.
   - `test_origin_source_assigned`: Variable with origin=ASSIGNED produces `<def:Origin Type="Assigned" Source="Sponsor defined"/>`.
   - `test_odm_originator`: ODM root has Originator="Astraea-SDTM" and AsOfDateTime is a valid ISO datetime string.

4. Ensure all existing tests still pass -- the new Originator/AsOfDateTime on root should not break `test_basic_structure` (it only checks FileType and ODMVersion).
  </action>
  <verify>`pytest tests/unit/submission/test_define_xml.py -x -q` passes all tests</verify>
  <done>Origin has Source attribute, ODM root has Originator and AsOfDateTime</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/submission/test_define_xml.py -x -v
pytest tests/unit/ -x -q
ruff check src/astraea/submission/define_xml.py
```
</verification>

<success_criteria>
- ItemRef for key variables has KeySequence numbered 1-N independently of OrderNumber
- ItemGroupDef has def:Label matching domain_label
- --SEQ variables have DataType="integer"
- def:Origin includes Source attribute based on origin type
- ODM root includes Originator="Astraea-SDTM" and valid AsOfDateTime
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-define-xml-and-findings-completeness/13-02-SUMMARY.md`
</output>
