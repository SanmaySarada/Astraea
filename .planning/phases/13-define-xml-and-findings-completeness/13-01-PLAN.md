---
phase: 13-define-xml-and-findings-completeness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/models/controlled_terms.py
  - src/astraea/submission/define_xml.py
  - tests/unit/submission/test_define_xml.py
autonomous: true

must_haves:
  truths:
    - "ValueListDef is placed on result variables (--ORRES, --STRESC, --STRESN), not --TESTCD"
    - "CodeListItem elements include NCI C-code Alias elements when nci_code is populated"
    - "Each ItemRef inside a ValueListDef has a matching ItemDef with correct OID"
    - "define.xml passes OID uniqueness check (no duplicate OIDs)"
  artifacts:
    - path: "src/astraea/models/controlled_terms.py"
      provides: "nci_code field on CodelistTerm"
      contains: "nci_code"
    - path: "src/astraea/submission/define_xml.py"
      provides: "Corrected ValueListDef, Alias, value-level ItemDef generation"
      contains: "_add_value_lists"
    - path: "tests/unit/submission/test_define_xml.py"
      provides: "Tests for VLD on result vars, NCI Alias, value-level ItemDefs"
      min_lines: 350
  key_links:
    - from: "src/astraea/submission/define_xml.py"
      to: "src/astraea/models/controlled_terms.py"
      via: "CodelistTerm.nci_code access in _add_codelists"
      pattern: "term\\.nci_code"
---

<objective>
Fix three structural define.xml errors: ValueListDef placement (HIGH-11), NCI C-codes on CodeListItem (HIGH-12), and missing ItemDef for ValueListDef targets (HIGH-13).

Purpose: These structural errors will cause P21 define.xml validation failures. ValueListDef on --TESTCD is a pre-define.xml-2.0 pattern; it must be on result variables. Missing NCI codes and ItemDefs are structural omissions.
Output: Corrected define_xml.py with proper ValueListDef on result variables, Alias elements on CodeListItem, and value-level ItemDef generation. Updated CodelistTerm model with nci_code field.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-define-xml-and-findings-completeness/13-RESEARCH.md

@src/astraea/submission/define_xml.py
@src/astraea/models/controlled_terms.py
@tests/unit/submission/test_define_xml.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nci_code to CodelistTerm + NCI Alias on CodeListItem</name>
  <files>
    src/astraea/models/controlled_terms.py
    src/astraea/submission/define_xml.py
    tests/unit/submission/test_define_xml.py
  </files>
  <action>
1. In `CodelistTerm` (src/astraea/models/controlled_terms.py), add field:
   `nci_code: str = Field(default="", description="NCI concept code for this term (e.g., 'C20197' for Male)")`

2. In `_add_codelists()` (src/astraea/submission/define_xml.py), after the Decode/TranslatedText element on each CodeListItem, add an Alias element IF `term.nci_code` is non-empty:
   ```python
   if term.nci_code:
       alias = etree.SubElement(cli, f"{{{ODM_NS}}}Alias")
       alias.set("Context", "nci:ExtCodeID")
       alias.set("Name", term.nci_code)
   ```
   Note: The Alias element uses the ODM_NS namespace (it's an ODM element, not a define extension).

3. Add test `test_codelist_nci_alias` that creates a mock CT with nci_code populated on terms, generates define.xml, and verifies:
   - Alias element exists on CodeListItem with Context="nci:ExtCodeID"
   - Alias Name matches the nci_code value
   - Alias is NOT emitted when nci_code is empty string

4. Update `_mock_ct_ref_with_sex()` to include nci_code values: M -> "C20197", F -> "C16576".
  </action>
  <verify>`pytest tests/unit/submission/test_define_xml.py -x -q` passes including new test</verify>
  <done>CodeListItem elements include NCI C-code Alias when nci_code is populated; empty nci_code produces no Alias</done>
</task>

<task type="auto">
  <name>Task 2: Fix ValueListDef placement + create value-level ItemDefs</name>
  <files>
    src/astraea/submission/define_xml.py
    tests/unit/submission/test_define_xml.py
  </files>
  <action>
1. Refactor `_add_value_lists()` in define_xml.py to place VLD on EACH result variable instead of --TESTCD:

   a. Identify result variables using suffixes: ("ORRES", "STRESC", "STRESN")
   b. For each result variable, create a separate ValueListDef with OID `VL.{domain}.{result_var}`
   c. Each VLD has ItemRef entries per unique test code with OID `IT.{domain}.{result_var}.{testcd}`
   d. WhereClauseDef OIDs: `WC.{domain}.{result_var}.{testcd}` -- each result var gets its own set
   e. RangeCheck in WhereClauseDef must reference the TESTCD variable's ItemDef OID (the condition), NOT the result variable
   f. When no data is available (no generated_dfs), create placeholder VLDs for each result variable (not just TESTCD)

2. Add `_add_item_def_for_value_level()` helper function:
   ```python
   def _add_item_def_for_value_level(
       mdv: etree._Element,
       domain: str,
       result_vm: VariableMapping,
       testcd: str,
   ) -> None:
       """Create ItemDef for a value-level reference (test-code-specific result)."""
       it = etree.SubElement(mdv, f"{{{ODM_NS}}}ItemDef")
       it.set("OID", f"IT.{domain}.{result_vm.sdtm_variable}.{testcd}")
       it.set("Name", result_vm.sdtm_variable)
       it.set("SASFieldName", result_vm.sdtm_variable)
       # Data type from the result variable
       if result_vm.sdtm_data_type == "Char":
           it.set("DataType", "text")
           it.set("Length", str(result_vm.length or 200))
       else:
           it.set("DataType", "float")
           it.set("Length", str(result_vm.length or 8))
       desc = etree.SubElement(it, f"{{{ODM_NS}}}Description")
       tt = etree.SubElement(desc, f"{{{ODM_NS}}}TranslatedText")
       tt.set(f"{{{XML_NS}}}lang", "en")
       tt.text = f"{result_vm.sdtm_label} ({testcd})"
   ```

3. Update `_add_item_group()` to add `def:ValueListRef` on ItemRef elements for result variables in Findings domains. After creating ItemRef entries, if the variable has a corresponding VLD, add:
   ```python
   ir.set(f"{{{DEFINE_NS}}}ValueListOID", f"VL.{spec.domain}.{vm.sdtm_variable}")
   ```
   This requires knowing which variables have VLDs. Pass a set of VLD variable names or check if the spec is Findings with TRANSPOSE.

4. Update existing test `test_findings_value_list`:
   - VLD OID should now be on LBORRES (not LBTESTCD): `VL.LB.LBORRES`
   - There should be 1 VLD (only LBORRES is in the spec, STRESC/STRESN not in fixture)
   - 3 ItemRef entries per VLD (3 unique test codes)
   - 3 WhereClauseDef elements per VLD
   - 3 value-level ItemDef elements (IT.LB.LBORRES.ALT, IT.LB.LBORRES.AST, IT.LB.LBORRES.WBC)
   - WhereClauseDef RangeCheck ItemOID points to IT.LB.LBTESTCD (the condition variable)

5. Add test `test_findings_multiple_result_vlds` with LBORRES + LBSTRESC + LBSTRESN in the spec:
   - 3 VLD elements (one per result variable)
   - Each VLD has 3 ItemRef entries
   - 9 WhereClauseDef elements total (3 result vars x 3 test codes)
   - 9 value-level ItemDef elements

6. Add test `test_no_duplicate_oids` that generates define.xml with multiple domains (DM + LB with VLDs) and asserts all OIDs across all element types are unique.
  </action>
  <verify>`pytest tests/unit/submission/test_define_xml.py -x -q` passes all tests including updated and new tests</verify>
  <done>ValueListDef placed on result variables per define.xml 2.0 spec; value-level ItemDefs created for each VLD target; no duplicate OIDs</done>
</task>

</tasks>

<verification>
```bash
pytest tests/unit/submission/test_define_xml.py -x -v
pytest tests/unit/ -x -q  # ensure no regressions
ruff check src/astraea/submission/define_xml.py src/astraea/models/controlled_terms.py
```
</verification>

<success_criteria>
- ValueListDef OIDs use VL.{domain}.{result_var} pattern (not VL.{domain}.{testcd})
- Each VLD ItemRef has a matching ItemDef with OID IT.{domain}.{result_var}.{testcd}
- WhereClauseDef RangeCheck references TESTCD ItemDef (condition variable)
- CodeListItem has Alias with Context="nci:ExtCodeID" when nci_code populated
- No duplicate OIDs in generated define.xml
- All existing tests pass (updated where needed)
</success_criteria>

<output>
After completion, create `.planning/phases/13-define-xml-and-findings-completeness/13-01-SUMMARY.md`
</output>
