---
phase: 13-define-xml-and-findings-completeness
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/astraea/execution/executor.py
  - tests/unit/execution/test_dtf_generation.py
autonomous: true

must_haves:
  truths:
    - "--DTF column is populated when date imputation occurs on --DTC variables"
    - "DTF is empty/null for non-imputed (full or truncated) dates"
    - "Infrastructure for DTF generation exists even if current pipeline rarely triggers it"
  artifacts:
    - path: "src/astraea/execution/executor.py"
      provides: "DTF generation logic wired into execute()"
      contains: "get_date_imputation_flag"
    - path: "tests/unit/execution/test_dtf_generation.py"
      provides: "Tests for DTF flag generation"
      min_lines: 50
  key_links:
    - from: "src/astraea/execution/executor.py"
      to: "src/astraea/transforms/imputation.py"
      via: "import get_date_imputation_flag"
      pattern: "get_date_imputation_flag"
---

<objective>
Wire date imputation flag (--DTF) generation into the execution pipeline.

Purpose: SDTM-IG v3.4 requires --DTF/--TMF when dates are imputed. The imputation utility already exists in transforms/imputation.py but is not wired into the executor. For v1, the pipeline truncates partial dates (correct SDTM behavior) rather than imputing, so DTF flags will rarely fire -- but the infrastructure must exist for completeness and for future imputation support.
Output: DTF generation infrastructure wired into DatasetExecutor with tests confirming correct behavior for both truncated and imputed dates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-define-xml-and-findings-completeness/13-RESEARCH.md

@src/astraea/execution/executor.py
@src/astraea/transforms/imputation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DTF generation into DatasetExecutor</name>
  <files>
    src/astraea/execution/executor.py
    tests/unit/execution/test_dtf_generation.py
  </files>
  <action>
1. Read `src/astraea/transforms/imputation.py` to understand the `get_date_imputation_flag()` API. It takes original_date (partial) and imputed_date (full) and returns the imputation flag character (D, M, Y) or empty string.

2. In `src/astraea/execution/executor.py`, add a private method `_generate_dtf_flags(self, result_df: pd.DataFrame, spec: DomainMappingSpec) -> pd.DataFrame`:
   - Find all columns ending in "DTC" in result_df
   - For each --DTC column, check if the corresponding --DTF variable exists in the spec's variable_mappings
   - If --DTF IS in the spec: generate the flag by comparing original partial dates against final DTC values
   - The challenge: by the time this runs, the original partial date is gone (already reformatted). Solution: Check if the DTC value is a partial ISO 8601 (length < 10, e.g., "2022-03" or "2022"). If it IS partial, the pipeline truncated (not imputed), so DTF should be empty. DTF only fires when a partial date is expanded to a full date.
   - For v1 implementation: Set DTF = empty string for all rows where DTC is already full (length >= 10) or where DTC is partial (truncated, not imputed). DTF would only be non-empty if future imputation logic fills in missing components.
   - Alternative simpler approach: Add DTF column with empty string values for all rows. This satisfies the "column exists" requirement. Add a TODO comment for future imputation logic to populate it.

   Use the simpler approach: If a --DTF variable is in the spec, ensure the column exists in the result DataFrame with empty string values. This is infrastructure -- the actual imputation flag logic will be populated when/if date imputation is added.

   ```python
   def _generate_dtf_flags(self, result_df: pd.DataFrame, spec: DomainMappingSpec) -> pd.DataFrame:
       """Generate --DTF date imputation flag columns.

       For v1, creates empty DTF columns as infrastructure. Actual imputation
       flag generation requires date imputation logic (current pipeline truncates,
       not imputes, partial dates per SDTM-IG rules).
       """
       dtf_vars = [vm for vm in spec.variable_mappings if vm.sdtm_variable.endswith("DTF")]
       for vm in dtf_vars:
           if vm.sdtm_variable not in result_df.columns:
               result_df[vm.sdtm_variable] = ""
               logger.debug("Created DTF column: {}", vm.sdtm_variable)
       return result_df
   ```

3. Call `_generate_dtf_flags` in the `execute()` method, AFTER the main execution loop but BEFORE `_enforce_column_order()`. This ensures DTF columns are present for column ordering.

4. Create test file `tests/unit/execution/test_dtf_generation.py`:
   - Test `test_dtf_column_created`: Spec includes AEDTF variable, result DataFrame gets AEDTF column with empty strings.
   - Test `test_dtf_not_created_when_not_in_spec`: Spec has no --DTF variables, no DTF columns added.
   - Test `test_dtf_preserves_existing`: If AEDTF column already exists in result (from prior processing), it is not overwritten.
   - Test `test_multiple_dtf_columns`: Spec with AESTDTF and AEENDTF, both created.

   For these tests, you can test the `_generate_dtf_flags` method directly by creating a DatasetExecutor instance and calling the private method with a test DataFrame and mock spec.
  </action>
  <verify>`pytest tests/unit/execution/test_dtf_generation.py -x -v` passes</verify>
  <done>DTF column generation wired into executor; columns exist in output when spec includes --DTF variables</done>
</task>

<task type="auto">
  <name>Task 2: Full regression verification</name>
  <files></files>
  <action>
1. Run the complete test suite to verify no regressions:
   ```bash
   pytest tests/ -x -q --tb=short
   ```

2. Run ruff on all modified files:
   ```bash
   ruff check src/astraea/submission/define_xml.py src/astraea/execution/findings.py src/astraea/execution/executor.py src/astraea/models/controlled_terms.py
   ```

3. If any test failures, fix them. Common expected issues:
   - Existing define.xml integration tests may need updates if they check VLD structure
   - Existing Findings execution tests may now have extra columns (STRESC, STRESN, etc.)

4. Report final test count.
  </action>
  <verify>`pytest tests/ -x -q` shows all tests passing; `ruff check src/ tests/` clean</verify>
  <done>All existing tests pass, no regressions, ruff clean</done>
</task>

</tasks>

<verification>
```bash
pytest tests/ -x -q --tb=short
ruff check src/ tests/
```
</verification>

<success_criteria>
- DTF columns created for any --DTF variable in the mapping spec
- All 1685+ existing tests still pass
- No ruff violations in modified files
- New tests for DTF generation pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-define-xml-and-findings-completeness/13-04-SUMMARY.md`
</output>
