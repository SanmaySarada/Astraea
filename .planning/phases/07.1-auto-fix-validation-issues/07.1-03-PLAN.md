---
phase: 07.1-auto-fix-validation-issues
plan: 03
type: execute
wave: 3
depends_on: ["07.1-02"]
files_modified:
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - tests/unit/cli/test_autofix_cli.py
autonomous: true

must_haves:
  truths:
    - "User can run 'astraea auto-fix <output-dir>' to run the fix loop on generated datasets"
    - "User can run 'astraea validate --auto-fix' to combine validation with auto-fixing"
    - "CLI displays per-iteration progress, fixes applied, and remaining human issues"
    - "CLI exits with code 0 if all issues resolved, code 1 if blocking issues remain"
  artifacts:
    - path: "src/astraea/cli/app.py"
      provides: "auto-fix command and --auto-fix flag on validate"
    - path: "src/astraea/cli/display.py"
      provides: "display_fix_loop_result() and display_needs_human() display helpers"
    - path: "tests/unit/cli/test_autofix_cli.py"
      provides: "CLI invocation tests for auto-fix command"
      min_lines: 50
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/validation/fix_loop.py"
      via: "lazy import of FixLoopEngine"
      pattern: "from astraea\\.validation\\.fix_loop import"
    - from: "src/astraea/cli/display.py"
      to: "src/astraea/validation/fix_loop.py"
      via: "imports FixLoopResult for display"
      pattern: "FixLoopResult"
---

<objective>
Add CLI commands for the auto-fix workflow: `astraea auto-fix` standalone command and `--auto-fix` flag on `astraea validate`. Add Rich display helpers for fix loop results. Add basic CLI tests.

Purpose: This makes the auto-fix system accessible to users through the CLI, completing the Phase 7.1 success criteria.
Output: Updated `src/astraea/cli/app.py`, `src/astraea/cli/display.py`, `tests/unit/cli/test_autofix_cli.py`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-auto-fix-validation-issues/07.1-01-SUMMARY.md
@.planning/phases/07.1-auto-fix-validation-issues/07.1-02-SUMMARY.md

@src/astraea/cli/app.py
@src/astraea/cli/display.py
@src/astraea/validation/fix_loop.py
@src/astraea/validation/autofix.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI auto-fix command and --auto-fix flag on validate</name>
  <files>src/astraea/cli/app.py, src/astraea/cli/display.py</files>
  <action>
**In `src/astraea/cli/app.py`**, add:

1. **`auto_fix` command** (add after the `generate_csdrg_cmd` command):

```python
@app.command(name="auto-fix")
def auto_fix_cmd(
    output_dir: Annotated[Path, typer.Argument(help="Directory containing .xpt files and mapping specs")],
    study_id: Annotated[str, typer.Option("--study-id", help="Study identifier")] = "UNKNOWN",
    specs_dir: Annotated[Path | None, typer.Option("--specs-dir", help="Directory with spec files")] = None,
    max_iterations: Annotated[int, typer.Option("--max-iterations", help="Maximum fix iterations")] = 3,
    format: Annotated[str, typer.Option("--format", help="Report format: markdown or json")] = "markdown",
) -> None:
    """Auto-fix deterministic validation issues in generated SDTM datasets.

    Runs a validate-fix-revalidate loop (max 3 iterations by default). Automatically
    fixes: CT case normalization, missing DOMAIN/STUDYID columns, variable name/label
    truncation, and non-ASCII characters. Issues requiring human judgment are reported
    with context and suggested fixes.

    Fixed datasets are written back to the output directory. An audit trail of all
    fixes is saved to autofix_audit.json.
    """
```

The command body should:
- Load XPT files (same pattern as validate command: pyreadstat.read_xport)
- Load mapping specs (same pattern: glob for *_spec.json and *_mapping.json)
- Build domains dict: `{domain_code: (df, spec)}`
- Lazy import FixLoopEngine, AutoFixer, ValidationEngine
- Initialize SDTMReference, CTReference, ValidationEngine, AutoFixer, FixLoopEngine
- Call `fix_loop_engine.run_fix_loop(domains, output_dir=output_dir, study_id=study_id)`
- Display results using display helpers (see below)
- Export report if format specified
- Exit code 1 if final report has blocking errors, 0 otherwise

2. **Add `--auto-fix` flag to existing `validate` command**:

Add an option to the existing validate command:
```python
auto_fix: Annotated[bool, typer.Option("--auto-fix", help="Auto-fix deterministic issues after validation")] = False,
```

When `--auto-fix` is True:
- After the normal validation runs (Step 3 in existing code)
- If there are any errors, run the auto-fix loop
- Lazy import FixLoopEngine, AutoFixer
- Build AutoFixer and FixLoopEngine using the same engine
- Run fix loop on the domains
- Display fix loop results
- Use the fix loop's final_report instead of the original report for display and export

Use lazy imports for all validation/fix_loop modules (inside the command function, not at module top), consistent with existing patterns in app.py.

**In `src/astraea/cli/display.py`**, add:

3. **`display_fix_loop_result(result: FixLoopResult, console: Console)` function**:

Uses Rich to display:
- Panel header: "Auto-Fix Results"
- Summary table: iterations_run, total_fixed, converged status
- Per-iteration breakdown table: iteration number, issues found, auto-fixed, remaining
- If total_fixed > 0: "Fixed Issues" table showing fix_type, domain, variable, before -> after (first 10 fix actions)
- Final submission readiness status (from final_report)

4. **`display_needs_human(issues: list[IssueClassification], console: Console)` function**:

Uses Rich to display:
- Panel header: "Issues Requiring Human Review"
- Table with columns: Severity, Rule, Domain, Variable, Message, Suggested Fix
- Grouped by domain for readability
- Clear formatting: ERROR in red, WARNING in yellow

Both display functions use Rich Panel, Table, and color formatting consistent with existing display.py patterns.
  </action>
  <verify>
  Run `python -c "from astraea.cli.app import app"` -- imports clean.
  Run `ruff check src/astraea/cli/app.py src/astraea/cli/display.py` -- clean.
  Run `astraea auto-fix --help` -- shows help text with arguments and options.
  Run `astraea validate --help` -- shows --auto-fix option.
  </verify>
  <done>CLI auto-fix command and --auto-fix validate flag exist, display helpers render fix loop results and needs-human issues with Rich formatting.</done>
</task>

<task type="auto">
  <name>Task 2: CLI tests and full integration verification</name>
  <files>tests/unit/cli/test_autofix_cli.py</files>
  <action>
Create `tests/unit/cli/test_autofix_cli.py` with tests:

1. **test_auto_fix_help**: Invoke `["auto-fix", "--help"]` via typer CliRunner. Assert exit_code 0 and "Auto-fix deterministic" in output.

2. **test_validate_auto_fix_help**: Invoke `["validate", "--help"]` via typer CliRunner. Assert "--auto-fix" appears in help text.

3. **test_auto_fix_no_xpt_files**: Create empty tmp_path directory. Invoke `["auto-fix", str(tmp_path)]`. Assert exit_code 1 and "No .xpt files" in output.

4. **test_auto_fix_no_directory**: Invoke with nonexistent path. Assert exit_code 1 and "not found" in output.

5. **test_display_fix_loop_result_renders**: Import display_fix_loop_result. Create a mock FixLoopResult with some fix actions. Call with Console(file=StringIO()). Assert no exceptions and output contains key strings like "Auto-Fix" and "iterations".

6. **test_display_needs_human_renders**: Import display_needs_human. Create sample IssueClassification list. Call with Console(file=StringIO()). Assert no exceptions.

Use `from typer.testing import CliRunner` and `from astraea.cli.app import app`.
Use `tmp_path` fixture for temp directories.

Also run the full test suite to ensure no regressions:
  </action>
  <verify>
  Run `pytest tests/unit/cli/test_autofix_cli.py -v` -- all pass.
  Run `pytest tests/unit/validation/test_autofix.py tests/unit/validation/test_fix_loop.py tests/unit/cli/test_autofix_cli.py -v` -- all pass (full Phase 7.1 test suite).
  Run `ruff check src/astraea/ tests/` -- clean.
  Run `pytest tests/unit/ -x -q` -- all existing tests still pass (no regressions).
  </verify>
  <done>CLI commands work (--help shows correct output), display helpers render without errors, no regressions in existing test suite.</done>
</task>

</tasks>

<verification>
- `astraea auto-fix --help` shows correct help
- `astraea validate --help` includes --auto-fix option
- `pytest tests/unit/cli/test_autofix_cli.py -v` passes
- `pytest tests/unit/ -x -q` -- full unit suite passes (no regressions)
- `ruff check src/ tests/` clean
</verification>

<success_criteria>
1. `astraea auto-fix <output-dir>` CLI command runs the fix loop
2. `astraea validate --auto-fix` combines validation with auto-fixing
3. Rich display shows per-iteration progress and remaining human issues
4. Exit codes correct: 0 for clean, 1 for blocking errors
5. No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-auto-fix-validation-issues/07.1-03-SUMMARY.md`
</output>
