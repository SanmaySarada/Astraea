---
phase: 07.1-auto-fix-validation-issues
plan: 03
subsystem: cli
tags: [cli, autofix, validation, rich-display, typer]
completed: 2026-02-28
duration: ~4 min

dependency_graph:
  requires: [07.1-01, 07.1-02]
  provides: [auto-fix CLI command, --auto-fix validate flag, fix loop display helpers]
  affects: []

tech_stack:
  added: []
  patterns: [lazy-import CLI commands, Rich Panel/Table display, exit-code signaling]

key_files:
  created:
    - tests/unit/cli/test_autofix_cli.py
  modified:
    - src/astraea/cli/app.py
    - src/astraea/cli/display.py

decisions:
  - id: D-07.1-03-01
    decision: "display.py imports FixLoopResult and IssueClassification at module level (not lazy) since display.py already imports other validation types at top level"
  - id: D-07.1-03-02
    decision: "auto-fix command uses same XPT/spec loading pattern as validate command for consistency"
  - id: D-07.1-03-03
    decision: "display_fix_loop_result shows first 10 fix actions only, directs user to autofix_audit.json for full trail"

metrics:
  tests_added: 7
  tests_passing: 7
  files_created: 1
  files_modified: 2
  lines_of_code: ~220 (app.py additions) + ~150 (display.py additions) + ~149 (tests)
---

# Phase 7.1 Plan 03: CLI Integration and Display Helpers Summary

CLI commands for the auto-fix workflow: `astraea auto-fix` standalone command, `--auto-fix` flag on `astraea validate`, and Rich display helpers for fix loop results and needs-human issues.

## What Was Built

### CLI Commands (`src/astraea/cli/app.py`)

1. **`astraea auto-fix <output-dir>`** standalone command:
   - Loads .xpt files and mapping specs from output directory
   - Initializes ValidationEngine, AutoFixer, and FixLoopEngine
   - Runs the validate-fix-revalidate loop (configurable max iterations)
   - Displays fix loop results with Rich formatting
   - Writes fixed datasets and audit trail to output directory
   - Exports validation report in markdown or JSON format
   - Exit code 0 if submission-ready, 1 if blocking errors remain
   - Options: `--study-id`, `--specs-dir`, `--max-iterations`, `--format`

2. **`--auto-fix` flag on `astraea validate`**:
   - When enabled and validation finds errors, runs the fix loop inline
   - Replaces the original validation report with the post-fix report
   - Displays both fix loop results and the updated validation summary
   - Seamless integration with existing validate workflow

### Display Helpers (`src/astraea/cli/display.py`)

3. **`display_fix_loop_result(result, console)`**:
   - Summary panel: iterations run, total fixed, convergence status
   - Per-iteration breakdown table: issues found, auto-fixed, remaining, needs-human
   - Fixed issues table (first 10): fix type, domain, variable, before/after values

4. **`display_needs_human(issues, console)`**:
   - Table grouped by domain with severity color-coding (ERROR red, WARNING yellow)
   - Columns: Severity, Rule, Domain, Variable, Message, Suggested Fix
   - Wrapped in a yellow-bordered Panel for visual distinction

### Test Coverage (`tests/unit/cli/test_autofix_cli.py`)

- `test_auto_fix_help`: Verifies help text includes description
- `test_validate_auto_fix_help`: Verifies --auto-fix appears in validate help
- `test_auto_fix_no_directory`: Nonexistent path exits code 1
- `test_auto_fix_no_xpt_files`: Empty directory exits code 1
- `test_display_fix_loop_result_renders`: Rich output renders without errors
- `test_display_needs_human_renders`: Needs-human table renders correctly
- `test_display_needs_human_empty`: Empty list shows "No issues" message

## Decisions Made

1. **D-07.1-03-01**: display.py imports FixLoopResult and IssueClassification at module level (consistent with existing top-level imports for ValidationReport, RuleResult, etc.).
2. **D-07.1-03-02**: auto-fix command reuses the same XPT/spec loading pattern as the validate command for consistency.
3. **D-07.1-03-03**: display_fix_loop_result shows only the first 10 fix actions in the table, directing users to autofix_audit.json for the full audit trail.

## Deviations from Plan

None -- plan executed exactly as written.

## Phase 7.1 Completion

This plan completes Phase 7.1 (Auto-Fix Validation Issues). All 3 plans delivered:

| Plan | Component | Tests |
|------|-----------|-------|
| 07.1-01 | AutoFixer core with issue classification | 29 |
| 07.1-02 | Validate-fix-revalidate loop engine | 11 |
| 07.1-03 | CLI integration and display helpers | 7 |
| **Total** | | **47 new tests** |

Combined test suite: 539 unit tests passing (no regressions).
