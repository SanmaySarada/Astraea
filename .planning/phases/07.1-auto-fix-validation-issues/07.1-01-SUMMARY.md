---
phase: 07.1-auto-fix-validation-issues
plan: 01
subsystem: validation
tags: [autofix, validation, audit-trail, controlled-terminology, ascii]
completed: 2026-02-28
duration: ~5 min

dependency_graph:
  requires: [07-01, 07-02, 07-03, 07-04]
  provides: [AutoFixer class, FixAction audit model, issue classification]
  affects: [07.1-02, 07.1-03]

tech_stack:
  added: []
  patterns: [classify-then-fix, copy-on-write fix functions, audit trail via FixAction]

key_files:
  created:
    - src/astraea/validation/autofix.py
    - tests/unit/validation/test_autofix.py
  modified: []

decisions:
  - id: D-07.1-01-01
    decision: "CT case normalization uses regex parsing of RuleResult.message to extract invalid values for case-insensitive comparison"
  - id: D-07.1-01-02
    decision: "USUBJID auto-fix classified as AUTO_FIXABLE but skipped at execution time (requires source data not available at fix time)"
  - id: D-07.1-01-03
    decision: "apply_fixes returns tuple[DataFrame, DomainMappingSpec, list[FixAction]] -- spec needed because label truncation modifies spec not df"

metrics:
  tests_added: 29
  tests_passing: 29
  files_created: 2
  lines_of_code: ~644 (autofix.py) + ~674 (tests)
---

# Phase 7.1 Plan 01: AutoFixer Core with Issue Classification Summary

AutoFixer class that classifies every validation RuleResult as auto-fixable or needs-human, with 6 deterministic fix functions and FixAction audit trail for before/after tracking.

## What Was Built

### AutoFixer Core (`src/astraea/validation/autofix.py`)

1. **FixAction Pydantic model** -- audit trail for every fix with rule_id, domain, variable, fix_type, before_value, after_value, affected_count, and ISO 8601 timestamp.

2. **FixClassification enum** -- `AUTO_FIXABLE` and `NEEDS_HUMAN` categories.

3. **IssueClassification model** -- links a RuleResult to its classification with reason and optional suggested_fix.

4. **AutoFixer class** with:
   - `classify_issue()` -- covers all known rule IDs: ASTR-T001/T002, ASTR-P001, ASTR-L001/L002/L003, ASTR-F001/F002/F003, FDAB*, ASTR-C*
   - `apply_fixes()` -- orchestrates classification and fix application, returns (fixed_df, fixed_spec, fix_actions)
   - 7 private fix methods: `_fix_ct_case`, `_fix_domain_column`, `_fix_missing_studyid`, `_fix_variable_name_length`, `_fix_variable_label_length`, `_fix_ascii`, `_fix_file_naming`

### Classification Rules

| Rule ID | Classification | Fix Type |
|---------|---------------|----------|
| ASTR-T001 (CT mismatch) | AUTO_FIXABLE if case-only mismatch | ct_case_normalize |
| ASTR-T002 (DOMAIN wrong) | Always AUTO_FIXABLE | add_missing_column / fix_domain_value |
| ASTR-P001 (Required var) | AUTO_FIXABLE for STUDYID/DOMAIN/USUBJID only | add_missing_column |
| ASTR-L001 (Name >8) | Always AUTO_FIXABLE | truncate_name |
| ASTR-L002 (Label >40) | Always AUTO_FIXABLE | truncate_label |
| ASTR-L003 (Char >200) | NEEDS_HUMAN | -- |
| ASTR-F001 (Date format) | NEEDS_HUMAN | -- |
| ASTR-F002 (ASCII) | Always AUTO_FIXABLE | fix_ascii |
| ASTR-F003 (File naming) | AUTO_FIXABLE (metadata only) | fix_file_naming |
| FDAB* | NEEDS_HUMAN | -- |
| ASTR-C* | NEEDS_HUMAN | -- |

### Test Coverage (`tests/unit/validation/test_autofix.py`)

- 15 classification tests covering every rule ID category
- 8 fix function tests (CT case, domain add/correct, STUDYID, name truncation with collision, label truncation, ASCII)
- 6 integration tests (copy semantics, skip needs-human, multiple fixes, audit trail completeness, STUDYID from spec, label updates spec)

## Decisions Made

1. **D-07.1-01-01**: CT case classification parses quoted values from RuleResult.message using regex, then checks each against the codelist case-insensitively via `get_codelist_for_variable()`.
2. **D-07.1-01-02**: USUBJID is classified AUTO_FIXABLE but skipped at execution (requires source data). This allows the loop engine to handle it separately.
3. **D-07.1-01-03**: `apply_fixes` returns a 3-tuple (df, spec, actions) because label truncation modifies the spec, not the DataFrame.

## Deviations from Plan

None -- plan executed exactly as written.

## Next Phase Readiness

Plan 07.1-02 (validate-fix-revalidate loop) can proceed. It will use `AutoFixer.apply_fixes()` as the core fix step within the loop engine.
