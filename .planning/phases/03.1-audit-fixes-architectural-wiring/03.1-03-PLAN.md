---
phase: 03.1-audit-fixes-architectural-wiring
plan: 03
type: execute
wave: 2
depends_on: ["03.1-02"]
files_modified:
  - src/astraea/data/sdtm_ig/domains.json
  - tests/unit/reference/test_sdtm_ig.py
autonomous: true

must_haves:
  truths:
    - "ARMNRS core is Perm (not Exp)"
    - "CMSTDTC and CMENDTC core is Exp (not Perm)"
    - "EXDOSE label is 'Dose per Administration' (not 'Dose')"
    - "LB has LBBLFL (Expected), VS has VSBLFL (Expected)"
    - "DM has INVID and INVNAM (Permissible)"
    - "AE has AETOXGR, AEREFID, AEGRPID (Permissible)"
    - "All 9 previously null key_variables domains have populated key_variables"
  artifacts:
    - path: "src/astraea/data/sdtm_ig/domains.json"
      provides: "Corrected core designations, labels, missing variables, key_variables"
    - path: "tests/unit/reference/test_sdtm_ig.py"
      provides: "Tests verifying all corrections"
  key_links:
    - from: "src/astraea/data/sdtm_ig/domains.json"
      to: "src/astraea/reference/sdtm_ig.py"
      via: "SDTMReference.get_domain_spec()"
      pattern: "get_domain_spec"
---

<objective>
Fix existing domain entries in domains.json: core designation errors, label errors, missing Expected/Permissible variables, and null key_variables for 9 domains.

Purpose: Incorrect core designations cause the mapping engine to incorrectly flag missing variables or miss truly required ones. Wrong labels will fail P21 validation (SD0063/DD0137). Missing Expected variables (LBBLFL, VSBLFL) mean baseline flags won't be mapped. Null key_variables breaks future uniqueness validation.

Output: Corrected domains.json entries plus targeted unit tests for each fix.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/PHASE3_AUDIT.md (sections H-01 through H-05, C-04, M-07)
@.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-RESEARCH.md (sections "Core Designation Fixes", "Label Fixes", "Missing Variables to Add", "Null Key Variables to Fill")
@src/astraea/data/sdtm_ig/domains.json
@tests/unit/reference/test_sdtm_ig.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix core designations, labels, and add missing variables</name>
  <files>src/astraea/data/sdtm_ig/domains.json</files>
  <action>
In domains.json, make these targeted edits:

**Core designation fixes (3 variables):**
1. DM domain: Change ARMNRS core from "Exp" to "Perm"
2. CM domain: Change CMSTDTC core from "Perm" to "Exp"
3. CM domain: Change CMENDTC core from "Perm" to "Exp"

**Label fix (1 variable):**
4. EX domain: Change EXDOSE label from "Dose" to "Dose per Administration"

**Add missing Expected variables (2 variables):**
5. LB domain: Add LBBLFL variable:
   - name: "LBBLFL", label: "Baseline Flag", data_type: "Char", core: "Exp"
   - codelist_code: "C66742", cdisc_notes: "Used to identify a baseline record"
   - order: Place after LBNRIND (check existing order numbers)

6. VS domain: Add VSBLFL variable:
   - name: "VSBLFL", label: "Baseline Flag", data_type: "Char", core: "Exp"
   - codelist_code: "C66742", cdisc_notes: "Used to identify a baseline record"
   - order: Place after VSSTAT or VSNRIND (check existing order numbers)

**Add missing Permissible variables (10 variables):**
7. DM domain: Add INVID (Investigator Identifier, Char, Perm, null codelist)
8. DM domain: Add INVNAM (Investigator Name, Char, Perm, null codelist)
9. AE domain: Add AETOXGR (Standard Toxicity Grade, Char, Perm, null codelist)
10. AE domain: Add AEREFID (Reference ID, Char, Perm, null codelist)
11. AE domain: Add AEGRPID (Group ID, Char, Perm, null codelist)
12. CM domain: Add CMCLAS (Medication Class, Char, Perm, null codelist)
13. CM domain: Add CMCLASCD (Medication Class Code, Char, Perm, null codelist)
14. EX domain: Add EXLOT (Lot Number, Char, Perm, null codelist)
15. LB domain: Add LBMETHOD (Method of Test or Examination, Char, Perm, null codelist)
16. VS domain: Add VSLOC (Location of Vital Signs Assessment, Char, Perm, null codelist)

For order field on new variables: append after existing variables in that domain (use max existing order + 1, +2, etc.).

**Fill null key_variables (9 domains):**
17. IE: ["STUDYID", "USUBJID", "IETESTCD"]
18. CE: ["STUDYID", "USUBJID", "CETERM", "CESTDTC"]
19. DV: ["STUDYID", "USUBJID", "DVTERM", "DVSTDTC"]
20. PE: ["STUDYID", "USUBJID", "PETESTCD", "VISITNUM", "PEDTC"]
21. QS: ["STUDYID", "USUBJID", "QSTESTCD", "VISITNUM", "QSDTC", "QSCAT"]
22. SC: ["STUDYID", "USUBJID", "SCTESTCD"]
23. FA: ["STUDYID", "USUBJID", "FATESTCD", "FADTC"]
24. SV: ["STUDYID", "USUBJID", "VISITNUM"]
25. DA: ["STUDYID", "USUBJID", "DATESTCD", "DADTC"]
  </action>
  <verify>
Run: `python -c "
from astraea.reference.sdtm_ig import SDTMReference
ref = SDTMReference()
dm = ref.get_domain_spec('DM')
armnrs = [v for v in dm.variables if v.name == 'ARMNRS'][0]
print('ARMNRS core:', armnrs.core.value)
invid = [v for v in dm.variables if v.name == 'INVID']
print('INVID exists:', len(invid) > 0)
"`
Run: `python -c "
from astraea.reference.sdtm_ig import SDTMReference
ref = SDTMReference()
lb = ref.get_domain_spec('LB')
blfl = [v for v in lb.variables if v.name == 'LBBLFL']
print('LBBLFL exists:', len(blfl) > 0, 'core:', blfl[0].core.value if blfl else 'MISSING')
ie = ref.get_domain_spec('IE')
print('IE key_vars:', ie.key_variables)
"`
  </verify>
  <done>All 3 core designations fixed, 1 label fixed, 12 missing variables added, 9 null key_variables populated</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for all corrections</name>
  <files>tests/unit/reference/test_sdtm_ig.py</files>
  <action>
Add targeted tests to the existing test file:

1. Parametrized test for core designation fixes:
   - ("DM", "ARMNRS", "Perm")
   - ("CM", "CMSTDTC", "Exp")
   - ("CM", "CMENDTC", "Exp")
   Each: load domain, find variable, assert core matches expected.

2. Test EXDOSE label:
   - Load EX domain, find EXDOSE, assert label == "Dose per Administration"

3. Parametrized test for missing Expected variables:
   - ("LB", "LBBLFL", "Exp")
   - ("VS", "VSBLFL", "Exp")
   Each: load domain, assert variable exists, assert core == "Exp"

4. Parametrized test for missing Permissible variables:
   - ("DM", "INVID"), ("DM", "INVNAM"), ("AE", "AETOXGR"), ("AE", "AEREFID"),
     ("AE", "AEGRPID"), ("CM", "CMCLAS"), ("CM", "CMCLASCD"), ("EX", "EXLOT"),
     ("LB", "LBMETHOD"), ("VS", "VSLOC")
   Each: load domain, assert variable exists, assert core == "Perm"

5. Parametrized test for key_variables:
   - ("IE", ["STUDYID", "USUBJID", "IETESTCD"])
   - ("CE", ["STUDYID", "USUBJID", "CETERM", "CESTDTC"])
   - ("SV", ["STUDYID", "USUBJID", "VISITNUM"])
   - ... etc for all 9 domains
   Each: load domain, assert key_variables is not None and matches expected list.

6. Run full test suite: `pytest -x -q`
  </action>
  <verify>`pytest tests/unit/reference/test_sdtm_ig.py -v` -- all new tests pass. `pytest -x -q` -- full suite passes.</verify>
  <done>Tests confirm all core designation, label, variable, and key_variable corrections</done>
</task>

</tasks>

<verification>
- `pytest -x -q` passes
- `ruff check src/ tests/` passes
- All corrections verified by targeted tests
</verification>

<success_criteria>
- 3 core designations corrected (ARMNRS, CMSTDTC, CMENDTC)
- 1 label corrected (EXDOSE)
- 2 Expected variables added (LBBLFL, VSBLFL)
- 10 Permissible variables added across 5 domains
- 9 null key_variables populated
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-03-SUMMARY.md`
</output>
