---
phase: 03.1-audit-fixes-architectural-wiring
plan: 04
subsystem: mapping-models-validation
tags: [pydantic, mapping, validation, codelist, suppqual, order, xpt]
dependency-graph:
  requires: [03-core-mapping-engine]
  provides: [order-field-on-variable-mapping, missing-required-on-spec, lookup-recode-ct-warning, dynamic-suppqual-label]
  affects: [04-human-review-gate, phase-6-findings-transpose, phase-9-xpt-generation]
tech-stack:
  added: []
  patterns: [default-field-backward-compatibility, deferred-runtime-validation]
key-files:
  created: []
  modified:
    - src/astraea/models/mapping.py
    - src/astraea/mapping/validation.py
    - src/astraea/mapping/engine.py
    - src/astraea/mapping/exporters.py
    - src/astraea/data/ct/codelists.json
    - tests/test_models/test_mapping.py
    - tests/unit/mapping/test_validation.py
    - tests/unit/mapping/test_exporters.py
decisions:
  - id: D-03.1-04-01
    description: "order and length fields use defaults (0 and None) for full backward compatibility"
  - id: D-03.1-04-02
    description: "LOOKUP_RECODE non-extensible codelist warning does NOT penalize confidence -- mapping is valid, validation deferred to runtime"
  - id: D-03.1-04-03
    description: "Fixed trailing comma in codelists.json (pre-existing JSON parse error blocking CTReference instantiation)"
metrics:
  duration: ~4 min
  completed: 2026-02-27
---

# Phase 3.1 Plan 04: Mapping Model Fields, Engine Wiring, and Validation Fixes Summary

Add order/length to VariableMapping, missing_required_variables to DomainMappingSpec, wire through validation/engine, fix SUPPQUAL label bug, extend codelist validation for LOOKUP_RECODE patterns.

## What Was Done

### Task 1: Model fields, SUPPQUAL fix, codelist validation

1. **VariableMapping model** -- added `order` (int, default 0, ge=0) and `length` (int|None, default None) fields after `notes`. Both have defaults for backward compatibility.

2. **DomainMappingSpec model** -- added `missing_required_variables` (list[str], default_factory=list) field. Populated by engine from check_required_coverage output.

3. **Validation enrichment** -- order field populated from `var_spec.order` during enrichment. Unknown variables get order=0.

4. **Engine wiring** -- `_build_spec()` accepts `missing_required_variables` parameter. `map_domain()` passes `missing_required` result through.

5. **SUPPQUAL label fix** -- Changed hardcoded `"SUPPDM Candidate"` to `f"SUPP{spec.domain} Candidate"` in exporters.py.

6. **LOOKUP_RECODE codelist validation** -- Added warning when non-extensible codelist used with LOOKUP_RECODE and no assigned_value. Warns that runtime values must be validated against CT during execution. Does NOT penalize confidence.

### Task 2: Tests (13 new tests)

- 4 tests for VariableMapping order/length (defaults, explicit, negative rejection, JSON roundtrip)
- 2 tests for DomainMappingSpec missing_required_variables (default, explicit with roundtrip)
- 2 tests for order enrichment (from domain spec, unknown variable default)
- 3 tests for LOOKUP_RECODE codelist validation (non-extensible warning, extensible no-warn, assigned_value path)
- 2 tests for SUPPQUAL label (AE domain -> SUPPAE, DM domain -> SUPPDM)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed trailing comma in codelists.json**

- **Found during:** Task 1 verification (running existing tests)
- **Issue:** codelists.json had a trailing comma after the last entry in the C66728 (Yes/No) codelist terms, causing `json.JSONDecodeError` when CTReference() was instantiated. All validation tests that used CTReference were broken.
- **Fix:** Removed the trailing comma at line 148.
- **Files modified:** src/astraea/data/ct/codelists.json
- **Commit:** ce42095

## Test Results

```
607 passed, 15 skipped in 14.58s
```

13 new tests added (46 -> 59 in the affected test files).

## Commits

| Hash | Type | Description |
|------|------|-------------|
| ce42095 | feat | Add model fields, fix SUPPQUAL label bug, extend codelist validation |
| ceaad67 | test | Add tests for model fields, codelist validation, and bug fixes |

## Next Phase Readiness

- order field ready for define.xml generation and XPT variable ordering
- missing_required_variables ready for human review gate display
- LOOKUP_RECODE codelist warning ready for reviewer attention routing
- Dynamic SUPPQUAL labels will work correctly for all domain expansions (Phase 5, 6)
