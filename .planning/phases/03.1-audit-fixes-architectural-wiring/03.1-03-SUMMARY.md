---
phase: 03.1-audit-fixes-architectural-wiring
plan: 03
subsystem: reference-data
tags: [sdtm-ig, domains-json, core-designations, key-variables, baseline-flag]
dependency-graph:
  requires: [03.1-02]
  provides: [corrected-core-designations, missing-variables, key-variables]
  affects: [04, 05, 06]
tech-stack:
  added: []
  patterns: []
key-files:
  created: []
  modified:
    - src/astraea/data/sdtm_ig/domains.json
    - tests/test_reference/test_sdtm_ig.py
decisions:
  - id: D-03.1-03-01
    description: "New Permissible variables use empty string for cdisc_notes (VariableSpec requires str, not None)"
  - id: D-03.1-03-02
    description: "New variables appended at max_order+N rather than inserted mid-list to avoid reordering existing variables"
  - id: D-03.1-03-03
    description: "Existing tests updated to match corrected core designations (ARMNRS Perm, CMSTDTC/CMENDTC removed from Perm parametrize)"
metrics:
  duration: ~13 min
  completed: 2026-02-27
---

# Phase 3.1 Plan 03: Fix Domain Entries in domains.json Summary

Corrected core designations, labels, missing variables, and null key_variables across 13 SDTM domains in domains.json, with 25 targeted tests.

## What Was Done

### Task 1: Fix core designations, labels, and add missing variables

**Core designation fixes (3 variables):**
- DM.ARMNRS: Exp -> Perm (was incorrectly flagging missing optional variable)
- CM.CMSTDTC: Perm -> Exp (start date is Expected for Interventions class)
- CM.CMENDTC: Perm -> Exp (end date is Expected for Interventions class)

**Label fix (1 variable):**
- EX.EXDOSE: "Dose" -> "Dose per Administration" (P21 rule SD0063/DD0137 compliance)

**Expected variables added (2):**
- LB.LBBLFL (Baseline Flag, Exp, codelist C66742) at order 23
- VS.VSBLFL (Baseline Flag, Exp, codelist C66742) at order 17

**Permissible variables added (10):**
- DM: INVID (order 28), INVNAM (order 29)
- AE: AETOXGR (order 27), AEREFID (order 28), AEGRPID (order 29)
- CM: CMCLAS (order 18), CMCLASCD (order 19)
- EX: EXLOT (order 15)
- LB: LBMETHOD (order 24)
- VS: VSLOC (order 18)

**Key variables populated (9 domains):**
- IE: [STUDYID, USUBJID, IETESTCD]
- CE: [STUDYID, USUBJID, CETERM, CESTDTC]
- DV: [STUDYID, USUBJID, DVTERM, DVSTDTC]
- PE: [STUDYID, USUBJID, PETESTCD, VISITNUM, PEDTC]
- QS: [STUDYID, USUBJID, QSTESTCD, VISITNUM, QSDTC, QSCAT]
- SC: [STUDYID, USUBJID, SCTESTCD]
- FA: [STUDYID, USUBJID, FATESTCD, FADTC]
- SV: [STUDYID, USUBJID, VISITNUM]
- DA: [STUDYID, USUBJID, DATESTCD, DADTC]

**Commit:** a9cfe29

### Task 2: Add tests for all corrections

Added `TestPlan0303CoreDesignationFixes` class with 25 parametrized tests:
- 3 tests for core designation corrections
- 1 test for EXDOSE label
- 2 tests for Expected baseline flag variables (with label and codelist verification)
- 10 tests for Permissible variable existence
- 9 tests for key_variables population

Also updated 2 pre-existing tests that asserted the old (incorrect) values:
- `test_cm_optional_vars_are_perm`: removed CMSTDTC and CMENDTC from Perm parametrize
- `test_dm_has_armnrs`: changed expected core from Exp to Perm

**Commit:** 5654bdc

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed null cdisc_notes causing VariableSpec validation error**
- **Found during:** Task 1
- **Issue:** New Permissible variables had `cdisc_notes: null` in JSON but VariableSpec model requires `str` (not `str | None`)
- **Fix:** Changed all null cdisc_notes to empty string `""`
- **Files modified:** src/astraea/data/sdtm_ig/domains.json
- **Commit:** a9cfe29

**2. [Rule 1 - Bug] Updated existing tests asserting old incorrect core designations**
- **Found during:** Task 1 verification
- **Issue:** `test_cm_optional_vars_are_perm` parametrized CMSTDTC/CMENDTC as Perm; `test_dm_has_armnrs` expected Exp
- **Fix:** Removed CMSTDTC/CMENDTC from Perm parametrize, changed ARMNRS expected to Perm
- **Files modified:** tests/test_reference/test_sdtm_ig.py
- **Commit:** a9cfe29

## Verification

- `pytest -x -q`: 686 passed, 15 skipped
- `ruff check tests/test_reference/test_sdtm_ig.py`: clean (1 pre-existing line-length issue in unmodified code)
- All 25 new tests pass
- All 102 pre-existing tests in test_sdtm_ig.py continue to pass

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| D-03.1-03-01 | Empty string for cdisc_notes on new Perm vars | VariableSpec.cdisc_notes is `str` not `str \| None`; empty string is valid default |
| D-03.1-03-02 | Append new vars at max_order+N | Avoids reordering existing variables that other code may depend on |
| D-03.1-03-03 | Updated existing test assertions | Tests must match corrected reference data, not perpetuate errors |
