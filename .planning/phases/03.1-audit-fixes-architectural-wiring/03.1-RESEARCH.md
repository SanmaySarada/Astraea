# Phase 3.1: Audit Fixes + Architectural Wiring - Research

**Researched:** 2026-02-27
**Domain:** SDTM reference data corrections, Pydantic model additions, bug fixes, and production code wiring
**Confidence:** HIGH

## Summary

This phase addresses all issues identified in `.planning/PHASE3_AUDIT.md`: 5 CRITICAL, 14 HIGH, 8 MEDIUM, and 3 architectural gaps. The work is entirely deterministic -- no LLM calls, no new features, just fixing reference data, adding missing model fields, fixing bugs, and wiring existing transforms into the production code path.

The audit found three categories of work: (1) reference data gaps in domains.json and codelists.json that would cause FDA technical rejection, (2) code bugs in the mapping engine, profiler, exporters, and XPT writer, and (3) architectural disconnects where working code (transforms/) has zero production imports.

**Primary recommendation:** Treat this as a strict fix-and-verify phase. Every fix has a clear before/after state. No new features, no refactoring beyond what the audit requires. All 579+ existing tests must continue passing after every fix.

## Standard Stack

No new libraries needed. All fixes use existing codebase tools:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| pydantic | >=2.10 | Model field additions (order, length, missing_required_variables) | Already in use |
| pytest | >=8.0 | Test new/fixed behavior | Already in use |

### Supporting
No new dependencies. All work is editing existing JSON data files, Python models, and wiring imports.

## Architecture Patterns

### Pattern 1: Reference Data as JSON (Existing)
**What:** All SDTM-IG domain specs and CT codelists are bundled as JSON in `src/astraea/data/`.
**How to add domains/codelists:** Follow existing JSON structure exactly. Each domain entry in `domains.json` has: `domain`, `description`, `domain_class`, `structure`, `variables[]` (each with `name`, `label`, `data_type`, `core`, `cdisc_notes`, `codelist_code`, `order`), `key_variables`.
**Example existing entry shape:** See DM in domains.json for full template.

### Pattern 2: Enrichment Pipeline (Existing)
**What:** `validation.py:validate_and_enrich()` takes LLM proposals and enriches them with data from SDTM-IG reference (labels, core, data_type). New fields (order, length) must follow this same pattern -- pulled from VariableSpec during enrichment, not generated by the LLM.
**Key file:** `src/astraea/mapping/validation.py` lines 136-154 -- the VariableMapping constructor. New fields added to VariableMapping must be populated here from `var_spec`.

### Pattern 3: Transform Wiring (NEW)
**What:** `src/astraea/transforms/` contains working date conversion and USUBJID generation code with 34+ test calls but zero production imports. These need to be importable from the mapping engine for Phase 4 execution.
**Approach:** Import transform function signatures into `context.py` or `engine.py` so that:
  1. The mapping spec can reference available transforms by name
  2. Phase 4 execution code has a clear import path
**Do NOT:** Make the mapping engine call transforms directly. The engine produces specs; execution happens in Phase 4.

### Anti-Patterns to Avoid
- **Changing model fields without updating serialization tests:** Every field added to VariableMapping or DomainMappingSpec must have corresponding test coverage for JSON roundtrip.
- **Adding codelists with incomplete term lists:** Each codelist must have ALL submission values per NCI EVS, not just common ones. Incomplete codelists cause silent validation gaps.
- **Editing domains.json by hand without verifying against SDTM-IG v3.4:** Every variable name, label, data_type, core designation, and order must match the official spec.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Codelist term lookup | Custom web scraper for NCI EVS | Manual curation from official NCI EVS browser | Only 16 codelists needed; web scraping is fragile and overkill |
| Variable ordering | Custom sorting logic | Use `order` field from SDTM-IG v3.4 spec | Order is prescribed by the standard |
| Date disambiguation (DD/MM vs MM/DD) | New logic in profiler | Port logic from `transforms/dates.py:detect_date_format()` | Already correctly implemented, just needs to replace the broken profiler version |

## Common Pitfalls

### Pitfall 1: C66742 "U" Term Survived Phase 2.1
**What goes wrong:** The audit found "U" still in C66742 (No Yes Response). Phase 2.1 was supposed to remove it but didn't.
**Why it happens:** The fix may have been planned but the JSON edit was missed or overwritten.
**How to avoid:** Verify the fix with a targeted test: `assert "U" not in ct_ref.lookup_codelist("C66742").terms`.
**Warning signs:** Any test asserting 3 terms in C66742 instead of 2.

### Pitfall 2: Adding Trial Design Domains Without Correct Class
**What goes wrong:** Adding TS, TA, TE, TV, TI with `domain_class: "Special-Purpose"` instead of `"Trial Design"`.
**Why it happens:** Copy-paste from existing domains. Trial Design is a distinct class in DomainClass enum (already defined in sdtm.py).
**How to avoid:** Every new domain must use the DomainClass enum value: `"Trial Design"` for TS/TA/TE/TV/TI, `"Special-Purpose"` for SE/CO.

### Pitfall 3: VariableMapping Field Addition Breaking Existing JSON Exports
**What goes wrong:** Adding `order: int` and `length: int | None` to VariableMapping without defaults breaks existing code that constructs VariableMapping without these fields (tests, engine.py:_build_spec).
**Why it happens:** Pydantic requires all new fields either have defaults or be provided everywhere.
**How to avoid:** Add with defaults: `order: int = 0`, `length: int | None = None`. The enrichment step populates them from VariableSpec. Zero/None are safe defaults for backward compatibility.

### Pitfall 4: SUPPQUAL Label Bug Fix Scope
**What goes wrong:** Only fixing the hardcoded "SUPPDM" string on line 217 of exporters.py but missing other hardcoded references.
**Why it happens:** Grep may miss similar patterns if they use slightly different phrasing.
**How to avoid:** Search for all occurrences of "SUPPDM" in exporters.py and replace with f-string using `spec.domain`.

### Pitfall 5: Codelist Term Data Quality
**What goes wrong:** Adding a codelist with incorrect terms, wrong extensibility flag, or missing variable_mappings.
**Why it happens:** Relying on training data instead of verifying each codelist against NCI EVS.
**How to avoid:** For each of the 16 missing codelists, verify against NCI EVS Terminology Browser (https://nciterms.nci.nih.gov/ncitbrowser/). Cross-check extensibility and term count.

## Code Examples

### Fix 1: SUPPQUAL Label Bug (exporters.py line 217)

**Before:**
```python
ws.cell(row=row, column=4, value="SUPPDM Candidate")
```

**After:**
```python
ws.cell(row=row, column=4, value=f"SUPP{spec.domain} Candidate")
```

### Fix 2: Add missing_required_variables to DomainMappingSpec (mapping.py)

**Add to DomainMappingSpec class:**
```python
missing_required_variables: list[str] = Field(
    default_factory=list,
    description="Required SDTM variables not mapped by LLM proposal",
)
```

**Wire in engine.py:_build_spec():**
```python
# After check_required_coverage call (line 156-162), pass result to spec:
missing_required = check_required_coverage(enriched_mappings, domain_spec)
# ... then in DomainMappingSpec constructor:
missing_required_variables=missing_required,
```

### Fix 3: Add order and length to VariableMapping (mapping.py)

```python
class VariableMapping(BaseModel):
    # ... existing fields ...
    order: int = Field(
        default=0,
        ge=0,
        description="Display order within domain from SDTM-IG spec",
    )
    length: int | None = Field(
        default=None,
        description="Character variable length for XPT generation",
    )
```

**Wire in validation.py:_validate_single_proposal():**
```python
# After looking up var_spec (line 76-79), extract order:
if var_spec is not None:
    order = var_spec.order
else:
    order = 0

# In VariableMapping constructor, add:
mapping = VariableMapping(
    # ... existing fields ...
    order=order,
    length=None,  # Populated during dataset generation
)
```

### Fix 4: Profiler Date Format Disambiguation (profiler.py)

**Replace lines 75-82 with logic from transforms/dates.py:**
```python
_DATE_PATTERNS: list[tuple[str, re.Pattern[str]]] = [
    ("DD Mon YYYY", re.compile(r"^\d{1,2}\s+[A-Za-z]{3}\s+\d{4}$")),
    ("YYYY-MM-DD", re.compile(r"^\d{4}-\d{1,2}-\d{1,2}$")),
    ("DD-Mon-YYYY", re.compile(r"^\d{1,2}-[A-Za-z]{3}-\d{4}$")),
    ("YYYY-MM-DDTHH:MM:SS", re.compile(r"^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}")),
    # Slash pattern handled separately with disambiguation
    ("SLASH_DATE", re.compile(r"^\d{1,2}/\d{1,2}/\d{4}$")),
]
```

Then in `detect_date_format()`, for SLASH_DATE matches, apply the same disambiguation logic as `transforms/dates.py`:
```python
if format_name == "SLASH_DATE":
    m = re.match(r"^(\d{1,2})/(\d{1,2})/(\d{4})$", s.strip())
    if m:
        first, second = int(m.group(1)), int(m.group(2))
        if first > 12:
            return "DD/MM/YYYY"
        elif second > 12:
            return "MM/DD/YYYY"
        else:
            return "DD/MM/YYYY"  # ambiguous default
```

### Fix 5: XPT Writer Dataset Label Validation (xpt_writer.py)

**Add to validate_for_xpt_v5():**
```python
def validate_for_xpt_v5(
    df: pd.DataFrame,
    column_labels: dict[str, str],
    table_name: str,
    table_label: str | None = None,  # NEW parameter
) -> list[str]:
    # ... existing checks ...

    # Table label validation (NEW)
    if table_label is not None and len(table_label) > 40:
        errors.append(
            f"Table label exceeds 40 characters ({len(table_label)} chars): "
            f"'{table_label[:50]}...'"
        )

    # Unlabeled column warning (NEW)
    for col in df.columns:
        col_str = str(col)
        if col_str not in column_labels and col_str.upper() not in {k.upper() for k in column_labels}:
            errors.append(
                f"Column '{col_str}' has no label defined -- "
                f"every SDTM variable must have a label"
            )
```

**Add table_label to write_xpt_v5():**
```python
def write_xpt_v5(
    df: pd.DataFrame,
    path: str | Path,
    table_name: str,
    column_labels: dict[str, str],
    table_label: str | None = None,  # NEW parameter
) -> None:
    # ... pass table_label to validation ...
    # ... pass table_label to pyreadstat.write_xport() ...
```

### Fix 6: Wire Transforms into Production Code

**In engine.py or a new transforms registry module:**
```python
# src/astraea/mapping/transform_registry.py (NEW)
"""Registry of available deterministic transforms for mapping specs.

Makes transform function signatures discoverable by the mapping engine
so that derivation_rule references can be validated against actual
available transforms.
"""

from astraea.transforms.dates import (
    sas_date_to_iso,
    sas_datetime_to_iso,
    parse_string_date_to_iso,
    format_partial_iso8601,
)
from astraea.transforms.usubjid import (
    generate_usubjid,
    generate_usubjid_column,
)

AVAILABLE_TRANSFORMS: dict[str, callable] = {
    "sas_date_to_iso": sas_date_to_iso,
    "sas_datetime_to_iso": sas_datetime_to_iso,
    "parse_string_date_to_iso": parse_string_date_to_iso,
    "format_partial_iso8601": format_partial_iso8601,
    "generate_usubjid": generate_usubjid,
    "generate_usubjid_column": generate_usubjid_column,
}
```

## Reference Data Fixes -- Detailed Specifications

### TS Domain (CRITICAL -- FDA TRC rejection without it)

Must add to domains.json. TS is Trial Design class, structure: "One record per trial summary parameter value".

**Required TS variables (per SDTM-IG v3.4):**

| Order | Name | Label | Type | Core | Codelist |
|-------|------|-------|------|------|----------|
| 1 | STUDYID | Study Identifier | Char | Req | null |
| 2 | DOMAIN | Domain Abbreviation | Char | Req | C66734 |
| 3 | TSSEQ | Sequence Number | Num | Req | null |
| 4 | TSGRPID | Group ID | Char | Perm | null |
| 5 | TSPARMCD | Trial Summary Parameter Short Name | Char | Req | C66738 |
| 6 | TSPARM | Trial Summary Parameter | Char | Req | null |
| 7 | TSVAL | Parameter Value | Char | Req | null |
| 8 | TSVALNF | Parameter Null Flavor | Char | Perm | null |
| 9 | TSVALCD | Parameter Value Code | Char | Perm | null |
| 10 | TSVCDREF | Name of the Reference Terminology | Char | Perm | null |
| 11 | TSVCDVER | Version of the Reference Terminology | Char | Perm | null |

**Key variables:** `["STUDYID", "TSPARMCD", "TSSEQ"]`

**FDA Required TS Parameters (minimum set):**
SSTDTC, SPONSOR, TITLE, STYPE, PLANSUB, RANDOM, SEXPOP, TBLIND, TCNTRL, TPHASE, TTYPE, OBJPRIM, REGID, OUTMSPRI, FCNTRY, AGEMIN, AGEMAX, LENGTH, STOPRULE, ADAPT, ACTSUB, NARMS, HLTSUBJI, SDTIGVER, SDTMVER

Note: These are parameter VALUES in TSPARMCD, not separate variables. The domain has the same 11 variables for every row.

### Trial Design Domains (TA, TE, TV, TI)

**TA (Trial Arms):**
- Class: Trial Design
- Structure: One record per planned element per arm
- Key variables: `["STUDYID", "ARMCD", "TAETORD"]`
- Variables: STUDYID (Req), DOMAIN (Req), ARMCD (Req), ARM (Req), TAETORD (Req), ETCD (Req), ELEMENT (Req), TABESSION (Perm), EPOCH (Perm)

**TE (Trial Elements):**
- Class: Trial Design
- Structure: One record per planned element
- Key variables: `["STUDYID", "ETCD"]`
- Variables: STUDYID (Req), DOMAIN (Req), ETCD (Req), ELEMENT (Req), TESTRL (Req), TEENRL (Req), TEDUR (Perm)

**TV (Trial Visits):**
- Class: Trial Design
- Structure: One record per planned visit per arm
- Key variables: `["STUDYID", "VISITNUM", "ARMCD"]`
- Variables: STUDYID (Req), DOMAIN (Req), VISITNUM (Req), VISIT (Req), VISITDY (Perm), ARMCD (Req), ARM (Req), TVSTRL (Perm), TVENRL (Perm)

**TI (Trial Inclusion/Exclusion):**
- Class: Trial Design
- Structure: One record per I/E criterion
- Key variables: `["STUDYID", "IETESTCD"]`
- Variables: STUDYID (Req), DOMAIN (Req), IETESTCD (Req), IETEST (Req), IECAT (Req), IESCAT (Perm), TIRL (Perm), TIVERS (Perm)

### SE (Subject Elements)

- Class: Special-Purpose
- Structure: One record per actual element per subject
- Key variables: `["STUDYID", "USUBJID", "ETCD", "SESTDTC"]`
- Variables: STUDYID (Req), DOMAIN (Req), USUBJID (Req), SESEQ (Req), ETCD (Exp), ELEMENT (Exp), SESTDTC (Exp), SEENDTC (Exp), TAESSION (Perm), EPOCH (Perm)

### CO (Comments)

- Class: Special-Purpose
- Structure: One record per comment per subject
- Key variables: `["STUDYID", "USUBJID", "COSEQ"]`
- Variables: STUDYID (Req), DOMAIN (Req), USUBJID (Perm), COSEQ (Req), RDOMAIN (Perm), IDVAR (Perm), IDVARVAL (Perm), COREF (Perm), CODTC (Perm), COVAL (Req), COEVAL (Perm)

### SUPPQUAL Structure Definition

Add as a pseudo-domain in domains.json or a separate file. The 10-variable structure is fixed for all SUPP-- datasets:

| Order | Name | Label | Type | Core |
|-------|------|-------|------|------|
| 1 | STUDYID | Study Identifier | Char | Req |
| 2 | RDOMAIN | Related Domain Abbreviation | Char | Req |
| 3 | USUBJID | Unique Subject Identifier | Char | Req |
| 4 | IDVAR | Identifying Variable | Char | Exp |
| 5 | IDVARVAL | Identifying Variable Value | Char | Exp |
| 6 | QNAM | Qualifier Variable Name | Char | Req |
| 7 | QLABEL | Qualifier Variable Label | Char | Req |
| 8 | QVAL | Data Value | Char | Req |
| 9 | QORIG | Origin | Char | Req |
| 10 | QEVAL | Evaluator | Char | Exp |

### 16 Missing Codelists

For each codelist below, the data needed is: C-code, name, extensible flag, variable_mappings, and complete term list. The term structure follows the existing pattern: `{submission_value, synonyms[], definition, nci_preferred_term}`.

**Confidence note:** The C-codes and codelist names are HIGH confidence (from SDTM-IG v3.4 and NCI EVS). The complete term lists need verification against NCI EVS Terminology Browser during implementation. Below are the key terms for critical codelists:

| # | C-Code | Name | Extensible | Key Terms (verify against NCI EVS) |
|---|--------|------|------------|-------------------------------------|
| 1 | C66767 | Action Taken with Study Treatment | No | DOSE NOT CHANGED, DOSE REDUCED, DOSE INCREASED, DRUG INTERRUPTED, DRUG WITHDRAWN, NOT APPLICABLE, UNKNOWN |
| 2 | C66727 | Disposition Event | Yes | COMPLETED, SCREEN FAILURE, ADVERSE EVENT, DEATH, LACK OF EFFICACY, LOST TO FOLLOW-UP, PHYSICIAN DECISION, PROTOCOL VIOLATION, WITHDRAWAL BY SUBJECT, OTHER |
| 3 | C65047 | Laboratory Test Code | Yes | ALB, ALP, ALT, AST, BILI, BUN, CA, CHOL, CK, CREAT, GLUC, HBA1C, HCT, HGB, K, LYM, MCH, MCHC, MCV, MONO, NEUT, PLAT, PROT, RBC, SODIUM, TRIG, WBC, etc. (large, extensible) |
| 4 | C67154 | Laboratory Test Name | Yes | Albumin, Alkaline Phosphatase, etc. (mirrors C65047 with full names) |
| 5 | C66741 | Vital Signs Test Code | Yes | BMI, DIABP, HEIGHT, HR, OXYSAT, PULSE, RESP, SYSBP, TEMP, WEIGHT |
| 6 | C67153 | Vital Signs Test Name | Yes | Body Mass Index, Diastolic Blood Pressure, Height, Heart Rate, etc. |
| 7 | C71153 | ECG Test Code | Yes | ECGHRMN, INTP, PRMEAN, QRSDUR, QTCBMN, QTCFMN, QTMEAN, RRMEAN, VENRATE |
| 8 | C71152 | ECG Test Name | Yes | ECG Mean Heart Rate, Interpretation, etc. |
| 9 | C66726 | Pharmaceutical Dosage Form | Yes | CAPSULE, CREAM, GEL, INJECTION, LOTION, OINTMENT, PATCH, POWDER, SOLUTION, SPRAY, SUPPOSITORY, SUSPENSION, SYRUP, TABLET |
| 10 | C66734 | Domain Abbreviation | No | AE, CE, CM, CO, DA, DM, DS, DV, EG, EX, FA, IE, LB, MH, PE, QS, SC, SE, SV, TA, TE, TI, TS, TV, VS (all standard domains) |
| 11 | C78736 | Reference Range Indicator | No | NORMAL, HIGH, LOW, ABNORMAL, HIGH HIGH, LOW LOW |
| 12 | C78734 | Specimen Type | Yes | BLOOD, PLASMA, SERUM, URINE, WHOLE BLOOD, CSF, etc. |
| 13 | C71148 | Position | No | SITTING, STANDING, SUPINE |
| 14 | C66728 | Relation to Reference Period | No | BEFORE, DURING, DURING/AFTER, AFTER, ONGOING |
| 15 | C99079 | Epoch | Yes | SCREENING, RUN-IN, TREATMENT, FOLLOW-UP, NOT APPLICABLE |
| 16 | C74456 | Anatomical Location | Yes | HEAD, NECK, CHEST, ABDOMEN, ARM, LEG, BACK, etc. |

**IMPORTANT:** For extensible codelists (C65047, C67154, C66741, C67153, C71153, C71152, C66726, C78734, C99079, C74456), include the most common terms from NCI EVS but mark as extensible=true so study-specific terms pass validation.

For non-extensible codelists (C66767, C66734, C78736, C71148, C66728), the term list must be COMPLETE -- these are the ONLY valid values.

### C66742 Fix

Remove "U" from C66742 (No Yes Response). Final terms: N, Y only. This is non-extensible.

### Core Designation Fixes

| Domain | Variable | Current | Correct |
|--------|----------|---------|---------|
| DM | ARMNRS | Exp | Perm |
| CM | CMSTDTC | Perm | Exp |
| CM | CMENDTC | Perm | Exp |

### Label Fixes

| Domain | Variable | Current | Correct |
|--------|----------|---------|---------|
| EX | EXDOSE | "Dose" | "Dose per Administration" |

### Missing Variables to Add

**Expected (must add):**
| Domain | Variable | Label | Type | Core | Order | Codelist |
|--------|----------|-------|------|------|-------|----------|
| LB | LBBLFL | Baseline Flag | Char | Exp | (after LBNRIND) | C66742 |
| VS | VSBLFL | Baseline Flag | Char | Exp | (after VSNRIND/VSSTAT) | C66742 |

**Permissible (should add for completeness):**
| Domain | Variable | Label | Type | Core | Codelist |
|--------|----------|-------|------|------|----------|
| DM | INVID | Investigator Identifier | Char | Perm | null |
| DM | INVNAM | Investigator Name | Char | Perm | null |
| AE | AETOXGR | Standard Toxicity Grade | Char | Perm | null |
| AE | AEREFID | Reference ID | Char | Perm | null |
| AE | AEGRPID | Group ID | Char | Perm | null |
| CM | CMCLAS | Medication Class | Char | Perm | null |
| CM | CMCLASCD | Medication Class Code | Char | Perm | null |
| EX | EXLOT | Lot Number | Char | Perm | null |
| LB | LBMETHOD | Method of Test or Examination | Char | Perm | null |
| VS | VSLOC | Location of Vital Signs Assessment | Char | Perm | null |

### Null Key Variables to Fill

Per SDTM-IG reference research:

| Domain | Key Variables |
|--------|-------------|
| IE | ["STUDYID", "USUBJID", "IETESTCD"] |
| CE | ["STUDYID", "USUBJID", "CETERM", "CESTDTC"] |
| DV | ["STUDYID", "USUBJID", "DVTERM", "DVSTDTC"] |
| PE | ["STUDYID", "USUBJID", "PETESTCD", "VISITNUM", "PEDTC"] |
| QS | ["STUDYID", "USUBJID", "QSTESTCD", "VISITNUM", "QSDTC", "QSCAT"] |
| SC | ["STUDYID", "USUBJID", "SCTESTCD"] |
| FA | ["STUDYID", "USUBJID", "FATESTCD", "FADTC"] |
| SV | ["STUDYID", "USUBJID", "VISITNUM"] |
| DA | ["STUDYID", "USUBJID", "DATRT", "DASTDTC"] |

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual SDTM-IG data entry | Still manual but with NCI EVS verification | Ongoing | Must verify every entry against NCI EVS |
| Profiler used same regex for DD/MM and MM/DD | transforms/dates.py has working disambiguation | Phase 3 | Port the working logic to profiler |
| Missing required vars only logged | Must be persisted on DomainMappingSpec | This phase | Enables Phase 4 human review gate |

## Open Questions

1. **Codelist term completeness for large extensible codelists:**
   - What we know: C65047 (Lab Test Code) and C67154 (Lab Test Name) have hundreds of terms. Including all of them in codelists.json would make the file very large.
   - What's unclear: How many terms to include for extensible codelists.
   - Recommendation: Include the ~50 most common terms for each. Mark as extensible. The validation logic already allows unlisted terms for extensible codelists.

2. **Transform wiring depth:**
   - What we know: transforms/ needs at least an import path from production code.
   - What's unclear: Should the mapping engine actively validate derivation_rule against available transforms, or just make them importable?
   - Recommendation: Create a transform registry module with a simple name-to-function mapping. Validation of derivation_rule against the registry is a Phase 4 concern.

3. **SUPPQUAL definition storage:**
   - What we know: The SUPPQUAL structure needs to be formally defined somewhere.
   - What's unclear: Should it go in domains.json as a pseudo-domain or a separate file?
   - Recommendation: Add as `"SUPPQUAL"` key in domains.json with the standard 10-variable definition. This keeps all domain definitions in one place.

## Sources

### Primary (HIGH confidence)
- `.planning/PHASE3_AUDIT.md` -- the definitive issue list for this phase
- `.planning/research/SDTM_IG_V34_REFERENCE.md` -- verified SDTM-IG v3.4 domain specs, key variables, SUPPQUAL structure
- NCI EVS Terminology Browser (https://nciterms.nci.nih.gov/ncitbrowser/) -- authoritative source for CT codelist terms
- Existing codebase: domains.json, codelists.json, mapping.py, validation.py, exporters.py, profiler.py, xpt_writer.py, transforms/

### Secondary (MEDIUM confidence)
- SDTM-IG v3.4 (https://sastricks.com/cdisc/SDTMIG%20v3.4-FINAL_2022-07-21.pdf) -- full spec document
- FDA Technical Rejection Criteria for TS domain requirements

### Tertiary (LOW confidence)
- Specific codelist term lists above (marked for NCI EVS verification during implementation)

## Metadata

**Confidence breakdown:**
- Reference data structure (domains.json additions): HIGH -- follows existing patterns exactly
- Code bug fixes (exporters, profiler, xpt_writer): HIGH -- issues are precisely located with clear fixes
- Model field additions (order, length, missing_required_variables): HIGH -- straightforward Pydantic additions
- Codelist term completeness: MEDIUM -- C-codes and names are verified, but exact term lists need NCI EVS verification
- Transform wiring approach: MEDIUM -- recommended pattern is sound but exact scope depends on Phase 4 needs
- Trial Design domain variable specs: MEDIUM -- based on SDTM-IG reference research, should be verified against official spec

**Research date:** 2026-02-27
**Valid until:** 2026-03-27 (stable -- SDTM-IG v3.4 doesn't change, CT version locked to 2025-09-26)
