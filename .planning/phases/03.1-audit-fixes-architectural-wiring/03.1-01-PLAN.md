---
phase: 03.1-audit-fixes-architectural-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/data/ct/codelists.json
  - tests/unit/reference/test_controlled_terms.py
autonomous: true

must_haves:
  truths:
    - "All 16 previously missing codelists are loadable via CTReference.lookup_codelist()"
    - "C66742 contains exactly N and Y -- no U term"
    - "Non-extensible codelists (C66767, C66734, C78736, C71148, C66728) have COMPLETE term lists"
    - "Extensible codelists are flagged as extensible=true"
  artifacts:
    - path: "src/astraea/data/ct/codelists.json"
      provides: "All 16 missing codelists plus C66742 fix"
      contains: "C66767"
    - path: "tests/unit/reference/test_controlled_terms.py"
      provides: "Tests for new codelists and C66742 fix"
  key_links:
    - from: "src/astraea/data/ct/codelists.json"
      to: "src/astraea/reference/controlled_terms.py"
      via: "CTReference loads codelists.json at init"
      pattern: "lookup_codelist"
---

<objective>
Add 16 missing CT codelists to codelists.json and fix C66742 (remove invalid "U" term).

Purpose: The mapping engine cannot validate CT compliance for 16 variable-codelist pairs referenced in domains.json. Without these codelists, P21 validation will flag invalid values that our system silently accepts. C66742 "U" causes false acceptance of invalid AESER/AESDTH values.

Output: Updated codelists.json with 16 new codelist entries + C66742 fix, plus unit tests verifying each.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE3_AUDIT.md (sections C-02, C-03)
@.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-RESEARCH.md (section "16 Missing Codelists" + "C66742 Fix")
@src/astraea/data/ct/codelists.json
@src/astraea/reference/controlled_terms.py
@tests/unit/reference/test_controlled_terms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix C66742 and add 16 missing codelists to codelists.json</name>
  <files>src/astraea/data/ct/codelists.json</files>
  <action>
1. In codelists.json, find the C66742 entry. Remove the "U" term entirely. Only N and Y should remain. This is non-extensible.

2. Add 16 new codelist entries following the EXACT structure of existing entries (see DM's C66731 for template). Each entry needs: codelist_code, name, extensible (boolean), variable_mappings (list of {domain, variable}), terms (dict of submission_value -> {submission_value, synonyms[], definition, nci_preferred_term}).

The 16 codelists to add (from RESEARCH.md section "16 Missing Codelists"):

**Non-extensible (term list must be COMPLETE):**
- C66767 (Action Taken with Study Treatment): DOSE NOT CHANGED, DOSE REDUCED, DOSE INCREASED, DRUG INTERRUPTED, DRUG WITHDRAWN, NOT APPLICABLE, UNKNOWN. variable_mappings: [{AE, AEACN}]
- C66734 (Domain Abbreviation): AE, CE, CM, CO, DA, DM, DS, DV, EG, EX, FA, IE, LB, MH, PE, QS, SC, SE, SV, TA, TE, TI, TS, TV, VS. variable_mappings: [{domain: each_domain, variable: DOMAIN}] for all domains
- C78736 (Reference Range Indicator): NORMAL, HIGH, LOW, ABNORMAL. variable_mappings: [{LB, LBNRIND}]
- C71148 (Position): SITTING, STANDING, SUPINE. variable_mappings: [{VS, VSPOS}]
- C66728 (Relation to Reference Period): BEFORE, DURING, DURING/AFTER, AFTER, ONGOING. variable_mappings: [{MH, MHENRF}]

**Extensible (include common terms, mark extensible=true):**
- C66727 (Disposition Event): COMPLETED, SCREEN FAILURE, ADVERSE EVENT, DEATH, LACK OF EFFICACY, LOST TO FOLLOW-UP, PHYSICIAN DECISION, PROTOCOL VIOLATION, WITHDRAWAL BY SUBJECT, OTHER. variable_mappings: [{DS, DSDECOD}]
- C65047 (Laboratory Test Code): ~50 most common: ALB, ALP, ALT, AST, BASO, BILI, BUN, CA, CHOL, CK, CL, CO2, CREAT, EOS, GGT, GLUC, HBA1C, HCT, HGB, K, LDH, LYM, MCH, MCHC, MCV, MG, MONO, NEUT, PHOS, PLAT, PROT, RBC, SODIUM, TRIG, UA, URATE, WBC. variable_mappings: [{LB, LBTESTCD}]
- C67154 (Laboratory Test Name): Full names matching C65047 codes (Albumin, Alkaline Phosphatase, etc.). variable_mappings: [{LB, LBTEST}]
- C66741 (Vital Signs Test Code): BMI, DIABP, HEIGHT, HR, OXYSAT, PULSE, RESP, SYSBP, TEMP, WEIGHT. variable_mappings: [{VS, VSTESTCD}]
- C67153 (Vital Signs Test Name): Full names matching C66741. variable_mappings: [{VS, VSTEST}]
- C71153 (ECG Test Code): ECGHRMN, INTP, PRMEAN, QRSDUR, QTCBMN, QTCFMN, QTMEAN, RRMEAN, VENRATE. variable_mappings: [{EG, EGTESTCD}]
- C71152 (ECG Test Name): Full names matching C71153. variable_mappings: [{EG, EGTEST}]
- C66726 (Pharmaceutical Dosage Form): CAPSULE, CREAM, GEL, INJECTION, LOTION, OINTMENT, PATCH, POWDER, SOLUTION, SPRAY, SUPPOSITORY, SUSPENSION, SYRUP, TABLET. variable_mappings: [{EX, EXDOSFRM}]
- C78734 (Specimen Type): BLOOD, PLASMA, SERUM, URINE, WHOLE BLOOD, CEREBROSPINAL FLUID. variable_mappings: [{LB, LBSPEC}]
- C99079 (Epoch): SCREENING, RUN-IN, TREATMENT, FOLLOW-UP, NOT APPLICABLE. variable_mappings: [{DV, EPOCH}, {SV, EPOCH}]
- C74456 (Anatomical Location): HEAD, NECK, CHEST, ABDOMEN, ARM, LEG, BACK, HAND, FOOT. variable_mappings: [{PE, PELOC}]

For term structure, use concise definitions. For large extensible codelists (C65047, C67154), include ~40-50 common terms, not all hundreds.

IMPORTANT: Follow the EXACT JSON structure of existing entries. Look at existing codelists for the pattern.
  </action>
  <verify>
Run: `python -c "from astraea.reference.controlled_terms import CTReference; ct = CTReference(); print(len(ct._codelists))"` -- should show count increased by 16 from baseline.
Run: `python -c "from astraea.reference.controlled_terms import CTReference; ct = CTReference(); cl = ct.lookup_codelist('C66742'); print(sorted(cl.terms.keys()))"` -- should print ['N', 'Y'] only.
Run: `python -c "from astraea.reference.controlled_terms import CTReference; ct = CTReference(); cl = ct.lookup_codelist('C66767'); print(cl.name, cl.extensible)"` -- should print "Action Taken with Study Treatment False".
  </verify>
  <done>All 16 codelists loadable via CTReference, C66742 has exactly 2 terms (N, Y), non-extensible codelists have complete term sets</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new codelists and C66742 fix</name>
  <files>tests/unit/reference/test_controlled_terms.py</files>
  <action>
Add tests to the existing test file:

1. Test C66742 fix: `assert "U" not in ct.lookup_codelist("C66742").terms` and `assert set(ct.lookup_codelist("C66742").terms.keys()) == {"N", "Y"}`

2. For each of the 5 non-extensible codelists (C66767, C66734, C78736, C71148, C66728), add a test that:
   - Verifies the codelist loads (not None)
   - Verifies extensible is False
   - Verifies the exact term set matches expected (since non-extensible = complete)

3. For the 11 extensible codelists, add a parametrized test that:
   - Verifies each codelist loads (not None)
   - Verifies extensible is True
   - Verifies at least N terms exist (use reasonable minimums: C65047 >= 30, C67154 >= 30, others >= 5)

4. Run the full test suite to confirm no regressions: `pytest -x -q`
  </action>
  <verify>`pytest tests/unit/reference/test_controlled_terms.py -v` -- all new tests pass. `pytest -x -q` -- full suite still passes (579+ tests).</verify>
  <done>Tests confirm all 16 codelists load correctly, C66742 has only N/Y, non-extensible codelists have complete term sets, full test suite passes</done>
</task>

</tasks>

<verification>
- `pytest -x -q` passes with 579+ tests
- `python -c "from astraea.reference.controlled_terms import CTReference; ct = CTReference(); missing = [c for c in ['C66767','C66727','C65047','C67154','C66741','C67153','C71153','C71152','C66726','C66734','C78736','C78734','C71148','C66728','C99079','C74456'] if ct.lookup_codelist(c) is None]; print('Missing:', missing)"` prints "Missing: []"
- `ruff check src/ tests/` passes
</verification>

<success_criteria>
- All 16 codelists load via CTReference.lookup_codelist()
- C66742 contains exactly N, Y (no U)
- Non-extensible codelists have complete term lists
- Extensible codelists are marked extensible=true
- All existing 579+ tests pass plus new codelist tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-01-SUMMARY.md`
</output>
