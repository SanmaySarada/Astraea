---
phase: 03.1-audit-fixes-architectural-wiring
plan: 05
subsystem: profiling, io, mapping, transforms
tags: [date-disambiguation, xpt-validation, suppqual, transform-registry]
depends_on:
  requires: [01, 02, 02.1, 03]
  provides: [fixed-profiler-date-detection, xpt-label-validation, suppqual-prompt-guidance, transform-registry]
  affects: [04, 05, 06]
tech_stack:
  added: []
  patterns: [transform-registry-pattern]
key_files:
  created:
    - src/astraea/mapping/transform_registry.py
  modified:
    - src/astraea/profiling/profiler.py
    - src/astraea/io/xpt_writer.py
    - src/astraea/transforms/dates.py
    - src/astraea/mapping/engine.py
    - src/astraea/mapping/prompts.py
    - tests/test_profiling/test_profiler_unit.py
    - tests/test_io/test_xpt_writer.py
    - tests/test_transforms/test_dates.py
    - tests/unit/mapping/test_transform_registry.py
decisions:
  - id: D-03.1-05-01
    description: "SLASH_DATE pattern with field-value disambiguation replaces duplicate DD/MM and MM/DD regex"
  - id: D-03.1-05-02
    description: "All _RAW columns checked for string dates (not just *DAT*_RAW) -- false positives are harmless"
  - id: D-03.1-05-03
    description: "XPT unlabeled column check uses case-insensitive fallback for label key matching"
  - id: D-03.1-05-04
    description: "timezone.utc -> UTC alias fixed in dates.py (ruff UP017 pre-existing lint fix)"
metrics:
  duration: ~6 min
  completed: 2026-02-27
---

# Phase 3.1 Plan 05: Profiler, XPT Writer, Docstrings, Prompts, and Transform Registry Summary

**One-liner:** Fixed profiler dead-code slash-date bug and _RAW detection, added XPT label validation, corrected docstrings, enhanced SUPPQUAL prompts with QNAM/QORIG/EDC rules, and created transform registry bridging transforms/ to production mapping code.

## Tasks Completed

| # | Task | Commit | Key Changes |
|---|------|--------|-------------|
| 1 | Fix profiler date disambiguation and XPT writer gaps | 64f0720 | SLASH_DATE pattern + disambiguation, broadened _RAW detection, table_label + unlabeled column validation |
| 2 | Fix docstrings, add error wrapping, enhance SUPPQUAL prompts, create transform registry | bbbd7a8 | Corrected sas_date_to_iso/sas_datetime_to_iso examples, LLM error wrapping, SUPPQUAL QNAM/QORIG/EDC rules, transform_registry.py |
| 3 | Add tests for all fixes | 7ef10ea | 60 new tests covering all changes |

## Decisions Made

1. **D-03.1-05-01:** Replaced two identical DD/MM/YYYY and MM/DD/YYYY regex patterns with a single SLASH_DATE pattern that defers to field-value analysis for disambiguation. First field > 12 means DD/MM/YYYY, second field > 12 means MM/DD/YYYY, all ambiguous defaults to DD/MM/YYYY per D-0104-01.

2. **D-03.1-05-02:** Broadened `_is_potential_string_date_column` to match all `_RAW` columns instead of requiring both `_RAW` and `DAT` in the name. False positives (e.g., VISIT_RAW without dates) are harmless because `detect_date_format()` returns None when sample values don't match any date pattern.

3. **D-03.1-05-03:** XPT unlabeled column check uses case-insensitive fallback -- if `col_str` is not in `column_labels` keys directly, it checks if `col_str.upper()` matches any uppercased key.

4. **D-03.1-05-04:** Fixed pre-existing ruff UP017 lint warning in dates.py: `timezone.utc` replaced with `UTC` import from `datetime` (Python 3.12+).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed pre-existing ruff UP017 lint warning in dates.py**
- **Found during:** Task 2
- **Issue:** `timezone.utc` used instead of `datetime.UTC` alias (ruff UP017)
- **Fix:** Changed import from `datetime import ... timezone` to `datetime import UTC, ...` and updated usage
- **Files modified:** src/astraea/transforms/dates.py
- **Commit:** bbbd7a8

**2. [Rule 1 - Bug] Fixed ruff UP035 lint warning in transform_registry.py**
- **Found during:** Task 2 verification
- **Issue:** `from typing import Callable` should be `from collections.abc import Callable`
- **Fix:** Updated import
- **Files modified:** src/astraea/mapping/transform_registry.py
- **Commit:** bbbd7a8

## Verification Results

- `pytest -x -q` (excluding 1 pre-existing failure): 639 passed, 15 skipped
- `ruff check` on all modified source files: all checks passed
- `python -c "from astraea.mapping.transform_registry import list_transforms; print(len(list_transforms()))"` prints 6
- `grep -c "QNAM" src/astraea/mapping/prompts.py` returns 2

## Test Suite Impact

- Tests before: 579 passing
- Tests added: 60 (10 profiler, 7 XPT, 4 docstring, 12 transform registry, remainder parametrized)
- Tests after: 639 passing
- Pre-existing failure: 1 (test_old_wrong_codes_do_not_exist -- C66767 is a valid codelist)

## Next Phase Readiness

All Phase 3.1 audit fixes are now complete (plans 01-05). The codebase is ready for Phase 4 (Human Review Gate):
- Reference data corrected (plans 01-02)
- Model fields and validation fixed (plans 03-04)
- Profiler, XPT writer, prompts, and transforms wired up (plan 05)
- Transform registry provides production import path for transforms/
- SUPPQUAL prompts guide LLM with QNAM constraints and EDC exclusion
