---
phase: 03.1-audit-fixes-architectural-wiring
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/models/mapping.py
  - src/astraea/mapping/validation.py
  - src/astraea/mapping/engine.py
  - src/astraea/mapping/exporters.py
  - tests/unit/mapping/test_validation.py
  - tests/unit/mapping/test_exporters.py
  - tests/unit/models/test_mapping.py
autonomous: true

must_haves:
  truths:
    - "VariableMapping has order (int, default 0) and length (int|None, default None) fields"
    - "DomainMappingSpec has missing_required_variables (list[str], default []) field"
    - "Enrichment pipeline populates order from VariableSpec.order"
    - "Engine stores missing_required result on DomainMappingSpec"
    - "SUPPQUAL candidate label uses spec.domain dynamically (not hardcoded 'DM')"
    - "Non-extensible codelist validation fires for LOOKUP_RECODE patterns (not just ASSIGN)"
    - "All existing tests pass after model field additions"
  artifacts:
    - path: "src/astraea/models/mapping.py"
      provides: "order, length fields on VariableMapping; missing_required_variables on DomainMappingSpec"
      contains: "missing_required_variables"
    - path: "src/astraea/mapping/validation.py"
      provides: "order populated from var_spec during enrichment; LOOKUP_RECODE codelist validation"
      contains: "order"
    - path: "src/astraea/mapping/engine.py"
      provides: "missing_required wired to DomainMappingSpec"
      contains: "missing_required_variables"
    - path: "src/astraea/mapping/exporters.py"
      provides: "Dynamic SUPPQUAL label using spec.domain"
      contains: "SUPP{spec.domain}"
  key_links:
    - from: "src/astraea/mapping/validation.py"
      to: "src/astraea/models/mapping.py"
      via: "VariableMapping constructor with order field"
      pattern: "order=.*order"
    - from: "src/astraea/mapping/engine.py"
      to: "src/astraea/models/mapping.py"
      via: "DomainMappingSpec constructor with missing_required_variables"
      pattern: "missing_required_variables"
    - from: "src/astraea/mapping/validation.py"
      to: "src/astraea/reference/controlled_terms.py"
      via: "LOOKUP_RECODE codelist validation logs warning for non-extensible codelists"
      pattern: "lookup_recode.*extensible|non.extensible.*lookup"
---

<objective>
Fix mapping model fields, engine wiring, exporter bugs, and codelist validation gap: add order/length to VariableMapping, add missing_required_variables to DomainMappingSpec, wire them in validation.py and engine.py, fix SUPPQUAL label bug in exporters.py, and extend non-extensible codelist validation to cover LOOKUP_RECODE patterns.

Purpose: Without order field, define.xml and XPT generation cannot produce variables in correct SDTM-IG order. Without missing_required_variables on the spec, the human review gate (Phase 4) cannot show reviewers which Required variables are missing. The SUPPQUAL label bug would incorrectly label all non-DM SUPPQUAL candidates as "SUPPDM". The codelist validation gap means LOOKUP_RECODE patterns (the most common CT usage) skip non-extensible codelist compliance checks entirely.

Output: Updated models, validation, engine, and exporters with tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/PHASE3_AUDIT.md (sections C-05, H-07, H-08, H-09, M-08)
@.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-RESEARCH.md (sections "Fix 2", "Fix 3", "Fix 1", "Pitfall 3", "Pitfall 4")
@src/astraea/models/mapping.py
@src/astraea/mapping/validation.py
@src/astraea/mapping/engine.py
@src/astraea/mapping/exporters.py
@tests/unit/mapping/test_validation.py
@tests/unit/mapping/test_exporters.py
@tests/unit/models/test_mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model fields, fix SUPPQUAL label bug, and extend codelist validation</name>
  <files>
    src/astraea/models/mapping.py
    src/astraea/mapping/validation.py
    src/astraea/mapping/engine.py
    src/astraea/mapping/exporters.py
  </files>
  <action>
**1. Add fields to VariableMapping (mapping.py):**

Add two fields to the VariableMapping class (after the `notes` field or in a logical position):
```python
order: int = Field(
    default=0,
    ge=0,
    description="Display order within domain from SDTM-IG spec",
)
length: int | None = Field(
    default=None,
    description="Character variable length for XPT generation",
)
```

IMPORTANT: Both fields MUST have defaults (0 and None) for backward compatibility. Existing code that constructs VariableMapping without these fields must continue working.

**2. Add missing_required_variables to DomainMappingSpec (mapping.py):**

Add to DomainMappingSpec class:
```python
missing_required_variables: list[str] = Field(
    default_factory=list,
    description="Required SDTM variables not mapped by LLM proposal",
)
```

**3. Wire order into validation.py enrichment:**

In `_validate_single_proposal()`, after looking up var_spec (line ~76-79):
- If var_spec is not None: extract `order = var_spec.order`
- If var_spec is None: use `order = 0`

In the VariableMapping constructor call (line ~136-154), add:
```python
order=var_spec.order if var_spec is not None else 0,
```

**4. Extend non-extensible codelist validation for LOOKUP_RECODE (validation.py, H-09):**

Currently (lines 119-126), codelist validation only checks `assigned_value` against non-extensible codelists. For LOOKUP_RECODE patterns, `assigned_value` is typically None because recoding happens at execution time. This means non-extensible codelist compliance is NEVER checked for LOOKUP_RECODE.

After the existing non-extensible check block (line 126), add a warning for LOOKUP_RECODE patterns with non-extensible codelists where no assigned_value is present to validate:
```python
# For LOOKUP_RECODE with non-extensible codelists, warn that runtime
# values must be validated against CT (cannot check at spec time)
if (
    vp.mapping_pattern == "lookup_recode"
    and not cl.extensible
    and not vp.assigned_value
):
    issues.append(
        f"{vp.sdtm_variable}: non-extensible codelist "
        f"{vp.codelist_code} ({cl.name}) used with "
        f"lookup_recode -- runtime values MUST be validated "
        f"against CT during execution"
    )
    logger.warning(
        "Non-extensible codelist {cl} on {var} with lookup_recode "
        "pattern -- cannot validate at spec time, must validate "
        "at execution time",
        cl=vp.codelist_code,
        var=vp.sdtm_variable,
    )
```

IMPORTANT: Do NOT penalize confidence for this case. The mapping pattern itself is valid -- the issue is that validation must be deferred to execution time. The warning ensures the human reviewer and the execution engine are both aware.

**5. Wire missing_required_variables into engine.py:**

In `_build_spec()`, add a `missing_required_variables` parameter:
```python
def _build_spec(
    *,
    domain_spec,
    study_id,
    source_profiles,
    enriched_mappings,
    proposal,
    model_used,
    missing_required_variables: list[str] | None = None,  # NEW
) -> DomainMappingSpec:
```

In the DomainMappingSpec constructor call, add:
```python
missing_required_variables=missing_required_variables or [],
```

In `map_domain()`, pass missing_required to _build_spec:
```python
spec = _build_spec(
    domain_spec=domain_spec,
    study_id=study_metadata.study_id,
    source_profiles=source_profiles,
    enriched_mappings=enriched_mappings,
    proposal=proposal,
    model_used=model,
    missing_required_variables=missing_required,  # NEW
)
```

**6. Fix SUPPQUAL label bug (exporters.py line 217):**

Change:
```python
ws.cell(row=row, column=4, value="SUPPDM Candidate")
```
To:
```python
ws.cell(row=row, column=4, value=f"SUPP{spec.domain} Candidate")
```

Also search for any other hardcoded "SUPPDM" strings in exporters.py and replace with dynamic `spec.domain` usage.
  </action>
  <verify>
Run: `python -c "from astraea.models.mapping import VariableMapping; print(VariableMapping.model_fields.keys())"` -- should include 'order' and 'length'.
Run: `python -c "from astraea.models.mapping import DomainMappingSpec; print('missing_required_variables' in DomainMappingSpec.model_fields)"` -- should print True.
Run: `ruff check src/astraea/models/mapping.py src/astraea/mapping/validation.py src/astraea/mapping/engine.py src/astraea/mapping/exporters.py` -- clean.
  </verify>
  <done>All 4 files updated: 2 new VariableMapping fields, 1 new DomainMappingSpec field, enrichment wiring, engine wiring, LOOKUP_RECODE codelist warning, SUPPQUAL label fix</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for model fields, codelist validation, and bug fixes</name>
  <files>
    tests/unit/models/test_mapping.py
    tests/unit/mapping/test_validation.py
    tests/unit/mapping/test_exporters.py
  </files>
  <action>
**1. Test new VariableMapping fields (test_mapping.py):**
- Test that VariableMapping can be constructed without order/length (defaults work)
- Test that order=5 and length=200 can be set explicitly
- Test that order ge=0 constraint works (order=-1 should fail validation)
- Test JSON roundtrip: VariableMapping.model_dump_json() includes order and length fields

**2. Test missing_required_variables on DomainMappingSpec (test_mapping.py):**
- Test default is empty list
- Test explicit list ["STUDYID", "DOMAIN"] serializes correctly
- Test JSON roundtrip preserves the field

**3. Test order enrichment in validation (test_validation.py):**
- Create a mock domain_spec with a variable that has order=5
- Create a proposal for that variable
- Run validate_and_enrich
- Assert the resulting VariableMapping has order=5
- Test unknown variable (not in domain_spec) gets order=0

**4. Test LOOKUP_RECODE non-extensible codelist warning (test_validation.py, H-09):**
- Create a proposal with mapping_pattern="lookup_recode", codelist_code pointing to a non-extensible codelist, and assigned_value=None
- Create a mock CTReference that returns a non-extensible codelist for that code
- Run validate_and_enrich
- Assert that issues list contains a warning mentioning "non-extensible" and "lookup_recode" and "runtime"
- Assert that confidence is NOT penalized (the mapping is valid, just needs runtime validation)
- Also test: LOOKUP_RECODE with extensible codelist should NOT produce this warning
- Also test: LOOKUP_RECODE with non-extensible codelist but WITH assigned_value should use the existing assigned_value check, not the new warning

**5. Test SUPPQUAL label fix (test_exporters.py):**
- Create a DomainMappingSpec with domain="AE" and suppqual_candidates=["CUSTOM_VAR"]
- Export to Excel
- Read back the Unmapped Variables sheet
- Assert the disposition column says "SUPPAE Candidate" (not "SUPPDM Candidate")
- Also test with domain="DM" to ensure "SUPPDM Candidate" still works correctly

**6. Run full test suite:** `pytest -x -q`
  </action>
  <verify>`pytest tests/unit/models/test_mapping.py tests/unit/mapping/test_validation.py tests/unit/mapping/test_exporters.py -v` -- all new tests pass. `pytest -x -q` -- full suite passes.</verify>
  <done>Tests confirm model fields work with defaults, enrichment populates order, LOOKUP_RECODE codelist warning fires correctly, engine persists missing_required, SUPPQUAL label is dynamic</done>
</task>

</tasks>

<verification>
- `pytest -x -q` passes
- `ruff check src/ tests/` passes
- VariableMapping JSON includes order and length
- DomainMappingSpec JSON includes missing_required_variables
- LOOKUP_RECODE with non-extensible codelist produces warning in validation issues
</verification>

<success_criteria>
- VariableMapping has order (default 0) and length (default None)
- DomainMappingSpec has missing_required_variables (default [])
- Validation enrichment populates order from VariableSpec
- Engine passes missing_required to spec construction
- SUPPQUAL candidate labels use dynamic domain name
- Non-extensible codelist validation warns for LOOKUP_RECODE patterns without assigned_value
- All tests pass (579+ existing plus new)
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-04-SUMMARY.md`
</output>
