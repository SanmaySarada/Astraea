---
phase: 03.1-audit-fixes-architectural-wiring
plan: 02
subsystem: reference-data
tags: [sdtm-ig, domains, trial-design, suppqual, ts-domain]
depends_on:
  requires: [02.1-04]
  provides: [TS, TA, TE, TV, TI, SE, CO, SUPPQUAL domain definitions]
  affects: [03.1-03, 04, 06, 07]
tech-stack:
  added: []
  patterns: [SUPPQUAL pseudo-domain in domains.json]
key-files:
  created: []
  modified:
    - src/astraea/data/sdtm_ig/domains.json
    - src/astraea/models/sdtm.py
    - tests/test_reference/test_sdtm_ig.py
    - tests/test_reference/test_controlled_terms.py
decisions:
  - id: D-03.1-02-01
    description: "DomainSpec.domain max_length increased from 4 to 8 to accommodate SUPPQUAL"
  - id: D-03.1-02-02
    description: "SUPPQUAL added as pseudo-domain in domains.json (same structure as real domains)"
  - id: D-03.1-02-03
    description: "C66738 used as forward-reference codelist for TSPARMCD (not yet in codelists.json)"
metrics:
  duration: ~3 min
  completed: 2026-02-27
  tests-added: 26
  tests-fixed: 1
  total-tests: 605
---

# Phase 3.1 Plan 02: Add Missing Domains Summary

**One-liner:** Added 8 missing SDTM domains (TS, TA, TE, TV, TI, SE, CO, SUPPQUAL) with complete variable lists, key_variables, and 26 tests.

## What Was Done

### Task 1: Add 8 domains to domains.json
Added complete domain definitions for:
- **TS (Trial Summary):** 11 variables, Trial Design class, key: STUDYID/TSPARMCD/TSSEQ. FDA-mandatory domain.
- **TA (Trial Arms):** 10 variables including ARMCD, ARM, TAETORD, EPOCH
- **TE (Trial Elements):** 7 variables with TESTRL/TEENRL start/end rules
- **TV (Trial Visits):** 9 variables with visit windows per arm
- **TI (Trial Inclusion/Exclusion):** 8 variables with IECAT (INCLUSION/EXCLUSION)
- **SE (Subject Elements):** 10 variables, Special-Purpose class
- **CO (Comments):** 11 variables, Special-Purpose class
- **SUPPQUAL:** 10 standard variables (QNAM, QLABEL, QVAL, QORIG, etc.)

Total domains in domains.json: 26 (was 18).

### Task 2: Add tests for new domains
26 new tests in `TestTrialDesignAndMissingDomains` class covering:
- TS domain: loads, class, 11 vars, key_variables, required vars, TSPARMCD codelist
- Trial Design parametrized (TA/TE/TV/TI): class, var counts, key_variables
- SE/CO: Special-Purpose class, required vars (USUBJID, COVAL), key_variables
- SUPPQUAL: 10 vars, required/expected core designations, key_variables with QNAM
- Total domain count >= 26

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] DomainSpec.domain max_length too restrictive**
- **Found during:** Task 1 verification
- **Issue:** DomainSpec had `max_length=4` for domain field, but SUPPQUAL is 8 characters
- **Fix:** Increased max_length from 4 to 8 in `src/astraea/models/sdtm.py`
- **Commit:** fd99de5

**2. [Rule 1 - Bug] Stale C66742 test asserting removed "U" term**
- **Found during:** Task 2 full suite run
- **Issue:** test_ny_code_is_c66742 still asserted `"U" in cl.terms`, but U was correctly removed from C66742 in Phase 2.1
- **Fix:** Changed assertion to `"U" not in cl.terms`
- **Commit:** 680bac7

## Commits

| Hash | Message |
|------|---------|
| fd99de5 | feat(03.1-02): add TS, TA, TE, TV, TI, SE, CO, SUPPQUAL domains to domains.json |
| 680bac7 | test(03.1-02): add tests for TS, TA, TE, TV, TI, SE, CO, SUPPQUAL domains |

## Verification

- All 8 domains load via SDTMReference with correct domain_class and variable counts
- TS: Trial Design, 11 vars; TA-TI: Trial Design; SE/CO/SUPPQUAL: Special-Purpose
- Full test suite: 605 passed, 15 skipped
- Pre-existing ruff warnings unchanged (UP042, E501 on lines not modified)
