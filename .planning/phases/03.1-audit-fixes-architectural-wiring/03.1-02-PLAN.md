---
phase: 03.1-audit-fixes-architectural-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/data/sdtm_ig/domains.json
  - tests/unit/reference/test_sdtm_ig.py
autonomous: true

must_haves:
  truths:
    - "TS domain is loadable from SDTMReference with all 11 variables"
    - "Trial Design domains TA, TE, TV, TI are loadable with correct domain_class"
    - "SE and CO domains are loadable as Special-Purpose class"
    - "SUPPQUAL pseudo-domain is loadable with the standard 10-variable structure"
    - "All new domains have correct key_variables"
  artifacts:
    - path: "src/astraea/data/sdtm_ig/domains.json"
      provides: "TS, TA, TE, TV, TI, SE, CO, SUPPQUAL domain definitions"
      contains: "TSPARMCD"
    - path: "tests/unit/reference/test_sdtm_ig.py"
      provides: "Tests for all new domains"
  key_links:
    - from: "src/astraea/data/sdtm_ig/domains.json"
      to: "src/astraea/reference/sdtm_ig.py"
      via: "SDTMReference loads domains.json at init"
      pattern: "get_domain_spec"
---

<objective>
Add 8 missing domains to domains.json: TS (Trial Summary), TA (Trial Arms), TE (Trial Elements), TV (Trial Visits), TI (Trial Inclusion/Exclusion), SE (Subject Elements), CO (Comments), and SUPPQUAL (structure definition).

Purpose: TS domain is mandatory for FDA submission (TRC code 1734). Trial Design domains are needed for Phase 6 completeness. SUPPQUAL structure definition is needed for automated SUPPQUAL generation. Without TS, the system produces datasets that are guaranteed to be technically rejected by FDA.

Output: 8 new domain entries in domains.json with complete variable lists, plus unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE3_AUDIT.md (sections C-01, H-06, M-05, M-06)
@.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-RESEARCH.md (sections "TS Domain", "Trial Design Domains", "SE", "CO", "SUPPQUAL Structure Definition")
@src/astraea/data/sdtm_ig/domains.json
@src/astraea/reference/sdtm_ig.py
@src/astraea/models/sdtm.py
@tests/unit/reference/test_sdtm_ig.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TS, TA, TE, TV, TI, SE, CO, SUPPQUAL domains to domains.json</name>
  <files>src/astraea/data/sdtm_ig/domains.json</files>
  <action>
Add 8 new domain entries to the domains array in domains.json. Follow the EXACT structure of existing entries (look at DM as template). Each domain needs: domain, description, domain_class, structure, variables[], key_variables.

CRITICAL: Use correct domain_class values:
- "Trial Design" for TS, TA, TE, TV, TI (NOT "Special-Purpose")
- "Special-Purpose" for SE, CO, SUPPQUAL

**TS (Trial Summary):**
- domain_class: "Trial Design"
- structure: "One record per trial summary parameter value"
- key_variables: ["STUDYID", "TSPARMCD", "TSSEQ"]
- Variables (11 total, per RESEARCH.md):
  1. STUDYID (Char, Req, null codelist)
  2. DOMAIN (Char, Req, C66734)
  3. TSSEQ (Num, Req, null)
  4. TSGRPID (Char, Perm, null)
  5. TSPARMCD (Char, Req, C66738) -- NOTE: C66738 may not be in codelists.json yet, use as forward reference
  6. TSPARM (Char, Req, null)
  7. TSVAL (Char, Req, null)
  8. TSVALNF (Char, Perm, null)
  9. TSVALCD (Char, Perm, null)
  10. TSVCDREF (Char, Perm, null)
  11. TSVCDVER (Char, Perm, null)

**TA (Trial Arms):**
- domain_class: "Trial Design"
- structure: "One record per planned element per arm"
- key_variables: ["STUDYID", "ARMCD", "TAETORD"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), ARMCD (Req), ARM (Req), TAETORD (Req, Num), ETCD (Req), ELEMENT (Req), TABRANCH (Perm), TATRANS (Perm), EPOCH (Perm, C99079)

**TE (Trial Elements):**
- domain_class: "Trial Design"
- structure: "One record per planned element"
- key_variables: ["STUDYID", "ETCD"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), ETCD (Req), ELEMENT (Req), TESTRL (Req), TEENRL (Req), TEDUR (Perm)

**TV (Trial Visits):**
- domain_class: "Trial Design"
- structure: "One record per planned visit per arm"
- key_variables: ["STUDYID", "VISITNUM", "ARMCD"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), VISITNUM (Req, Num), VISIT (Req), VISITDY (Perm, Num), ARMCD (Req), ARM (Req), TVSTRL (Perm), TVENRL (Perm)

**TI (Trial Inclusion/Exclusion):**
- domain_class: "Trial Design"
- structure: "One record per I/E criterion"
- key_variables: ["STUDYID", "IETESTCD"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), IETESTCD (Req), IETEST (Req), IECAT (Req), IESCAT (Perm), TIRL (Perm), TIVERS (Perm)

**SE (Subject Elements):**
- domain_class: "Special-Purpose"
- structure: "One record per actual element per subject"
- key_variables: ["STUDYID", "USUBJID", "ETCD", "SESTDTC"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), USUBJID (Req), SESEQ (Req, Num), ETCD (Exp), ELEMENT (Exp), SESTDTC (Exp), SEENDTC (Exp), TAESSION (Perm), EPOCH (Perm, C99079)

**CO (Comments):**
- domain_class: "Special-Purpose"
- structure: "One record per comment per subject"
- key_variables: ["STUDYID", "USUBJID", "COSEQ"]
- Variables: STUDYID (Req), DOMAIN (Req, C66734), USUBJID (Perm), COSEQ (Req, Num), RDOMAIN (Perm, C66734), IDVAR (Perm), IDVARVAL (Perm), COREF (Perm), CODTC (Perm), COVAL (Req), COEVAL (Perm)

**SUPPQUAL:**
- domain_class: "Special-Purpose"
- structure: "One record per supplemental qualifier value per subject per parent domain record"
- key_variables: ["STUDYID", "RDOMAIN", "USUBJID", "IDVAR", "IDVARVAL", "QNAM"]
- Variables (10 total):
  1. STUDYID (Char, Req, null)
  2. RDOMAIN (Char, Req, C66734)
  3. USUBJID (Char, Req, null)
  4. IDVAR (Char, Exp, null)
  5. IDVARVAL (Char, Exp, null)
  6. QNAM (Char, Req, null)
  7. QLABEL (Char, Req, null)
  8. QVAL (Char, Req, null)
  9. QORIG (Char, Req, null)
  10. QEVAL (Char, Exp, null)

For all variables, include cdisc_notes with brief descriptions. Use the EXACT field names from the existing entries: name, label, data_type ("Char" or "Num"), core ("Req", "Exp", or "Perm"), cdisc_notes, codelist_code (null if no codelist), order (sequential integer starting from 1).
  </action>
  <verify>
Run: `python -c "from astraea.reference.sdtm_ig import SDTMReference; ref = SDTMReference(); ts = ref.get_domain_spec('TS'); print(ts.domain, ts.domain_class.value, len(ts.variables))"` -- should print "TS Trial Design 11"
Run: `python -c "from astraea.reference.sdtm_ig import SDTMReference; ref = SDTMReference(); domains = [ref.get_domain_spec(d) for d in ['TA','TE','TV','TI','SE','CO','SUPPQUAL']]; print([(d.domain, d.domain_class.value) for d in domains if d])"` -- should list all 7 with correct classes.
  </verify>
  <done>All 8 domains load from SDTMReference with correct domain_class, variable counts, and key_variables</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new domains</name>
  <files>tests/unit/reference/test_sdtm_ig.py</files>
  <action>
Add tests to the existing test file:

1. Test TS domain:
   - Loads via SDTMReference.get_domain_spec("TS")
   - Has domain_class == DomainClass.TRIAL_DESIGN (verify the enum value used)
   - Has 11 variables
   - key_variables == ["STUDYID", "TSPARMCD", "TSSEQ"]
   - All Required vars present: STUDYID, DOMAIN, TSSEQ, TSPARMCD, TSPARM, TSVAL

2. Parametrized test for Trial Design domains (TA, TE, TV, TI):
   - Each loads successfully
   - Each has domain_class == DomainClass.TRIAL_DESIGN
   - Each has non-empty key_variables

3. Test SE and CO:
   - Each loads with domain_class matching "Special-Purpose" (check DomainClass enum)
   - SE has USUBJID as Required
   - CO has COVAL as Required

4. Test SUPPQUAL:
   - Loads with 10 variables
   - Has QNAM, QLABEL, QVAL, QORIG as Required
   - Has IDVAR, IDVARVAL, QEVAL as Expected
   - key_variables includes QNAM

5. Run full test suite: `pytest -x -q`
  </action>
  <verify>`pytest tests/unit/reference/test_sdtm_ig.py -v` -- all new tests pass. `pytest -x -q` -- full suite passes.</verify>
  <done>Tests confirm all 8 new domains load correctly with proper classes, variables, and key_variables</done>
</task>

</tasks>

<verification>
- `pytest -x -q` passes with 579+ tests plus new domain tests
- `ruff check src/ tests/` passes
- All 8 new domains loadable via SDTMReference
</verification>

<success_criteria>
- TS domain exists with 11 variables and Trial Design class
- Trial Design domains TA, TE, TV, TI all present
- SE and CO present as Special-Purpose
- SUPPQUAL structure defined with 10 standard variables
- All existing tests pass plus new tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-audit-fixes-architectural-wiring/03.1-02-SUMMARY.md`
</output>
