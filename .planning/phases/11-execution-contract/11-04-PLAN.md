---
phase: 11-execution-contract
plan: 04
type: execute
wave: 3
depends_on: ["11-01", "11-02", "11-03"]
files_modified:
  - tests/integration/execution/test_dm_execution_real.py
autonomous: true

must_haves:
  truths:
    - "Executing DM mapping spec on real Fakedata/dm.sas7bdat produces non-NULL USUBJID"
    - "At least 14 of 18 DM columns are populated (not all-NULL)"
    - "STUDYID, DOMAIN, USUBJID are non-NULL for all rows"
    - "BRTHDTC contains ISO 8601 formatted values (not raw numeric years)"
    - "RACE is derived from checkbox columns (not NULL)"
    - "All 1567+ existing tests pass alongside the new integration test"
  artifacts:
    - path: "tests/integration/execution/test_dm_execution_real.py"
      provides: "End-to-end DM execution test against real Fakedata"
      min_lines: 80
  key_links:
    - from: "tests/integration/execution/test_dm_execution_real.py"
      to: "src/astraea/execution/executor.py"
      via: "DatasetExecutor.execute() with real data"
      pattern: "DatasetExecutor"
    - from: "tests/integration/execution/test_dm_execution_real.py"
      to: "src/astraea/execution/pattern_handlers.py"
      via: "Derivation rule dispatch for GENERATE_USUBJID, RACE_CHECKBOX, etc."
      pattern: "USUBJID.*non-null"
---

<objective>
Write an integration test that executes the DM mapping spec against real Fakedata/dm.sas7bdat and verifies that the execution pipeline produces valid SDTM data with non-NULL critical columns.

Purpose: This is the acceptance test for Phase 11 -- proving that the LLM-to-executor contract works end-to-end on real data. The Master Audit showed 10/18 columns ALL NULL; this test verifies the fix.
Output: Integration test that validates DM execution produces at least 14/18 populated columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/MASTER_AUDIT.md
@.planning/phases/11-execution-contract/11-RESEARCH.md
@.planning/phases/11-execution-contract/11-01-SUMMARY.md
@.planning/phases/11-execution-contract/11-02-SUMMARY.md
@.planning/phases/11-execution-contract/11-03-SUMMARY.md
@src/astraea/execution/executor.py
@src/astraea/execution/pattern_handlers.py
@output/DM_mapping.json
@tests/integration/execution/test_dm_execution.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: DM real-data integration test</name>
  <files>
    tests/integration/execution/test_dm_execution_real.py
  </files>
  <action>
    Create `tests/integration/execution/test_dm_execution_real.py` that:

    1. **Loads real data:**
       - Read `Fakedata/dm.sas7bdat` via pyreadstat
       - Load `output/DM_mapping.json` (the LLM-generated mapping spec) as DomainMappingSpec
       - If DM_mapping.json doesn't exist, skip the test with `pytest.skip("DM_mapping.json not found")`
       - Also load any cross-domain datasets needed (ex.sas7bdat for RFSTDTC/RFENDTC) if they exist

    2. **Builds StudyMetadata** with study_id="PHA022121-C301" and appropriate site_col/subject_col

    3. **Executes via DatasetExecutor:**
       ```python
       executor = DatasetExecutor(
           spec=dm_spec,
           raw_dfs={"dm": dm_df},  # plus cross-domain if available
           study_metadata=study_metadata,
           ct_reference=ct_ref,
           sdtm_reference=sdtm_ref,
       )
       result_df = executor.execute()
       ```

    4. **Asserts critical columns are populated:**
       - `STUDYID` is non-NULL for all rows, value is "PHA022121-C301"
       - `DOMAIN` is non-NULL for all rows, value is "DM"
       - `USUBJID` is non-NULL for all rows (the CRIT-02 fix)
       - `USUBJID` values follow pattern "PHA022121-C301-*-*"

    5. **Asserts derived columns are populated:**
       - `BRTHDTC` contains ISO 8601 values (match regex `r"^\d{4}$"` for year-only or `r"^\d{4}-\d{2}-\d{2}"` for full dates), NOT raw numerics like "1960.0"
       - `RACE` is non-NULL for most rows (derived from checkbox columns)
       - `SEX` is populated
       - `ETHNIC` is populated
       - `AGE` is populated (if source has AGE column)

    6. **Counts populated columns:**
       ```python
       populated = sum(1 for col in result_df.columns if result_df[col].notna().any())
       assert populated >= 14, f"Only {populated}/18 columns populated (expected >= 14)"
       ```

    7. **Negative assertions:**
       - No column should contain raw SAS numeric dates (values like 22738.0)
       - USUBJID should not contain "nan" or "None" as string values

    Mark the test class/module with `@pytest.mark.integration` or appropriate markers. Use `pytest.importorskip` or file-existence checks so the test is gracefully skipped in CI without Fakedata/.

    NOTE: If the existing DM_mapping.json uses the old free-form derivation rules that don't match the new vocabulary, create a test-local mapping spec fixture that uses the correct vocabulary (GENERATE_USUBJID, ISO8601_PARTIAL_DATE, RACE_CHECKBOX, etc.) based on the known DM column structure. This is more reliable than depending on an LLM-regenerated spec.
  </action>
  <verify>pytest tests/integration/execution/test_dm_execution_real.py -xvs</verify>
  <done>DM execution on real Fakedata produces non-NULL USUBJID, BRTHDTC in ISO 8601, RACE derived from checkboxes, and at least 14/18 columns populated. The CRIT-02/CRIT-03 execution contract gap is closed.</done>
</task>

<task type="auto">
  <name>Task 2: Full test suite verification</name>
  <files></files>
  <action>
    Run the complete test suite to verify no regressions:
    1. `pytest tests/ -x -q` -- all tests pass
    2. `ruff check src/ tests/` -- no lint violations
    3. `mypy src/` -- no type errors

    If any failures, fix them. The changes in plans 01-03 should not break existing tests since:
    - Bug fixes (Plan 01) are additive (new behavior for edge cases)
    - Derivation handlers (Plan 02) are new code paths that only activate for new rule keywords
    - Prompt changes (Plan 03) don't affect existing tests (prompt content is not tested structurally)
    - Executor resolution (Plan 03) falls through to existing behavior when aliases don't match
  </action>
  <verify>pytest tests/ -x -q && ruff check src/ tests/ && mypy src/</verify>
  <done>All 1567+ existing tests pass. Zero ruff violations. Zero mypy errors. Phase 11 complete.</done>
</task>

</tasks>

<verification>
- `pytest tests/integration/execution/test_dm_execution_real.py -xvs` -- DM integration test passes
- `pytest tests/ -x -q` -- all tests pass (1567+ existing + new Phase 11 tests)
- `ruff check src/ tests/` -- clean
- `mypy src/` -- clean
</verification>

<success_criteria>
- DM execution on real Fakedata: USUBJID non-NULL for all rows
- DM execution: at least 14/18 columns populated
- DM execution: BRTHDTC in ISO 8601 format, RACE derived from checkboxes
- All existing 1567+ tests pass
- Zero ruff/mypy violations
</success_criteria>

<output>
After completion, create `.planning/phases/11-execution-contract/11-04-SUMMARY.md`
</output>
