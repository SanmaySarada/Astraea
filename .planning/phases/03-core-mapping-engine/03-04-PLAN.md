---
phase: 03-core-mapping-engine
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - src/astraea/mapping/exporters.py
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - tests/unit/mapping/test_exporters.py
  - tests/unit/cli/test_display.py
autonomous: true

must_haves:
  truths:
    - "DomainMappingSpec exports to Excel workbook with 3 sheets (Mapping Spec, Unmapped Variables, Summary)"
    - "DomainMappingSpec exports to JSON file via Pydantic serialization"
    - "Excel workbook has conditional formatting: green for HIGH, yellow for MEDIUM, red for LOW confidence"
    - "CLI 'astraea map' command accepts data folder, eCRF PDF, and domain as arguments"
    - "CLI displays mapping results in a Rich table with confidence coloring"
    - "Primary SAS file for domain is found by lowercase filename heuristic (domain.lower() + '.sas7bdat'), with --source-file override"
  artifacts:
    - path: "src/astraea/mapping/exporters.py"
      provides: "Excel and JSON export functions"
      contains: "def export_to_excel"
    - path: "src/astraea/cli/app.py"
      provides: "CLI map command"
      contains: "def map_domain"
    - path: "tests/unit/cli/test_display.py"
      provides: "Unit test for display_mapping_spec"
      contains: "test_display_mapping_spec"
  key_links:
    - from: "src/astraea/mapping/exporters.py"
      to: "src/astraea/models/mapping.py"
      via: "DomainMappingSpec model"
      pattern: "DomainMappingSpec"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.map_domain()"
      pattern: "MappingEngine"
---

<objective>
Build the output layer: Excel/JSON export of mapping specs and the CLI `astraea map` command that ties everything together.

Purpose: The mapping spec must be exportable in industry-standard formats (Excel for human review, JSON for programmatic use) and accessible via the CLI. This completes the user-facing flow for Phase 3.
Output: `exporters.py` (Excel+JSON), updated CLI with `map` command + display formatting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-mapping-engine/03-RESEARCH.md

@src/astraea/cli/app.py
@src/astraea/cli/display.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Excel and JSON exporters</name>
  <files>src/astraea/mapping/exporters.py, tests/unit/mapping/test_exporters.py</files>
  <action>
**exporters.py:**

Create `src/astraea/mapping/exporters.py` with:

1. **`export_to_json(spec: DomainMappingSpec, output_path: Path) -> Path`**
   - Write spec.model_dump_json(indent=2) to output_path
   - Return the path written
   - Use loguru to log the export

2. **`export_to_excel(spec: DomainMappingSpec, output_path: Path) -> Path`**
   - Use openpyxl to create a workbook with 3 sheets:

   **Sheet 1: "Mapping Spec"**
   - Columns: Row #, SDTM Variable, SDTM Label, Type, Core, Source Dataset, Source Variable, Source Label, Pattern, Mapping Logic, Derivation Rule, CT Codelist, Confidence, Confidence Level, Notes
   - One row per VariableMapping in spec.variable_mappings
   - Header row: bold, with auto-filter
   - Conditional formatting on the "Confidence Level" column:
     - GREEN fill (#C6EFCE) for HIGH
     - YELLOW fill (#FFEB9C) for MEDIUM
     - RED fill (#FFC7CE) for LOW
   - Column widths: auto-fit or reasonable defaults (Variable: 12, Label: 35, Logic: 40, etc.)

   **Sheet 2: "Unmapped Variables"**
   - Columns: Source Dataset, Source Variable, Source Label, Disposition
   - Populate from spec.unmapped_source_variables (label them "Unmapped")
   - Also populate spec.suppqual_candidates (label them "SUPPDM Candidate")

   **Sheet 3: "Summary"**
   - Key-value pairs: Domain, Domain Label, Study ID, Mapping Timestamp, Model Used
   - Total variables, Required mapped, Expected mapped
   - HIGH/MEDIUM/LOW confidence counts
   - Source datasets list
   - Cross-domain sources list

   - Return the path written

**test_exporters.py:**

Create `tests/unit/mapping/test_exporters.py` with:
- Create a realistic DomainMappingSpec fixture with 5-6 VariableMappings (mix of HIGH/MEDIUM/LOW confidence)
- `test_export_to_json`: Export to tmp_path, verify file exists, verify JSON is valid and round-trips back to DomainMappingSpec
- `test_export_to_excel`: Export to tmp_path, verify file exists, read back with openpyxl, verify 3 sheets exist, verify header row matches expected columns, verify data rows match variable count
- `test_export_to_excel_conditional_formatting`: Verify the "Confidence Level" column cells have correct fill colors
- `test_export_to_excel_unmapped_sheet`: Verify unmapped variables appear in Sheet 2
- `test_export_to_excel_summary_sheet`: Verify summary values match spec metadata
  </action>
  <verify>
    `pytest tests/unit/mapping/test_exporters.py -v` -- all tests pass.
    `ruff check src/astraea/mapping/exporters.py` -- no lint errors.
  </verify>
  <done>Excel export produces a 3-sheet workbook with conditional formatting. JSON export round-trips cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI map command with Rich display and source file heuristic</name>
  <files>src/astraea/cli/app.py, src/astraea/cli/display.py, tests/unit/cli/test_display.py</files>
  <action>
Read the existing CLI files first to understand the current structure and patterns.

**app.py updates:**

Add a new `map` command (or `map-domain` to avoid Python keyword conflict -- check Typer's handling) to the existing Typer app:

```python
@app.command()
def map_domain(
    data_folder: Path = typer.Argument(..., help="Folder containing raw SAS files"),
    ecrf_pdf: Path = typer.Argument(..., help="Path to annotated eCRF PDF"),
    domain: str = typer.Argument(..., help="SDTM domain to map (e.g., 'DM')"),
    study_id: str = typer.Option("PHA022121-C301", help="Study identifier"),
    output_dir: Path = typer.Option(Path("output"), help="Output directory for mapping spec"),
    source_file: str | None = typer.Option(None, "--source-file", help="Override primary SAS file name (e.g., 'dm.sas7bdat'). Default: auto-detect by domain name."),
) -> None:
```

The command should:
1. Validate inputs exist (data_folder is dir, ecrf_pdf is file)
2. Initialize SDTMReference, CTReference, AstraeaLLMClient
3. **Identify the primary SAS file for the domain using this heuristic:**
   - If --source-file is provided, use that filename directly in data_folder
   - Otherwise, search data_folder for files matching `{domain.lower()}.sas7bdat` (e.g., "dm.sas7bdat" for DM)
   - If no exact match, search for files starting with `{domain.lower()}_` (e.g., "dm_data.sas7bdat")
   - If still no match, list available .sas7bdat files and show an error: "Could not identify primary SAS file for domain {domain}. Available files: [...]. Use --source-file to specify."
4. Profile the identified SAS dataset(s) using existing profiler
5. Parse eCRF and match forms (using existing parse_ecrf pipeline)
6. Identify cross-domain source datasets (for DM: ex, ie, irt, ds) and profile them
7. Create StudyMetadata, create MappingEngine, call map_domain()
8. Export to JSON and Excel in output_dir
9. Display results in terminal using Rich

For cross-domain identification: For DM domain, hardcode the known cross-domain datasets for now (ex, ie, irt, ds). A generic cross-domain resolver is a future enhancement. Use a simple dict mapping: `{"DM": ["ex", "ie", "irt", "ds"]}`.

Handle ANTHROPIC_API_KEY missing with a clear error message (follow existing pattern from classify command).

**display.py updates:**

Add a function `display_mapping_spec(spec: DomainMappingSpec, console: Console) -> None` that:
- Shows a Rich Panel header with domain name, study ID, timestamp
- Shows a Rich Table with columns: #, Variable, Label, Core, Source, Pattern, Confidence, Logic
- Color-code confidence: green for HIGH, yellow for MEDIUM, red for LOW (use Rich styles)
- Show summary footer: total mapped, by confidence level
- Show unmapped/SUPPDM candidates if any
- Show file paths where JSON/Excel were saved

Follow the existing display patterns in display.py.

**test_display.py:**

Create `tests/unit/cli/test_display.py` (or add to existing test file if one exists) with:
- Create a minimal DomainMappingSpec fixture (reuse from test_exporters or create similar)
- `test_display_mapping_spec_no_error`: Call `display_mapping_spec(spec, Console(file=StringIO()))` -- verify it runs without exception and produces output
- `test_display_mapping_spec_contains_domain`: Capture console output, verify it contains the domain name
- `test_display_mapping_spec_contains_variables`: Verify output contains SDTM variable names from the fixture
  </action>
  <verify>
    `python -c "from astraea.cli.app import app; print('CLI importable')"` -- succeeds without errors.
    `astraea map-domain --help` -- shows help text with all arguments and options including --source-file.
    `pytest tests/unit/cli/test_display.py -v` -- display tests pass.
    `ruff check src/astraea/cli/app.py src/astraea/cli/display.py tests/unit/cli/test_display.py` -- no lint errors.
  </verify>
  <done>CLI map-domain command is wired with source file heuristic and --source-file override. Display shows Rich-formatted mapping results. Display function has unit tests.</done>
</task>

</tasks>

<verification>
- `ruff check src/astraea/mapping/ src/astraea/cli/ tests/unit/cli/` -- no lint errors
- `pytest tests/unit/mapping/ tests/unit/cli/ -v` -- all tests pass
- `pytest tests/ -x -q` -- full test suite still passes
- `astraea map-domain --help` -- shows usage with --source-file option
</verification>

<success_criteria>
Mapping specs export to properly formatted Excel (3 sheets, conditional formatting) and JSON. CLI map-domain command is available with automatic source file detection and --source-file override. Rich display formats mapping results with color-coded confidence. Display function has unit tests.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-mapping-engine/03-04-SUMMARY.md`
</output>
