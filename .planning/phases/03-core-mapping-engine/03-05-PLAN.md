---
phase: 03-core-mapping-engine
plan: 05
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - tests/integration/mapping/__init__.py
  - tests/integration/mapping/test_dm_mapping.py
autonomous: false

must_haves:
  truths:
    - "MappingEngine produces a complete DM mapping spec from real Fakedata profiles"
    - "All 7 Required DM variables have mappings (STUDYID, DOMAIN, USUBJID, SUBJID, SITEID, SEX, COUNTRY)"
    - "Expected DM variables with available data are mapped (AGE, AGEU, RACE, ETHNIC, RFSTDTC, etc.)"
    - "Confidence scores are reasonable: direct/rename mappings >= 0.8, derivations >= 0.6"
    - "Excel and JSON exports are valid and readable"
  artifacts:
    - path: "tests/integration/mapping/test_dm_mapping.py"
      provides: "Integration test using real Fakedata + real LLM call"
      contains: "test_dm_mapping_end_to_end"
  key_links:
    - from: "tests/integration/mapping/test_dm_mapping.py"
      to: "src/astraea/mapping/engine.py"
      via: "MappingEngine.map_domain()"
      pattern: "engine.map_domain"
---

<objective>
Run the mapping engine end-to-end on real DM data from Fakedata/ with a real Claude API call. Verify the output is a complete, reasonable DM mapping specification.

Purpose: This is the proof that the Phase 3 engine works. It exercises the full pipeline: profile real SAS data, build context, call Claude, validate proposals, enrich, and export. This is the only test that makes a real API call.
Output: Integration test + manual verification checkpoint of the actual DM mapping output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-mapping-engine/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DM domain integration test</name>
  <files>tests/integration/mapping/__init__.py, tests/integration/mapping/test_dm_mapping.py</files>
  <action>
Create `tests/integration/mapping/__init__.py` (empty).

Create `tests/integration/mapping/test_dm_mapping.py` with:

1. **Setup:** Profile dm.sas7bdat from Fakedata/ using the existing profiler. Also profile ex.sas7bdat, ie.sas7bdat, irt.sas7bdat, ds.sas7bdat as cross-domain sources. Parse the eCRF PDF and extract the Demographics form. Initialize SDTMReference, CTReference, AstraeaLLMClient, MappingEngine.

2. **Mark all tests with `@pytest.mark.integration`** so they can be skipped in unit-only runs. Also mark with `@pytest.mark.skipif(not os.environ.get("ANTHROPIC_API_KEY"), reason="No API key")`.

3. **`test_dm_mapping_end_to_end`:**
   - Call engine.map_domain("DM", profiles, ecrf_forms, study_metadata, cross_domain_profiles)
   - Assert domain == "DM"
   - Assert total_variables >= 15 (DM has 27 possible, at least 15 should be mapped)
   - Assert all 7 Required variables have mappings: STUDYID, DOMAIN, USUBJID, SUBJID, SITEID, SEX, COUNTRY
   - Assert STUDYID mapping pattern is ASSIGN
   - Assert DOMAIN mapping pattern is ASSIGN with value "DM"
   - Assert AGE mapping exists (direct or derivation)
   - Assert RACE mapping exists (should be COMBINE or LOOKUP_RECODE from checkbox columns)
   - Assert at least one cross-domain source dataset listed (ex.sas7bdat)
   - Assert high_confidence_count > 0
   - Assert no Req variable has confidence < 0.5

4. **`test_dm_export_roundtrip`:**
   - Take the DomainMappingSpec from the mapping test (use module-level caching or session fixture to avoid duplicate API calls)
   - Export to JSON in tmp_path
   - Read back and validate it's a valid DomainMappingSpec
   - Export to Excel in tmp_path
   - Read back with openpyxl, verify 3 sheets and correct row count

5. **`test_dm_ct_validation`:**
   - From the mapping output, check that SEX mapping references codelist C66731
   - Check that ETHNIC mapping references codelist C66790
   - Check that any RACE mapping references codelist C74457 or has a reasonable confidence

6. **Fixture optimization:** Use `@pytest.fixture(scope="module")` for the engine result to avoid multiple LLM calls. One call per test module, multiple assertions.

The test should print the full mapping spec to stdout (for human inspection during the checkpoint) using Rich display.
  </action>
  <verify>
    `pytest tests/integration/mapping/test_dm_mapping.py -v -s` -- all tests pass (requires ANTHROPIC_API_KEY).
    The output shows the full DM mapping spec with confidence scores.
  </verify>
  <done>Integration test proves end-to-end DM mapping works with real data and real LLM. All Required variables mapped, confidence scores reasonable.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete DM domain mapping engine: Pydantic models, context builder, LLM-powered mapper with post-proposal validation, Excel/JSON exporters, CLI command, and integration test on real Fakedata.</what-built>
  <how-to-verify>
    1. Review the integration test output: `pytest tests/integration/mapping/test_dm_mapping.py -v -s`
       - Check that all 7 Required DM variables (STUDYID, DOMAIN, USUBJID, SUBJID, SITEID, SEX, COUNTRY) have mappings
       - Check that RACE is correctly identified as coming from checkbox columns
       - Check that cross-domain derivations (RFSTDTC from EX, COUNTRY from IRT) are documented
       - Check that confidence scores are reasonable (HIGH for direct/rename, MEDIUM for derivations)

    2. Check the exported Excel file (in output/ or tmp):
       - Sheet 1 "Mapping Spec" has all variables with color-coded confidence
       - Sheet 2 "Unmapped Variables" lists HEIGHT, DMCBP as not-DM or SUPPDM candidates
       - Sheet 3 "Summary" shows correct counts

    3. Run the CLI command: `astraea map-domain Fakedata ECRF.pdf DM`
       - Verify it completes without error
       - Verify Rich output displays mapping table
       - Verify JSON and Excel files are created in output/

    4. Run the full test suite: `pytest tests/ -x -q`
       - Verify no regressions (all 490+ existing tests still pass)
  </how-to-verify>
  <resume-signal>Type "approved" if the DM mapping output looks correct and complete, or describe any issues with the mappings.</resume-signal>
</task>

</tasks>

<verification>
- `pytest tests/integration/mapping/ -v -s` -- integration tests pass with API key
- `pytest tests/ -x -q` -- full suite passes, no regressions
- Excel and JSON output files are valid and readable
- CLI `astraea map-domain` completes successfully on Fakedata
</verification>

<success_criteria>
End-to-end DM mapping produces a complete, accurate mapping specification. All Required variables mapped with correct patterns. Cross-domain derivations documented. Excel and JSON exports valid. Human reviewer approves the mapping quality.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-mapping-engine/03-05-SUMMARY.md`
</output>
