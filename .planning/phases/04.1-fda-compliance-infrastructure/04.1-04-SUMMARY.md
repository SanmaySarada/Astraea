---
phase: 04.1-fda-compliance-infrastructure
plan: 04
subsystem: transforms
tags: [ascii, xpt, character-length, compliance, transforms]
depends_on:
  requires: ["04.1-01"]
  provides: ["ascii-validation", "char-length-optimization", "full-transform-registry"]
  affects: ["04.1-05", "05", "06", "07"]
tech-stack:
  added: []
  patterns: ["deterministic-validation", "byte-length-optimization"]
key-files:
  created:
    - src/astraea/transforms/ascii_validation.py
    - src/astraea/transforms/char_length.py
    - tests/test_transforms/test_ascii_validation.py
    - tests/test_transforms/test_char_length.py
  modified:
    - src/astraea/transforms/__init__.py
    - src/astraea/mapping/transform_registry.py
    - tests/unit/mapping/test_transform_registry.py
decisions:
  - id: "D-04.1-04-01"
    description: "Test files placed in tests/test_transforms/ to match existing project structure (not tests/unit/transforms/)"
metrics:
  duration: "~3 min"
  completed: "2026-02-27"
  tests_added: 27
  total_tests: 883
---

# Phase 4.1 Plan 04: XPT Compliance Utilities Summary

ASCII validation and character length optimization for XPT-compliant output.

## What Was Done

### Task 1: ASCII Validation and Character Length Optimization

Created two new transform modules:

**`ascii_validation.py`** -- Detects and fixes non-ASCII characters in DataFrame string columns.
- `validate_ascii(df)` scans all object/string columns, reports up to 100 non-ASCII issues with column, row, value, and offending characters
- `fix_common_non_ascii(df)` replaces 12 common non-ASCII characters with ASCII equivalents (curly quotes, en/em-dash, degree sign, micro sign, plus-minus, comparison operators, ellipsis)
- Works on copy of DataFrame, logs replacements per column

**`char_length.py`** -- Computes optimal byte widths for character columns.
- `optimize_char_lengths(df)` returns dict of column name to minimum byte width needed
- Uses ASCII encoding with replacement for byte-accurate measurement
- Minimum width is always 1 (never 0), handles all-null columns

27 tests covering detection, all 12 replacements, edge cases (nulls, numeric columns, cap at 100, empty strings, byte vs char length).

### Task 2: Transform Registry and Re-exports

- Added `validate_ascii`, `fix_common_non_ascii`, `optimize_char_lengths` to `transforms/__init__.py` with `__all__`
- Registered 9 new transforms in `AVAILABLE_TRANSFORMS` (total 15, up from 6): `calculate_study_day`, `generate_seq`, `assign_epoch`, `assign_visit`, `get_date_imputation_flag`, `get_time_imputation_flag`, `validate_ascii`, `fix_common_non_ascii`, `optimize_char_lengths`
- Updated registry test from 6 to 15 expected transforms

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated existing test assertion for transform count**
- **Found during:** Task 2
- **Issue:** `test_returns_6_transforms` hardcoded count of 6, now 15
- **Fix:** Updated test name and assertion to `test_returns_15_transforms` with count 15
- **Files modified:** tests/unit/mapping/test_transform_registry.py

**2. [Rule 1 - Bug] Removed unused pytest imports flagged by ruff**
- **Found during:** Task 1
- **Issue:** Both test files imported `pytest` without using it
- **Fix:** Removed unused imports
- **Files modified:** tests/test_transforms/test_ascii_validation.py, tests/test_transforms/test_char_length.py

## Commits

| Task | Commit | Message |
|------|--------|---------|
| 1 | 6bc7630 | feat(04.1-04): add ASCII validation and character length optimization |
| 2 | 55ad609 | feat(04.1-04): register all transforms in registry and re-exports |

## Verification

- All 883 tests passing (15 skipped)
- All new transforms importable from `astraea.transforms`
- All 15 transforms registered in `AVAILABLE_TRANSFORMS`
- ruff check clean on all modified files
