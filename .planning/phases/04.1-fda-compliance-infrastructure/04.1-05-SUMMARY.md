---
phase: 04.1-fda-compliance-infrastructure
plan: 05
subsystem: execution
tags: [execution-pipeline, xpt-compliance, ascii-validation, cli, integration-test]
depends_on:
  requires: ["04.1-03", "04.1-04"]
  provides: ["execute_to_xpt", "execute-domain CLI", "cross-domain USUBJID validation", "XPT-ready pipeline"]
  affects: ["05", "06", "07"]
tech-stack:
  added: []
  patterns: ["post-processing compliance pipeline", "spec-to-XPT bridge", "cross-domain validation"]
key-files:
  created:
    - tests/unit/execution/test_executor_xpt.py
    - tests/integration/execution/__init__.py
    - tests/integration/execution/test_dm_execution.py
  modified:
    - src/astraea/execution/executor.py
    - src/astraea/cli/app.py
decisions: []
metrics:
  duration: "~7 min"
  completed: "2026-02-27"
  tests-added: 16
  tests-total: 907
---

# Phase 4.1 Plan 05: Execution Bridge + CLI + Integration Test Summary

**One-liner:** Wired ASCII cleanup, char length optimization, and sort enforcement into DatasetExecutor; added execute-domain CLI command and end-to-end DM integration test.

## What Was Built

### Task 1: XPT Compliance in DatasetExecutor

Enhanced `DatasetExecutor.execute()` with three post-processing steps after column ordering and sort:

1. **ASCII fix**: Calls `fix_common_non_ascii()` to replace curly quotes, en-dash, degree sign, etc. with ASCII equivalents
2. **ASCII validation**: Calls `validate_ascii()` and logs warnings for any remaining non-ASCII characters (does not raise)
3. **Character length optimization**: Calls `optimize_char_lengths()` and stores result in `_last_char_widths` for XPT writing

Added two new methods:

- **`execute_to_xpt()`**: Full pipeline from spec + raw data to XPT file. Calls `execute()`, builds column labels from spec, then calls `write_xpt_v5()`.
- **`validate_cross_domain_usubjid()`**: Static method checking that all USUBJIDs across domain DataFrames exist in the DM domain. Reports orphan subjects.

8 new unit tests covering ASCII replacement, char width computation, sort order verification, and cross-domain validation (pass/fail/missing column/multi-domain).

### Task 2: CLI Command + DM Integration Test

**`execute-domain` CLI command** (`src/astraea/cli/app.py`):
- Takes mapping spec JSON + raw data directory as arguments
- Loads spec, reads matching SAS source files, optionally loads DM for cross-domain context
- Executes through DatasetExecutor, writes XPT file to output directory
- Displays Rich summary with domain, output path, source count, and char width stats
- Uses lazy imports consistent with all other CLI commands

**DM integration test** (`tests/integration/execution/test_dm_execution.py`):
- Creates synthetic 5-subject DM scenario with 8 mapped variables
- Uses real `SDTMReference` and `CTReference` (bundled JSON, no mocks)
- 8 tests verifying: correct column set, constant STUDYID, DOMAIN="DM", column ordering, no raw column leakage, optimized char lengths, subject count preservation, SEX codelist recoding (Male->M, Female->F)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Ruff lint: f-string without placeholders**
- **Found during:** Task 2
- **Issue:** `f"\n[bold green]Execution complete:[/bold green]"` has no interpolation
- **Fix:** Removed the `f` prefix
- **Files modified:** src/astraea/cli/app.py

**2. [Rule 3 - Blocking] Ruff lint: unused imports in test files**
- **Found during:** Tasks 1 and 2
- **Issue:** `MagicMock`, `pytest`, `CrossDomainContext` imported but unused in test files
- **Fix:** Removed unused imports
- **Files modified:** tests/unit/execution/test_executor_xpt.py, tests/integration/execution/test_dm_execution.py

## Commits

| Task | Commit | Message |
|------|--------|---------|
| 1 | 5ce63ba | feat(04.1-05): wire XPT compliance into DatasetExecutor + cross-domain validation |
| 2 | 80b30f1 | feat(04.1-05): add execute-domain CLI command and DM integration test |

## Verification

- 907 tests passing (up from 892, +16 new: 8 unit + 8 integration), 15 skipped
- ruff check clean on all modified files
- `from astraea.execution import DatasetExecutor` imports successfully
- CLI app loads without error

## Phase 4.1 Completion

This was the final plan (5/5) of Phase 4.1. The phase deliverables are complete:

| Plan | What | Tests Added |
|------|------|-------------|
| 01 | Study day, sequence, epoch, visit, imputation transforms | 63 |
| 02 | Model extensions (VariableOrigin, sort_order) + 4 CT codelists | 16 |
| 03 | Pattern handlers + DatasetExecutor core pipeline | 22 |
| 04 | ASCII validation + char length optimization | 27 |
| 05 | XPT compliance bridge + CLI + DM integration | 16 |
| **Total** | | **144 new tests** |

**Combined test suite: 907 tests passing**

## Next Phase Readiness

Phase 5 (Events/Interventions domain expansion) can now:
- Create `DomainMappingSpec` for any domain via `MappingEngine`
- Execute specs through `DatasetExecutor.execute()` with full compliance
- Write XPT files via `execute_to_xpt()` with optimized column widths
- Validate cross-domain USUBJID consistency
- Use CLI `execute-domain` command for manual execution

Remaining gaps for Phase 5: SPLIT and TRANSPOSE pattern handlers (stubs in Phase 4.1-03, implemented in Phase 6 for Findings domains).
