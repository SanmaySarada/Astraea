---
phase: 04.1-fda-compliance-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["04.1-01"]
files_modified:
  - src/astraea/transforms/ascii_validation.py
  - src/astraea/transforms/char_length.py
  - src/astraea/transforms/__init__.py
  - src/astraea/mapping/transform_registry.py
  - tests/unit/transforms/test_ascii_validation.py
  - tests/unit/transforms/test_char_length.py
autonomous: true

must_haves:
  truths:
    - "ASCII validation detects non-ASCII characters in string columns"
    - "Common non-ASCII characters (curly quotes, en-dash) are auto-replaceable"
    - "Character length optimizer computes max observed length per column"
    - "Optimized lengths are at least 1 and represent byte length (not char count)"
  artifacts:
    - path: "src/astraea/transforms/ascii_validation.py"
      provides: "ASCII detection, reporting, and auto-fix"
      exports: ["validate_ascii", "fix_common_non_ascii"]
    - path: "src/astraea/transforms/char_length.py"
      provides: "Character variable length optimization for XPT"
      exports: ["optimize_char_lengths"]
  key_links:
    - from: "src/astraea/transforms/__init__.py"
      to: "ascii_validation and char_length modules"
      via: "re-exports"
      pattern: "from astraea\\.transforms\\.(ascii_validation|char_length) import"
    - from: "src/astraea/mapping/transform_registry.py"
      to: "new transform functions"
      via: "AVAILABLE_TRANSFORMS registry"
      pattern: "AVAILABLE_TRANSFORMS"
---

<objective>
Create XPT compliance utilities: ASCII validation/cleanup for character data and character length optimization to prevent bloated XPT files.

Purpose: XPT v5 requires ASCII-only character data. Without length optimization, character variables default to 200 bytes, producing unnecessarily large files and potential P21 warnings.

Output: Two new transform modules with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04.1-fda-compliance-infrastructure/04.1-RESEARCH.md

@src/astraea/transforms/__init__.py
@src/astraea/io/xpt_writer.py
@src/astraea/mapping/transform_registry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ASCII validation and character length optimization</name>
  <files>
    src/astraea/transforms/ascii_validation.py
    src/astraea/transforms/char_length.py
    tests/unit/transforms/test_ascii_validation.py
    tests/unit/transforms/test_char_length.py
  </files>
  <action>
    Create `src/astraea/transforms/ascii_validation.py`:

    1. Common replacement map (module-level constant):
       ```python
       _NON_ASCII_REPLACEMENTS: dict[str, str] = {
           "\u2018": "'",   # left single curly quote
           "\u2019": "'",   # right single curly quote
           "\u201c": '"',   # left double curly quote
           "\u201d": '"',   # right double curly quote
           "\u2013": "-",   # en-dash
           "\u2014": "-",   # em-dash
           "\u2026": "...", # ellipsis
           "\u00b0": "deg", # degree sign
           "\u00b5": "u",   # micro sign (mu)
           "\u00b1": "+-",  # plus-minus
           "\u2264": "<=",  # less-than-or-equal
           "\u2265": ">=",  # greater-than-or-equal
       }
       ```

    2. `validate_ascii(df: pd.DataFrame) -> list[dict[str, str]]`:
       - Check all object/string dtype columns
       - For each non-null value, check if it's ASCII-only using val.isascii() (Python 3.7+)
       - Return list of dicts: {"column": col_name, "row": row_index, "value": the_value, "non_ascii_chars": chars_found}
       - Cap at 100 issues to avoid memory explosion
       - Log count of issues found with loguru

    3. `fix_common_non_ascii(df: pd.DataFrame) -> pd.DataFrame`:
       - Work on a copy of df
       - For each object/string column, apply the replacement map
       - Use str.replace() for each replacement character
       - Return the fixed DataFrame
       - Log how many replacements were made per column

    Create `src/astraea/transforms/char_length.py`:

    1. `optimize_char_lengths(df: pd.DataFrame) -> dict[str, int]`:
       - For each object/string dtype column in df
       - Compute max byte length of non-null values: .dropna().astype(str).str.encode("ascii", errors="replace").str.len().max()
       - If all null, use 1 (minimum XPT character width)
       - Return dict of column_name -> optimal_width
       - Minimum width is always 1 (never 0)

    Tests for ascii_validation (test_ascii_validation.py):
    - test_all_ascii_no_issues: DataFrame with only ASCII -> empty list
    - test_detects_non_ascii: DataFrame with curly quotes -> list with entries
    - test_fix_curly_quotes: "He said \u201chello\u201d" -> 'He said "hello"'
    - test_fix_en_dash: "1\u20132" -> "1-2"
    - test_fix_degree_sign: "37\u00b0C" -> "37degC"
    - test_fix_preserves_ascii: pure ASCII columns unchanged
    - test_issue_cap: DataFrame with >100 non-ASCII values -> exactly 100 issues returned
    - test_numeric_columns_skipped: numeric columns not checked

    Tests for char_length (test_char_length.py):
    - test_basic_optimization: column with values "AB", "ABCD" -> width 4
    - test_empty_column: all NaN column -> width 1
    - test_numeric_columns_excluded: numeric columns not in result
    - test_minimum_width_1: column with "" values -> width 1 (not 0)
    - test_mixed_lengths: multiple columns return correct max per column
    - test_ascii_byte_length: confirms byte length (not char count) for multi-byte chars that got replaced
  </action>
  <verify>
    pytest tests/unit/transforms/test_ascii_validation.py tests/unit/transforms/test_char_length.py -x -q
  </verify>
  <done>
    ASCII validation detects and reports non-ASCII characters; fix_common_non_ascii replaces 12 common non-ASCII chars with ASCII equivalents; optimize_char_lengths computes optimal column widths; all edge cases tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update re-exports and transform registry</name>
  <files>
    src/astraea/transforms/__init__.py
    src/astraea/mapping/transform_registry.py
  </files>
  <action>
    Update `src/astraea/transforms/__init__.py`:
    - Add imports from ascii_validation: validate_ascii, fix_common_non_ascii
    - Add imports from char_length: optimize_char_lengths
    - Add all to __all__

    Update `src/astraea/mapping/transform_registry.py`:
    - Add new transforms to AVAILABLE_TRANSFORMS dict:
      - "calculate_study_day": from transforms.study_day
      - "generate_seq": from transforms.sequence
      - "assign_epoch": from transforms.epoch
      - "assign_visit": from transforms.visit
      - "validate_ascii": from transforms.ascii_validation
      - "fix_common_non_ascii": from transforms.ascii_validation
      - "optimize_char_lengths": from transforms.char_length
      - "get_date_imputation_flag": from transforms.imputation
      - "get_time_imputation_flag": from transforms.imputation
    - Import the functions at the top of the file

    Verify all existing transform registry tests still pass.
  </action>
  <verify>
    pytest tests/unit/transforms/ tests/unit/mapping/ -x -q && python -c "from astraea.mapping.transform_registry import list_transforms; ts = list_transforms(); print(f'{len(ts)} transforms registered:', ts)"
  </verify>
  <done>
    All new Phase 4.1 transforms registered in AVAILABLE_TRANSFORMS; all re-exported from transforms/__init__.py; existing tests pass; transform count increased from 6 to 15.
  </done>
</task>

</tasks>

<verification>
pytest tests/unit/transforms/ -x -q
python -c "from astraea.transforms import validate_ascii, fix_common_non_ascii, optimize_char_lengths, calculate_study_day, generate_seq, assign_epoch, assign_visit, get_date_imputation_flag; print('All transforms importable')"
ruff check src/astraea/transforms/ src/astraea/mapping/transform_registry.py
</verification>

<success_criteria>
- validate_ascii detects non-ASCII characters in string columns, caps at 100 issues
- fix_common_non_ascii replaces 12 common non-ASCII chars with ASCII equivalents
- optimize_char_lengths returns optimal byte widths (min 1) per character column
- All new transforms registered in transform_registry.py
- All re-exported from transforms/__init__.py
- All existing 764+ tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-fda-compliance-infrastructure/04.1-04-SUMMARY.md`
</output>
