---
phase: 04.1-fda-compliance-infrastructure
plan: 01
subsystem: transforms
tags: [sdtm, derivation, study-day, sequence, epoch, visit]
depends_on:
  requires: [01-foundation, 02.1-ref-data-fixes]
  provides: [calculate_study_day, calculate_study_day_column, generate_seq, assign_epoch, assign_visit]
  affects: [04.1-02, 04.1-03, 05-domain-expansion]
tech_stack:
  added: []
  patterns: [no-Day-0-convention, SE-domain-epoch-lookup, visit-mapping-dict]
key_files:
  created:
    - src/astraea/transforms/study_day.py
    - src/astraea/transforms/sequence.py
    - src/astraea/transforms/epoch.py
    - src/astraea/transforms/visit.py
    - tests/test_transforms/test_study_day.py
    - tests/test_transforms/test_sequence.py
    - tests/test_transforms/test_epoch.py
    - tests/test_transforms/test_visit.py
  modified:
    - src/astraea/transforms/__init__.py
decisions:
  - id: D-04.1-01-01
    decision: "Test files placed in tests/test_transforms/ (not tests/unit/transforms/) to match existing project structure"
  - id: D-04.1-01-02
    decision: "EPOCH uses pre-grouped dict for SE lookup rather than per-row DataFrame filtering for performance"
  - id: D-04.1-01-03
    decision: "VISITNUM uses Float64 dtype to support decimal values for unplanned visits (e.g., 2.1)"
metrics:
  duration: ~3 min
  completed: 2026-02-27
---

# Phase 4.1 Plan 01: Core SDTM Derivation Utilities Summary

Four deterministic derivation utilities for --DY, --SEQ, EPOCH, and VISITNUM/VISIT that every SDTM domain requires.

## What Was Built

### study_day.py -- --DY Calculation
- `calculate_study_day(event_dtc, rfstdtc)`: Scalar function implementing SDTM no-Day-0 convention (Day 1 = RFSTDTC, Day -1 = day before, no Day 0)
- `calculate_study_day_column(df, date_col, rfstdtc_lookup)`: Vectorized DataFrame version with Int64 nullable output
- Handles partial dates, datetime strings (extracts date portion), None/empty inputs

### sequence.py -- --SEQ Generation
- `generate_seq(df, domain, sort_keys)`: Generates monotonic 1-based integers within USUBJID groups
- Sorts by USUBJID + configurable sort keys, returns series aligned to original index
- Gracefully skips missing sort key columns

### epoch.py -- EPOCH Derivation
- `assign_epoch(df, se_df, date_col)`: Matches observation dates against SE domain date ranges
- Pre-groups SE data by USUBJID for efficient lookup
- Handles open-ended SE elements (missing SEENDTC)
- Uses ISO 8601 string comparison (lexicographic order valid for YYYY-MM-DD)

### visit.py -- VISITNUM/VISIT Assignment
- `assign_visit(df, visit_mapping, raw_visit_col)`: Maps raw visit identifiers to standardized values
- Returns tuple of (Float64 VISITNUM, object VISIT) series
- Supports decimal VISITNUM for unplanned visits
- Logs warnings for unmatched visit values

## Test Coverage

| Module | Tests | Key Cases |
|--------|-------|-----------|
| study_day | 14 | Day 1/RFSTDTC, no Day 0, partial dates, datetime extraction, column version |
| sequence | 6 | Single/multi subject, index preservation, missing sort keys, empty df |
| epoch | 9 | Screening/treatment/follow-up, boundaries, open-ended, multi-subject, partial/missing dates |
| visit | 7 | Mapped/unmatched visits, empty mapping, decimal VISITNUM, custom column, NaN |
| **Total** | **36** | |

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | ba92b36 | --DY study day and --SEQ sequence utilities |
| 2 | 344d6d9 | EPOCH and VISITNUM/VISIT utilities with re-exports |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Test directory path adjusted to match project structure**
- **Found during:** Task 1
- **Issue:** Plan specified `tests/unit/transforms/` but existing transform tests live in `tests/test_transforms/`
- **Fix:** Created test files in `tests/test_transforms/` for consistency
- **Files modified:** test file paths only

**2. [Rule 1 - Bug] Removed unused logger import in epoch.py**
- **Found during:** Task 2 verification
- **Issue:** ruff flagged unused `loguru.logger` import
- **Fix:** Removed the import since epoch.py uses no logging
- **Files modified:** src/astraea/transforms/epoch.py

## Verification

- All 36 new tests pass
- All 773 existing tests pass (excludes pre-existing test_total_codelist_count failure)
- ruff check clean on all new/modified files
- All 5 new functions importable from `astraea.transforms`
