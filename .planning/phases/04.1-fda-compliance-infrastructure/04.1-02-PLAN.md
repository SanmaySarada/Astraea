---
phase: 04.1-fda-compliance-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/models/mapping.py
  - src/astraea/transforms/imputation.py
  - src/astraea/data/ct/codelists.json
  - tests/unit/models/test_mapping_origin.py
  - tests/unit/transforms/test_imputation.py
  - tests/unit/reference/test_new_codelists.py
autonomous: true

must_haves:
  truths:
    - "VariableMapping has origin and computational_method fields for define.xml"
    - "Date imputation flag utilities produce correct DTF/TMF values"
    - "Missing CT codelists (C66785 Laterality, C66789 Specimen Condition) are present and queryable"
    - "VariableOrigin enum has all five define.xml 2.0 origin types"
  artifacts:
    - path: "src/astraea/models/mapping.py"
      provides: "VariableOrigin enum, origin + computational_method on VariableMapping"
      contains: "class VariableOrigin"
    - path: "src/astraea/transforms/imputation.py"
      provides: "Date/time imputation flag utilities"
      exports: ["get_date_imputation_flag", "get_time_imputation_flag"]
    - path: "src/astraea/data/ct/codelists.json"
      provides: "C66785 Laterality and C66789 Specimen Condition codelists"
  key_links:
    - from: "src/astraea/models/mapping.py"
      to: "VariableOrigin enum"
      via: "origin field on VariableMapping"
      pattern: "origin.*VariableOrigin"
---

<objective>
Extend the mapping model with origin metadata for define.xml, add date imputation flag utilities, and add the 2 missing CT codelists needed by Findings domains.

Purpose: Origin tracking is required for define.xml generation (Phase 7). Imputation flags are needed when partial dates are handled. Missing codelists block Phase 6 Findings domain mapping.

Output: Extended VariableMapping model, imputation utilities, 2 new CT codelists.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-fda-compliance-infrastructure/04.1-RESEARCH.md

@src/astraea/models/mapping.py
@src/astraea/data/ct/codelists.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Model extensions (origin, computational_method) and imputation flags</name>
  <files>
    src/astraea/models/mapping.py
    src/astraea/transforms/imputation.py
    src/astraea/transforms/__init__.py
    tests/unit/models/test_mapping_origin.py
    tests/unit/transforms/test_imputation.py
  </files>
  <action>
    In `src/astraea/models/mapping.py`:

    1. Add VariableOrigin StrEnum (after ConfidenceLevel):
       ```python
       class VariableOrigin(StrEnum):
           CRF = "CRF"
           DERIVED = "Derived"
           ASSIGNED = "Assigned"
           PROTOCOL = "Protocol"
           EDT = "eDT"
           PREDECESSOR = "Predecessor"
       ```

    2. Add two fields to VariableMapping (after the `length` field):
       ```python
       origin: VariableOrigin | None = Field(
           default=None,
           description="Variable origin type for define.xml (CRF, Derived, Assigned, Protocol, eDT)",
       )
       computational_method: str | None = Field(
           default=None,
           description="Derivation algorithm description for define.xml MethodDef",
       )
       ```

    3. Add an `origin` field to VariableMappingProposal (after rationale):
       ```python
       origin: str | None = Field(
           default=None,
           description="Proposed origin type (CRF, Derived, Assigned, Protocol, eDT)",
       )
       ```

    IMPORTANT: The new fields have defaults (None), so all existing code and tests that construct VariableMapping without origin/computational_method will continue to work.

    Create `src/astraea/transforms/imputation.py` with:

    1. `get_date_imputation_flag(original_dtc: str, imputed_dtc: str) -> str | None`:
       - Return None if either input is missing/empty
       - Check date portion length of original_dtc (split on "T", take first part):
         - >= 10 chars (YYYY-MM-DD): return None (no date imputation)
         - >= 7 chars (YYYY-MM): return "D" (day imputed)
         - >= 4 chars (YYYY): return "M" (month imputed)
         - else: return "Y" (year imputed)

    2. `get_time_imputation_flag(original_dtc: str, imputed_dtc: str) -> str | None`:
       - Return None if either input is missing/empty
       - If "T" not in original but "T" in imputed: return "H"
       - If "T" not in original and "T" not in imputed: return None
       - Parse time portion (after "T"), strip colons, check length:
         - >= 6 (HHMMSS): return None
         - >= 4 (HHMM): return "S"
         - >= 2 (HH): return "M"
         - else: return "H"

    Update `src/astraea/transforms/__init__.py` to re-export imputation functions.

    Tests for model (test_mapping_origin.py):
    - test_variable_origin_enum_values: verify all 6 values exist
    - test_variable_mapping_with_origin: construct VariableMapping with origin=VariableOrigin.CRF
    - test_variable_mapping_origin_default_none: construct without origin, verify None
    - test_variable_mapping_with_computational_method: verify string field
    - test_proposal_with_origin: VariableMappingProposal with origin="Derived"
    - test_variable_mapping_serialization: .model_dump() includes origin and computational_method

    Tests for imputation (test_imputation.py):
    - test_full_date_no_imputation: "2022-03-30" -> None
    - test_year_month_day_imputed: "2022-03" -> "D"
    - test_year_only_month_imputed: "2022" -> "M"
    - test_empty_original: "" -> None
    - test_time_no_imputation: "2022-03-30T14:30:00" -> None for TMF
    - test_time_hour_imputed: no T in original, T in imputed -> "H"
    - test_time_minute_imputed: "2022-03-30T14" -> "M"
    - test_time_second_imputed: "2022-03-30T14:30" -> "S"
  </action>
  <verify>
    pytest tests/unit/models/test_mapping_origin.py tests/unit/transforms/test_imputation.py -x -q && pytest tests/unit/models/ -x -q
  </verify>
  <done>
    VariableMapping has origin and computational_method fields with backward-compatible defaults; VariableOrigin enum covers all define.xml 2.0 origin types; imputation flag utilities correctly detect imputation level from partial vs full dates; all existing model tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing CT codelists (Laterality, Specimen Condition)</name>
  <files>
    src/astraea/data/ct/codelists.json
    tests/unit/reference/test_new_codelists.py
  </files>
  <action>
    Edit `src/astraea/data/ct/codelists.json` to add 2 new codelists.

    NOTE: C101854 (Outcome) -- the research found C66768 (Outcome of Event) already exists in codelists.json with the needed terms. C101854 appears to be a duplicate reference. Do NOT add it. C71148 (Position) already exists. So only 2 are genuinely missing.

    Add C66785 (Laterality):
    ```json
    "C66785": {
      "name": "Laterality",
      "extensible": false,
      "terms": {
        "LEFT": "Left",
        "RIGHT": "Right",
        "BILATERAL": "Bilateral"
      }
    }
    ```

    Add C66789 (Specimen Condition):
    ```json
    "C66789": {
      "name": "Specimen Condition",
      "extensible": true,
      "terms": {
        "HEMOLYZED": "Hemolyzed",
        "LIPEMIC": "Lipemic",
        "ICTERIC": "Icteric",
        "CLOTTED": "Clotted",
        "INSUFFICIENT QUANTITY": "Insufficient Quantity",
        "NOT APPLICABLE": "Not Applicable"
      }
    }
    ```

    C66789 is extensible (study-specific specimen conditions are allowed). C66785 is non-extensible (only LEFT, RIGHT, BILATERAL are valid).

    Insert the new entries alphabetically by C-code within the JSON file. Ensure valid JSON (no trailing commas).

    Tests (test_new_codelists.py):
    - test_laterality_codelist_exists: CTReference can load C66785
    - test_laterality_terms: verify LEFT, RIGHT, BILATERAL present
    - test_laterality_non_extensible: validate_term with unknown term returns False
    - test_specimen_condition_codelist_exists: CTReference can load C66789
    - test_specimen_condition_terms: verify HEMOLYZED, LIPEMIC, ICTERIC, CLOTTED present
    - test_specimen_condition_extensible: validate_term with unknown term returns True (extensible)
  </action>
  <verify>
    pytest tests/unit/reference/test_new_codelists.py -x -q && python -c "from astraea.reference import CTReference; ct = CTReference(); print('C66785:', ct.get_codelist('C66785').name); print('C66789:', ct.get_codelist('C66789').name)"
  </verify>
  <done>
    C66785 (Laterality) with 3 non-extensible terms and C66789 (Specimen Condition) with 6 extensible terms are in codelists.json; both load and validate correctly via CTReference; all existing codelist tests still pass.
  </done>
</task>

</tasks>

<verification>
pytest tests/unit/models/ tests/unit/transforms/test_imputation.py tests/unit/reference/ -x -q
ruff check src/astraea/models/mapping.py src/astraea/transforms/imputation.py
python -c "from astraea.models.mapping import VariableOrigin, VariableMapping; print('Origin types:', list(VariableOrigin)); m = VariableMapping(sdtm_variable='AGE', sdtm_label='Age', sdtm_data_type='Num', core='Req', mapping_pattern='derivation', mapping_logic='test', confidence=0.9, confidence_level='high', confidence_rationale='test', origin='Derived', computational_method='BRTHDAT - RFSTDTC'); print('origin:', m.origin, 'method:', m.computational_method)"
</verification>

<success_criteria>
- VariableOrigin enum has CRF, Derived, Assigned, Protocol, eDT, Predecessor values
- VariableMapping.origin and .computational_method fields exist with None defaults
- VariableMappingProposal.origin field exists for LLM to propose origin types
- get_date_imputation_flag returns correct DTF values (None/D/M/Y)
- get_time_imputation_flag returns correct TMF values (None/H/M/S)
- C66785 (Laterality) and C66789 (Specimen Condition) codelists present and queryable
- All existing 764+ tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-fda-compliance-infrastructure/04.1-02-SUMMARY.md`
</output>
