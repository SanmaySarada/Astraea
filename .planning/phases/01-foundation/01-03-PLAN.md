---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/astraea/reference/__init__.py
  - src/astraea/reference/sdtm_ig.py
  - src/astraea/reference/controlled_terms.py
  - src/astraea/reference/loader.py
  - src/astraea/data/sdtm_ig/domains.json
  - src/astraea/data/sdtm_ig/version.json
  - src/astraea/data/ct/codelists.json
  - src/astraea/data/ct/version.json
  - tests/test_reference/test_sdtm_ig.py
  - tests/test_reference/test_controlled_terms.py
autonomous: true

must_haves:
  truths:
    - "User can query all required variables for any common SDTM domain (DM, AE, CM, EX, LB, VS, EG, MH, DS, IE)"
    - "User can look up any NCI codelist and check if a value is valid"
    - "User can determine if a codelist is extensible or non-extensible"
    - "SDTM-IG version and CT version are locked together via version manifest"
  artifacts:
    - path: "src/astraea/data/sdtm_ig/domains.json"
      provides: "SDTM-IG v3.4 domain and variable specifications for 10+ domains"
      min_lines: 100
    - path: "src/astraea/data/ct/codelists.json"
      provides: "NCI CDISC CT codelists with submission values and extensibility"
      min_lines: 100
    - path: "src/astraea/reference/sdtm_ig.py"
      provides: "SDTMReference lookup class"
      exports: ["SDTMReference"]
    - path: "src/astraea/reference/controlled_terms.py"
      provides: "CTReference lookup class"
      exports: ["CTReference"]
    - path: "src/astraea/reference/loader.py"
      provides: "Load bundled reference data"
      exports: ["load_sdtm_reference", "load_ct_reference"]
  key_links:
    - from: "src/astraea/reference/sdtm_ig.py"
      to: "src/astraea/data/sdtm_ig/domains.json"
      via: "loads JSON at init"
      pattern: "json.load|domains.json"
    - from: "src/astraea/reference/controlled_terms.py"
      to: "src/astraea/data/ct/codelists.json"
      via: "loads JSON at init"
      pattern: "json.load|codelists.json"
    - from: "src/astraea/reference/sdtm_ig.py"
      to: "src/astraea/models/sdtm.py"
      via: "returns DomainSpec, VariableSpec"
      pattern: "DomainSpec|VariableSpec"
---

<objective>
Bundle CDISC SDTM-IG v3.4 domain specifications and NCI Controlled Terminology as queryable JSON reference data.

Purpose: Satisfies DATA-03 (SDTM-IG metadata as structured reference) and DATA-04 (NCI CT codelists). Every mapping agent needs this reference data. Bundled JSON means zero network dependency at runtime.
Output: Pre-processed JSON reference files plus Python lookup classes with tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bundled SDTM-IG and CT JSON reference data</name>
  <files>
    src/astraea/data/sdtm_ig/domains.json
    src/astraea/data/sdtm_ig/version.json
    src/astraea/data/ct/codelists.json
    src/astraea/data/ct/version.json
  </files>
  <action>
    Create the bundled JSON reference data files from SDTM-IG v3.4 specifications.

    **domains.json** -- SDTM-IG v3.4 domain definitions. Create entries for these 10 priority domains: DM, AE, CM, EX, LB, VS, EG, MH, DS, IE. For each domain include:
    - domain code (e.g., "DM")
    - description (e.g., "Demographics")
    - domain_class (e.g., "SPECIAL_PURPOSE" for DM, "EVENTS" for AE, "INTERVENTIONS" for CM/EX, "FINDINGS" for LB/VS/EG)
    - structure (e.g., "One record per subject" for DM)
    - variables: array of objects, each with: name, label, data_type ("Char"/"Num"), core ("Req"/"Exp"/"Perm"), cdisc_notes, codelist_code (NCI code if applicable, null otherwise), order (integer)

    For DM domain, include ALL standard variables: STUDYID, DOMAIN, USUBJID, SUBJID, RFSTDTC, RFENDTC, RFXSTDTC, RFXENDTC, RFICDTC, RFPENDTC, DTHDTC, DTHFL, SITEID, BRTHDTC, AGE, AGEU, SEX, RACE, ETHNIC, ARMCD, ARM, ACTARMCD, ACTARM, COUNTRY, DMDTC, DMDY.

    For other domains, include at minimum all Required and Expected variables per SDTM-IG v3.4. The general class variables (STUDYID, DOMAIN, USUBJID, --SEQ, --TERM/--TRT/--TESTCD depending on class) must be present.

    **version.json** (in sdtm_ig/): {"version": "3.4", "source": "SDTM-IG v3.4"}

    **codelists.json** -- NCI CDISC CT. Create entries for the most commonly used codelists:
    - C66731 (Sex): M, F, U, UNDIFFERENTIATED
    - C66790 (No Yes Response): N, Y
    - C66767 (Race): entries for AMERICAN INDIAN OR ALASKA NATIVE, ASIAN, BLACK OR AFRICAN AMERICAN, NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER, WHITE, OTHER, MULTIPLE, NOT REPORTED, UNKNOWN
    - C66728 (Ethnicity): HISPANIC OR LATINO, NOT HISPANIC OR LATINO, NOT REPORTED, UNKNOWN
    - C66742 (Country): at minimum US, CA, GB, DE, FR, JP, AU, IN, BR, MX, CN
    - C66726 (Age Unit): YEARS, MONTHS, WEEKS, DAYS, HOURS
    - C66769 (Route of Administration): ORAL, INTRAVENOUS, SUBCUTANEOUS, INTRAMUSCULAR, TOPICAL, TRANSDERMAL, INHALATION, NASAL, OPHTHALMIC, RECTAL, SUBLINGUAL
    - C66734 (Severity/Intensity Scale): MILD, MODERATE, SEVERE
    - C66768 (Outcome of Event): RECOVERED/RESOLVED, RECOVERING/RESOLVING, NOT RECOVERED/NOT RESOLVED, RECOVERED/RESOLVED WITH SEQUELAE, FATAL, UNKNOWN
    - C66781 (Unit): common lab/vital sign units (kg, cm, mmHg, bpm, mg/dL, mmol/L, g/dL, etc.)
    - C66770 (Frequency): QD, BID, TID, QID, PRN, QW, Q2W, QM, ONCE, etc.

    Each codelist entry follows the schema from RESEARCH.md: code, name, extensible (bool), variable_mappings (which SDTM variables use this codelist), terms (dict of submission_value -> {synonym, definition, nci_preferred_term}).

    Mark extensibility correctly: Sex, Race, Ethnicity are NON-extensible. Route, Unit are extensible.

    **version.json** (in ct/): {"version": "2025-09-26", "ig_version": "3.4", "source": "NCI EVS CDISC SDTM CT"}

    IMPORTANT: Be thorough with DM domain variables (this is the Phase 3 reference implementation domain). Other domains need at minimum Required + Expected variables. Get the core designations right -- this data is the source of truth for the entire system.
  </action>
  <verify>
    Run: python -c "import json; d=json.load(open('src/astraea/data/sdtm_ig/domains.json')); print(f'Domains: {len(d)}'); dm=d['DM']; print(f'DM vars: {len(dm[\"variables\"])}')"
    Run: python -c "import json; c=json.load(open('src/astraea/data/ct/codelists.json')); print(f'Codelists: {len(c[\"codelists\"])}')"
  </verify>
  <done>domains.json has 10+ domain definitions with complete variable specs. codelists.json has 10+ codelists with proper extensibility flags. DM domain has all 26+ standard variables.</done>
</task>

<task type="auto">
  <name>Task 2: Implement reference data lookup classes</name>
  <files>
    src/astraea/reference/sdtm_ig.py
    src/astraea/reference/controlled_terms.py
    src/astraea/reference/loader.py
    src/astraea/reference/__init__.py
    tests/test_reference/test_sdtm_ig.py
    tests/test_reference/test_controlled_terms.py
  </files>
  <action>
    Implement Python lookup classes over the bundled JSON data.

    **sdtm_ig.py -- SDTMReference class:**
    - __init__(self, data_path: str | Path | None = None): loads domains.json from data_path or default bundled location (use importlib.resources or Path(__file__).parent approach to find src/astraea/data/sdtm_ig/)
    - get_domain_spec(domain: str) -> DomainSpec | None: returns full domain specification as Pydantic model
    - get_required_variables(domain: str) -> list[str]: returns names of Required variables only
    - get_expected_variables(domain: str) -> list[str]: returns names of Expected variables
    - get_variable_spec(domain: str, variable: str) -> VariableSpec | None: returns single variable spec
    - list_domains() -> list[str]: returns all available domain codes
    - get_domain_class(domain: str) -> DomainClass | None: returns the class of a domain

    **controlled_terms.py -- CTReference class:**
    - __init__(self, data_path: str | Path | None = None): loads codelists.json
    - lookup_codelist(codelist_code: str) -> Codelist | None: returns full codelist as Pydantic model
    - is_extensible(codelist_code: str) -> bool: checks extensibility
    - validate_term(codelist_code: str, value: str) -> bool: checks if submission value is valid
    - get_codelist_for_variable(variable_name: str) -> Codelist | None: reverse lookup -- given an SDTM variable name, find its associated codelist
    - list_codelists() -> list[str]: returns all codelist codes

    **loader.py:**
    - load_sdtm_reference() -> SDTMReference: convenience function, uses default bundled path
    - load_ct_reference() -> CTReference: convenience function, uses default bundled path

    **reference/__init__.py:** Re-export SDTMReference, CTReference, load_sdtm_reference, load_ct_reference.

    **Tests:**
    test_sdtm_ig.py:
    - Test get_domain_spec("DM") returns valid DomainSpec with variables
    - Test get_required_variables("DM") includes STUDYID, DOMAIN, USUBJID
    - Test get_domain_class("AE") returns DomainClass.EVENTS
    - Test get_domain_class("LB") returns DomainClass.FINDINGS
    - Test get_variable_spec("DM", "SEX") returns VariableSpec with codelist_code set
    - Test list_domains() returns at least 10 domains
    - Test non-existent domain returns None

    test_controlled_terms.py:
    - Test lookup_codelist("C66731") returns Sex codelist with terms M, F, U
    - Test validate_term("C66731", "M") returns True
    - Test validate_term("C66731", "INVALID") returns False
    - Test is_extensible("C66731") returns False (Sex is non-extensible)
    - Test get_codelist_for_variable("SEX") returns the Sex codelist
    - Test list_codelists() returns at least 10 codelists
  </action>
  <verify>Run: pytest tests/test_reference/ -v</verify>
  <done>SDTMReference queries domain specs and variables. CTReference validates terms against codelists. All tests pass.</done>
</task>

</tasks>

<verification>
- `pytest tests/test_reference/ -v` all pass
- `python -c "from astraea.reference import load_sdtm_reference; ref = load_sdtm_reference(); print(ref.get_required_variables('DM'))"` prints list of required DM variables
- `python -c "from astraea.reference import load_ct_reference; ct = load_ct_reference(); print(ct.validate_term('C66731', 'M')); print(ct.is_extensible('C66731'))"` prints True then False
</verification>

<success_criteria>
- 10+ SDTM domains with complete variable specifications in domains.json
- 10+ NCI codelists with terms and extensibility flags in codelists.json
- SDTMReference and CTReference classes provide full query interface
- Version manifest locks SDTM-IG v3.4 with CT 2025-09-26
- All reference tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
