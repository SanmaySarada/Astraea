---
phase: 01-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03", "01-04"]
files_modified:
  - src/astraea/io/xpt_writer.py
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - tests/test_io/test_xpt_writer.py
  - tests/test_cli/test_app.py
  - tests/test_cli/__init__.py
autonomous: false

must_haves:
  truths:
    - "User can run `astraea profile <folder>` and see profiling output in terminal"
    - "User can run `astraea reference <domain>` and see SDTM-IG variable specs"
    - "System writes valid .xpt files that can be read back with identical data"
    - "System catches XPT v5 constraint violations before writing (variable name > 8 chars, label > 40 chars, non-ASCII)"
    - "Pipeline progress is displayed clearly in terminal"
  artifacts:
    - path: "src/astraea/io/xpt_writer.py"
      provides: "XPT v5 writer with pre-validation"
      exports: ["write_xpt_v5", "validate_for_xpt_v5", "XPTValidationError"]
    - path: "src/astraea/cli/app.py"
      provides: "Typer CLI application with profile and reference commands"
      exports: ["app"]
    - path: "src/astraea/cli/display.py"
      provides: "Rich display helpers for terminal output"
      exports: ["display_profile_summary", "display_domain_spec"]
  key_links:
    - from: "src/astraea/io/xpt_writer.py"
      to: "pyreadstat.write_xport"
      via: "validated write"
      pattern: "pyreadstat\\.write_xport"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/io/sas_reader.py"
      via: "profile command reads SAS files"
      pattern: "read_all_sas_files|read_sas_with_metadata"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/profiling/profiler.py"
      via: "profile command calls profiler"
      pattern: "profile_dataset"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/reference/sdtm_ig.py"
      via: "reference command queries domain specs"
      pattern: "SDTMReference|get_domain_spec"
---

<objective>
Build the XPT writer with pre-validation and the CLI that ties the entire Phase 1 together -- the user-facing surface of the system.

Purpose: Satisfies DATA-07 (valid XPT output), CLI-01 (run from terminal, point at data folder), and CLI-04 (display progress clearly). This is the integration layer that proves all components work together.
Output: Working CLI with profile and reference commands, plus validated XPT writer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement XPT v5 writer with pre-write validation</name>
  <files>
    src/astraea/io/xpt_writer.py
    tests/test_io/test_xpt_writer.py
  </files>
  <action>
    Implement XPT v5 file writer with validation that catches pyreadstat's silent truncation.

    **XPTValidationError(Exception):** Custom exception for validation failures.

    **validate_for_xpt_v5(df: pd.DataFrame, column_labels: dict[str, str], table_name: str) -> list[str]:**
    - Check table_name: <= 8 chars, starts with letter, alphanumeric only
    - Check each column name: <= 8 chars, alphanumeric + underscore, starts with letter
    - Check each label: <= 40 chars
    - Check character variable values: <= 200 bytes
    - Check ASCII only in character columns
    - Return list of error strings (empty = valid)

    **write_xpt_v5(df: pd.DataFrame, path: str | Path, table_name: str, column_labels: dict[str, str]) -> None:**
    - Step 1: Call validate_for_xpt_v5. If errors, raise XPTValidationError with all errors listed.
    - Step 2: Uppercase all column names (SDTM convention)
    - Step 3: Call pyreadstat.write_xport with file_format_version=5, table_name uppercased, column_labels uppercased
    - Step 4: Read-back verification -- read the file back with pyreadstat.read_xport and assert column names match and row count matches. This catches any silent corruption.

    **Tests (test_xpt_writer.py):**
    - Test valid write: create a small DataFrame with columns <= 8 chars, write, read back, assert identical
    - Test validation catches long variable name (> 8 chars)
    - Test validation catches long label (> 40 chars)
    - Test validation catches non-ASCII characters
    - Test validation catches table name too long
    - Test write raises XPTValidationError on invalid data
    - Test read-back produces identical data (round-trip test)
    - Use tmpdir/tmp_path fixture for test file paths
  </action>
  <verify>Run: pytest tests/test_io/test_xpt_writer.py -v</verify>
  <done>XPT writer validates all v5 constraints before writing. Round-trip test confirms data integrity. Validation catches all known pyreadstat silent truncation issues.</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI with profile and reference commands</name>
  <files>
    src/astraea/cli/app.py
    src/astraea/cli/display.py
    src/astraea/cli/__init__.py
    tests/test_cli/__init__.py
    tests/test_cli/test_app.py
  </files>
  <action>
    Build the CLI entry point using typer + rich.

    **display.py -- Rich formatting helpers:**

    **display_profile_summary(profiles: list[DatasetProfile], console: Console) -> None:**
    - Print a summary table with columns: Dataset, Rows, Columns, Clinical Cols, EDC Cols, Date Cols, Missing%
    - Clinical Cols = total cols - EDC cols
    - Missing% = average missing percentage across all clinical (non-EDC) variables
    - Use rich.table.Table with colored headers

    **display_variable_detail(profile: DatasetProfile, console: Console) -> None:**
    - Print detailed variable-level table: Variable, Label, Type, Format, Missing%, Unique, Top Values
    - Highlight EDC columns in dim/gray style
    - Highlight date columns in yellow
    - Show top 3 values inline for categorical variables

    **display_domain_spec(spec: DomainSpec, console: Console) -> None:**
    - Print domain info: name, description, class, structure
    - Print variable table: Variable, Label, Type, Core, Codelist
    - Color-code core designation: Req=red, Exp=yellow, Perm=green

    **app.py -- Typer CLI app:**

    app = typer.Typer(name="astraea", help="Astraea SDTM Mapping Pipeline")

    **@app.command() profile(data_dir: Path, output: Path | None = None, detail: bool = False):**
    - Verify data_dir exists and contains .sas7bdat files
    - Read all SAS files using read_all_sas_files
    - Profile each dataset using profile_dataset
    - Display summary table using display_profile_summary
    - If --detail flag, also show variable-level detail for each dataset
    - If --output provided, write profiles as JSON (using model_dump on each DatasetProfile)
    - Show Rich progress spinner while reading/profiling
    - Print pipeline stage: "[1/2] Reading SAS files...", "[2/2] Profiling datasets..."

    **@app.command() reference(domain: str, variable: str | None = None):**
    - Load SDTM reference using load_sdtm_reference
    - If variable is None: show full domain spec using display_domain_spec
    - If variable is provided: show single variable detail (label, type, core, codelist, notes)
    - If domain not found, print error and list available domains

    **@app.command() codelist(code: str | None = None, variable: str | None = None):**
    - Load CT reference using load_ct_reference
    - If code provided: show codelist detail (name, extensible, all terms)
    - If variable provided: look up codelist by variable name and show it
    - If neither: list all available codelists

    **cli/__init__.py:** Re-export app.

    **Tests (test_app.py):**
    - Use typer.testing.CliRunner
    - Test `profile Fakedata/` exits 0 and output contains "Dataset Summary" or dataset names
    - Test `reference DM` exits 0 and output contains "USUBJID"
    - Test `reference INVALID` exits non-zero or shows error message
    - Test `profile /nonexistent/` exits non-zero
  </action>
  <verify>
    Run: pytest tests/test_cli/test_app.py -v
    Run: python -m astraea.cli.app profile Fakedata/
    Run: python -m astraea.cli.app reference DM
  </verify>
  <done>CLI profile command reads SAS files, profiles them, and displays rich terminal output. CLI reference command queries SDTM-IG specs. Progress displayed clearly with stage indicators.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 foundation: SAS reader, profiler, CDISC reference data, date converter, USUBJID generator, XPT writer, and CLI.</what-built>
  <how-to-verify>
    1. Run `astraea profile Fakedata/` -- verify it shows a summary table of all 36 datasets with row counts, column counts, EDC column counts, and date column counts
    2. Run `astraea profile Fakedata/ --detail` -- verify it shows variable-level detail including labels, types, and top values
    3. Run `astraea reference DM` -- verify it shows all DM domain variables with core designations
    4. Run `astraea reference DM --variable SEX` -- verify it shows SEX variable spec with codelist reference
    5. Run `astraea codelist C66731` -- verify it shows Sex codelist with M, F, U terms
    6. Run full test suite: `pytest -v` -- verify all tests pass
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pytest -v` -- all tests pass across all modules
- `astraea profile Fakedata/` displays clean summary table
- `astraea reference DM` shows complete DM variable specs
- `astraea codelist C66731` shows Sex codelist
- XPT round-trip test passes (write then read produces identical data)
- All 5 success criteria from roadmap are met:
  1. User runs CLI, points at SAS folder, sees profiling output
  2. SDTM-IG domain definitions and CT codelists loaded and queryable
  3. Date conversion handles SAS numeric, string formats, and partial dates
  4. USUBJID generated from components and validated
  5. Valid XPT file written from DataFrame and passes structural validation
</verification>

<success_criteria>
- CLI profile command shows rich terminal output for any directory of SAS files
- CLI reference command queries SDTM-IG domain and variable specs
- CLI codelist command queries NCI controlled terminology
- XPT writer validates constraints before writing and verifies round-trip integrity
- All Phase 1 requirements (DATA-01 through DATA-07, CLI-01, CLI-04) are satisfied
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
