---
phase: 07-validation-submission-readiness
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/astraea/validation/rules/consistency.py
  - src/astraea/validation/rules/fda_business.py
  - src/astraea/validation/rules/fda_trc.py
  - tests/unit/validation/test_consistency_rules.py
  - tests/unit/validation/test_fda_rules.py
autonomous: true

must_haves:
  truths:
    - "Cross-domain USUBJID consistency is validated (all USUBJIDs exist in DM)"
    - "STUDYID consistency across all domains is checked"
    - "RFSTDTC and date consistency across domains is validated"
    - "FDA TRC pre-checks verify DM present, TS present with SSTDTC, define.xml exists, STUDYID consistent, filenames correct"
    - "FDA Business Rules FDAB057/055/039/009/030 are implemented"
  artifacts:
    - path: "src/astraea/validation/rules/consistency.py"
      provides: "Cross-domain consistency rules (VAL-03)"
      contains: "class CrossDomainUSUBJIDRule"
    - path: "src/astraea/validation/rules/fda_business.py"
      provides: "FDA Business Rules (FDAB*)"
      contains: "class FDAB057Rule"
    - path: "src/astraea/validation/rules/fda_trc.py"
      provides: "FDA Technical Rejection Criteria pre-check"
      contains: "class TRCPreCheck"
  key_links:
    - from: "src/astraea/validation/rules/consistency.py"
      to: "src/astraea/validation/engine.py"
      via: "CrossDomainValidator uses multi-domain data"
      pattern: "class CrossDomainValidator"
---

<objective>
Implement cross-domain consistency rules (VAL-03), FDA Business Rules (FDAB009/030/039/055/057), and FDA Technical Rejection Criteria (TRC) pre-checks. These operate across multiple domains simultaneously.

Purpose: Cross-domain validation and FDA compliance checking -- the rules that require seeing all generated datasets together.
Output: consistency.py, fda_business.py, fda_trc.py + unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-validation-submission-readiness/07-RESEARCH.md
@src/astraea/validation/rules/base.py
@src/astraea/validation/engine.py
@src/astraea/execution/executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-domain consistency rules (VAL-03)</name>
  <files>
    src/astraea/validation/rules/consistency.py
    tests/unit/validation/test_consistency_rules.py
  </files>
  <action>
**consistency.py** -- VAL-03 rules. These rules differ from single-domain rules: they need access to ALL generated DataFrames, not just one. Create a `CrossDomainValidator` class (not a ValidationRule subclass) with its own evaluate method signature:

`CrossDomainValidator`:
- `__init__(self)` -- no constructor args needed
- `validate(self, domains: dict[str, pd.DataFrame], specs: dict[str, DomainMappingSpec]) -> list[RuleResult]` -- runs all cross-domain checks

Rules implemented as methods:
- `_check_usubjid_consistency(domains)` -> rule_id="ASTR-C001": All USUBJIDs in every domain must exist in DM.USUBJID. Severity: ERROR. p21_equivalent="SD0085". Report per-domain: "AE has 3 USUBJIDs not in DM". affected_count = number of orphan USUBJIDs.
- `_check_studyid_consistency(domains)` -> rule_id="ASTR-C002": STUDYID must have exactly one unique value across all domains. Severity: ERROR.
- `_check_rfstdtc_consistency(domains)` -> rule_id="ASTR-C003": If DM has RFSTDTC, check that EX/DS dates are consistent. Specifically: RFSTDTC should equal earliest EXSTDTC for each subject (warning if not). Severity: WARNING.
- `_check_domain_column_consistency(domains, specs)` -> rule_id="ASTR-C004": Each domain's DOMAIN column must contain only its expected domain code. Severity: ERROR.
- `_check_studyday_consistency(domains)` -> rule_id="ASTR-C005": If --DY columns exist, verify no positive --DY values on dates before RFSTDTC and no negative --DY on dates after RFSTDTC. Severity: WARNING (may have legitimate edge cases).

**Update ValidationEngine**: Add `validate_cross_domain(self, domains: dict[str, tuple[pd.DataFrame, DomainMappingSpec]]) -> list[RuleResult]` method that creates CrossDomainValidator and runs it. Also update `validate_all()` to call validate_cross_domain after per-domain validation.

**Tests**: Create synthetic multi-domain DataFrames (DM, AE, EX with known inconsistencies). Test each cross-domain rule independently.
  </action>
  <verify>pytest tests/unit/validation/test_consistency_rules.py -x -q</verify>
  <done>Cross-domain USUBJID, STUDYID, RFSTDTC, DOMAIN consistency checks all work with severity levels</done>
</task>

<task type="auto">
  <name>Task 2: FDA Business Rules and TRC pre-checks</name>
  <files>
    src/astraea/validation/rules/fda_business.py
    src/astraea/validation/rules/fda_trc.py
    tests/unit/validation/test_fda_rules.py
  </files>
  <action>
**fda_business.py** -- FDA Business Rules as ValidationRule subclasses:
- `FDAB057Rule(ValidationRule)`: rule_id="FDAB057". Check DM.ETHNIC values against CT codelist C66790. Must include "HISPANIC OR LATINO" and "NOT HISPANIC OR LATINO" as available choices. Severity: WARNING. Only evaluates when domain=="DM".
- `FDAB055Rule(ValidationRule)`: rule_id="FDAB055". Check DM.RACE values against CT codelist C74457. Severity: WARNING. Only evaluates when domain=="DM".
- `FDAB039Rule(ValidationRule)`: rule_id="FDAB039". For Findings domains (LB, VS, EG): check that --ORNRLO and --ORNRHI are numeric when --STRESN is populated. Severity: WARNING. Only evaluates when domain in findings set.
- `FDAB009Rule(ValidationRule)`: rule_id="FDAB009". For Findings domains: check that --TESTCD and --TEST have a 1:1 relationship (each TESTCD maps to exactly one TEST and vice versa). Severity: ERROR.
- `FDAB030Rule(ValidationRule)`: rule_id="FDAB030". For Findings domains: check that --STRESU values are consistent for the same --TESTCD. Severity: WARNING.

Each FDA rule's evaluate() should return empty list when the rule doesn't apply to the given domain.

**fda_trc.py** -- TRC pre-check. This is NOT a ValidationRule subclass -- it checks submission-level artifacts:
- `TRCPreCheck` class:
  - `check_all(self, generated_domains: dict[str, pd.DataFrame], output_dir: Path, study_id: str) -> list[RuleResult]`
  - Checks: DM present (FDA-TRC-1736), TS present with SSTDTC (FDA-TRC-1734), define.xml present (FDA-TRC-1735), STUDYID consistent (FDA-TRC-STUDYID), file naming lowercase (FDA-TRC-FILENAME)
  - All failures are severity ERROR (these cause FDA rejection)

Register FDA business rules in engine.register_defaults(). TRCPreCheck is called separately (submission-level, not per-domain).

**Tests**: Synthetic DM with bad ETHNIC/RACE values, Findings with mismatched TESTCD/TEST pairs, missing TS, missing DM. Verify each rule independently.
  </action>
  <verify>pytest tests/unit/validation/test_fda_rules.py -x -q</verify>
  <done>All 5 FDA Business Rules implemented; TRC pre-check catches missing DM/TS/define.xml and STUDYID inconsistency</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/validation/ -x -q` -- all tests pass
- `ruff check src/astraea/validation/`
- CrossDomainValidator catches USUBJID orphans across domains
- TRCPreCheck produces ERROR results for missing mandatory artifacts
</verification>

<success_criteria>
- VAL-03: Cross-domain USUBJID, STUDYID, RFSTDTC, --DY consistency validated
- FDA Business Rules FDAB057/055/039/009/030 implemented with correct severity
- FDA TRC pre-checks verify DM, TS, define.xml presence and STUDYID consistency
- 15+ unit tests covering all cross-domain and FDA rules
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-submission-readiness/07-03-SUMMARY.md`
</output>
