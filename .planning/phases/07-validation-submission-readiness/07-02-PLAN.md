---
phase: 07-validation-submission-readiness
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/astraea/validation/rules/terminology.py
  - src/astraea/validation/rules/presence.py
  - src/astraea/validation/rules/limits.py
  - src/astraea/validation/rules/format.py
  - tests/unit/validation/test_terminology_rules.py
  - tests/unit/validation/test_presence_rules.py
  - tests/unit/validation/test_limit_format_rules.py
autonomous: true

must_haves:
  truths:
    - "CT values in generated DataFrames are validated against correct codelists with extensible vs non-extensible distinction"
    - "Required SDTM-IG variables are verified present in generated datasets"
    - "Variable name/label lengths are checked against XPT v5 limits"
    - "Date variables are validated for ISO 8601 format compliance"
    - "File naming conventions (lowercase domain.xpt) are enforced"
  artifacts:
    - path: "src/astraea/validation/rules/terminology.py"
      provides: "CT validation rules (VAL-01)"
      contains: "class CTValueRule"
    - path: "src/astraea/validation/rules/presence.py"
      provides: "Required variable/record rules (VAL-02)"
      contains: "class RequiredVariableRule"
    - path: "src/astraea/validation/rules/limits.py"
      provides: "Variable length limit rules (VAL-04)"
      contains: "class VariableNameLengthRule"
    - path: "src/astraea/validation/rules/format.py"
      provides: "Date format and naming rules (VAL-05)"
      contains: "class DateFormatRule"
  key_links:
    - from: "src/astraea/validation/rules/terminology.py"
      to: "src/astraea/reference/controlled_terms.py"
      via: "CTReference.lookup_codelist()"
      pattern: "ct_ref\\.lookup_codelist"
    - from: "src/astraea/validation/rules/presence.py"
      to: "src/astraea/models/sdtm.py"
      via: "DomainSpec.variables with core==REQ"
      pattern: "CoreDesignation\\.REQ"
---

<objective>
Implement the four single-domain validation rule categories: Terminology (VAL-01), Presence (VAL-02), Limits (VAL-04), and Format (VAL-05). These wrap and extend existing validation logic from mapping/validation.py and xpt_writer.py into formal rule objects.

Purpose: Core validation capabilities that run per-domain on generated DataFrames.
Output: Four rule modules with concrete ValidationRule subclasses + unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-validation-submission-readiness/07-RESEARCH.md
@src/astraea/validation/rules/base.py
@src/astraea/validation/engine.py
@src/astraea/mapping/validation.py
@src/astraea/io/xpt_writer.py
@src/astraea/reference/controlled_terms.py
@src/astraea/reference/sdtm_ig.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Terminology and Presence rules (VAL-01, VAL-02)</name>
  <files>
    src/astraea/validation/rules/terminology.py
    src/astraea/validation/rules/presence.py
    tests/unit/validation/test_terminology_rules.py
    tests/unit/validation/test_presence_rules.py
  </files>
  <action>
**terminology.py** -- VAL-01 rules:
- `CTValueRule(ValidationRule)`: rule_id="ASTR-T001". For each VariableMapping with a codelist_code, look up the codelist via ct_ref.lookup_codelist(). Get all unique non-null values from df[variable]. Check each value against codelist terms. Severity: ERROR for non-extensible codelists, WARNING for extensible. Include fix_suggestion with up to 5 valid terms for non-extensible violations. Set p21_equivalent="SD0065" (CT validation).
- `DomainValueRule(ValidationRule)`: rule_id="ASTR-T002". Check that DOMAIN column value matches spec.domain. Severity: ERROR. This is a simple constant check.

**presence.py** -- VAL-02 rules:
- `RequiredVariableRule(ValidationRule)`: rule_id="ASTR-P001". Check that all Required (core==REQ) variables from the SDTM-IG domain spec exist as columns in df. Severity: ERROR for missing. p21_equivalent="SD0083".
- `ExpectedVariableRule(ValidationRule)`: rule_id="ASTR-P002". Check Expected (core==EXP) variables exist. Severity: WARNING (expected but not mandatory).
- `NoRecordsRule(ValidationRule)`: rule_id="ASTR-P003". Check that df has at least 1 row. Severity: WARNING (empty domain file is suspicious).
- `USUBJIDPresentRule(ValidationRule)`: rule_id="ASTR-P004". Check USUBJID column exists and has zero nulls. Severity: ERROR.

**Tests**: Create synthetic DataFrames with known CT violations and missing variables. Test each rule independently. Verify severity levels, affected_count, fix_suggestion content.
  </action>
  <verify>pytest tests/unit/validation/test_terminology_rules.py tests/unit/validation/test_presence_rules.py -x -q</verify>
  <done>CT value validation distinguishes extensible/non-extensible; required/expected variable checks work; all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Limit and Format rules (VAL-04, VAL-05)</name>
  <files>
    src/astraea/validation/rules/limits.py
    src/astraea/validation/rules/format.py
    tests/unit/validation/test_limit_format_rules.py
  </files>
  <action>
**limits.py** -- VAL-04 rules:
- `VariableNameLengthRule(ValidationRule)`: rule_id="ASTR-L001". Check all column names are <= 8 chars. Severity: ERROR. p21_equivalent="SD0006".
- `VariableLabelLengthRule(ValidationRule)`: rule_id="ASTR-L002". Check all variable labels from spec.variable_mappings are <= 40 chars. Severity: ERROR.
- `CharacterLengthRule(ValidationRule)`: rule_id="ASTR-L003". Check that character column max observed length <= 200 chars (XPT v5 limit). Severity: ERROR for >200.
- `DatasetSizeRule(ValidationRule)`: rule_id="ASTR-L004". Check that df byte size (estimated from dtypes and row count) is reasonable. Severity: NOTICE if >100MB (single domain), WARNING if >500MB. This helps catch the 5GB total limit.

**format.py** -- VAL-05 rules:
- `DateFormatRule(ValidationRule)`: rule_id="ASTR-F001". Check all --DTC columns match ISO 8601 pattern (YYYY, YYYY-MM, YYYY-MM-DD, YYYY-MM-DDTHH:MM:SS, or partial truncations). Use regex: `^\d{4}(-\d{2}(-\d{2}(T\d{2}(:\d{2}(:\d{2})?)?)?)?)?$`. Severity: ERROR for non-matching non-null values. p21_equivalent="SD0020".
- `ASCIIRule(ValidationRule)`: rule_id="ASTR-F002". Check all character columns for non-ASCII characters. Use existing ascii_validation.validate_ascii(). Severity: WARNING (fixable). fix_suggestion="Run fix_common_non_ascii() before XPT write".
- `FileNamingRule(ValidationRule)`: rule_id="ASTR-F003". A special rule that doesn't operate on df but checks that the domain name is valid for filename: lowercase alpha, 2-8 chars. Severity: ERROR. This validates the domain code itself, not a file on disk.

**Tests**: Test each rule with synthetic DataFrames: names too long, labels too long, char values >200, invalid dates, non-ASCII characters. Verify rule IDs, messages, severity levels.

**Wire into engine**: Update ValidationEngine.register_defaults() to import and register all rules from terminology, presence, limits, format modules. Each module should export a `get_rules() -> list[ValidationRule]` function that returns instantiated rule objects.
  </action>
  <verify>pytest tests/unit/validation/ -x -q</verify>
  <done>All four VAL categories have concrete rule implementations; engine auto-discovers and registers them; all tests pass</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/validation/ -x -q` -- all tests pass including plan 01 tests
- `ruff check src/astraea/validation/`
- Each rule category has at least 2 concrete rules
- Engine.register_defaults() loads all rules
</verification>

<success_criteria>
- VAL-01: CT values validated against codelists with extensible/non-extensible distinction
- VAL-02: Required and Expected variables checked in generated DataFrames
- VAL-04: Name/label/character length limits enforced per XPT v5 constraints
- VAL-05: ISO 8601 date format validated, ASCII validated, file naming checked
- All rules registered in ValidationEngine via register_defaults()
- 20+ unit tests across all rule categories
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-submission-readiness/07-02-SUMMARY.md`
</output>
