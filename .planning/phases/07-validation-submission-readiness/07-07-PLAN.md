---
phase: 07-validation-submission-readiness
plan: 07
type: execute
wave: 4
depends_on: ["07-02", "07-03", "07-04", "07-05", "07-06"]
files_modified:
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - tests/integration/validation/test_validation_integration.py
  - tests/integration/submission/test_define_xml_integration.py
autonomous: true

must_haves:
  truths:
    - "User can run validation on generated datasets via CLI command"
    - "User can generate define.xml via CLI command"
    - "User can generate cSDRG template via CLI command"
    - "Validation runs end-to-end on synthetic multi-domain data producing correct results"
    - "define.xml generated from real DomainMappingSpec objects is valid XML"
  artifacts:
    - path: "src/astraea/cli/app.py"
      provides: "CLI commands: validate, generate-define, generate-csdrg"
      contains: "def validate_cmd"
    - path: "tests/integration/validation/test_validation_integration.py"
      provides: "End-to-end validation integration test"
      contains: "def test_full_validation_pipeline"
    - path: "tests/integration/submission/test_define_xml_integration.py"
      provides: "define.xml generation integration test"
      contains: "def test_define_xml_generation"
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/validation/engine.py"
      via: "validate CLI command creates and runs ValidationEngine"
      pattern: "ValidationEngine"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/submission/define_xml.py"
      via: "generate-define CLI command calls generate_define_xml"
      pattern: "generate_define_xml"
---

<objective>
Wire validation, define.xml, and cSDRG into CLI commands and run end-to-end integration tests on synthetic multi-domain data to prove the entire Phase 7 pipeline works.

Purpose: Final integration -- make all Phase 7 capabilities accessible via CLI and verify they work together.
Output: 3 new CLI commands + integration tests proving end-to-end functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-validation-submission-readiness/07-RESEARCH.md
@src/astraea/cli/app.py
@src/astraea/cli/display.py
@src/astraea/validation/engine.py
@src/astraea/validation/report.py
@src/astraea/submission/define_xml.py
@src/astraea/submission/csdrg.py
@src/astraea/submission/package.py
@src/astraea/validation/rules/fda_trc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI commands for validation and submission artifacts</name>
  <files>
    src/astraea/cli/app.py
    src/astraea/cli/display.py
  </files>
  <action>
Read the existing cli/app.py and cli/display.py first. Then add three new commands following the existing patterns (lazy imports, typer.Argument/Option, Rich console output):

**Command 1: `astraea validate`**
```
astraea validate <output-dir> [--study-id TEXT] [--format table|json|markdown]
```
- Loads all .xpt files from output-dir using pyreadstat.read_xport()
- Loads mapping specs from output-dir (look for *_spec.json files, or accept --specs-dir option)
- Creates ValidationEngine with SDTMReference and CTReference
- Runs validate_all() for per-domain validation
- Runs TRCPreCheck for submission-level checks
- Runs check_submission_size() and validate_file_naming()
- Generates ValidationReport using from_results()
- Displays results using Rich: summary table, per-domain breakdown, top issues
- If --format=markdown: write report to output-dir/validation_report.md
- If --format=json: write report to output-dir/validation_report.json
- Exit code 0 if submission_ready, 1 if not

**Command 2: `astraea generate-define`**
```
astraea generate-define <output-dir> [--study-id TEXT] [--study-name TEXT]
```
- Loads mapping specs from output-dir
- Loads generated DataFrames from .xpt files (for ValueListDef)
- Calls generate_define_xml()
- Writes define.xml to output-dir/define.xml
- Displays Rich panel with file path, element counts

**Command 3: `astraea generate-csdrg`**
```
astraea generate-csdrg <output-dir> [--study-id TEXT]
```
- Loads mapping specs and validation report (if exists)
- Calls generate_csdrg()
- Writes csdrg.md to output-dir/csdrg.md
- Displays Rich panel with file path

**Display helpers** in display.py:
- `display_validation_summary(report: ValidationReport)`: Rich table with severity counts, submission readiness
- `display_validation_issues(results: list[RuleResult], *, limit: int = 20)`: Rich table of top issues sorted by severity

Use lazy imports for all validation/submission modules inside command functions.
  </action>
  <verify>python -c "from astraea.cli.app import app; print('CLI loads OK')"</verify>
  <done>Three new CLI commands added: validate, generate-define, generate-csdrg</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests</name>
  <files>
    tests/integration/validation/__init__.py
    tests/integration/validation/test_validation_integration.py
    tests/integration/submission/__init__.py
    tests/integration/submission/test_define_xml_integration.py
  </files>
  <action>
**test_validation_integration.py** -- End-to-end validation test using synthetic data:

Setup fixture: Create 3 synthetic DataFrames (DM, AE, LB) and corresponding DomainMappingSpec objects with realistic variable mappings. Include intentional issues:
- AE with a USUBJID not in DM (cross-domain fail)
- LB with an invalid CT value in non-extensible codelist
- AE with a missing Required variable
- DM with ETHNIC not matching C66790

Tests:
1. **test_full_validation_pipeline**: Create ValidationEngine, run validate_all() on all 3 domains. Verify: results contain expected rule_ids, correct severity levels, correct affected_counts.
2. **test_cross_domain_validation**: Run CrossDomainValidator on the 3 domains. Verify USUBJID orphan detected in AE.
3. **test_trc_precheck_pass**: Create tmp output dir with dm.xpt, ts.xpt, define.xml (empty files for presence check). Verify TRCPreCheck returns no errors.
4. **test_trc_precheck_fail**: Empty output dir. Verify TRCPreCheck returns errors for missing DM, TS, define.xml.
5. **test_validation_report_generation**: Run full pipeline, generate ValidationReport.from_results(). Verify error_count, submission_ready, summary_by_domain, summary_by_category.
6. **test_validation_report_markdown**: Generate report, call to_markdown(). Verify non-empty string with expected headers.

**test_define_xml_integration.py** -- define.xml generation with realistic specs:

Setup fixture: Create DomainMappingSpec objects for DM (simple, non-repeating) and LB (Findings, with transpose, value-level metadata). Use realistic variable mappings with codelist_codes, origins, computational_methods.

Tests:
1. **test_define_xml_multi_domain**: Generate define.xml with DM + LB specs. Parse back with lxml. Verify: 2 ItemGroupDefs, correct ItemDef count, CodeList elements for referenced codelists, MethodDef for derived vars.
2. **test_define_xml_namespaces**: Verify root element has correct nsmap, def: prefix elements resolve correctly.
3. **test_define_xml_findings_value_list**: For LB spec, verify ValueListDef element present with WhereClauseDef entries.
4. **test_define_xml_roundtrip**: Write define.xml, read back, verify all OID references are internally consistent (every ItemRef.ItemOID points to an existing ItemDef.OID).

Mark all integration tests with `@pytest.mark.integration`.
  </action>
  <verify>pytest tests/integration/validation/ tests/integration/submission/ -x -q</verify>
  <done>Integration tests prove validation pipeline catches known issues and define.xml generates valid XML</done>
</task>

</tasks>

<verification>
- `pytest tests/ -x -q --ignore=tests/integration/mapping --ignore=tests/integration/execution` -- all tests pass (skip LLM tests)
- `ruff check src/astraea/cli/ src/astraea/validation/ src/astraea/submission/`
- CLI loads without errors: `python -c "from astraea.cli.app import app"`
- Integration test creates ValidationReport with correct severity counts
</verification>

<success_criteria>
- `astraea validate` runs validation engine + TRC + package checks and displays results
- `astraea generate-define` produces define.xml from mapping specs
- `astraea generate-csdrg` produces cSDRG template from specs + validation results
- Integration test validates 3+ domains with intentional issues and catches all of them
- define.xml integration test verifies multi-domain generation with correct structure
- 10+ integration tests covering the full pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-submission-readiness/07-07-SUMMARY.md`
</output>
