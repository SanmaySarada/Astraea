---
phase: 07-validation-submission-readiness
plan: 06
type: execute
wave: 3
depends_on: ["07-03"]
files_modified:
  - src/astraea/submission/csdrg.py
  - src/astraea/submission/package.py
  - src/astraea/validation/report.py
  - tests/unit/submission/test_csdrg.py
  - tests/unit/submission/test_package.py
autonomous: true

must_haves:
  truths:
    - "System generates a cSDRG template document with domain mapping rationale and validation summary"
    - "System produces a validation report with severity categorization and submission readiness score"
    - "Dataset size validation checks total submission against 5GB FDA limit"
    - "File naming conventions enforced (lowercase domain codes, .xpt extension)"
  artifacts:
    - path: "src/astraea/submission/csdrg.py"
      provides: "cSDRG template generator using Jinja2"
      contains: "def generate_csdrg"
    - path: "src/astraea/submission/package.py"
      provides: "Submission package assembly and size check"
      contains: "def check_submission_size"
  key_links:
    - from: "src/astraea/submission/csdrg.py"
      to: "src/astraea/models/mapping.py"
      via: "reads DomainMappingSpec for domain sections"
      pattern: "DomainMappingSpec"
    - from: "src/astraea/submission/package.py"
      to: "src/astraea/validation/rules/fda_trc.py"
      via: "uses TRCPreCheck for submission validation"
      pattern: "TRCPreCheck"
---

<objective>
Build the cSDRG (Clinical Study Data Reviewer's Guide) template generator, submission package assembly with size validation, and enhance the ValidationReport for pre-submission reporting.

Purpose: Complete the submission artifact set (cSDRG + validation report + package checks) required for FDA submission readiness.
Output: submission/csdrg.py, submission/package.py, enhanced report.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-validation-submission-readiness/07-RESEARCH.md
@src/astraea/validation/rules/base.py
@src/astraea/validation/report.py
@src/astraea/validation/rules/fda_trc.py
@src/astraea/models/mapping.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: cSDRG template generator</name>
  <files>
    src/astraea/submission/csdrg.py
    tests/unit/submission/test_csdrg.py
  </files>
  <action>
First, add `jinja2` to pyproject.toml dependencies if not already present.

**csdrg.py** -- cSDRG Markdown document generator:

`generate_csdrg(specs: list[DomainMappingSpec], validation_report: ValidationReport, study_id: str, output_path: Path, *, sdtm_ig_version: str = "3.4", ct_version: str | None = None) -> Path`

Use Jinja2 to render a Markdown template inline (string template, not file-based). The template follows PHUSE cSDRG structure:

**Section 1 - Introduction**: Study ID, purpose of guide, generated timestamp.

**Section 2 - Study Description**: "[Placeholder: Add study description, trial design, objectives, endpoints]" -- user fills this in.

**Section 3 - Data Standards and Dictionary Inventory**: Table with SDTM-IG version, CT version (from params), MedDRA version (placeholder), data standard (SDTM).

**Section 4 - Dataset Overview**: Table listing all domains with: Domain code, Domain label, Domain class, Number of records (from spec.total_variables), Structure, Source datasets.

**Section 5 - Domain-Specific Information**: For each domain spec:
- Source data description (list source_datasets)
- Mapping approach summary (count of each mapping pattern used)
- Non-standard variables (any mappings where variable not in SDTM-IG)
- SUPPQUAL candidates (from spec.suppqual_candidates)
- Missing required variables (from spec.missing_required_variables)

**Section 6 - Data Issues and Handling**: Date imputation rules (partial dates -> ISO 8601 truncation, per SDTM-IG convention). Missing data conventions. Known data issues (placeholder for user).

**Section 7 - Validation Results Summary**: Error count, warning count, notice count from validation_report. Top 5 most common issues. Known false positive note (placeholder).

**Section 8 - Non-Standard Variables**: Table of all SUPPQUAL candidates across all domains with justification (from mapping notes).

Write rendered Markdown to output_path.

**Tests**:
1. Generate cSDRG with 2 synthetic specs + synthetic ValidationReport
2. Verify output file exists and is valid Markdown
3. Verify all 8 sections present (check for section headers)
4. Verify domain overview table has correct domain count
5. Verify validation summary includes error/warning counts
  </action>
  <verify>pytest tests/unit/submission/test_csdrg.py -x -q</verify>
  <done>cSDRG template generates 8-section Markdown document from specs and validation report</done>
</task>

<task type="auto">
  <name>Task 2: Submission package assembly and size check</name>
  <files>
    src/astraea/submission/package.py
    src/astraea/validation/report.py
    tests/unit/submission/test_package.py
  </files>
  <action>
**package.py** -- Submission package utilities:

`check_submission_size(output_dir: Path, *, limit_gb: float = 5.0) -> list[RuleResult]`:
- Walk output_dir, sum sizes of all .xpt files
- If total > limit_gb * 1024^3: return ERROR result with split recommendation
- If any single file > 1GB: return WARNING with recommendation to review
- Return NOTICE with total size regardless

`validate_file_naming(output_dir: Path, expected_domains: list[str]) -> list[RuleResult]`:
- For each expected domain: check {domain.lower()}.xpt exists
- Check no unexpected .xpt files (warning for extras)
- Check define.xml exists (error if missing)
- Severity: ERROR for missing expected files, WARNING for extra files

`assemble_package_manifest(output_dir: Path, specs: list[DomainMappingSpec]) -> dict`:
- Return dict with: file inventory (path, size, domain), total_size, domain_count, has_define_xml, has_csdrg
- This is informational metadata for the user

**Enhance report.py** -- Add to ValidationReport:
- `to_markdown(self) -> str` method: Renders the validation report as a Markdown document with:
  - Header with study_id and generated_at
  - Summary table: domains validated, total errors/warnings/notices, submission_ready flag
  - Per-domain breakdown table
  - Per-category breakdown table
  - Top 10 issues (sorted by severity then affected_count)
  - Submission readiness assessment (READY / NOT READY with blocking issues listed)

**Tests**:
1. check_submission_size with small dir (under limit) returns NOTICE
2. check_submission_size with mocked large files returns ERROR
3. validate_file_naming with correct files returns empty errors
4. validate_file_naming with missing file returns ERROR
5. assemble_package_manifest returns correct file inventory
6. ValidationReport.to_markdown() produces valid Markdown with all sections
  </action>
  <verify>pytest tests/unit/submission/test_package.py -x -q</verify>
  <done>Package size check, file naming validation, manifest assembly, and report Markdown export all work</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/submission/ tests/unit/validation/test_engine.py -x -q` -- all tests pass
- `ruff check src/astraea/submission/ src/astraea/validation/report.py`
- cSDRG generates 8-section document
- Package size check enforces 5GB limit
</verification>

<success_criteria>
- cSDRG template generates complete 8-section Markdown with domain details and validation summary
- Submission package size checked against 5GB FDA limit
- File naming conventions validated (lowercase domain.xpt)
- ValidationReport.to_markdown() produces readable pre-submission report
- 10+ unit tests covering cSDRG, package, and report
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-submission-readiness/07-06-SUMMARY.md`
</output>
