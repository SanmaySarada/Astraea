---
phase: 07-validation-submission-readiness
plan: 05
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - src/astraea/submission/__init__.py
  - src/astraea/submission/define_xml.py
  - tests/unit/submission/__init__.py
  - tests/unit/submission/test_define_xml.py
autonomous: true

must_haves:
  truths:
    - "System generates a valid define.xml 2.0 file from DomainMappingSpec objects"
    - "define.xml contains ItemGroupDef for each domain with repeating/structure/class"
    - "define.xml contains ItemDef for each variable with name/label/type/origin/CodeListRef"
    - "define.xml contains CodeList definitions matching bundled CT codelists"
    - "define.xml contains MethodDef for all derived variables with computational methods"
    - "define.xml contains ValueListDef for Findings domains with per-test metadata"
    - "define.xml contains CommentDef for non-standard variables and SUPPQUAL candidates"
  artifacts:
    - path: "src/astraea/submission/define_xml.py"
      provides: "define.xml 2.0 generator from DomainMappingSpec"
      contains: "def generate_define_xml"
  key_links:
    - from: "src/astraea/submission/define_xml.py"
      to: "src/astraea/models/mapping.py"
      via: "reads DomainMappingSpec and VariableMapping"
      pattern: "DomainMappingSpec"
    - from: "src/astraea/submission/define_xml.py"
      to: "src/astraea/reference/controlled_terms.py"
      via: "CTReference for CodeList elements"
      pattern: "ct_ref"
---

<objective>
Build the define.xml 2.0 generator that produces a complete define.xml file from the collection of DomainMappingSpec objects. Uses lxml for proper namespace handling. Includes CommentDef elements for non-standard variables and SUPPQUAL candidates.

Purpose: VAL-08 requirement -- define.xml is mandatory for FDA submission and is a TRC rejection criterion.
Output: submission/define_xml.py with generate_define_xml() function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-validation-submission-readiness/07-RESEARCH.md
@src/astraea/models/mapping.py
@src/astraea/models/sdtm.py
@src/astraea/reference/controlled_terms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: define.xml 2.0 generator</name>
  <files>
    src/astraea/submission/__init__.py
    src/astraea/submission/define_xml.py
  </files>
  <action>
First, add `lxml` to pyproject.toml dependencies if not already present.

**define_xml.py** -- define.xml 2.0 generation using lxml:

Constants:
```python
ODM_NS = "http://www.cdisc.org/ns/odm/v1.3"
DEFINE_NS = "http://www.cdisc.org/ns/def/v2.0"
XLINK_NS = "http://www.w3.org/1999/xlink"
XML_NS = "http://www.w3.org/XML/1998/namespace"
NSMAP = {None: ODM_NS, "def": DEFINE_NS, "xlink": XLINK_NS}
```

Main function:
```python
def generate_define_xml(
    specs: list[DomainMappingSpec],
    ct_ref: CTReference,
    study_id: str,
    study_name: str,
    output_path: Path,
    *,
    sdtm_ig_version: str = "3.4",
    generated_dfs: dict[str, pd.DataFrame] | None = None,
) -> Path:
```

Implementation:
1. Create ODM root element with FileType="Snapshot", FileOID, CreationDateTime, ODMVersion="1.3.2"
2. Add Study element with OID
3. Add GlobalVariables: StudyName, StudyDescription, ProtocolName
4. Add MetaDataVersion with OID, Name, def:DefineVersion="2.0.0", def:StandardName="CDISC SDTM", def:StandardVersion=sdtm_ig_version

5. **ItemGroupDef** per domain (helper: `_add_item_group(mdv, spec)`):
   - OID=f"IG.{spec.domain}", Name=spec.domain
   - Repeating="Yes"/"No" (No only for DM), IsReferenceData (Yes for Trial Design class)
   - SASDatasetName=spec.domain, Purpose="Tabulation"
   - def:Structure=spec.structure, def:Class=spec.domain_class
   - def:ArchiveLocationID=f"LF.{spec.domain}"
   - Description/TranslatedText = spec.domain_label
   - ItemRef for each variable mapping: ItemOID, OrderNumber, Mandatory (Yes if core==REQ)
   - If variable has computational_method: MethodOID reference
   - If variable has a CommentDef (non-standard or SUPPQUAL candidate): def:CommentOID reference

6. **ItemDef** per variable (helper: `_add_item_def(mdv, domain, mapping)`):
   - OID=f"IT.{domain}.{mapping.sdtm_variable}"
   - Name=mapping.sdtm_variable, SASFieldName=mapping.sdtm_variable
   - DataType="text" or "integer"/"float" based on sdtm_data_type (Char->text, Num->float)
   - Length (from mapping.length or 8 for Num)
   - Description/TranslatedText = mapping.sdtm_label
   - def:Origin Type=mapping.origin.value if set
   - CodeListRef OID=f"CL.{mapping.codelist_code}" if codelist_code set

7. **CodeList** for used codelists (helper: `_add_codelists(mdv, specs, ct_ref)`):
   - Collect all unique codelist_codes from all specs
   - For each, look up in ct_ref, create CodeList element
   - OID=f"CL.{code}", Name=codelist.name, DataType="text"
   - def:Extensible="Yes"/"No"
   - CodeListItem for each term: CodedValue, Decode/TranslatedText

8. **MethodDef** for derived variables (helper: `_add_methods(mdv, specs)`):
   - For each mapping with computational_method set
   - OID=f"MT.{domain}.{variable}", Name=description[:40], Type="Computation"
   - Description/TranslatedText = computational_method text
   - FormalExpression Context="Python" = computational_method

9. **CommentDef** for non-standard variables and SUPPQUAL candidates (helper: `_add_comments(mdv, specs)`):
   - For each spec, identify variables that are non-standard (not in SDTM-IG for this domain -- check by comparing sdtm_variable names against known domain variables from spec metadata or by checking if variable is in suppqual_candidates list).
   - Also generate CommentDef for each variable listed in spec.suppqual_candidates.
   - OID=f"COM.{domain}.{variable}", create Description/TranslatedText with explanation:
     - For non-standard variables: "Non-standard variable. {mapping.notes or mapping.sdtm_label}"
     - For SUPPQUAL candidates: "Candidate for SUPPQUAL domain. Source: {source_variable}. {mapping.notes or ''}"
   - Reference these CommentDefs from the corresponding ItemDef or ItemRef via def:CommentOID attribute.

10. **ValueListDef** for Findings domains (helper: `_add_value_lists(mdv, specs, generated_dfs)`):
    - For Findings class domains (LB, VS, EG, PE) with TRANSPOSE pattern
    - Create def:ValueListDef for each --TESTCD variable
    - If generated_dfs provided: get unique TESTCD values from actual data
    - Create ItemRef + WhereClauseDef for each test code value

11. **def:leaf** elements for dataset file locations:
    - For each domain: def:leaf with xlink:href=f"{domain.lower()}.xpt"

Write with: `etree.ElementTree(root).write(str(output_path), xml_declaration=True, encoding="UTF-8", pretty_print=True)`

**__init__.py**: Export generate_define_xml.
  </action>
  <verify>python -c "from astraea.submission.define_xml import generate_define_xml; print('OK')"</verify>
  <done>define.xml generator function exists and is importable, includes CommentDef generation</done>
</task>

<task type="auto">
  <name>Task 2: define.xml unit tests</name>
  <files>
    tests/unit/submission/__init__.py
    tests/unit/submission/test_define_xml.py
  </files>
  <action>
Test the define.xml generator with synthetic DomainMappingSpec objects:

1. **test_basic_structure**: Create 1 simple DomainMappingSpec (DM, 3 variables: STUDYID, DOMAIN, USUBJID). Generate define.xml to tmp_path. Parse back with lxml. Verify: ODM root element, Study element, MetaDataVersion, 1 ItemGroupDef, 3 ItemDefs.

2. **test_item_group_attributes**: Verify ItemGroupDef has correct OID, Name, Repeating, SASDatasetName, Purpose, def:Structure, def:Class, def:ArchiveLocationID.

3. **test_item_def_attributes**: Verify ItemDef has correct OID, Name, DataType, Description, def:Origin.

4. **test_codelist_generation**: Create spec with a variable that has codelist_code="C66731" (SEX). Mock ct_ref to return a codelist. Verify CodeList element with CodeListItems.

5. **test_method_def**: Create spec with a DERIVATION variable with computational_method. Verify MethodDef element present with Description and FormalExpression.

6. **test_comment_def_nonstandard**: Create spec with a variable NOT in standard SDTM-IG for the domain. Verify CommentDef element is generated with OID=f"COM.{domain}.{variable}" and Description containing "Non-standard variable". Verify the corresponding ItemDef or ItemRef references def:CommentOID.

7. **test_comment_def_suppqual**: Create spec with suppqual_candidates=["AESSION"]. Verify CommentDef generated for SUPPQUAL candidate with Description containing "Candidate for SUPPQUAL". Verify def:CommentOID reference.

8. **test_multiple_domains**: Create specs for DM + AE. Verify 2 ItemGroupDefs, correct ItemDef count, no duplicate OIDs.

9. **test_findings_value_list**: Create LB domain spec with TRANSPOSE mapping. Provide generated_dfs with LBTESTCD column having unique values. Verify ValueListDef element present.

10. **test_leaf_elements**: Verify def:leaf elements with correct xlink:href for each domain.

11. **test_output_file_written**: Verify file exists at output_path, starts with XML declaration, is valid XML.

Use `from lxml import etree` for parsing and validation. Use pytest tmp_path fixture for output.
  </action>
  <verify>pytest tests/unit/submission/test_define_xml.py -x -q</verify>
  <done>define.xml generator produces valid XML with all required elements including CommentDef; 11 tests pass</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/submission/ -x -q` -- all tests pass
- `ruff check src/astraea/submission/`
- Generated define.xml is valid XML with ODM root element and correct namespaces
- define.xml contains ItemGroupDef, ItemDef, CodeList, MethodDef, CommentDef elements
</verification>

<success_criteria>
- VAL-08: define.xml 2.0 generated from DomainMappingSpec with all required elements
- ItemGroupDef per domain with repeating/structure/class attributes
- ItemDef per variable with name/label/type/origin/CodeListRef
- CodeList definitions from CT reference with extensibility flag
- MethodDef for derived variables with computational methods
- CommentDef for non-standard variables and SUPPQUAL candidates with def:CommentOID references
- ValueListDef for Findings domains
- 11 unit tests covering all define.xml elements including CommentDef
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-submission-readiness/07-05-SUMMARY.md`
</output>
