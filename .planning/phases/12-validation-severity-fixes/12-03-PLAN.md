---
phase: 12-validation-severity-fixes
plan: 03
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - src/astraea/validation/engine.py
  - tests/unit/validation/test_engine.py
autonomous: true

must_haves:
  truths:
    - "validate_all() runs TRCPreCheck when output_dir and study_id are provided"
    - "validate_all() works without TRC params (backward compatible)"
    - "All 1660+ existing tests still pass"
  artifacts:
    - path: "src/astraea/validation/engine.py"
      provides: "validate_all() with optional output_dir and study_id params for TRC integration"
      contains: "TRCPreCheck"
  key_links:
    - from: "src/astraea/validation/engine.py"
      to: "src/astraea/validation/rules/fda_trc.py"
      via: "TRCPreCheck instantiation in validate_all()"
      pattern: "TRCPreCheck\\(\\)"
---

<objective>
Integrate TRCPreCheck into validate_all() so callers get TRC results alongside per-domain and cross-domain results in a single call, and verify the full test suite passes with all Phase 12 changes.

Purpose: Currently TRCPreCheck must be called separately from validate_all(), meaning callers can easily forget TRC checks. Integrating it into validate_all() with optional params (backward compatible) ensures TRC checks run automatically when output context is available.

Output: Updated validate_all() with TRC integration, full regression verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-validation-severity-fixes/12-RESEARCH.md

@src/astraea/validation/engine.py
@src/astraea/validation/rules/fda_trc.py
@tests/unit/validation/test_engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate TRCPreCheck into validate_all()</name>
  <files>
    src/astraea/validation/engine.py
    tests/unit/validation/test_engine.py
  </files>
  <action>
    1. In `src/astraea/validation/engine.py`:
       - Add `from pathlib import Path` to imports
       - Modify `validate_all()` signature to accept optional keyword-only params:
         ```python
         def validate_all(
             self,
             domains: dict[str, tuple[pd.DataFrame, DomainMappingSpec]],
             *,
             output_dir: Path | None = None,
             study_id: str | None = None,
         ) -> list[RuleResult]:
         ```
       - After the cross-domain results block, add TRC integration:
         ```python
         # Run TRC checks when output context is provided
         if output_dir is not None and study_id is not None:
             from astraea.validation.rules.fda_trc import TRCPreCheck
             trc = TRCPreCheck()
             domain_dfs = {code: df for code, (df, _spec) in domains.items()}
             trc_results = trc.check_all(domain_dfs, output_dir, study_id)
             all_results.extend(trc_results)
         ```
       - Update the docstring to document the new optional params and TRC behavior
       - IMPORTANT: The import of TRCPreCheck is lazy (inside the if block) to match the engine's existing lazy import pattern

    2. In `tests/unit/validation/test_engine.py`:
       - Add test_validate_all_without_trc_params: call validate_all(domains) without output_dir/study_id -> works as before, no TRC results included
       - Add test_validate_all_with_trc_params: create a tmp_path output_dir, call validate_all(domains, output_dir=tmp_path, study_id="STUDY01") -> TRC results are included in output (e.g., FDA-TRC-1735 for missing define.xml)
       - Add test_validate_all_trc_backward_compatible: existing tests that call validate_all(domains) must not break (no required new params)
       - Use minimal mock domains (DM with a simple DataFrame + DomainMappingSpec) to keep test focused on engine behavior, not rule correctness
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/test_engine.py -x -q
  </verify>
  <done>
    validate_all() runs TRCPreCheck when output_dir and study_id provided. Backward compatible without those params. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full regression test suite verification</name>
  <files></files>
  <action>
    Run the complete test suite to verify all Phase 12 changes work together without regressions:

    1. Run `python -m pytest tests/ -x -q --tb=short` to confirm all 1660+ tests pass
    2. Run `ruff check src/astraea/validation/ src/astraea/execution/trial_summary.py` to confirm no lint issues
    3. If any tests fail, diagnose and fix the root cause (likely test assertions that reference old severity values or old param counts)

    This is a verification-only task. No new code should be written unless a regression is found.
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/ -x -q --tb=short 2>&1 | tail -5
  </verify>
  <done>
    All 1660+ tests pass. Zero ruff violations on modified files. Phase 12 is complete.
  </done>
</task>

</tasks>

<verification>
Full test suite:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/ -x -q --tb=short
```

Lint on all modified files:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && ruff check src/astraea/validation/ src/astraea/execution/trial_summary.py
```
</verification>

<success_criteria>
- validate_all() accepts optional output_dir and study_id keyword params
- When both params provided, TRCPreCheck.check_all() runs and results are appended
- When params omitted, behavior is identical to before (backward compatible)
- All 1660+ existing tests pass
- Zero ruff violations on all modified files
- Phase 12 success criteria fully met: HIGH-06, HIGH-07, HIGH-08, HIGH-09, HIGH-16, MED-01, MED-04, MED-05
</success_criteria>

<output>
After completion, create `.planning/phases/12-validation-severity-fixes/12-03-SUMMARY.md`
</output>
