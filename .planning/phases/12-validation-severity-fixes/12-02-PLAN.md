---
phase: 12-validation-severity-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/execution/trial_summary.py
  - src/astraea/validation/rules/fda_trc.py
  - tests/unit/execution/test_trial_summary.py
  - tests/unit/validation/test_fda_trc.py
autonomous: true

must_haves:
  truths:
    - "FDA_REQUIRED_PARAMS contains 26+ mandatory TS parameter codes"
    - "validate_ts_completeness() warns on all 26+ missing params"
    - "TRC checks verify SDTMVER, STYPE, and TITLE in addition to SSTDTC"
  artifacts:
    - path: "src/astraea/execution/trial_summary.py"
      provides: "Expanded FDA_REQUIRED_PARAMS frozenset with 26+ entries"
      contains: "PLANSUB"
    - path: "src/astraea/validation/rules/fda_trc.py"
      provides: "TRC checks for SDTMVER, STYPE, TITLE"
      contains: "SDTMVER"
  key_links:
    - from: "src/astraea/execution/trial_summary.py"
      to: "validate_ts_completeness()"
      via: "FDA_REQUIRED_PARAMS frozenset expansion"
      pattern: "FDA_REQUIRED_PARAMS"
    - from: "src/astraea/validation/rules/fda_trc.py"
      to: "_check_ts_present()"
      via: "Loop over required TRC params set"
      pattern: "_TRC_REQUIRED_TS_PARAMS"
---

<objective>
Expand FDA-mandatory TS parameters from 7 to 26+ and extend TRC pre-checks to verify SDTMVER, STYPE, and TITLE beyond just SSTDTC.

Purpose: The current TS parameter list only has 7 entries, missing 19+ FDA-required parameters. TRC checks only verify SSTDTC, but SDTMVER, STYPE, and TITLE are also Technical Rejection Criteria -- missing any causes immediate FDA rejection.

Output: Expanded FDA_REQUIRED_PARAMS, extended TRC checks, with full test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-validation-severity-fixes/12-RESEARCH.md

@src/astraea/execution/trial_summary.py
@src/astraea/models/trial_design.py
@src/astraea/validation/rules/fda_trc.py
@tests/unit/execution/test_trial_summary.py
@tests/unit/validation/test_fda_trc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand FDA_REQUIRED_PARAMS to 26+ entries</name>
  <files>
    src/astraea/execution/trial_summary.py
    tests/unit/execution/test_trial_summary.py
  </files>
  <action>
    1. In `src/astraea/execution/trial_summary.py`:
       - Expand `FDA_REQUIRED_PARAMS` frozenset from the current 7 entries to include all FDA CDER-mandated TS parameters. The full list (per FDA guidance and SDTM-IG v3.4):
         ```
         Current 7: SSTDTC, SPONSOR, INDIC, TRT, STYPE, SDTMVER, TPHASE
         Add these 19+:
         TITLE, PLANSUB, RANDOM, SEXPOP, TBLIND, TCNTRL, OBJPRIM, REGID,
         OUTMSPRI, FCNTRY, AGEMIN, AGEMAX, LENGTH, STOPRULE, ADAPT, ACTSUB,
         NARMS, HLTSUBJI, SENDTC
         ```
         Total: 26 entries minimum
       - Add a comment block above the frozenset documenting the source: "Per FDA CDER guidance for NDA/BLA submissions. Missing any of these triggers a validation warning."
       - Do NOT change the build_ts_domain() function or TSConfig model -- those are for generation. The frozenset is for validation only (validate_ts_completeness uses it).

    2. In `tests/unit/execution/test_trial_summary.py`:
       - Update any existing test that asserts len(FDA_REQUIRED_PARAMS) == 7 to assert >= 26
       - Add test_fda_required_params_complete: verify that TITLE, PLANSUB, RANDOM, SEXPOP, FCNTRY, AGEMIN, AGEMAX are all in FDA_REQUIRED_PARAMS
       - Add test_validate_ts_completeness_warns_on_new_params: create a TS DataFrame with only SSTDTC and SDTMVER, verify validate_ts_completeness returns warnings for TITLE, PLANSUB, etc.
       - Keep existing test_validate_ts_completeness tests working (they should still pass since we're adding params, not removing)
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/execution/test_trial_summary.py -x -q
  </verify>
  <done>
    FDA_REQUIRED_PARAMS has 26+ entries. validate_ts_completeness warns on missing new params. All existing TS tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand TRC checks to verify SDTMVER, STYPE, TITLE</name>
  <files>
    src/astraea/validation/rules/fda_trc.py
    tests/unit/validation/test_fda_trc.py
  </files>
  <action>
    1. In `src/astraea/validation/rules/fda_trc.py`:
       - Add a module-level constant:
         ```python
         _TRC_REQUIRED_TS_PARAMS: frozenset[str] = frozenset({"SSTDTC", "SDTMVER", "STYPE", "TITLE"})
         ```
         These 4 are the Technical Rejection Criteria params -- missing any causes immediate FDA rejection (stricter than the full 26+ list which are warnings).
       - Modify `_check_ts_present()` to check all 4 params instead of just SSTDTC:
         - After confirming TS exists and has TSPARMCD column, get the set of tsparmcds
         - For each param in _TRC_REQUIRED_TS_PARAMS, if not in tsparmcds, emit an ERROR result
         - Use rule_id format "FDA-TRC-1734" for SSTDTC (existing), and new rule_ids for the others: "FDA-TRC-SDTMVER", "FDA-TRC-STYPE", "FDA-TRC-TITLE"
         - Each result should have a descriptive message explaining which param is missing and why it causes rejection
       - Update the method docstring to reflect it checks 4 params, not just SSTDTC

    2. In `tests/unit/validation/test_fda_trc.py`:
       - Add test_ts_missing_sdtmver: TS exists with SSTDTC but no SDTMVER -> result with "FDA-TRC-SDTMVER"
       - Add test_ts_missing_stype: TS exists with SSTDTC but no STYPE -> result with "FDA-TRC-STYPE"
       - Add test_ts_missing_title: TS exists with SSTDTC but no TITLE -> result with "FDA-TRC-TITLE"
       - Add test_ts_all_trc_params_present: TS with SSTDTC, SDTMVER, STYPE, TITLE -> 0 results from _check_ts_present
       - Add test_ts_missing_multiple_trc_params: TS missing SDTMVER and TITLE -> 2 results
       - Ensure existing SSTDTC-missing test still passes
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/test_fda_trc.py -x -q
  </verify>
  <done>
    TRC checks verify SSTDTC, SDTMVER, STYPE, and TITLE. Missing any emits ERROR-severity result. All existing + new tests pass.
  </done>
</task>

</tasks>

<verification>
Run full validation and execution test suites:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/test_fda_trc.py tests/unit/execution/test_trial_summary.py -x -q
```

Lint check:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && ruff check src/astraea/execution/trial_summary.py src/astraea/validation/rules/fda_trc.py
```
</verification>

<success_criteria>
- FDA_REQUIRED_PARAMS contains 26+ entries (was 7)
- validate_ts_completeness() warns on all missing params from the expanded list
- TRC checks verify 4 critical params: SSTDTC, SDTMVER, STYPE, TITLE
- Missing any TRC param emits ERROR severity
- All existing tests pass unchanged or with updated assertions
- New tests cover each expanded param check
</success_criteria>

<output>
After completion, create `.planning/phases/12-validation-severity-fixes/12-02-SUMMARY.md`
</output>
