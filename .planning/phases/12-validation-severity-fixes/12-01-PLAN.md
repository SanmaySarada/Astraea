---
phase: 12-validation-severity-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/validation/rules/fda_business.py
  - src/astraea/validation/rules/format.py
  - src/astraea/validation/rules/presence.py
  - tests/unit/validation/test_fda_rules.py
  - tests/unit/validation/test_limit_format_rules.py
  - tests/unit/validation/test_presence_rules.py
autonomous: true

must_haves:
  truths:
    - "FDAB057 (ETHNIC) validation fires as ERROR, not WARNING"
    - "ASTR-F002 (ASCII) validation fires as ERROR, not WARNING"
    - "DM.SEX values are validated against C66731 non-extensible codelist"
    - "--SEQ uniqueness is enforced per USUBJID within each domain"
    - "DM is validated to have exactly one record per USUBJID"
  artifacts:
    - path: "src/astraea/validation/rules/fda_business.py"
      provides: "FDAB057 severity=ERROR, new FDAB015Rule for DM.SEX"
      contains: "FDAB015Rule"
    - path: "src/astraea/validation/rules/format.py"
      provides: "ASTR-F002 severity=ERROR"
      contains: "RuleSeverity.ERROR"
    - path: "src/astraea/validation/rules/presence.py"
      provides: "SeqUniquenessRule (ASTR-P005), DMOneRecordPerSubjectRule (ASTR-P006)"
      contains: "SeqUniquenessRule"
  key_links:
    - from: "src/astraea/validation/rules/fda_business.py"
      to: "get_fda_business_rules()"
      via: "FDAB015Rule registered in factory function"
      pattern: "FDAB015Rule\\(\\)"
    - from: "src/astraea/validation/rules/presence.py"
      to: "get_presence_rules()"
      via: "SeqUniquenessRule and DMOneRecordPerSubjectRule registered"
      pattern: "SeqUniquenessRule\\(\\)"
---

<objective>
Fix 2 severity misclassifications (FDAB057 WARNING->ERROR, ASTR-F002 WARNING->ERROR) and add 3 new validation rules (DM.SEX codelist C66731, --SEQ uniqueness per USUBJID, DM one-record-per-subject).

Purpose: The validation engine currently misses real FDA submission issues (SEX values, duplicate sequences, duplicate DM records) and incorrectly classifies 2 rules as WARNING that should be ERROR (non-extensible CT violations and non-ASCII data both cause FDA findings/data corruption).

Output: 5 validation improvements with full test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-validation-severity-fixes/12-RESEARCH.md

@src/astraea/validation/rules/base.py
@src/astraea/validation/rules/fda_business.py
@src/astraea/validation/rules/format.py
@src/astraea/validation/rules/presence.py
@tests/unit/validation/test_fda_rules.py
@tests/unit/validation/test_limit_format_rules.py
@tests/unit/validation/test_presence_rules.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Severity fixes (FDAB057 and ASTR-F002) + DM.SEX rule</name>
  <files>
    src/astraea/validation/rules/fda_business.py
    src/astraea/validation/rules/format.py
    tests/unit/validation/test_fda_rules.py
    tests/unit/validation/test_limit_format_rules.py
  </files>
  <action>
    1. In `src/astraea/validation/rules/fda_business.py`:
       - Change FDAB057Rule severity from `RuleSeverity.WARNING` to `RuleSeverity.ERROR` (C66790 ETHNIC is non-extensible -- invalid values are errors, not warnings)
       - Add new `FDAB015Rule` class for DM.SEX validation against C66731:
         - rule_id="FDAB015", category=FDA_BUSINESS, severity=ERROR
         - Only fires on domain=="DM"
         - If SEX column missing, return error result
         - Look up C66731 via ct_ref.lookup_codelist("C66731"), get valid terms from codelist.terms.keys()
         - Check df["SEX"].dropna().unique() against valid terms set
         - Report invalid values with affected_count and fix_suggestion listing valid terms
       - Register FDAB015Rule() in get_fda_business_rules() return list

    2. In `src/astraea/validation/rules/format.py`:
       - Change ASCIIRule severity from `RuleSeverity.WARNING` to `RuleSeverity.ERROR` (non-ASCII in XPT causes data corruption)

    3. In `tests/unit/validation/test_fda_rules.py`:
       - Update `test_invalid_ethnic_detected` assertion from `RuleSeverity.WARNING` to `RuleSeverity.ERROR` (line ~138)
       - Add new TestFDAB015Rule class with tests:
         - test_rule_metadata: rule_id=="FDAB015", severity==ERROR
         - test_valid_sex_no_findings: SEX column with "M", "F" -> 0 results
         - test_invalid_sex_detected: SEX with "Male", "Female" -> 1 result with ERROR severity
         - test_missing_sex_column: DataFrame without SEX -> 1 result
         - test_skips_non_dm: domain="AE" -> 0 results
         - Use same fixture pattern as existing FDAB057 tests (dm_spec, mock_sdtm_ref, mock_ct_ref)
         - Mock ct_ref.lookup_codelist("C66731") to return a Codelist with terms={"M": ..., "F": ..., "U": ..., "UNDIFFERENTIATED": ...}

    4. In `tests/unit/validation/test_limit_format_rules.py`:
       - Update `test_rule_metadata` in TestASCIIRule from `RuleSeverity.WARNING` to `RuleSeverity.ERROR` (line ~294)
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/test_fda_rules.py tests/unit/validation/test_limit_format_rules.py -x -q
  </verify>
  <done>
    FDAB057 severity is ERROR. ASTR-F002 severity is ERROR. FDAB015Rule validates DM.SEX against C66731. All existing + new tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: SEQ uniqueness and DM one-record-per-subject rules</name>
  <files>
    src/astraea/validation/rules/presence.py
    tests/unit/validation/test_presence_rules.py
  </files>
  <action>
    1. In `src/astraea/validation/rules/presence.py`:
       - Add `SeqUniquenessRule` class (rule_id="ASTR-P005"):
         - description="--SEQ must be unique per USUBJID within a domain"
         - category=PRESENCE, severity=ERROR
         - evaluate(): construct seq_col as f"{domain[:2]}SEQ" (domain-prefixed). If seq_col or USUBJID not in columns, return []. Group by USUBJID, check seq_series.dropna().duplicated().any() per group. Collect dup_subjects list. If any, return 1 RuleResult with affected_count=len(dup_subjects), p21_equivalent="SD0007"
         - IMPORTANT: Use domain[:2] for the prefix (AE->AE, LB->LB, DM->DM). This matches the existing pattern in FDAB039Rule.

       - Add `DMOneRecordPerSubjectRule` class (rule_id="ASTR-P006"):
         - description="DM must have exactly one record per subject"
         - category=PRESENCE, severity=ERROR
         - evaluate(): Only fire for domain=="DM". If USUBJID not in columns, return []. Check df["USUBJID"].duplicated(keep=False). If any duplicates, count unique duplicated subjects, return 1 RuleResult with affected_count.

       - Register both in get_presence_rules() return list

    2. In `tests/unit/validation/test_presence_rules.py`:
       - Add TestSeqUniquenessRule class:
         - test_rule_metadata: rule_id=="ASTR-P005", severity==ERROR
         - test_unique_seq_no_findings: AESEQ=[1,2,3] per USUBJID -> 0 results
         - test_duplicate_seq_detected: AESEQ=[1,1,2] for one USUBJID -> 1 result with "AESEQ" in message
         - test_handles_missing_seq_col: no AESEQ column -> 0 results (skip gracefully)
         - test_different_domain_prefix: domain="LB", check for "LBSEQ" column

       - Add TestDMOneRecordPerSubjectRule class:
         - test_rule_metadata: rule_id=="ASTR-P006", severity==ERROR
         - test_unique_subjects_no_findings: 3 distinct USUBJIDs -> 0 results
         - test_duplicate_subjects_detected: 2 rows with same USUBJID -> 1 result
         - test_skips_non_dm: domain="AE" -> 0 results
         - test_missing_usubjid_col: no USUBJID column -> 0 results
  </action>
  <verify>
    cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/test_presence_rules.py -x -q
  </verify>
  <done>
    SeqUniquenessRule (ASTR-P005) detects duplicate --SEQ within USUBJID. DMOneRecordPerSubjectRule (ASTR-P006) detects duplicate DM records. Both registered in get_presence_rules(). All tests pass.
  </done>
</task>

</tasks>

<verification>
Run the full validation test suite to confirm no regressions:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && python -m pytest tests/unit/validation/ -x -q
```

Then run ruff to check for lint issues:

```bash
cd /Users/sanmaysarada/Astraea-SDTM && ruff check src/astraea/validation/rules/fda_business.py src/astraea/validation/rules/format.py src/astraea/validation/rules/presence.py
```
</verification>

<success_criteria>
- FDAB057 severity is ERROR (was WARNING)
- ASTR-F002 severity is ERROR (was WARNING)
- FDAB015Rule validates DM.SEX against C66731 non-extensible codelist
- ASTR-P005 (SeqUniquenessRule) checks --SEQ uniqueness per USUBJID with domain-prefixed column name
- ASTR-P006 (DMOneRecordPerSubjectRule) enforces one record per subject in DM
- All 3 new rules registered in their respective get_*_rules() functions
- All existing tests updated and passing
- New tests cover positive, negative, skip, and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/12-validation-severity-fixes/12-01-SUMMARY.md`
</output>
