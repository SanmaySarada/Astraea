---
phase: 09-cli-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/cli/app.py
  - tests/unit/cli/test_trial_design_cli.py
autonomous: true

must_haves:
  truths:
    - "User can run `astraea generate-trial-design` with a JSON config and get TS, TA, TE, TV, TI, SV datasets as XPT files"
    - "TS domain includes all FDA-mandatory parameters (SSTDTC, SPONSOR, INDIC, TRT, STYPE, SDTMVER, TPHASE)"
    - "SV domain is built from raw data visit metadata when --data-dir is provided"
  artifacts:
    - path: "src/astraea/cli/app.py"
      provides: "generate-trial-design CLI command"
      contains: "generate_trial_design"
    - path: "tests/unit/cli/test_trial_design_cli.py"
      provides: "CLI wiring tests for trial design command"
      min_lines: 50
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/execution/trial_summary.py"
      via: "lazy import + build_ts_domain call"
      pattern: "build_ts_domain"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/execution/trial_design.py"
      via: "lazy import + build_ta/te/tv/ti_domain calls"
      pattern: "build_ta_domain|build_te_domain|build_tv_domain|build_ti_domain"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/execution/subject_visits.py"
      via: "lazy import + extract_visit_dates + build_sv_domain calls"
      pattern: "build_sv_domain"
---

<objective>
Wire trial design domain builders (TS, TA, TE, TV, TI, SV) into the CLI as a new `generate-trial-design` command, closing GAP-1 from the v1 milestone audit.

Purpose: TS is mandatory for FDA submission -- missing TS = automatic technical rejection. All 6 builders exist with unit tests but have no CLI entry point, making them unreachable by users.

Output: New CLI command `astraea generate-trial-design` that reads a JSON config file, builds all trial design domains, and writes them as XPT files. Plus unit tests for the CLI wiring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/astraea/cli/app.py
@src/astraea/execution/trial_summary.py
@src/astraea/execution/trial_design.py
@src/astraea/execution/subject_visits.py
@src/astraea/models/trial_design.py
@src/astraea/io/xpt_writer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generate-trial-design CLI command</name>
  <files>src/astraea/cli/app.py</files>
  <action>
Add a new `@app.command(name="generate-trial-design")` function to app.py.

Command signature:
```python
def generate_trial_design(
    config_path: Annotated[Path, typer.Argument(help="Path to trial design JSON config")],
    output_dir: Annotated[Path, typer.Option("--output-dir", help="Output directory for XPT files")] = Path("output"),
    data_dir: Annotated[Path | None, typer.Option("--data-dir", help="Raw data directory for SV domain visit extraction")] = None,
    dm_path: Annotated[Path | None, typer.Option("--dm-path", help="Path to DM XPT for TS date derivation")] = None,
) -> None:
```

Implementation steps (all imports lazy inside the function body, consistent with existing commands):

1. Validate config_path exists, read JSON, parse into two models:
   - `TSConfig.model_validate_json(...)` for the `ts_config` key
   - `TrialDesignConfig.model_validate(...)` for the `trial_design` key
   The JSON structure should be: `{"ts_config": {...}, "trial_design": {...}}`

2. Load DM DataFrame if --dm-path provided (using `read_sas_with_metadata` or `pyreadstat.read_xport` depending on extension).

3. Build TS domain: call `build_ts_domain(ts_config, dm_df=dm_df)`, then `validate_ts_completeness(ts_df)` and print any warnings.

4. Build TA, TE, TV, TI domains: call `build_ta_domain(trial_design_config, study_id)`, etc. Use `ts_config.study_id` as the study_id.

5. Optionally build SV domain if --data-dir provided:
   - Read all .sas7bdat files from data_dir using `read_sas_with_metadata`
   - Call `extract_visit_dates(raw_dfs)` then `build_sv_domain(visit_data, study_id)`

6. Write all generated DataFrames as XPT files to output_dir using `write_xpt` from `astraea.io.xpt_writer`. File names: `ts.xpt`, `ta.xpt`, `te.xpt`, `tv.xpt`, `ti.xpt`, `sv.xpt`.

7. Print Rich summary table showing each domain, row count, and output path.

Use lazy imports for: `build_ts_domain`, `validate_ts_completeness`, `build_ta_domain`, `build_te_domain`, `build_tv_domain`, `build_ti_domain`, `extract_visit_dates`, `build_sv_domain`, `TSConfig`, `TrialDesignConfig`, `read_sas_with_metadata`, `write_xpt`.

Also update the module docstring at the top of app.py to include `astraea generate-trial-design` in the usage list.

Place this command after the existing `learn-optimize` command (near end of file) to maintain logical grouping.
  </action>
  <verify>
Run `python -c "from astraea.cli.app import app; print([c.name for c in app.registered_commands])"` and confirm `generate-trial-design` appears in the list.
Run `ruff check src/astraea/cli/app.py` -- zero errors.
  </verify>
  <done>
`generate-trial-design` command is registered in the typer app with correct argument/option types. All imports are lazy. Module docstring updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI wiring tests for generate-trial-design</name>
  <files>tests/unit/cli/test_trial_design_cli.py</files>
  <action>
Create test file with unit tests that verify the CLI command is properly wired to the builders. Use `typer.testing.CliRunner` (same pattern as `test_autofix_cli.py` and `test_learn_commands.py`).

Tests to write:

1. `test_generate_trial_design_basic` -- Create a minimal valid JSON config (inline as tmp_path fixture), invoke `generate-trial-design`, verify exit code 0, verify ts.xpt/ta.xpt/te.xpt/tv.xpt exist in output dir. Mock `write_xpt` to avoid actual XPT I/O (or use the real writer -- both are fine since it is fast).

2. `test_generate_trial_design_missing_config` -- Invoke with nonexistent config path, verify exit code 1 and error message.

3. `test_generate_trial_design_ts_validation_warnings` -- Create a config missing SPONSOR (make it empty string to trigger TSConfig validation or use additional_params only), verify the command still succeeds but prints a warning about missing FDA-mandatory parameters.

4. `test_generate_trial_design_with_dm_path` -- Create config + a minimal DM DataFrame with RFSTDTC column (write as XPT via pyreadstat), invoke with --dm-path, verify SSTDTC is derived in TS output.

5. `test_generate_trial_design_sv_from_data_dir` -- Create synthetic .sas7bdat files with InstanceName/FolderName columns in tmp_path, invoke with --data-dir, verify sv.xpt is created.

Use a helper function to create a minimal valid JSON config dict:
```python
def _make_config() -> dict:
    return {
        "ts_config": {
            "study_id": "TEST001",
            "study_title": "Test Study",
            "sponsor": "TestCorp",
            "indication": "Test Indication",
            "treatment": "Test Drug",
            "pharmacological_class": "Test Class",
        },
        "trial_design": {
            "arms": [{"armcd": "DRUG", "arm": "Drug Arm", "taetord": 1, "etcd": "SCRN"}],
            "elements": [{"etcd": "SCRN", "element": "Screening"}],
            "visits": [{"visitnum": 1.0, "visit": "Screening", "armcd": "DRUG"}],
        },
    }
```
  </action>
  <verify>
Run `pytest tests/unit/cli/test_trial_design_cli.py -x -q` -- all tests pass.
Run `ruff check tests/unit/cli/test_trial_design_cli.py` -- zero errors.
  </verify>
  <done>
5 tests verify the generate-trial-design CLI command wiring: basic success, missing config error, TS validation warnings, DM date derivation, and SV from data directory.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/cli/test_trial_design_cli.py -x -q` -- all 5 tests pass
2. `ruff check src/astraea/cli/app.py tests/unit/cli/test_trial_design_cli.py` -- zero violations
3. `pytest tests/ -x -q --timeout=120` -- all ~1652 existing tests still pass (no regressions)
</verification>

<success_criteria>
- `astraea generate-trial-design` command exists and is callable
- Command reads JSON config and produces TS, TA, TE, TV, TI XPT files
- Command optionally reads --data-dir for SV domain generation
- Command optionally reads --dm-path for TS date derivation (SSTDTC/SENDTC)
- TS validation warnings are printed when FDA-mandatory params are missing
- GAP-1 from v1-MILESTONE-AUDIT.md is closed
</success_criteria>

<output>
After completion, create `.planning/phases/09-cli-wiring/09-01-SUMMARY.md`
</output>
