---
phase: 02-source-parsing
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/parsing/ecrf_parser.py
  - src/astraea/cli/app.py
  - tests/test_parsing/test_ecrf_parser.py
  - tests/test_cli/test_parse_ecrf.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "A single form extraction failure does not crash the entire eCRF parsing pipeline"
    - "Failed forms are logged as warnings and skipped; remaining forms still parse"
    - "CLI parse-ecrf command extracts PDF pages only once (no double extraction)"
  artifacts:
    - path: "src/astraea/parsing/ecrf_parser.py"
      provides: "try/except around extract_form_fields in parse_ecrf loop"
      contains: "except Exception"
    - path: "src/astraea/cli/app.py"
      provides: "Single-pass PDF extraction for parse-ecrf command"
    - path: "tests/test_parsing/test_ecrf_parser.py"
      provides: "Test proving single form failure doesn't crash pipeline"
  key_links:
    - from: "src/astraea/parsing/ecrf_parser.py"
      to: "extract_form_fields"
      via: "try/except wrapper in parse_ecrf loop"
      pattern: "except.*Exception"
---

<objective>
Add error handling to eCRF parse loop (Gap 3) and eliminate double PDF extraction in CLI (Gap 6).

Purpose: A single form extraction failure crashes the entire eCRF pipeline, which is unacceptable for a 189-page PDF with ~50 forms. The CLI also extracts the PDF twice (once for progress counting, once in parse_ecrf()), wasting time and API calls.

Output: Resilient eCRF parser that continues on per-form failures, and a CLI that extracts once.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/astraea/parsing/ecrf_parser.py
@src/astraea/parsing/pdf_extractor.py
@src/astraea/cli/app.py
@tests/test_parsing/test_ecrf_parser.py
@tests/test_cli/test_parse_ecrf.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add try/except in parse_ecrf loop and refactor for pre-extracted pages</name>
  <files>src/astraea/parsing/ecrf_parser.py, tests/test_parsing/test_ecrf_parser.py</files>
  <action>
  1. In `parse_ecrf()`, wrap the `extract_form_fields()` call (lines 169-175) in a try/except block:

  ```python
  for idx, (form_name, page_list) in enumerate(processable.items(), start=1):
      logger.info(...)

      page_numbers = [pn for pn, _ in page_list]
      combined_text = "\n\n---\n\n".join(text for _, text in page_list)

      try:
          form = extract_form_fields(
              client=client,
              form_name=form_name,
              form_text=combined_text,
              page_numbers=page_numbers,
          )
          forms.append(form)
      except Exception as e:
          logger.warning(
              "Failed to extract form '{name}' (pages {pages}): {error}. Skipping.",
              name=form_name,
              pages=page_numbers,
              error=str(e),
          )
          # Create empty form placeholder so we know it was attempted
          forms.append(ECRFForm(
              form_name=form_name,
              fields=[],
              page_numbers=page_numbers,
          ))
  ```

  2. Add an optional `pre_extracted_pages` parameter to `parse_ecrf()` to support pre-extracted pages (needed for Gap 6 CLI fix):

  ```python
  def parse_ecrf(
      pdf_path: str | Path,
      client: AstraeaLLMClient | None = None,
      pre_extracted_pages: list[tuple[int, str]] | None = None,
  ) -> ECRFExtractionResult:
  ```

  If `pre_extracted_pages` is provided, skip the `extract_ecrf_pages(path)` call and use those pages directly. Otherwise, extract as before.

  3. Add tests:
     - Test that when `extract_form_fields` raises an exception for one form, `parse_ecrf` still returns results for other forms (mock the client to raise on a specific form name)
     - Test that the failed form appears in results with an empty fields list
     - Test that `pre_extracted_pages` parameter works (bypasses PDF extraction)

  Mock `extract_ecrf_pages` and `AstraeaLLMClient` in tests. Follow existing test patterns.
  </action>
  <verify>
  Run: `cd /Users/sanmaysarada/Astraea-SDTM && pytest tests/test_parsing/test_ecrf_parser.py -v --tb=short`
  All tests pass.
  </verify>
  <done>parse_ecrf() catches per-form exceptions, logs warnings, continues processing. Empty-field placeholder created for failed forms. pre_extracted_pages parameter enables single-extraction CLI flow.</done>
</task>

<task type="auto">
  <name>Task 2: Fix double PDF extraction in CLI parse-ecrf command</name>
  <files>src/astraea/cli/app.py, tests/test_cli/test_parse_ecrf.py</files>
  <action>
  In the `parse_ecrf` CLI command (around lines 296-314 of app.py):

  Current flow (BROKEN):
  1. Lines 300-303: Calls `extract_ecrf_pages()` + `group_pages_by_form()` to count forms
  2. Lines 310-311: Calls `parse_ecrf()` which internally calls `extract_ecrf_pages()` AGAIN

  Fixed flow:
  1. Extract pages once: `pages = extract_ecrf_pages(ecrf_path)`
  2. Group pages: `form_groups = group_pages_by_form(pages)`
  3. Count forms for progress display
  4. Pass pre-extracted pages to `parse_ecrf()`: `result = parse_ecrf(ecrf_path, pre_extracted_pages=pages)`

  The import of `parse_ecrf` from `astraea.parsing.ecrf_parser` is already present. Just change the call to pass `pre_extracted_pages=pages`.

  Update CLI tests:
  - Verify that `extract_ecrf_pages` is called only once during a parse-ecrf invocation (use mock call counts)
  - If existing tests mock at different levels, adapt accordingly
  </action>
  <verify>
  Run: `cd /Users/sanmaysarada/Astraea-SDTM && pytest tests/test_cli/test_parse_ecrf.py -v --tb=short`
  All tests pass.
  </verify>
  <done>CLI parse-ecrf extracts PDF once. Pre-extracted pages passed to parse_ecrf() via new parameter. Test verifies single extraction.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_parsing/test_ecrf_parser.py tests/test_cli/test_parse_ecrf.py -v` -- all pass
2. `ruff check src/astraea/parsing/ecrf_parser.py src/astraea/cli/app.py` -- no lint errors
3. `pytest -x` -- full suite still passes
</verification>

<success_criteria>
- Single form failure in eCRF parsing does not crash pipeline
- Failed forms logged as warnings with loguru
- CLI extracts PDF exactly once (no double extraction)
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-source-parsing/02-08-SUMMARY.md`
</output>
