---
phase: 02-source-parsing
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/classification/heuristic.py
  - tests/test_classification/test_heuristic.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Files like ecoa.sas7bdat and epro.sas7bdat match QS domain via filename heuristic"
    - "Files like ds2.sas7bdat and eg3.sas7bdat match DS and EG domains respectively"
    - "Trial design files (ta, te, tv, ti, ts) get heuristic scores for their respective domains"
    - "All 36 sample files get at least one heuristic match (no file left without filename signal)"
  artifacts:
    - path: "src/astraea/classification/heuristic.py"
      provides: "Expanded FILENAME_PATTERNS with QS, SC, FA, TA, TE, TV, TI, TS domains"
      contains: "QS.*ecoa|epro|questionnaire"
    - path: "tests/test_classification/test_heuristic.py"
      provides: "Tests for new domain patterns and numbered variant matching"
  key_links:
    - from: "src/astraea/classification/heuristic.py"
      to: "FILENAME_PATTERNS"
      via: "score_by_filename uses FILENAME_PATTERNS dict"
      pattern: "FILENAME_PATTERNS"
---

<objective>
Fix heuristic domain scorer: add missing SDTM domain filename patterns (Gap 1) and allow numbered variant file matching (Gap 4).

Purpose: 33% of sample files (12/36) get no filename heuristic match because QS, SC, FA, and trial design domains are missing. Additionally, numbered variants like ds2.sas7bdat fail to match because digits aren't recognized as valid segment boundaries.

Output: Updated heuristic.py with complete domain coverage and relaxed segment matching, plus tests proving both fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/astraea/classification/heuristic.py
@tests/test_classification/test_heuristic.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand FILENAME_PATTERNS and fix segment boundary matching</name>
  <files>src/astraea/classification/heuristic.py</files>
  <action>
  1. Add missing domains to FILENAME_PATTERNS dict:
     - "QS": ["qs", "questionnaire", "ecoa", "epro", "qol"]
     - "SC": ["sc", "subclass", "subjectchar"]
     - "FA": ["fa", "finding"]
     - "TA": ["ta"]
     - "TE": ["te"]
     - "TV": ["tv"]
     - "TI": ["ti"]
     - "TS": ["ts"]

  2. Fix `_is_segment_match` function to allow digits as valid right-boundary characters. Currently line 69 only allows "_" and "-" as right boundaries. Change the right-boundary check to ALSO accept digits as valid boundaries. This makes "ds2" match pattern "ds" because "2" is a digit boundary.

  Specifically, change the right boundary check at line 69 from:
    `return not (end < len(name) and name[end] not in ("_", "-"))`
  to:
    `return not (end < len(name) and name[end] not in ("_", "-") and not name[end].isdigit())`

  IMPORTANT: Do NOT change the left boundary logic -- only the right boundary. Left boundary should still require underscore, hyphen, or start-of-string. This prevents false positives like "data" matching "da" (because "t" is not a digit).

  3. Also add trial design merge prefixes if applicable (TA, TE, etc. typically don't merge, so this is optional -- skip if not needed).
  </action>
  <verify>
  Run: `cd /Users/sanmaysarada/Astraea-SDTM && python -c "from astraea.classification.heuristic import score_by_filename; print(score_by_filename('ecoa.sas7bdat')); print(score_by_filename('ds2.sas7bdat')); print(score_by_filename('ts.sas7bdat'))"`

  Expected: QS score for ecoa, DS score for ds2, TS score for ts.
  </verify>
  <done>FILENAME_PATTERNS has entries for QS, SC, FA, TA, TE, TV, TI, TS. Numbered variant files like ds2, eg3 get correct domain matches.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new patterns and numbered variants</name>
  <files>tests/test_classification/test_heuristic.py</files>
  <action>
  Add the following test cases to the existing test file:

  1. Test new domain filename patterns:
     - "qs.sas7bdat" -> QS exact match (1.0)
     - "ecoa.sas7bdat" -> QS exact match (1.0)
     - "epro.sas7bdat" -> QS exact match (1.0)
     - "sc.sas7bdat" -> SC exact match (1.0)
     - "fa.sas7bdat" -> FA exact match (1.0)
     - "ta.sas7bdat" -> TA exact match (1.0)
     - "te.sas7bdat" -> TE exact match (1.0)
     - "tv.sas7bdat" -> TV exact match (1.0)
     - "ti.sas7bdat" -> TI exact match (1.0)
     - "ts.sas7bdat" -> TS exact match (1.0)

  2. Test numbered variant matching (Gap 4):
     - "ds2.sas7bdat" -> DS match
     - "eg3.sas7bdat" -> EG match
     - "ae2.sas7bdat" -> AE match
     - "cm1.sas7bdat" -> CM match

  3. Test that false positives are NOT introduced:
     - "data.sas7bdat" should NOT match DA (because "t" is not a valid boundary)
     - "testing.sas7bdat" should NOT match TE (because "s" is not a valid boundary)

  Use @parametrize for compact test organization. Follow existing test patterns in the file.
  </action>
  <verify>
  Run: `cd /Users/sanmaysarada/Astraea-SDTM && pytest tests/test_classification/test_heuristic.py -v --tb=short`
  All tests pass including new ones.
  </verify>
  <done>New tests cover all added domain patterns, numbered variant matching, and false positive prevention. All existing + new tests pass.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_classification/test_heuristic.py -v` -- all pass
2. `ruff check src/astraea/classification/heuristic.py` -- no lint errors
3. Quick smoke test: `python -c "from astraea.classification.heuristic import FILENAME_PATTERNS; assert len(FILENAME_PATTERNS) >= 23"` (was 15, now 23+)
</verification>

<success_criteria>
- FILENAME_PATTERNS covers all SDTM domains mentioned in the UAT (QS, SC, FA, TA, TE, TV, TI, TS)
- Numbered variants (ds2, eg3) produce correct domain scores
- No false positives introduced (data != DA, testing != TE)
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-source-parsing/02-06-SUMMARY.md`
</output>
