---
phase: 02-source-parsing
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/astraea/classification/__init__.py
  - src/astraea/classification/heuristic.py
  - tests/test_classification/__init__.py
  - tests/test_classification/test_heuristic.py
autonomous: true

must_haves:
  truths:
    - "System scores domain likelihood from filename patterns (exact match = 1.0, prefix match = 0.7)"
    - "System scores domain likelihood from variable name overlap with SDTM-IG specs"
    - "System detects multi-file domain merges (lb_biochem + lb_hem -> LB)"
    - "System returns UNCLASSIFIED for datasets with no strong heuristic signal"
  artifacts:
    - path: "src/astraea/classification/heuristic.py"
      provides: "score_by_filename(), score_by_variables(), compute_heuristic_scores(), detect_merge_groups()"
      contains: "def compute_heuristic_scores"
  key_links:
    - from: "src/astraea/classification/heuristic.py"
      to: "src/astraea/reference/sdtm_ig.py"
      via: "SDTMReference for variable overlap scoring"
      pattern: "SDTMReference"
    - from: "src/astraea/classification/heuristic.py"
      to: "src/astraea/models/profiling.py"
      via: "DatasetProfile for variable names"
      pattern: "DatasetProfile"
    - from: "src/astraea/classification/heuristic.py"
      to: "src/astraea/models/classification.py"
      via: "Returns HeuristicScore objects"
      pattern: "HeuristicScore"
---

<objective>
Build the deterministic heuristic domain scorer that classifies raw datasets to SDTM domains using filename patterns and variable name overlap -- no LLM calls required. Also detect multi-file merge groups (e.g., lb_* -> LB).

Purpose: Fulfills the deterministic half of CLSF-01 (classify datasets), CLSF-02 (handle all domain classes), and CLSF-03 (detect multi-dataset merges). Acts as sanity check against LLM classification to prevent hallucination cascading (Pitfall C1).
Output: classification/heuristic.py with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-source-parsing/02-RESEARCH.md
@src/astraea/models/profiling.py
@src/astraea/models/classification.py
@src/astraea/reference/sdtm_ig.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filename and Variable Heuristic Scorers</name>
  <files>
    src/astraea/classification/__init__.py
    src/astraea/classification/heuristic.py
    tests/test_classification/__init__.py
    tests/test_classification/test_heuristic.py
  </files>
  <action>
**src/astraea/classification/__init__.py:** Export key functions.

**src/astraea/classification/heuristic.py:**

Constants:
- `FILENAME_PATTERNS: dict[str, list[str]]` mapping domain codes to filename patterns per the research:
  AE: ["ae"], CM: ["cm", "conmed"], DM: ["dm", "demo"], DS: ["ds", "disp"], DV: ["dv", "deviat"], EG: ["eg", "ecg"], EX: ["ex", "expos", "dose"], IE: ["ie", "incl", "excl"], LB: ["lb", "lab", "biochem", "hem", "coag", "urin", "chem"], MH: ["mh", "medhist", "haemh"], PE: ["pe", "physex"], VS: ["vs", "vital"], CE: ["ce"], DA: ["da"], SV: ["sv"]
- `MERGE_PREFIXES: dict[str, list[str]]` for detecting multi-file domains:
  LB: ["lb_", "lab"], EG: ["eg_", "ecg"], DS: ["ds"], EX: ["ex"], MH: ["haemh", "mh"]

`score_by_filename(dataset_name: str) -> list[HeuristicScore]`:
- Strip .sas7bdat extension, lowercase
- Exact match with any pattern -> score 1.0, signal "filename exact match: {pattern}"
- Starts with pattern + "_" or contains pattern -> score 0.7, signal "filename contains: {pattern}"
- Return list of HeuristicScore objects sorted by score descending
- Return empty list if no matches (dataset is ambiguous)

`score_by_variables(profile: DatasetProfile, ref: SDTMReference) -> list[HeuristicScore]`:
- Get clinical (non-EDC) variable names from profile, uppercase
- For each domain in ref.list_domains(), get domain spec variables
- Exclude common identifiers: STUDYID, DOMAIN, USUBJID, SUBJID, SITEID
- Compute overlap ratio: len(clinical_vars & domain_vars) / len(domain_vars)
- Only include domains with overlap > 0.1 (at least 10% variable match)
- Return list of HeuristicScore sorted by score descending, signal "variable overlap: {overlap_count}/{domain_var_count}"

`compute_heuristic_scores(dataset_name: str, profile: DatasetProfile | None, ref: SDTMReference | None) -> list[HeuristicScore]`:
- Combines filename and variable scores
- If both available, take max score per domain
- If only filename available, use filename scores
- Sort by score descending
- If no scores >= 0.3, return a single HeuristicScore with domain="UNCLASSIFIED", score=0.0, signals=["no heuristic match"]

`detect_merge_groups(dataset_names: list[str]) -> dict[str, list[str]]`:
- Given all dataset names, detect groups that should merge into one domain
- Use MERGE_PREFIXES: datasets sharing same prefix pattern go into same group
- Returns dict of domain -> list of dataset names (only for groups with 2+ datasets)
- Example: ["lb_biochem", "lb_hem", "lb_urin"] -> {"LB": ["lb_biochem", "lb_hem", "lb_urin"]}

**Tests (test_heuristic.py):**
- Test score_by_filename: "ae.sas7bdat" -> AE with score 1.0
- Test score_by_filename: "lb_biochem.sas7bdat" -> LB with score 0.7
- Test score_by_filename: "unknown_data.sas7bdat" -> empty list
- Test score_by_variables with mock DatasetProfile containing AETERM, AESTDTC, AEENDTC -> AE scores high
- Test score_by_variables with mock DatasetProfile containing non-SDTM vars -> low/no scores
- Test compute_heuristic_scores combines filename + variable scores
- Test compute_heuristic_scores returns UNCLASSIFIED when no match
- Test detect_merge_groups: ["lb_biochem", "lb_hem", "lb_urin", "ae", "dm"] -> {"LB": ["lb_biochem", "lb_hem", "lb_urin"]}
- Test detect_merge_groups: ["ae", "dm", "cm"] -> empty dict (no merges)
  </action>
  <verify>pytest tests/test_classification/test_heuristic.py -v</verify>
  <done>Heuristic scorer classifies datasets by filename and variable overlap. Merge detection identifies multi-file domains. All tests pass without API key or real data.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_classification/ -v` -- all tests pass
2. `python -c "from astraea.classification.heuristic import compute_heuristic_scores, detect_merge_groups; print('Heuristic OK')"` -- imports work
3. `ruff check src/astraea/classification/` -- no lint errors
</verification>

<success_criteria>
- Filename heuristic correctly identifies all 13+ standard SDTM domains from common dataset names
- Variable overlap scoring uses SDTM-IG reference data for domain matching
- Merge detection groups lb_*, eg_*, ds* into their respective domains
- UNCLASSIFIED returned for ambiguous datasets
- All tests pass without external dependencies (no API key, no real SAS files)
</success_criteria>

<output>
After completion, create `.planning/phases/02-source-parsing/02-03-SUMMARY.md`
</output>
