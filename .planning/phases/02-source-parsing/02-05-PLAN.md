---
phase: 02-source-parsing
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - src/astraea/cli/app.py
  - src/astraea/cli/display.py
  - tests/test_cli/test_parse_ecrf.py
  - tests/test_cli/test_classify.py
autonomous: false

must_haves:
  truths:
    - "User can run 'astraea parse-ecrf ECRF.pdf' and see extracted forms with field counts"
    - "User can run 'astraea classify Fakedata/' and see domain classifications with confidence scores"
    - "User can run 'astraea classify Fakedata/ --ecrf ECRF.pdf' to include eCRF context in classification"
    - "Cached extraction/classification results are reused on subsequent runs"
  artifacts:
    - path: "src/astraea/cli/app.py"
      provides: "parse_ecrf and classify CLI commands"
      contains: "def parse_ecrf"
    - path: "src/astraea/cli/display.py"
      provides: "display_ecrf_summary and display_classification Rich formatters"
      contains: "def display_ecrf_summary"
  key_links:
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/parsing/ecrf_parser.py"
      via: "parse_ecrf() function call"
      pattern: "parse_ecrf"
    - from: "src/astraea/cli/app.py"
      to: "src/astraea/classification/classifier.py"
      via: "classify_all() function call"
      pattern: "classify_all"
---

<objective>
Add CLI commands for eCRF parsing and domain classification, with Rich-formatted output tables showing extraction results and classification scores. Includes an integration checkpoint to verify the full pipeline works with real data.

Purpose: Fulfills the user-facing side of ECRF-01 through ECRF-04 and CLSF-01 through CLSF-04. Makes Phase 2 functionality accessible via the CLI.
Output: Updated cli/app.py with parse-ecrf and classify commands, display helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-source-parsing/02-RESEARCH.md
@src/astraea/cli/app.py
@src/astraea/cli/display.py
@src/astraea/parsing/ecrf_parser.py
@src/astraea/classification/classifier.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI Commands and Display Helpers</name>
  <files>
    src/astraea/cli/app.py
    src/astraea/cli/display.py
    tests/test_cli/test_parse_ecrf.py
    tests/test_cli/test_classify.py
  </files>
  <action>
**src/astraea/cli/display.py:** Add display functions for Phase 2 output:

`display_ecrf_summary(result: ECRFExtractionResult, console: Console) -> None`:
- Rich Table with columns: Form Name, Fields, Page Range
- Each row shows a form, its field count, and the page numbers it spans
- Footer row: "Total: {n} forms, {m} fields"

`display_ecrf_form_detail(form: ECRFForm, console: Console) -> None`:
- Rich Table with columns: #, Field Name, Type, SAS Label, Coded Values
- Shows all fields in the form
- coded_values shown as "Y=Yes, N=No" format

`display_classification(result: ClassificationResult, console: Console) -> None`:
- Rich Table with columns: Dataset, Domain, Confidence, Reasoning
- Color-code confidence: >=0.8 green, 0.5-0.8 yellow, <0.5 red
- UNCLASSIFIED datasets in bold red
- After main table, show merge groups section if any DomainPlans have >1 source dataset:
  "Merge Groups:" panel listing each domain and its source datasets

**src/astraea/cli/app.py:** Add two new commands:

`parse_ecrf(ecrf_path: Path, output: Path | None = None, detail: bool = False, cache_dir: Path | None = None) -> None`:
- Validates ecrf_path exists and is a PDF
- If cache_dir provided and cached result exists, load it instead of re-parsing
- Calls parse_ecrf() from parsing module
- Displays summary with display_ecrf_summary
- If --detail, also display each form's fields with display_ecrf_form_detail
- If --output, save JSON to output path
- If --cache-dir, save extraction result for reuse
- Show progress: "[1/2] Extracting PDF..." "[2/2] Parsing {n} forms..."
- IMPORTANT: This command requires ANTHROPIC_API_KEY. If not set, print a clear error message.

`classify(data_dir: Path, ecrf: Path | None = None, output: Path | None = None, cache_dir: Path | None = None) -> None`:
- Validates data_dir exists
- Reads and profiles all SAS files (reuse existing profile command logic)
- If --ecrf provided, parse eCRF first (or load cached), then match forms to datasets
- Calls classify_all() with profiles, ecrf_result, form_matches
- Displays results with display_classification
- If --output, save classification JSON
- If --cache-dir, save/load cached results
- Show progress: "[1/3] Profiling datasets..." "[2/3] Classifying..." "[3/3] Detecting merge groups..."
- IMPORTANT: This command requires ANTHROPIC_API_KEY. If not set, print a clear error message.

**Tests:**
- test_parse_ecrf.py: Test CLI invocation with `typer.testing.CliRunner` and mocked parse_ecrf function. Verify it handles missing file, shows summary output.
- test_classify.py: Test CLI invocation with mocked classify_all. Verify it handles missing directory, shows classification table.
- Do NOT test with real LLM calls.
  </action>
  <verify>pytest tests/test_cli/test_parse_ecrf.py tests/test_cli/test_classify.py -v && astraea --help</verify>
  <done>CLI has parse-ecrf and classify commands. Rich-formatted output shows forms, fields, and classification results. Tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 pipeline: eCRF PDF extraction, form parsing, form-dataset matching, heuristic + LLM domain classification, and CLI commands for both.</what-built>
  <how-to-verify>
    1. Run full test suite: `pytest tests/ -v` -- all tests should pass (216 Phase 1 + new Phase 2 tests)
    2. If you have ANTHROPIC_API_KEY set, test with real data:
       a. `astraea parse-ecrf ECRF.pdf --detail` -- should show 30+ forms with field counts
       b. `astraea classify Fakedata/ --ecrf ECRF.pdf` -- should show 36 datasets classified to domains with confidence scores
       c. Verify: AE, CM, DM, DS, DV, EX, IE, MH, PE mapped correctly (confidence >= 0.7)
       d. Verify: LB merge group includes lb_biochem, lb_hem, lb_urin, lb_coagulation
       e. Verify: Some datasets marked UNCLASSIFIED (irt, ecoa, etc.)
    3. If no API key, verify: `astraea parse-ecrf --help` and `astraea classify --help` show correct options
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `pytest tests/ -v` -- entire test suite passes
2. `astraea --help` -- shows parse-ecrf and classify commands
3. `ruff check src/astraea/` -- no lint errors across all modules
4. `python -c "from astraea.parsing import parse_ecrf; from astraea.classification import classify_all; print('Pipeline importable')"` -- full pipeline importable
</verification>

<success_criteria>
- `astraea parse-ecrf ECRF.pdf` extracts forms and displays Rich-formatted summary
- `astraea classify Fakedata/` classifies datasets with confidence scores
- `astraea classify Fakedata/ --ecrf ECRF.pdf` uses eCRF context for better classification
- Caching works: second run loads from cache instead of re-parsing
- All tests pass (Phase 1 + Phase 2)
- Human verifies real data results look correct
</success_criteria>

<output>
After completion, create `.planning/phases/02-source-parsing/02-05-SUMMARY.md`
</output>
