---
phase: 02.1-ref-data-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/transforms/usubjid.py
  - src/astraea/profiling/profiler.py
  - tests/test_transforms/test_usubjid.py
  - tests/test_profiling/test_profiler_unit.py
autonomous: true

must_haves:
  truths:
    - "USUBJID generation rejects NaN/empty components instead of producing '301-nan-01'"
    - "EDC column set includes subject, Subject, SiteNumber, Site, SiteGroup, StudySiteId, FolderName"
    - "EDC column set typo fixed: studyenvsitenumber (not studyenvsiteumber)"
    - "All existing tests still pass"
  artifacts:
    - path: "src/astraea/transforms/usubjid.py"
      provides: "NaN-safe USUBJID generation"
    - path: "src/astraea/profiling/profiler.py"
      provides: "Updated EDC column set with 7 new columns and typo fix"
    - path: "tests/test_transforms/test_usubjid.py"
      provides: "Tests for NaN rejection"
    - path: "tests/test_profiling/test_profiler_unit.py"
      provides: "Unit tests for EDC column detection (not dependent on Fakedata)"
  key_links:
    - from: "src/astraea/transforms/usubjid.py"
      to: "src/astraea/profiling/profiler.py"
      via: "both used during SDTM mapping pipeline"
      pattern: "generate_usubjid"
---

<objective>
Fix USUBJID NaN-to-"nan" bug and update EDC system column set (add 7 missing columns, fix 1 typo).

Purpose: The USUBJID bug produces corrupt identifiers ("301-nan-01") when source data has NaN values, breaking cross-domain subject linkage. The missing EDC columns cause clinical data leakage into profiling (e.g., "Subject" column treated as clinical instead of EDC system).

Output: Fixed usubjid.py + updated profiler.py + tests for both.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE2_AUDIT.md
@src/astraea/transforms/usubjid.py
@src/astraea/profiling/profiler.py
@tests/test_transforms/test_usubjid.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix USUBJID NaN bug and update EDC columns</name>
  <files>src/astraea/transforms/usubjid.py, src/astraea/profiling/profiler.py</files>
  <action>
  **Fix 1: USUBJID NaN bug in usubjid.py**

  In `generate_usubjid` function: Add validation before concatenation. After str() conversion and strip(), check if any component is empty, "nan", or "None". If so, raise ValueError with a descriptive message.

  ```python
  def generate_usubjid(studyid, siteid, subjid, delimiter="-"):
      components = [str(studyid).strip(), str(siteid).strip(), str(subjid).strip()]
      for i, (name, val) in enumerate(zip(["studyid", "siteid", "subjid"], components)):
          if not val or val.lower() in ("nan", "none", ""):
              raise ValueError(
                  f"USUBJID component '{name}' is empty or NaN (got '{val}' from input {[studyid, siteid, subjid][i]})"
              )
      return delimiter.join(components)
  ```

  In `generate_usubjid_column` function: The pandas vectorized path (lines 140-148) uses `.astype(str)` which converts NaN to "nan". Fix by:
  1. After creating each series (studyid_series, siteid_series, subjid_series), check for "nan" values
  2. Replace the simple concatenation with a safer approach:

  ```python
  # After creating the three series, detect NaN contamination
  for col_name, series in [
      (studyid_col if studyid_value is None else "studyid_value", studyid_series),
      (siteid_col, siteid_series),
      (subjid_col, subjid_series),
  ]:
      nan_mask = series.str.lower().isin(["nan", "none", ""])
      if nan_mask.any():
          n_bad = int(nan_mask.sum())
          logger.warning(
              "Found {} NaN/empty values in {} -- these will produce invalid USUBJIDs",
              n_bad, col_name,
          )

  result = studyid_series + delimiter + siteid_series + delimiter + subjid_series
  # Mark rows with NaN-contaminated components as NaN
  nan_mask = (
      studyid_series.str.lower().isin(["nan", "none", ""])
      | siteid_series.str.lower().isin(["nan", "none", ""])
      | subjid_series.str.lower().isin(["nan", "none", ""])
  )
  result[nan_mask] = pd.NA
  return result
  ```

  **Fix 2: EDC column set in profiler.py**

  Update the `EDC_SYSTEM_COLUMNS` frozenset:
  1. Fix typo: change "studyenvsiteumber" to "studyenvsitenumber"
  2. Add these 7 columns (all lowercase since matching is case-insensitive):
     - "subject" (covers both "subject" and "Subject" via lowercase comparison)
     - "sitenumber"
     - "site"
     - "sitegroup"
     - "studysiteid"
     - "foldername" (note: "folder" already exists, but "foldername" is different from "folder")

  Wait -- check first: "foldername" may already be in the set. Looking at the current set: "folder" and "foldername" are NOT the same. Currently have "folder" but NOT "foldername". Add "foldername".

  Actually re-reading the audit: FolderName is listed as missing. Current set has "folder" but not "foldername". These are different EDC columns. Add "foldername".

  The final frozenset should have the original 24 entries (minus the typo) + 6 new = 30 entries.
  </action>
  <verify>
  ```
  python3 -c "
  from astraea.transforms.usubjid import generate_usubjid
  import math, pandas as pd
  # Test NaN rejection
  try:
      generate_usubjid('301', float('nan'), '01')
      print('FAIL: should have raised ValueError')
  except ValueError as e:
      print(f'OK: NaN rejected: {e}')
  # Test normal still works
  assert generate_usubjid('301', '04401', '01') == '301-04401-01'
  print('OK: normal generation works')

  from astraea.profiling.profiler import EDC_SYSTEM_COLUMNS
  assert 'studyenvsitenumber' in EDC_SYSTEM_COLUMNS, 'typo fix missing'
  assert 'studyenvsiteumber' not in EDC_SYSTEM_COLUMNS, 'old typo still present'
  assert 'subject' in EDC_SYSTEM_COLUMNS, 'subject missing'
  assert 'sitenumber' in EDC_SYSTEM_COLUMNS, 'sitenumber missing'
  assert 'foldername' in EDC_SYSTEM_COLUMNS, 'foldername missing'
  print('OK: EDC columns updated')
  print('ALL CHECKS PASSED')
  "
  ```
  </verify>
  <done>USUBJID rejects NaN/empty components. EDC column set has 30 entries with all corrections.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for USUBJID NaN fix and EDC column updates</name>
  <files>tests/test_transforms/test_usubjid.py, tests/test_profiling/test_profiler_unit.py</files>
  <action>
  **In tests/test_transforms/test_usubjid.py**, add:

  1. `test_generate_usubjid_nan_siteid_raises`: generate_usubjid("301", float("nan"), "01") raises ValueError
  2. `test_generate_usubjid_nan_subjid_raises`: generate_usubjid("301", "04401", float("nan")) raises ValueError
  3. `test_generate_usubjid_none_component_raises`: generate_usubjid("301", None, "01") raises ValueError
  4. `test_generate_usubjid_empty_string_raises`: generate_usubjid("301", "", "01") raises ValueError
  5. `test_generate_usubjid_column_nan_produces_na`: Create a DataFrame with NaN in siteid column, call generate_usubjid_column, verify NaN rows produce pd.NA (not "301-nan-01")
  6. `test_generate_usubjid_column_valid_unchanged`: Normal DataFrame still produces correct USUBJIDs

  **Create new file tests/test_profiling/test_profiler_unit.py** (unit tests not dependent on Fakedata):

  First check if `tests/test_profiling/` directory exists. If not, create it with an `__init__.py`.

  Add:
  1. `test_edc_columns_count`: len(EDC_SYSTEM_COLUMNS) >= 30
  2. `test_edc_column_subject_detected`: _is_edc_column("Subject") returns True
  3. `test_edc_column_subject_lowercase`: _is_edc_column("subject") returns True
  4. `test_edc_column_sitenumber_detected`: _is_edc_column("SiteNumber") returns True
  5. `test_edc_column_site_detected`: _is_edc_column("Site") returns True
  6. `test_edc_column_sitegroup_detected`: _is_edc_column("SiteGroup") returns True
  7. `test_edc_column_studysiteid_detected`: _is_edc_column("StudySiteId") returns True
  8. `test_edc_column_foldername_detected`: _is_edc_column("FolderName") returns True
  9. `test_edc_typo_fixed`: "studyenvsiteumber" not in EDC_SYSTEM_COLUMNS
  10. `test_edc_correct_spelling`: "studyenvsitenumber" in EDC_SYSTEM_COLUMNS
  11. `test_clinical_column_not_edc`: _is_edc_column("AETERM") returns False

  Run the full test suite.
  </action>
  <verify>Run: `cd /Users/sanmaysarada/Astraea-SDTM && python3 -m pytest tests/test_transforms/test_usubjid.py tests/test_profiling/test_profiler_unit.py -v` -- all new tests pass.</verify>
  <done>USUBJID NaN rejection tested, EDC column updates tested, all tests pass.</done>
</task>

</tasks>

<verification>
1. `python3 -m pytest tests/ -x -q` -- all 389+ tests pass (no regressions)
2. USUBJID NaN rejection confirmed via spot check
3. EDC column detection confirmed for all 7 new columns
</verification>

<success_criteria>
- generate_usubjid raises ValueError for NaN/None/empty components
- generate_usubjid_column produces pd.NA for NaN-contaminated rows (not "nan" strings)
- EDC_SYSTEM_COLUMNS includes subject, sitenumber, site, sitegroup, studysiteid, foldername
- Typo fixed: studyenvsitenumber (not studyenvsiteumber)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ref-data-fixes/02.1-03-SUMMARY.md`
</output>
