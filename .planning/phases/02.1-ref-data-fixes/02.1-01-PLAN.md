---
phase: 02.1-ref-data-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/astraea/data/ct/codelists.json
  - tests/test_reference/test_controlled_terms.py
autonomous: true

must_haves:
  truths:
    - "Every codelist in codelists.json has the correct NCI C-code verified against SDTM-IG v3.4"
    - "NY codelist includes U (Unknown) as a valid term"
    - "Race codelist is marked extensible: true"
    - "All existing CT reference tests still pass"
  artifacts:
    - path: "src/astraea/data/ct/codelists.json"
      provides: "Corrected CT codelists with verified NCI C-codes"
      contains: "C74457"
    - path: "tests/test_reference/test_controlled_terms.py"
      provides: "Tests verifying corrected C-codes, NY U term, Race extensibility"
  key_links:
    - from: "src/astraea/data/ct/codelists.json"
      to: "src/astraea/reference/controlled_terms.py"
      via: "JSON loading at import time"
      pattern: "codelists\\.json"
---

<objective>
Fix all 9 wrong NCI C-codes in codelists.json, add missing "U" term to NY codelist, and fix Race extensibility flag.

Purpose: The CT reference data has 9 of 11 codelists with wrong NCI C-codes due to a systematic code swap during initial data entry. This blocks Phase 3 because the mapper will assign wrong codelists to SDTM variables, causing P21 validation failures.

Output: Corrected codelists.json with verified C-codes + updated tests confirming correctness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE2_AUDIT.md
@src/astraea/data/ct/codelists.json
@tests/test_reference/test_controlled_terms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all NCI C-codes and term-level issues in codelists.json</name>
  <files>src/astraea/data/ct/codelists.json</files>
  <action>
  Open codelists.json and apply the following corrections to the top-level codelist keys AND the "code" field inside each codelist object. Both must match.

  **C-code corrections (change both the key AND the inner "code" field):**

  1. Race: key "C66767" -> "C74457", inner code "C66767" -> "C74457". Also set "extensible": true (currently false).
  2. Ethnicity: key "C66728" -> "C66790", inner code "C66728" -> "C66790".
  3. No Yes Response: key "C66790" -> "C66742", inner code "C66790" -> "C66742".
  4. Country: key "C66742" -> "ISO3166", inner code "C66742" -> "ISO3166". Keep extensible: true.
  5. Age Unit: key "C66726" -> "C66781", inner code "C66726" -> "C66781".
  6. Route of Administration: key "C66769" -> "C66729", inner code "C66769" -> "C66729".
  7. Severity: key "C66734" -> "C66769", inner code "C66734" -> "C66769".
  8. Unit: key "C66781" -> "C71620", inner code "C66781" -> "C71620".
  9. Frequency: key "C66770" -> "C71113", inner code "C66770" -> "C71113".

  **Sex (C66731) and Outcome of Event (C66768) are already correct -- do NOT change them.**

  **Term-level fix:**
  In the NY codelist (which will now be keyed as "C66742"), add a "U" term:
  ```json
  "U": {
    "submission_value": "U",
    "synonyms": ["Unknown"],
    "definition": "Not known, not observed, not recorded, or refused.",
    "nci_preferred_term": "Unknown"
  }
  ```

  **Also update variable_mappings arrays to reflect the correct codelist assignments:**
  - C66742 (NY): keep ["DTHFL", "AESER", "AESCAN", "AESCONG", "AESDISAB", "AESDTH", "AESHOSP", "AESLIFE", "AESMIE", "AECONTRT", "MHPRESP", "MHOCCUR"] -- these are correct target variables for NY
  - C66781 (Age Unit, formerly C66726): update variable_mappings to ["AGEU"]
  - C71620 (Unit, formerly C66781): update variable_mappings to ["CMDOSU", "EXDOSU", "LBORRESU", "LBSTRESU", "VSORRESU", "VSSTRESU", "EGORRESU", "EGSTRESU"]

  **IMPORTANT:** Be very careful with the key swaps. C66790 is currently used for NY but should become Ethnicity. C66742 is currently Country but should become NY. These are swaps, not simple renames. Best approach: build the new JSON from scratch for the affected entries to avoid swap collisions.

  After all changes, the file should have these 11 codelist keys: C66731, C74457, C66790, C66742, ISO3166, C66781, C66729, C66769, C66768, C71620, C71113.
  </action>
  <verify>
  Run: `python3 -c "import json; d=json.load(open('src/astraea/data/ct/codelists.json')); print(sorted(d['codelists'].keys())); assert 'C74457' in d['codelists']; assert 'C66742' in d['codelists']; assert d['codelists']['C74457']['name']=='Race'; assert d['codelists']['C74457']['extensible']==True; assert 'U' in d['codelists']['C66742']['terms']; assert d['codelists']['C66742']['name']=='No Yes Response'; print('ALL CHECKS PASSED')"`
  </verify>
  <done>All 11 codelists have correct NCI C-codes, Race is extensible, NY includes U term.</done>
</task>

<task type="auto">
  <name>Task 2: Update tests to verify corrected C-codes</name>
  <files>tests/test_reference/test_controlled_terms.py</files>
  <action>
  Update the existing test file to:

  1. Fix any existing tests that reference old C-codes. For example, tests that look up "C66790" expecting "No Yes Response" should now use "C66742". Tests looking up "C66731" for Sex are fine (unchanged).

  2. Add a new test class `TestCodelistCCodesVerified` with:
     - `test_race_code_is_c74457`: Look up C74457, verify name="Race", extensible=True
     - `test_ethnicity_code_is_c66790`: Look up C66790, verify name="Ethnicity"
     - `test_ny_code_is_c66742`: Look up C66742, verify name="No Yes Response", verify "U" in terms, "Y" in terms, "N" in terms
     - `test_country_code_is_iso3166`: Look up ISO3166, verify name="Country"
     - `test_age_unit_code_is_c66781`: Look up C66781, verify name="Age Unit"
     - `test_route_code_is_c66729`: Look up C66729, verify name="Route of Administration"
     - `test_severity_code_is_c66769`: Look up C66769, verify name="Severity/Intensity Scale for Adverse Events"
     - `test_unit_code_is_c71620`: Look up C71620, verify name="Unit"
     - `test_frequency_code_is_c71113`: Look up C71113, verify name="Frequency"
     - `test_sex_code_unchanged_c66731`: Look up C66731, verify name="Sex" (confirm no regression)
     - `test_outcome_code_unchanged_c66768`: Look up C66768, verify name="Outcome of Event"

  3. Add `test_old_wrong_codes_do_not_exist`: Verify that the OLD wrong codes (C66767, C66728, C66726, C66734, C66770 as codelist keys) return None from lookup. This prevents regression.

  Run the full test suite afterward to ensure no regressions.
  </action>
  <verify>Run: `cd /Users/sanmaysarada/Astraea-SDTM && python3 -m pytest tests/test_reference/test_controlled_terms.py -v` -- all tests pass, including new verification tests.</verify>
  <done>All 11 codelist C-codes verified by tests, old wrong codes confirmed absent, full test suite green.</done>
</task>

</tasks>

<verification>
1. `python3 -m pytest tests/ -x -q` -- all 389+ tests pass (no regressions)
2. Manual spot-check: `python3 -c "from astraea.reference import load_ct_reference; ct=load_ct_reference(); print([(c, ct.lookup_codelist(c).name) for c in ct.list_codelists()])"` -- all names match expected
</verification>

<success_criteria>
- All 11 codelists in codelists.json have verified correct NCI C-codes
- Race codelist is extensible: true
- NY codelist includes U (Unknown) term
- New tests verify each C-code mapping
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ref-data-fixes/02.1-01-SUMMARY.md`
</output>
