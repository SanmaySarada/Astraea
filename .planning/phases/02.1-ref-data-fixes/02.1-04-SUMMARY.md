---
phase: 02.1-ref-data-fixes
plan: 04
subsystem: reference
tags: [cdisc, sdtm-ig, domains, codelists, core-designations, key-variables]

# Dependency graph
requires:
  - phase: 02.1-ref-data-fixes plan 01
    provides: Corrected NCI C-codes in codelists.json
provides:
  - Corrected codelist assignments for all domain variables in domains.json
  - Corrected core designations (Req/Exp/Perm) per SDTM-IG v3.4
  - DA domain class fixed to Findings
  - DM.ARMNRS variable added
  - Natural key_variables for 9 core domains
  - DomainSpec Pydantic model with key_variables field
  - 50 regression tests for all corrections
affects: [03-mapping-engine, phase-3-mapper-agent]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "key_variables on DomainSpec for natural key uniqueness validation"

key-files:
  created: []
  modified:
    - src/astraea/data/sdtm_ig/domains.json
    - src/astraea/models/sdtm.py
    - src/astraea/reference/sdtm_ig.py
    - tests/test_reference/test_sdtm_ig.py

key-decisions:
  - "Forward-reference codelist codes allowed in domains.json even if not yet in codelists.json"
  - "DOMAIN variable gets C66734 codelist, EPOCH gets C99079 across all domains"
  - "Non-core domains (IE, CE, DV, PE, QS, SC, FA, SV, DA) get key_variables: null for now"

patterns-established:
  - "key_variables field on DomainSpec for natural key definition"
  - "Parametrized pytest tests for bulk variable-level verification"

# Metrics
duration: 3min
completed: 2026-02-27
---

# Phase 2.1 Plan 04: domains.json Corrections Summary

**Fixed 19 codelist assignments, 15 core designations, DA class, added ARMNRS and key_variables for 9 domains with 50 new tests**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-27T05:43:25Z
- **Completed:** 2026-02-27T05:46:25Z
- **Tasks:** 2/2
- **Files modified:** 4

## Accomplishments
- Fixed 19 wrong codelist assignments across DM, AE, CM, EX, LB, VS, EG, MH domains
- Fixed 15 wrong core designations (Req/Exp/Perm) to match SDTM-IG v3.4
- Changed DA domain class from Interventions to Findings
- Added DM.ARMNRS variable (Expected) for null arm reason
- Filled 16 null codelist assignments with correct C-codes (some as forward-references)
- Added DOMAIN (C66734) and EPOCH (C99079) codelist codes across all domains
- Added key_variables for 9 core domains (LB includes LBSPEC per SDTM-IG v3.4 Section 3.7)
- Added key_variables field to DomainSpec Pydantic model
- 50 new regression tests, full suite at 490 tests passing

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix codelist assignments, core designations, DA class, null codelists, and add key_variables** - `a4f021c` (fix)
2. **Task 2: Add tests verifying all domains.json corrections** - `f032f54` (test)

## Files Created/Modified
- `src/astraea/data/sdtm_ig/domains.json` - All codelist assignments, core designations, DA class, null fills, ARMNRS, key_variables corrected
- `src/astraea/models/sdtm.py` - Added key_variables: list[str] | None = None to DomainSpec
- `src/astraea/reference/sdtm_ig.py` - Updated loader to pass key_variables from JSON
- `tests/test_reference/test_sdtm_ig.py` - Updated 3 existing tests for corrected values; added TestDomainsJsonCorrections class with 50 tests

## Decisions Made
- Forward-reference codelist codes (C65047, C67154, C78736, etc.) are assigned in domains.json even though the corresponding codelists are not yet populated in codelists.json -- they record the correct SDTM-IG assignments and will be added when those domains are actively mapped
- DOMAIN variable assigned C66734 and EPOCH assigned C99079 wherever those variables exist in domains.json
- Non-core domains (IE, CE, DV, PE, QS, SC, FA, SV, DA) get key_variables: null -- to be populated when those domains are actively mapped
- Existing tests updated rather than deleted: test_get_required_variables_dm now correctly asserts ARMCD/ARM are NOT in required list; test_get_expected_variables_dm asserts they ARE in expected list

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Updated existing tests that would break from core/class changes**
- **Found during:** Task 1
- **Issue:** 3 existing tests asserted old wrong values (ARMCD/ARM as Req, ETHNIC as Exp, DA as Interventions)
- **Fix:** Updated test assertions to match corrected SDTM-IG v3.4 values
- **Files modified:** tests/test_reference/test_sdtm_ig.py
- **Verification:** All 24 existing tests pass with corrected assertions
- **Committed in:** a4f021c (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Necessary to prevent test failures from corrected reference data. No scope creep.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All Phase 2.1 Tier 1 items are now complete (plans 01-04)
- Reference data (codelists.json + domains.json) is corrected and verified
- Phase 3 (Mapping Engine) is unblocked -- the mapper can now look up correct codelist assignments, core designations, and natural keys
- domains.json key_variables enable the mapper to generate correct --SEQ numbering and uniqueness validation

---
*Phase: 02.1-ref-data-fixes*
*Completed: 2026-02-27*
