---
phase: 02.1-ref-data-fixes
plan: 03
subsystem: transforms, profiling
tags: [usubjid, edc-columns, nan-safety, pandas]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: "USUBJID generation (usubjid.py) and dataset profiler (profiler.py)"
provides:
  - "NaN-safe USUBJID generation (raises ValueError for NaN/None/empty)"
  - "NaN-safe USUBJID column generation (pd.NA for invalid rows)"
  - "Updated EDC column set (29 columns, 4 additions)"
  - "Unit tests for EDC column detection"
affects: [03-mapping-agent, 05-events-interventions, 06-findings]

# Tech tracking
tech-stack:
  added: []
  patterns: ["NaN-guard pattern for string concatenation from pandas columns"]

key-files:
  created:
    - "tests/test_profiling/test_profiler_unit.py"
  modified:
    - "src/astraea/transforms/usubjid.py"
    - "src/astraea/profiling/profiler.py"
    - "tests/test_transforms/test_usubjid.py"

key-decisions:
  - "ValueError raised for NaN/None/empty USUBJID components (not silent corruption)"
  - "pd.NA used for invalid column rows (not empty string or NaN string)"

patterns-established:
  - "NaN guard: always check str() conversion of pandas values for 'nan'/'none' before concatenation"

# Metrics
duration: 3min
completed: 2026-02-27
---

# Phase 2.1 Plan 03: USUBJID NaN Fix and EDC Column Update Summary

**NaN-safe USUBJID generation with ValueError/pd.NA guards plus 4 missing EDC system columns (subject, sitenumber, site, sitegroup)**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-27T05:37:30Z
- **Completed:** 2026-02-27T05:40:30Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- generate_usubjid now raises ValueError for NaN/None/empty components instead of producing corrupt "301-nan-01"
- generate_usubjid_column marks NaN-contaminated rows as pd.NA instead of string "nan"
- EDC_SYSTEM_COLUMNS expanded from 25 to 29 entries (subject, sitenumber, site, sitegroup)
- 16 new tests added (6 USUBJID NaN tests + 10 EDC column tests)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix USUBJID NaN bug and update EDC columns** - `35af6b3` (fix)
2. **Task 2: Add tests for USUBJID NaN fix and EDC column updates** - `879ee19` (test)

## Files Created/Modified
- `src/astraea/transforms/usubjid.py` - NaN/None/empty validation in generate_usubjid and generate_usubjid_column
- `src/astraea/profiling/profiler.py` - 4 new EDC system columns added to frozenset
- `tests/test_transforms/test_usubjid.py` - 6 new NaN rejection tests + updated empty component test
- `tests/test_profiling/test_profiler_unit.py` - 10 new unit tests for EDC column detection

## Decisions Made
- [D-02.1-03-01] ValueError raised for NaN/None/empty USUBJID components (fail-fast over silent corruption)
- [D-02.1-03-02] pd.NA used for invalid column rows (preserves pandas NA semantics, not string "nan")
- [D-02.1-03-03] Updated existing test_empty_components to expect ValueError (was testing incorrect behavior)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated existing test_empty_components to match new behavior**
- **Found during:** Task 1 (USUBJID NaN fix)
- **Issue:** Existing test asserted generate_usubjid("", "", "") == "--" which is now correctly rejected
- **Fix:** Changed test to expect ValueError with "empty or NaN" message
- **Files modified:** tests/test_transforms/test_usubjid.py
- **Verification:** All 43 USUBJID + profiler tests pass
- **Committed in:** 35af6b3 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Necessary fix -- old test was validating incorrect behavior.

## Issues Encountered
- Pre-existing test failure in test_controlled_terms.py::test_is_extensible_route_true (C66769) -- not caused by this plan, exists on main branch before changes.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- USUBJID generation is now NaN-safe for the mapping pipeline
- EDC column detection covers all known Rave/EDC system columns
- Ready for Phase 2.1 Plan 04 (remaining reference data fixes)

---
*Phase: 02.1-ref-data-fixes*
*Completed: 2026-02-27*
