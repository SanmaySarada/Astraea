---
phase: 02.1-ref-data-fixes
plan: 04
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - src/astraea/data/sdtm_ig/domains.json
  - tests/test_reference/test_sdtm_ig.py
autonomous: true

must_haves:
  truths:
    - "All wrong codelist assignments in domains.json now reference correct C-codes from Plan 01"
    - "All 15 core designation errors are corrected (Req/Exp/Perm match SDTM-IG v3.4)"
    - "DA domain class is Findings (not Interventions)"
    - "All null codelist assignments filled where SDTM-IG specifies a codelist"
    - "All 9 core domains have key_variables defined"
    - "LB key_variables includes LBSPEC"
    - "DM.ARMNRS variable exists as Exp"
    - "All existing SDTM-IG reference tests still pass"
  artifacts:
    - path: "src/astraea/data/sdtm_ig/domains.json"
      provides: "Corrected domain specs with right codelists, core designations, keys, DA class"
    - path: "tests/test_reference/test_sdtm_ig.py"
      provides: "Tests verifying codelist assignments, core designations, DA class, key_variables"
  key_links:
    - from: "src/astraea/data/sdtm_ig/domains.json"
      to: "src/astraea/data/ct/codelists.json"
      via: "codelist_code references must match codelist keys"
      pattern: "codelist_code"
    - from: "src/astraea/data/sdtm_ig/domains.json"
      to: "src/astraea/reference/sdtm_ig.py"
      via: "JSON loading at import time"
      pattern: "domains\\.json"
---

<objective>
Fix all domains.json errors: wrong codelist assignments, 15 wrong core designations, DA domain class, null codelist assignments, and add natural key_variables for 9 core domains.

Purpose: domains.json is the Phase 3 mapper's primary reference for what variables belong in each SDTM domain, what codelists they use, and whether they're required/expected/permissible. Every error here produces wrong mapping output.

Output: Corrected domains.json + comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE2_AUDIT.md
@src/astraea/data/sdtm_ig/domains.json
@src/astraea/data/ct/codelists.json
@tests/test_reference/test_sdtm_ig.py
@.planning/phases/02.1-ref-data-fixes/02.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix codelist assignments, core designations, DA class, null codelists, and add key_variables</name>
  <files>src/astraea/data/sdtm_ig/domains.json</files>
  <action>
  Apply ALL of the following corrections to domains.json. After Plan 01, the codelist C-codes in codelists.json are now correct. The domains.json codelist_code values must reference these corrected codes.

  **1. Fix wrong codelist assignments:**

  DM domain:
  - DTHFL: "C66790" -> "C66742" (NY codelist)
  - RACE: "C66767" -> "C74457" (Race codelist)
  - ETHNIC: "C66728" -> "C66790" (Ethnic Group codelist)
  - AGEU: "C66726" -> "C66781" (Age Unit codelist -- was mapped to wrong code)
  - COUNTRY: "C66742" -> "ISO3166" (Country codelist)

  AE domain:
  - AESEV: "C66734" -> "C66769" (Severity codelist)
  - AESER: "C66790" -> "C66742" (NY)
  - AESCAN: "C66790" -> "C66742" (NY)
  - AESCONG: "C66790" -> "C66742" (NY)
  - AESDISAB: "C66790" -> "C66742" (NY)
  - AESDTH: "C66790" -> "C66742" (NY)
  - AESHOSP: "C66790" -> "C66742" (NY)
  - AESLIFE: "C66790" -> "C66742" (NY)
  - AESMIE: "C66790" -> "C66742" (NY)
  - AECONTRT: "C66790" -> "C66742" (NY)

  CM domain:
  - CMDOSU: "C66781" -> "C71620" (Unit codelist)
  - CMDOSFRQ: "C66770" -> "C71113" (Frequency codelist)
  - CMROUTE: "C66769" -> "C66729" (Route codelist)

  EX domain:
  - EXDOSU: "C66781" -> "C71620" (Unit)
  - EXDOSFRQ: "C66770" -> "C71113" (Frequency)
  - EXROUTE: "C66769" -> "C66729" (Route)

  LB domain:
  - LBORRESU: "C66781" -> "C71620" (Unit)
  - LBSTRESU: "C66781" -> "C71620" (Unit)

  VS domain:
  - VSORRESU: "C66781" -> "C71620" (Unit)
  - VSSTRESU: "C66781" -> "C71620" (Unit)

  EG domain:
  - EGORRESU: "C66781" -> "C71620" (Unit)
  - EGSTRESU: "C66781" -> "C71620" (Unit)

  MH domain:
  - MHPRESP: "C66790" -> "C66742" (NY)
  - MHOCCUR: "C66790" -> "C66742" (NY)

  CE domain:
  - CEPRESP: "C66742" -> "C66742" (already correct after code swap -- NY is now C66742)
  - CEOCCUR: "C66742" -> "C66742" (same -- already correct)

  **2. Fix 15 core designations:**

  DM domain:
  - ARMCD: "Req" -> "Exp"
  - ARM: "Req" -> "Exp"
  - ACTARMCD: "Req" -> "Exp"
  - ACTARM: "Req" -> "Exp"
  - DTHDTC: "Perm" -> "Exp"
  - DTHFL: "Perm" -> "Exp"
  - ETHNIC: "Exp" -> "Perm"

  AE domain:
  - AEOUT: "Exp" -> "Perm"

  CM domain:
  - CMDECOD: "Exp" -> "Perm"
  - CMSTDTC: "Exp" -> "Perm"
  - CMENDTC: "Exp" -> "Perm"
  - CMINDC: "Exp" -> "Perm"

  EX domain:
  - EXROUTE: "Exp" -> "Perm"

  LB domain:
  - LBCAT: "Perm" -> "Exp"

  **3. Add DM.ARMNRS variable:**
  Add a new variable entry to DM.variables (after ACTARM, before COUNTRY -- around order 24):
  ```json
  {
    "name": "ARMNRS",
    "label": "Reason Arm and/or Actual Arm is Null",
    "data_type": "Char",
    "core": "Exp",
    "cdisc_notes": "A coded reason that arm variables (ARM, ARMCD, ACTARM, ACTARMCD) are null.",
    "codelist_code": null,
    "order": 24
  }
  ```
  Adjust order numbers for subsequent variables if needed.

  **4. Fix DA domain class:**
  Change DA.domain_class from "Interventions" to "Findings"

  **5. Fill null codelist assignments:**
  For variables that currently have codelist_code: null but should have a codelist per SDTM-IG:

  AE domain:
  - AEACN: null -> "C66767" (Action Taken with Study Treatment)

  LB domain:
  - LBTESTCD: null -> "C65047" (if variable exists; if not, skip)
  - LBTEST: null -> "C67154" (if variable exists; if not, skip)
  - LBNRIND: null -> "C78736" (if variable exists; if not, skip)
  - LBSPEC: null -> "C78734" (if variable exists; if not, skip)

  VS domain:
  - VSTESTCD: null -> "C66741" (if variable exists; if not, skip)
  - VSTEST: null -> "C67153" (if variable exists; if not, skip)
  - VSPOS: null -> "C71148" (if variable exists; if not, skip)

  EG domain:
  - EGTESTCD: null -> "C71153" (if variable exists; if not, skip)
  - EGTEST: null -> "C71152" (if variable exists; if not, skip)

  EX domain:
  - EXDOSFRM: null -> "C66726" (if variable exists; if not, skip)

  DS domain:
  - DSDECOD: null -> "C66727" (if variable exists; if not, skip)

  MH domain:
  - MHENRF: null -> "C66728" (if variable exists; if not, skip)

  **NOTE on forward references:** Some of these C-codes (e.g., C65047, C67154, C78736, C78734, C66741, C67153, C71148, C71153, C71152, C66726, C66727, C66728) may not yet exist as keys in codelists.json. This is intentional -- domains.json records the correct SDTM-IG codelist assignments even if those codelists have not been populated in codelists.json yet. They will be added in a future phase when those domains are actively mapped. Do NOT skip assigning a code just because it is not in codelists.json.

  For DOMAIN and EPOCH variables across all domains: these are valid assignments (C66734 for DOMAIN, C99079 for EPOCH) but since these variables may not exist in all domains in the current JSON, only update where the variable already exists. If DOMAIN variable exists in a domain, set its codelist_code to "C66734". Same for EPOCH -> "C99079".

  **6. Add key_variables to each domain:**
  Add a "key_variables" field at the top level of each domain object (same level as "domain", "description", "domain_class"):

  ```json
  "DM": { "key_variables": ["STUDYID", "USUBJID"], ... }
  "AE": { "key_variables": ["STUDYID", "USUBJID", "AETERM", "AESTDTC"], ... }
  "CM": { "key_variables": ["STUDYID", "USUBJID", "CMTRT", "CMSTDTC"], ... }
  "EX": { "key_variables": ["STUDYID", "USUBJID", "EXTRT", "EXSTDTC"], ... }
  "LB": { "key_variables": ["STUDYID", "USUBJID", "LBTESTCD", "LBSPEC", "VISITNUM", "LBDTC"], ... }
  "VS": { "key_variables": ["STUDYID", "USUBJID", "VSTESTCD", "VISITNUM", "VSDTC"], ... }
  "EG": { "key_variables": ["STUDYID", "USUBJID", "EGTESTCD", "VISITNUM", "EGDTC"], ... }
  "DS": { "key_variables": ["STUDYID", "USUBJID", "DSDECOD", "DSSTDTC"], ... }
  "MH": { "key_variables": ["STUDYID", "USUBJID", "MHTERM"], ... }
  ```

  NOTE: LB key_variables MUST include "LBSPEC" per SDTM-IG v3.4 Section 3.7 (specimen type is part of the natural key for lab results -- the same test from different specimens produces different records).

  For domains not listed above (IE, CE, DV, PE, QS, SC, FA, SV, DA), add key_variables as null or an empty list -- they can be populated later.

  **IMPORTANT:** Check the DomainSpec Pydantic model in src/astraea/models/sdtm.py to see if it already has a key_variables field. If not, add `key_variables: list[str] | None = None` to the model FIRST, then update domains.json. If the model already supports it, just update the JSON.
  </action>
  <verify>
  ```
  python3 -c "
  import json
  with open('src/astraea/data/sdtm_ig/domains.json') as f:
      d = json.load(f)

  # Check codelist assignments (spot checks across ALL categories)
  dm_vars = {v['name']: v for v in d['DM']['variables']}
  assert dm_vars['DTHFL']['codelist_code'] == 'C66742', f'DTHFL: {dm_vars[\"DTHFL\"][\"codelist_code\"]}'
  assert dm_vars['RACE']['codelist_code'] == 'C74457', f'RACE: {dm_vars[\"RACE\"][\"codelist_code\"]}'
  assert dm_vars['ETHNIC']['codelist_code'] == 'C66790', f'ETHNIC: {dm_vars[\"ETHNIC\"][\"codelist_code\"]}'
  assert dm_vars['COUNTRY']['codelist_code'] == 'ISO3166', f'COUNTRY: {dm_vars[\"COUNTRY\"][\"codelist_code\"]}'
  assert dm_vars['AGEU']['codelist_code'] == 'C66781', f'AGEU: {dm_vars[\"AGEU\"][\"codelist_code\"]}'

  # Check AE codelist fixes -- ALL NY variables
  ae_vars = {v['name']: v for v in d['AE']['variables']}
  assert ae_vars['AESEV']['codelist_code'] == 'C66769', f'AESEV: {ae_vars[\"AESEV\"][\"codelist_code\"]}'
  for v in ['AESER','AESCAN','AESCONG','AESDISAB','AESDTH','AESHOSP','AESLIFE','AESMIE','AECONTRT']:
      assert ae_vars[v]['codelist_code'] == 'C66742', f'{v}: {ae_vars[v][\"codelist_code\"]}'

  # Check CM/EX/LB/VS/EG fixes
  cm_vars = {v['name']: v for v in d['CM']['variables']}
  assert cm_vars['CMROUTE']['codelist_code'] == 'C66729', f'CMROUTE: {cm_vars[\"CMROUTE\"][\"codelist_code\"]}'
  assert cm_vars['CMDOSU']['codelist_code'] == 'C71620', f'CMDOSU: {cm_vars[\"CMDOSU\"][\"codelist_code\"]}'
  assert cm_vars['CMDOSFRQ']['codelist_code'] == 'C71113', f'CMDOSFRQ: {cm_vars[\"CMDOSFRQ\"][\"codelist_code\"]}'

  lb_vars = {v['name']: v for v in d['LB']['variables']}
  assert lb_vars['LBORRESU']['codelist_code'] == 'C71620', f'LBORRESU: {lb_vars[\"LBORRESU\"][\"codelist_code\"]}'

  mh_vars = {v['name']: v for v in d['MH']['variables']}
  assert mh_vars['MHPRESP']['codelist_code'] == 'C66742', f'MHPRESP: {mh_vars[\"MHPRESP\"][\"codelist_code\"]}'

  # Check core designations
  assert dm_vars['ARMCD']['core'] == 'Exp', f'ARMCD: {dm_vars[\"ARMCD\"][\"core\"]}'
  assert dm_vars['DTHDTC']['core'] == 'Exp', f'DTHDTC: {dm_vars[\"DTHDTC\"][\"core\"]}'
  assert dm_vars['ETHNIC']['core'] == 'Perm', f'ETHNIC: {dm_vars[\"ETHNIC\"][\"core\"]}'
  assert ae_vars['AEOUT']['core'] == 'Perm', f'AEOUT: {ae_vars[\"AEOUT\"][\"core\"]}'
  assert cm_vars['CMDECOD']['core'] == 'Perm', f'CMDECOD: {cm_vars[\"CMDECOD\"][\"core\"]}'
  assert lb_vars['LBCAT']['core'] == 'Exp', f'LBCAT: {lb_vars[\"LBCAT\"][\"core\"]}'

  # Check ARMNRS exists
  assert 'ARMNRS' in dm_vars, 'ARMNRS missing'
  assert dm_vars['ARMNRS']['core'] == 'Exp'

  # Check DA class
  assert d['DA']['domain_class'] == 'Findings', f'DA class: {d[\"DA\"][\"domain_class\"]}'

  # Check key_variables (including LBSPEC)
  assert d['DM'].get('key_variables') == ['STUDYID', 'USUBJID'], f'DM keys: {d[\"DM\"].get(\"key_variables\")}'
  assert d['AE'].get('key_variables') is not None, 'AE keys missing'
  lb_keys = d['LB'].get('key_variables')
  assert lb_keys is not None, 'LB keys missing'
  assert 'LBSPEC' in lb_keys, f'LB keys missing LBSPEC: {lb_keys}'
  assert lb_keys == ['STUDYID', 'USUBJID', 'LBTESTCD', 'LBSPEC', 'VISITNUM', 'LBDTC'], f'LB keys wrong: {lb_keys}'

  # Check null codelist fills (spot check)
  if 'AEACN' in ae_vars:
      assert ae_vars['AEACN']['codelist_code'] == 'C66767', f'AEACN: {ae_vars[\"AEACN\"][\"codelist_code\"]}'

  print('ALL CHECKS PASSED')
  "
  ```
  </verify>
  <done>All codelist assignments, core designations, DA class, null codelists, ARMNRS, and key_variables corrected. LB keys include LBSPEC.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests verifying all domains.json corrections</name>
  <files>tests/test_reference/test_sdtm_ig.py</files>
  <action>
  Add new test classes to the existing test file. First, check if the DomainSpec model needs updating for key_variables (if Task 1 needed to update the model, tests must also reflect that).

  Add a new class `TestDomainsJsonCorrections`:

  **Codelist assignment tests:**
  - `test_dm_dthfl_uses_ny_codelist`: DTHFL.codelist_code == "C66742"
  - `test_dm_race_uses_race_codelist`: RACE.codelist_code == "C74457"
  - `test_dm_ethnic_uses_ethnic_codelist`: ETHNIC.codelist_code == "C66790"
  - `test_dm_country_uses_iso3166`: COUNTRY.codelist_code == "ISO3166"
  - `test_dm_ageu_uses_age_unit_codelist`: AGEU.codelist_code == "C66781"
  - `test_ae_aesev_uses_severity_codelist`: AESEV.codelist_code == "C66769"
  - `test_ae_ny_variables_use_c66742`: Check AESER, AESCAN, AESCONG, AESDISAB, AESDTH, AESHOSP, AESLIFE, AESMIE, AECONTRT all have codelist_code == "C66742"
  - `test_cm_route_uses_route_codelist`: CMROUTE.codelist_code == "C66729"
  - `test_cm_dosu_uses_unit_codelist`: CMDOSU.codelist_code == "C71620"
  - `test_cm_dosfrq_uses_freq_codelist`: CMDOSFRQ.codelist_code == "C71113"
  - `test_ex_route_uses_route_codelist`: EXROUTE.codelist_code == "C66729"
  - `test_lb_unit_vars_use_c71620`: LBORRESU and LBSTRESU both use "C71620"
  - `test_mh_ny_variables_use_c66742`: MHPRESP and MHOCCUR use "C66742"

  **Core designation tests:**
  - `test_dm_arm_variables_are_exp`: ARMCD, ARM, ACTARMCD, ACTARM all have core == "Exp"
  - `test_dm_death_variables_are_exp`: DTHDTC, DTHFL have core == "Exp"
  - `test_dm_ethnic_is_perm`: ETHNIC has core == "Perm"
  - `test_ae_aeout_is_perm`: AEOUT has core == "Perm"
  - `test_cm_optional_vars_are_perm`: CMDECOD, CMSTDTC, CMENDTC, CMINDC all have core == "Perm"
  - `test_ex_exroute_is_perm`: EXROUTE has core == "Perm"
  - `test_lb_lbcat_is_exp`: LBCAT has core == "Exp"

  **Structural tests:**
  - `test_da_domain_class_is_findings`: DA.domain_class == "Findings"
  - `test_dm_has_armnrs`: "ARMNRS" in DM variable names, core == "Exp"
  - `test_dm_key_variables`: DM.key_variables == ["STUDYID", "USUBJID"]
  - `test_ae_key_variables`: AE.key_variables == ["STUDYID", "USUBJID", "AETERM", "AESTDTC"]
  - `test_lb_key_variables_includes_lbspec`: LB.key_variables == ["STUDYID", "USUBJID", "LBTESTCD", "LBSPEC", "VISITNUM", "LBDTC"]
  - `test_all_core_domains_have_keys`: Check DM, AE, CM, EX, LB, VS, EG, DS, MH all have non-null key_variables

  **Null codelist fill tests:**
  - `test_ae_aeacn_has_codelist`: AEACN.codelist_code == "C66767" (if AEACN exists in the domain)

  Use the existing `ref` fixture (loads SDTMReference). Access domain specs via ref.get_domain_spec("DM") etc. Get variables via spec.variables and filter by name.

  Run the full test suite.
  </action>
  <verify>Run: `cd /Users/sanmaysarada/Astraea-SDTM && python3 -m pytest tests/test_reference/test_sdtm_ig.py -v` -- all tests pass.</verify>
  <done>All domains.json corrections verified by tests. Full test suite green.</done>
</task>

</tasks>

<verification>
1. `python3 -m pytest tests/ -x -q` -- all tests pass (no regressions)
2. Verify cross-reference: every codelist_code in domains.json has a matching key in codelists.json (except forward-reference codes for codelists not yet added like C65047, C67154, C78736, C78734, C66741, C67153, C71148, C71153, C71152, C66726, C66727, C66728 -- these are correct SDTM-IG assignments that will be populated when those domains are actively mapped in future phases)
</verification>

<success_criteria>
- All wrong codelist assignment errors fixed in domains.json
- All 15 core designation errors fixed
- DA domain class is Findings
- Null codelist assignments filled (with forward-reference note for codes not yet in codelists.json)
- DM.ARMNRS added as Exp variable
- key_variables defined for DM, AE, CM, EX, LB, VS, EG, DS, MH
- LB key_variables includes LBSPEC: ["STUDYID", "USUBJID", "LBTESTCD", "LBSPEC", "VISITNUM", "LBDTC"]
- DomainSpec Pydantic model supports key_variables (if not already)
- All existing tests pass + new verification tests
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ref-data-fixes/02.1-04-SUMMARY.md`
</output>
